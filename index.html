<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>äº¬é˜ªä¹‹æ—…</title>

  <!-- 1. Global Error Handler -->
  <script>
    window.addEventListener('error', function(e) {
      console.error("Global Error:", e.error);
      setTimeout(() => {
        const splash = document.getElementById('splash-screen');
        if (splash) splash.style.display = 'none';
      }, 1000);
    });

    // Force enter after 4 seconds to prevent splash screen stuck
    setTimeout(() => {
      const splash = document.getElementById('splash-screen');
      if (splash && splash.style.display !== 'none') {
        splash.style.display = 'none';
      }
    }, 4000);
  </script>

  <!-- Preconnect -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Vue 3 (Global Build) -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            sakura: { light: '#fff0f5', DEFAULT: '#ffb7c5', dark: '#2EA9DF', text: '#5d4037' }
          },
          fontFamily: { sans: ['"Zen Maru Gothic"', 'sans-serif'] },
          boxShadow: { 'soft': '0 4px 20px -2px rgba(255, 183, 197, 0.4)', 'card': '0 2px 10px rgba(0,0,0,0.05)' },
          animation: {
            'float': 'float 3s ease-in-out infinite',
            'fade-in': 'fadeIn 0.3s ease-out forwards',
            'slide-up': 'slideUp 0.3s ease-out forwards',
            'fall-1': 'fall-sway-1 6s linear infinite',
            'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'marquee': 'marquee 15s linear infinite',
          },
          keyframes: {
            float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
            'fall-sway-1': {
              '0%': { top: '-10%', left: 'var(--start-left)', transform: 'rotate(0deg) translateX(0)', opacity: '0' },
              '10%': { opacity: '0.8' },
              '50%': { transform: 'rotate(180deg) translateX(20px)' },
              '100%': { top: '110%', left: 'calc(var(--start-left) + 10%)', transform: 'rotate(360deg) translateX(-20px)', opacity: '0' }
            },
            marquee: {
              '0%': { transform: 'translateX(100%)' },
              '100%': { transform: 'translateX(-100%)' }
            }
          }
        }
      }
    }
  </script>

  <style>
    body { background-color: #fff0f5; -webkit-tap-highlight-color: transparent; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .app-container { max-width: 480px; margin: 0 auto; background-color: #fafafa; min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.05); padding-bottom: 80px; }
    .sakura-petal { position: absolute; background-color: #ffb7c5; border-radius: 100% 0 100% 0; opacity: 0; top: -20px; }
    .blur-sm { filter: blur(1px); }
    
    /* Custom Modal Styles */
    .glass-modal { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
  </style>
</head>

<body>
<div id="app" class="app-container">

  <!-- Splash Screen -->
  <div id="splash-screen" v-if="showSplash" class="fixed inset-0 z-[100] bg-gradient-to-b from-[#fff0f5] to-white flex flex-col items-center justify-center overflow-hidden transition-opacity duration-700">
    <div class="absolute inset-0 pointer-events-none z-10 w-full h-full overflow-hidden">
      <span class="sakura-petal w-4 h-4 animate-fall-1" style="--start-left: 10%; animation-duration: 6s;"></span>
      <span class="sakura-petal w-5 h-5 animate-fall-1" style="--start-left: 70%; animation-duration: 8s; animation-delay: 1s;"></span>
    </div>
    <div class="relative z-10 text-center animate-float">
      <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mx-auto mb-6 shadow-soft border-4 border-white">
        <i class="fa-solid fa-plane-departure text-4xl text-sakura-dark"></i>
      </div>
      <h1 class="text-4xl font-bold text-sakura-text tracking-[0.3em] mb-3 ml-2">äº¬é˜ªä¹‹æ—…</h1>
      <div class="inline-block px-4 py-1 bg-white/60 rounded-full backdrop-blur-sm mt-2">
        <p class="text-sm font-bold text-sakura-dark tracking-widest">READY FOR TRIP</p>
      </div>
    </div>
    <div class="absolute bottom-12 text-sakura-text/50 text-xs font-bold animate-pulse text-center w-full">
      <span v-if="migrationStatus">{{ migrationStatus }}</span>
      <span v-else>æ­£åœ¨å‰µé€ ç¾å¥½å›æ†¶...</span>
    </div>
  </div>

  <!-- 1. Top Bar (With Titles) -->
  <div class="sticky top-0 z-40 bg-white/95 backdrop-blur-md shadow-sm py-3 px-4 flex flex-col justify-center items-center border-b border-gray-100">
      <h1 class="text-2xl font-bold tracking-[0.2em] text-sakura-text flex items-center gap-2 mb-1" style="font-family: 'Zen Maru Gothic';">
          <i class="fa-solid fa-plane text-sakura text-xl"></i>
          äº¬é˜ªä¹‹æ—…
          <span class="text-xl">ğŸŒ¸</span>
      </h1>
      <div class="flex items-center gap-2 text-[10px] font-bold tracking-widest text-gray-500 uppercase">
          <span>Osaka</span>
          <span class="text-sakura">â€¢</span>
          <span>Kyoto</span>
          <span class="text-sakura">â€¢</span>
          <span>Nara</span>
      </div>
      <div class="text-[10px] font-medium text-gray-400 tracking-widest mt-0.5">
          2026.04.02 - 04.06
      </div>
  </div>

  <!-- 2. Header Banner (Restored Height to 240px) -->
  <header class="relative h-[240px] w-full overflow-hidden bg-gray-100 group">
    <!-- æ©«å¹…åœ–ç‰‡ -->
    <img :src="bannerImage" class="w-full h-full object-cover object-center origin-center opacity-100" @error="handleImageError">
    
    <!-- Countdown Badge -->
    <div class="absolute top-4 right-4 bg-black/40 backdrop-blur-md px-3 py-1.5 rounded-full text-white text-[10px] border border-white/20 shadow-lg flex items-center gap-2 z-20 font-bold">
      <i class="fa-regular fa-clock text-sakura"></i>
      <span v-if="daysUntilTrip > 0">è·é›¢å‡ºç™¼ <b>{{ daysUntilTrip }}</b> å¤©</span>
      <span v-else-if="daysUntilTrip >= -3">æ—…ç¨‹ç¬¬ {{ Math.abs(daysUntilTrip) + 1 }} å¤©</span>
      <span v-else-if="daysUntilTrip === -4">æ—…ç¨‹çµæŸ ğŸ </span>
      <span v-else>æ—…ç¨‹å·²åœ“æ»¿çµæŸ</span>
    </div>
  </header>

  <!-- Main Content Area -->
  <main class="relative -mt-6 bg-[#fafafa] rounded-t-[30px] px-4 pt-6 min-h-[500px] z-10 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">

    <!-- Cloud Status (Moved to top-left corner) -->
    <div class="fixed top-4 left-4 z-50 flex items-center gap-2 cursor-pointer" @click="reconnectFirebase">
      <div class="w-3 h-3 rounded-full shadow-[0_0_8px_rgba(0,0,0,0.2)] border border-white transition-all duration-500"
           :class="isSaving ? 'bg-yellow-400 animate-pulse' : (firebaseStatus === 'error' ? 'bg-red-500' : (firebaseStatus === 'connected' ? 'bg-green-400' : 'bg-yellow-400'))">
      </div>
      <span v-if="isSaving || migrationStatus" class="text-[10px] bg-white/90 backdrop-blur px-2 py-0.5 rounded-full text-gray-600 font-bold shadow-sm border border-gray-100">
        {{ migrationStatus || 'åŒæ­¥ä¸­...' }}
      </span>
    </div>

    <!-- TAB 1: Itinerary -->
    <div v-if="currentTab === 'itinerary'">
      
      <!-- Weather Card (Compacted) -->
      <div class="relative bg-white rounded-3xl p-4 shadow-[0_8px_30px_rgba(0,0,0,0.04)] mb-4 border border-gray-50 overflow-hidden group transition-all duration-300">
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-gradient-to-br from-sakura-light to-blue-50 rounded-full blur-3xl opacity-50 pointer-events-none"></div>
        
        <div v-if="weatherLoading" class="absolute inset-0 bg-white/80 backdrop-blur-md z-30 flex items-center justify-center rounded-3xl">
          <div class="text-sakura-dark animate-pulse flex flex-col items-center gap-1">
            <i class="fa-solid fa-cloud-sun text-4xl animate-bounce"></i>
            <span class="text-xs font-bold tracking-widest uppercase mt-1">Loading Weather</span>
          </div>
        </div>

        <div v-if="currentDayCities.length > 1" class="flex justify-end gap-1.5 mb-1 relative z-20 overflow-x-auto no-scrollbar pb-1">
          <button v-for="city in currentDayCities" :key="city.name" @click.stop="changeWeatherCity(city)"
            :class="['text-[10px] px-2.5 py-1 rounded-full font-bold transition-all border shadow-sm', weatherData.city === city.name ? 'bg-sakura text-white border-sakura ring-1 ring-sakura/20' : 'bg-white text-gray-400 border-gray-100 hover:bg-gray-50']">
            {{ city.name }}
          </button>
        </div>

        <div @click="toggleWeather" class="relative z-10 cursor-pointer pt-0">
          <div class="flex justify-between items-center">
            <div class="pl-1">
              <div class="flex items-center gap-2 mb-0.5">
                <h2 class="text-lg font-bold text-gray-800 tracking-tight">{{ weatherData.city }}</h2>
                <span class="px-2 py-0.5 bg-gray-100 rounded-md text-[10px] font-bold text-gray-500 flex items-center gap-1">
                  <i class="fa-solid fa-circle text-[5px]" :style="{color: weatherData.iconColor}"></i>
                  {{ weatherData.description }}
                </span>
              </div>
              <div class="flex items-end h-10">
                <span class="text-4xl font-bold text-gray-800 tracking-tighter leading-none -ml-0.5">{{ weatherData.temp }}Â°</span>
                <div class="ml-3 flex flex-col justify-center text-[10px] font-bold text-gray-400 leading-tight border-l border-gray-200 pl-2 h-7">
                  <span class="flex items-center gap-1 mb-0.5"><i class="fa-solid fa-arrow-up text-red-300"></i>{{ weatherData.maxTemp }}Â°</span>
                  <span class="flex items-center gap-1"><i class="fa-solid fa-arrow-down text-blue-300"></i>{{ weatherData.minTemp }}Â°</span>
                </div>
              </div>
              <p class="text-[10px] text-gray-400 mt-1 font-medium pl-0.5">é«”æ„Ÿ {{ weatherData.apparentTemp }}Â°C</p>
            </div>
            <div class="w-12 h-12 flex items-center justify-center animate-float mr-1">
              <i :class="weatherData.icon" class="text-4xl drop-shadow-md transition-all duration-500" :style="{color: weatherData.iconColor}"></i>
            </div>
          </div>
          <div class="flex justify-center -mt-1 opacity-30 group-hover:opacity-100 transition-opacity">
            <i class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-300 text-[10px]" :class="{'rotate-180': isWeatherExpanded}"></i>
          </div>
        </div>

        <div v-if="isWeatherExpanded" class="mt-2 pt-2 border-t border-gray-100 animate-fade-in relative z-10">
          
          <!-- 1. Outfit Advice -->
          <div class="mb-3 bg-gradient-to-r from-sakura-light/30 to-white border border-sakura-light/40 rounded-xl p-2 shadow-sm flex gap-2 items-start">
            <div class="w-5 h-5 rounded-full bg-white text-sakura-dark flex items-center justify-center shrink-0 shadow-sm text-[10px] mt-0.5"><i class="fa-solid fa-shirt"></i></div>
            <div>
              <h5 class="text-[9px] font-bold text-sakura-dark mb-0.5 tracking-wider uppercase">Outfit Advice</h5>
              <p class="text-[10px] text-gray-600 font-medium leading-relaxed">{{ weatherData.clothing }}</p>
            </div>
          </div>

          <!-- 2. Hourly Forecast (New) -->
          <div class="mb-3">
            <h5 class="text-[10px] text-gray-400 font-bold mb-2 ml-1">æœªä¾† 24 å°æ™‚</h5>
            <div class="flex overflow-x-auto no-scrollbar gap-2 pb-2">
                <div v-for="(hour, hIdx) in weatherData.hourly" :key="hIdx" class="flex-shrink-0 flex flex-col items-center bg-gray-50 rounded-xl p-1.5 w-12 border border-gray-100">
                    <span class="text-[9px] text-gray-500 font-bold mb-1">{{ hour.time }}</span>
                    <i :class="hour.icon" class="text-sm mb-1" :style="{color: hour.color}"></i>
                    <span class="text-[10px] font-bold text-gray-700">{{ hour.temp }}Â°</span>
                    <span v-if="hour.pop > 0" class="text-[8px] text-blue-400 font-bold mt-0.5">{{ hour.pop }}%</span>
                </div>
            </div>
          </div>

          <!-- 3. Detailed Metrics Grid (Expanded) -->
          <div class="grid grid-cols-3 gap-2 mb-3">
            <!-- Humidity -->
            <div class="bg-gray-50 rounded-xl p-1.5 flex flex-col items-center justify-center border border-gray-100 h-16">
              <i class="fa-solid fa-droplet text-blue-400 text-sm mb-0.5"></i>
              <div class="text-[9px] text-gray-400 font-bold uppercase">æ¿•åº¦</div>
              <div class="text-[10px] font-bold text-gray-700">{{ weatherData.humidity }}%</div>
            </div>
            <!-- Rain -->
            <div class="bg-gray-50 rounded-xl p-1.5 flex flex-col items-center justify-center border border-gray-100 h-16">
              <i class="fa-solid fa-umbrella text-cyan-400 text-sm mb-0.5"></i>
              <div class="text-[9px] text-gray-400 font-bold uppercase">é™é›¨é‡</div>
              <div class="text-[10px] font-bold text-gray-700">{{ weatherData.rain }}<span class="text-[8px] font-normal scale-75">mm</span></div>
            </div>
            <!-- Wind -->
            <div class="bg-gray-50 rounded-xl p-1.5 flex flex-col items-center justify-center border border-gray-100 h-16">
              <i class="fa-solid fa-wind text-indigo-400 text-sm mb-0.5"></i>
              <div class="text-[9px] text-gray-400 font-bold uppercase">é¢¨é€Ÿ</div>
              <div class="text-[10px] font-bold text-gray-700">{{ weatherData.windSpeed }}<span class="text-[8px] font-normal scale-75">m/s</span></div>
            </div>
            <!-- UV -->
            <div class="bg-gray-50 rounded-xl p-1.5 flex flex-col items-center justify-center border border-gray-100 h-16">
              <i class="fa-solid fa-sun text-orange-400 text-sm mb-0.5"></i>
              <div class="text-[9px] text-gray-400 font-bold uppercase">ç´«å¤–ç·š</div>
              <div class="text-[10px] font-bold text-gray-700">{{ weatherData.uvIndex }}</div>
            </div>
            <!-- Pressure (New) -->
            <div class="bg-gray-50 rounded-xl p-1.5 flex flex-col items-center justify-center border border-gray-100 h-16">
              <i class="fa-solid fa-gauge-high text-emerald-400 text-sm mb-0.5"></i>
              <div class="text-[9px] text-gray-400 font-bold uppercase">æ°£å£“</div>
              <div class="text-[10px] font-bold text-gray-700">{{ weatherData.pressure }}<span class="text-[8px] font-normal scale-75">hPa</span></div>
            </div>
            <!-- Visibility (New) -->
            <div class="bg-gray-50 rounded-xl p-1.5 flex flex-col items-center justify-center border border-gray-100 h-16">
              <i class="fa-solid fa-eye text-purple-400 text-sm mb-0.5"></i>
              <div class="text-[9px] text-gray-400 font-bold uppercase">èƒ½è¦‹åº¦</div>
              <div class="text-[10px] font-bold text-gray-700">{{ weatherData.visibility }}<span class="text-[8px] font-normal scale-75">km</span></div>
            </div>
          </div>

          <!-- 4. Sun Times -->
          <div class="flex justify-between items-center bg-gray-50 rounded-full px-4 py-1.5 border border-gray-100 mb-3">
            <div class="flex items-center gap-2"><i class="fa-regular fa-sun text-orange-400 text-xs"></i><div class="flex flex-col"><span class="text-[8px] text-gray-400 leading-none">æ—¥å‡º</span><span class="text-[10px] font-bold text-gray-600 leading-none">{{ weatherData.sunrise }}</span></div></div>
            <div class="h-6 w-px bg-gray-200 mx-2"></div>
            <div class="flex items-center gap-2"><div class="flex flex-col items-end"><span class="text-[8px] text-gray-400 leading-none">æ—¥è½</span><span class="text-[10px] font-bold text-gray-600 leading-none">{{ weatherData.sunset }}</span></div><i class="fa-regular fa-moon text-indigo-400 text-xs"></i></div>
          </div>

          <!-- 5. Daily Forecast -->
          <div v-if="weatherData.forecast && weatherData.forecast.length > 0" class="border-t border-gray-100 pt-3">
            <h5 class="text-[10px] text-gray-400 font-bold mb-2 ml-1">æœªä¾†é å ±</h5>
            <div class="flex flex-col gap-2">
              <div v-for="day in weatherData.forecast" :key="day.dayName" class="flex justify-between items-center bg-gray-50 rounded-xl p-1.5 px-3 border border-transparent hover:border-sakura-light transition-colors">
                <span class="text-[10px] font-bold text-gray-600 w-12">{{ day.dayName }}</span>
                <div class="flex items-center gap-2 flex-1 justify-center">
                    <i :class="day.icon" class="text-sm" :style="{color: day.color}"></i>
                    <span v-if="day.pop > 0" class="text-[8px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded-full font-bold flex items-center"><i class="fa-solid fa-umbrella text-[8px] mr-1"></i>{{ day.pop }}%</span>
                </div>
                <div class="flex items-center text-[10px] font-bold text-gray-700 w-16 justify-end">{{ day.max }}Â° <span class="text-[9px] text-gray-400 font-normal ml-1">{{ day.min }}Â°</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Dates -->
      <div class="flex overflow-x-auto no-scrollbar gap-3 mb-4 pb-2 justify-center">
        <button v-for="(day, index) in days" :key="index" @click="selectedDate = day.dateStr"
          :class="['flex-shrink-0 flex flex-col items-center justify-center w-16 h-20 rounded-2xl transition-all duration-300 relative overflow-hidden', selectedDate === day.dateStr ? 'bg-sakura text-white shadow-soft transform scale-105' : 'bg-white text-gray-400 border border-gray-100']">
          <span class="text-xs font-bold z-10 opacity-60 mb-1">Day{{ index + 1 }}</span>
          <span class="text-xl font-bold z-10 leading-none">{{ day.displayDate }}</span>
        </button>
      </div>

      <!-- Marquee Notice (Moved Here) -->
      <div class="bg-yellow-50 border border-yellow-200/60 text-yellow-800 px-3 py-2 rounded-xl mb-4 overflow-hidden relative shadow-sm mx-1">
        <div class="whitespace-nowrap animate-marquee text-xs font-bold flex items-center">
           <i class="fa-solid fa-clock mr-2 text-yellow-600"></i>æ™‚é–“çš†ç‚ºé ä¼°ï¼Œåƒ…ä¾›åƒè€ƒï¼Œä¾ç¾å ´ç‹€æ³ç‚ºæº–
        </div>
        <!-- Gradient masks for fade effect -->
        <div class="absolute left-0 top-0 bottom-0 w-4 bg-gradient-to-r from-yellow-50 to-transparent z-10"></div>
        <div class="absolute right-0 top-0 bottom-0 w-4 bg-gradient-to-l from-yellow-50 to-transparent z-10"></div>
      </div>

      <!-- Itinerary List -->
      <div class="space-y-4">
        <div v-for="(item, index) in filteredItinerary" :key="item.id" class="relative pl-4 border-l-2 border-sakura-light">
          <div class="bg-white rounded-2xl p-4 shadow-card relative group"
               :class="{'border-l-4 border-sakura': item.category !== 'flight', 'bg-blue-50 border-l-4 border-blue-400': item.category === 'flight'}">
            
            <div v-if="item.category === 'flight'">
              <div class="flex justify-between items-start mb-2">
                <span class="bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full font-bold"><i class="fa-solid fa-plane-departure mr-1"></i>èˆªç­</span>
                <span class="text-xs text-gray-500 font-bold">{{ item.time }}</span>
              </div>
              <h3 class="font-bold text-gray-800 text-lg mb-1">{{ item.name }}</h3>
              <div class="text-sm text-gray-600 space-y-1"><p>{{ item.note }}</p></div>
              <div v-if="item.description" class="text-xs text-gray-400 mt-1">{{ item.description }}</div>
            </div>

            <div v-else>
              <div class="flex justify-between items-start mb-1">
                <div class="flex items-center gap-2 mb-2 flex-wrap">
                  <span :class="['text-xs px-2 py-1 rounded-full font-medium inline-block', getCategoryColor(item.category)]">{{ getCategoryLabel(item.category) }}</span>
                  <span v-if="item.travelTime > 0" class="text-[10px] text-gray-400 flex items-center bg-gray-50 px-2 py-1 rounded-full border border-gray-100">
                    <i :class="getTransportIcon(item.transportType)" class="mr-1 text-sakura-dark"></i>ç´„ {{ item.travelTime }} åˆ†
                  </span>
                  <span v-else-if="index === 0 && selectedDate !== '2026-04-02' && item.category !== 'flight'" class="text-[10px] text-gray-400 flex items-center bg-gray-50 px-2 py-1 rounded-full border border-gray-100">
                    <i class="fa-solid fa-hotel mr-1 text-sakura-dark"></i>é£¯åº—å‡ºç™¼
                  </span>
                </div>
                <span class="text-sm font-bold text-sakura-text bg-sakura-light px-2 py-1 rounded-lg whitespace-nowrap ml-2">{{ item.time }}</span>
              </div>
              
              <h3 class="font-bold text-gray-800 text-lg mb-2 flex items-center gap-2 select-none">
                {{ item.name }} 
                <button @click.stop="openMap(item.name)" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-sakura-light/50 active:bg-sakura-light transition-colors -my-1">
                    <i class="fa-solid fa-location-arrow text-xs text-sakura cursor-pointer"></i>
                </button>
              </h3>

              <div class="space-y-2 text-sm text-gray-600">
                <div class="flex flex-wrap gap-3 text-xs">
                  <p v-if="item.category !== 'other' && item.category !== 'accommodation' && item.openHours" class="flex items-center"><i class="fa-regular fa-clock w-4 text-center text-gray-400 mr-1"></i> {{ item.openHours }}</p>
                  <p v-if="item.category === 'attraction' && item.ticket" class="flex items-center"><i class="fa-solid fa-ticket w-4 text-center text-yellow-500 mr-1"></i> {{ item.ticket }}</p>
                </div>
                <div v-if="item.description" class="text-xs bg-gray-50 p-3 rounded-lg border border-gray-100 leading-relaxed text-gray-500">
                  <p style="white-space: pre-line;">{{ item.description }}</p>
                </div>
                <p v-if="item.note" class="text-xs text-sakura-dark mt-1 flex items-start font-medium"><i class="fa-solid fa-circle-exclamation w-4 mt-0.5 mr-1"></i> {{ item.note }}</p>
              </div>
            </div>
          </div>
        </div>

        <div v-if="filteredItinerary.length === 0" class="text-center py-10 text-gray-400">
          <p v-if="migrationStatus" class="animate-pulse">æ­£åœ¨è¼‰å…¥è¡Œç¨‹è³‡æ–™...</p>
          <div v-else>
             <i class="fa-solid fa-mug-hot text-4xl mb-3 opacity-50"></i>
             <p>æœ¬æ—¥å°šç„¡è¡Œç¨‹</p>
          </div>
        </div>
      </div>
      
      <!-- Update Actions -->
      <div class="text-center pb-20 pt-8 space-y-3">
        <button @click="updateItineraryContentOnly" class="text-[12px] text-gray-400 underline hover:text-sakura-dark transition-colors font-bold flex items-center justify-center mx-auto">
            <i class="fa-solid fa-arrows-rotate mr-1"></i>æ›´æ–°è¡Œç¨‹å…§å®¹ (ä¿ç•™å…¶ä»–è³‡æ–™)
        </button>
        
        <button @click="fixDuplicates" class="text-[12px] text-red-300 underline hover:text-red-500 transition-colors font-bold flex items-center justify-center mx-auto">
            <i class="fa-solid fa-wrench mr-1"></i>ä¿®å¾©é‡è¤‡è¡Œç¨‹
        </button>

        <div class="text-[10px] text-gray-300 pt-2">è³‡æ–™åº«ç‰ˆæœ¬: {{ TRIP_ID }}</div>
      </div>
    </div>

    <!-- TAB 2: Info -->
    <div v-if="currentTab === 'info'" class="space-y-6 pb-20">
      <!-- Exchange Rate -->
      <div class="bg-white rounded-2xl p-5 shadow-card">
        <h3 class="font-bold text-sakura-text mb-4 border-b pb-2 flex justify-between items-center">
          <span><i class="fa-solid fa-coins mr-2 text-yellow-500"></i>å³æ™‚åŒ¯ç‡åƒè€ƒ</span>
          <div class="text-right">
            <span class="text-[10px] text-gray-400 block font-mono">1 JPY â‰ˆ {{ currentRate.toFixed(4) }} TWD</span>
            <span v-if="rateUpdateDate" class="text-[9px] text-gray-300 block">æ›´æ–°: {{ rateUpdateDate }}</span>
          </div>
        </h3>
        <div class="flex items-center gap-4 mb-3">
          <div class="flex-1"><label class="text-xs text-gray-500 mb-1 block font-medium">æ—¥å¹£ (JPY)</label><input type="number" v-model="exchange.jpy" @input="calcTwd" class="w-full bg-gray-50 rounded-xl p-3 outline-none focus:ring-2 focus:ring-sakura" placeholder="Â¥"></div>
          <i class="fa-solid fa-arrow-right-arrow-left text-gray-300"></i>
          <div class="flex-1"><label class="text-xs text-gray-500 mb-1 block font-medium">å°å¹£ (TWD)</label><input type="number" v-model="exchange.twd" @input="calcJpy" class="w-full bg-sakura-light rounded-xl p-3 font-bold text-sakura-text outline-none focus:ring-2 focus:ring-sakura" placeholder="NT$"></div>
        </div>

        <!-- Explanation and Warning (Collapsible) -->
        <div class="bg-gray-50 rounded-xl border border-gray-100 overflow-hidden">
            <button @click="isExchangeWarningExpanded = !isExchangeWarningExpanded" class="w-full p-3 flex justify-between items-center text-left hover:bg-gray-100 transition-colors focus:outline-none">
                <h5 class="text-[10px] font-bold text-gray-600 flex items-center m-0">
                    <i class="fa-solid fa-circle-exclamation mr-1.5 text-gray-400"></i>èªªæ˜èˆ‡è­¦èª
                </h5>
                <i class="fa-solid fa-chevron-down text-gray-400 text-[10px] transition-transform duration-300" :class="{'rotate-180': isExchangeWarningExpanded}"></i>
            </button>
            <div v-show="isExchangeWarningExpanded" class="px-3 pb-3 pt-0 animate-fade-in">
                <ul class="text-[10px] text-gray-500 list-disc pl-3 space-y-1 border-t border-gray-200 pt-2">
                    <li>æ­¤ç‚º<b>åœ‹éš›å¸‚å ´åŒ¯ç‡ + 0.002 (é ä¼°é»å·®)</b> ä¹‹æ¨¡æ“¬ç¾é‡‘è³£å‡ºåƒ¹ï¼ŒééŠ€è¡Œå®˜æ–¹å³æ™‚å ±åƒ¹ã€‚</li>
                    <li>å¯¦éš›æ›åŒ¯æˆ–åˆ·å¡é‡‘é¡ï¼Œè«‹ä¾<b>äº¤æ˜“ç•¶ä¸‹éŠ€è¡Œå…¬å‘Š</b>ç‚ºæº–ã€‚</li>
                    <li>æœ¬åŠŸèƒ½åƒ…ä¾›æ—…è¡Œé ç®—æ¦‚ä¼°åƒè€ƒã€‚</li>
                </ul>
            </div>
        </div>
      </div>

      <!-- Announcement -->
      <div class="bg-white rounded-2xl p-4 shadow-card border-l-4 border-sakura-dark relative overflow-hidden">
        <div class="flex items-start gap-3">
            <div class="bg-sakura-light text-sakura-dark w-10 h-10 rounded-full flex items-center justify-center shrink-0">
                <i class="fa-solid fa-bullhorn text-lg"></i>
            </div>
            <div class="w-full">
                <!-- æ¨™é¡Œä¿®æ”¹ -->
                <h4 class="font-bold text-gray-800 text-sm mb-2">é‡è¦å…¬å‘Šèˆ‡èªªæ˜</h4>
                <ul class="text-xs text-gray-600 space-y-1.5 list-disc pl-4 font-medium">
                    <!-- å…§å®¹ä¿®æ”¹ -->
                    <li>é£¯åº—<b>ç„¡å®‰æ’æ—©é¤</b>ï¼Œå› åƒ¹æ ¼è¼ƒé«˜ä¸”éè‡ªåŠ©å¼ï¼Œå¯è‡³é™„è¿‘è¶…å•†æˆ–è¶…å¸‚è³¼è²·ã€‚</li>
                    <li>å·²åŒ…å« <b>åƒåˆ°é£½ç¶²å¡</b> ä¸éœ€è¦å¦å¤–è³¼è²·ã€‚</li>
                    <li>è¡Œç¨‹ä¸­è‹¥è¦è„«éšŠæˆ–æŸå€‹æ™¯é»ä¸æƒ³å»ï¼Œå¾ŒçºŒè«‹<b>è‡ªè¡Œå›é£¯åº—</b>ã€‚</li>
                    <li>è‡ªç”±è¡Œæ¯æ—¥åŸºæœ¬ä¸Šèµ° <b>ç´„20,000 æ­¥ä»¥ä¸Š</b>ï¼Œå»ºè­°ç©¿è‘—å¥½èµ°çš„é‹ã€‚</li>
                </ul>
                <p class="text-xs font-bold text-pink-500 mt-3 text-right border-t border-pink-100 pt-2">
                    <i class="fa-regular fa-face-smile-wink mr-1"></i>ç¥å¤§å®¶æ—…é€”æ„‰å¿«~
                </p>
            </div>
        </div>
      </div>

      <!-- Flight Info -->
      <div class="bg-white rounded-2xl p-5 shadow-card">
        <h3 class="font-bold text-sakura-text mb-4 border-b pb-2"><i class="fa-solid fa-plane mr-2 text-blue-400"></i>èˆªç­è³‡è¨Š</h3>
        <!-- Outbound -->
        <div class="mb-4 bg-blue-50 rounded-xl p-4 border border-blue-100 relative overflow-hidden">
          <div class="absolute top-0 right-0 bg-blue-500 text-white text-xs px-3 py-1 rounded-bl-xl font-bold tracking-wider">å»ç¨‹</div>
          <div class="flex items-center gap-2 mb-4">
            <span class="font-bold text-xl text-gray-800 tracking-wide">IT-284</span>
            <span class="text-[10px] text-blue-600 bg-white px-2 py-0.5 rounded-full border border-blue-100 font-bold">å°ç£è™èˆª</span>
          </div>
          <div class="flex justify-between items-center text-center mb-4 relative z-10">
            <div class="text-left"><div class="text-3xl font-bold text-gray-800 leading-none">07:00</div><div class="text-sm font-bold text-gray-600 mt-1">KHH é«˜é›„</div></div>
            <div class="flex flex-col items-center w-1/3 px-2"><span class="text-[10px] text-gray-400 mb-2 font-bold">2h 55m</span><div class="w-full h-0.5 bg-gray-300 relative flex items-center justify-center"><i class="fa-solid fa-plane-departure text-blue-400 text-sm absolute bg-blue-50 px-1"></i></div><span class="text-[10px] text-blue-400 mt-1">ç›´é£›</span></div>
            <div class="text-right"><div class="text-3xl font-bold text-gray-800 leading-none">10:55</div><div class="text-sm font-bold text-gray-600 mt-1">KIX é—œè¥¿</div></div>
          </div>
          <div class="text-center mb-3">
            <span class="text-xs font-bold text-blue-600 bg-white border border-blue-200 px-3 py-1 rounded-full shadow-sm"><i class="fa-solid fa-user-clock mr-1"></i>å»ºè­°å ±åˆ°ï¼š04:30</span>
          </div>
          <!-- Restored Baggage & Meal Info (Outbound) -->
          <div class="flex justify-between items-center text-xs text-gray-500 border-t border-blue-200/50 pt-3 mt-2">
            <span class="flex items-center"><i class="fa-regular fa-calendar-check mr-1.5 text-blue-400"></i>2026/04/02 (é€±å››)</span>
            <span class="flex items-center"><i class="fa-solid fa-suitcase-rolling mr-1 text-blue-400"></i>20kg<span class="mx-1 text-blue-200">|</span><i class="fa-solid fa-briefcase mr-1 text-blue-400"></i>10kg<span class="mx-1 text-blue-200">|</span><i class="fa-solid fa-utensils mr-1 text-blue-400"></i>å«é¤</span>
          </div>
        </div>
        <!-- Inbound -->
        <div class="bg-sakura-light/40 rounded-xl p-4 border border-sakura-light relative overflow-hidden mb-4">
          <div class="absolute top-0 right-0 bg-sakura text-white text-xs px-3 py-1 rounded-bl-xl font-bold tracking-wider">å›ç¨‹</div>
          <div class="flex items-center gap-2 mb-4">
            <span class="font-bold text-xl text-gray-800 tracking-wide">IT-285</span>
            <span class="text-[10px] text-sakura-dark bg-white px-2 py-0.5 rounded-full border border-sakura-light font-bold">å°ç£è™èˆª</span>
          </div>
          <div class="flex justify-between items-center text-center mb-4 relative z-10">
            <div class="text-left"><div class="text-3xl font-bold text-gray-800">12:00</div><div class="text-sm font-bold text-gray-600 mt-1">KIX é—œè¥¿</div></div>
            <div class="flex flex-col items-center w-1/3 px-2"><span class="text-[10px] text-gray-400 mb-2 font-bold">3h 0m</span><div class="w-full h-0.5 bg-gray-300 relative flex items-center justify-center"><i class="fa-solid fa-plane-departure text-sakura text-sm absolute bg-sakura-light/40 px-1"></i></div><span class="text-[10px] text-sakura mt-1">ç›´é£›</span></div>
            <div class="text-right"><div class="text-3xl font-bold text-gray-800 leading-none">14:00</div><div class="text-sm font-bold text-gray-600 mt-1">KHH é«˜é›„</div></div>
          </div>
          <div class="text-center mb-3">
            <span class="text-xs font-bold text-sakura-text bg-white border border-sakura-light px-3 py-1 rounded-full shadow-sm"><i class="fa-solid fa-user-clock mr-1 text-sakura"></i>å»ºè­°å ±åˆ°ï¼š10:00</span>
          </div>
          <!-- Restored Baggage & Meal Info (Inbound) -->
          <div class="flex justify-between items-center text-xs text-gray-500 border-t border-sakura-light pt-3 mt-2">
            <span class="flex items-center"><i class="fa-regular fa-calendar-check mr-1.5 text-sakura"></i>2026/04/06 (é€±ä¸€)</span>
            <span class="flex items-center"><i class="fa-solid fa-suitcase-rolling mr-1 text-sakura"></i>20kg<span class="mx-1 text-sakura-light">|</span><i class="fa-solid fa-briefcase mr-1 text-sakura"></i>10kg<span class="mx-1 text-sakura-light">|</span><i class="fa-solid fa-utensils mr-1 text-sakura"></i>å«é¤</span>
          </div>
        </div>
      </div>

      <!-- Hotel Info (Restored) -->
      <div class="bg-white rounded-2xl p-5 shadow-card">
        <h3 class="font-bold text-sakura-text mb-4 border-b pb-2"><i class="fa-solid fa-hotel mr-2 text-purple-400"></i>ä½å®¿è³‡è¨Š</h3>
        <div class="flex gap-4 mb-4">
           <div class="w-20 h-20 bg-purple-50 rounded-xl overflow-hidden shrink-0 shadow-sm border border-purple-100 flex items-center justify-center text-purple-300">
                <i class="fa-solid fa-bed text-3xl"></i>
           </div>
           <div class="flex-1 min-w-0 py-0.5">
             <h4 class="font-bold text-gray-800 text-lg truncate">æ±æ€¥ Stay å¤§é˜ªæœ¬ç”º</h4>
             <p class="text-xs text-gray-400 mb-2 truncate">Tokyu Stay Osaka Hommachi</p>
             <div class="flex gap-1 flex-wrap">
               <span class="text-[10px] bg-purple-50 text-purple-600 px-2 py-0.5 rounded border border-purple-100">æœ¬ç”ºç«™ 11è™Ÿå‡ºå£</span>
               <!-- æ–°å¢çš„ä¾¿åˆ©å•†åº—æ¨™ç±¤ -->
               <span class="text-[10px] bg-sky-50 text-sky-600 px-2 py-0.5 rounded border border-sky-100">è·é›¢Lowsonä¾¿åˆ©å•†åº—æ­¥è¡Œç´„4åˆ†é˜</span>
               <span class="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded border border-emerald-100">è·é›¢LIFE Sakaisujiè¶…å¸‚æ­¥è¡Œç´„5åˆ†é˜</span>
               <!-- ä¿®æ”¹é€™è£¡ -->
               <span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded border border-blue-100">æˆ¿å…§æœ‰æ´—è¡£æ©Ÿ</span>
             </div>
           </div>
        </div>
        
        <div class="space-y-2">
            <div class="flex items-start gap-3 text-xs text-gray-600 bg-gray-50 p-2.5 rounded-xl border border-gray-100">
                <i class="fa-solid fa-location-dot text-red-400 mt-0.5 ml-1"></i>
                <div class="flex-1">
                    <p class="font-bold text-gray-700">å¤§é˜ªåºœå¤§é˜ªå¸‚ä¸­å¤®å€ä¹…å¤ªéƒç”º 2-4-24</p>
                    <p class="text-[10px] text-gray-400 mt-0.5">é›¢å¿ƒé½‹æ©‹å•†åº—è¡—æ­¥è¡Œç´„ 10 åˆ†é˜</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button @click="openMap('æ±æ€¥ Stay å¤§é˜ªæœ¬ç”º')" class="flex-1 bg-purple-400 text-white py-2 rounded-xl text-xs font-bold shadow-sm hover:bg-purple-500 transition-colors">
                    <i class="fa-solid fa-map-location-dot mr-1"></i>Google å°èˆª
                </button>
                 <a href="tel:+81662620109" class="flex-1 bg-white text-gray-600 border border-gray-200 py-2 rounded-xl text-xs font-bold shadow-sm hover:bg-gray-50 transition-colors flex items-center justify-center">
                    <i class="fa-solid fa-phone mr-1"></i>æ’¥æ‰“é›»è©±
                </a>
            </div>
        </div>
      </div>

      <!-- Travel Tips (Restored to Static) -->
      <div class="bg-white rounded-2xl p-5 shadow-card">
        <h3 class="font-bold text-sakura-text mb-4 border-b pb-2"><i class="fa-solid fa-triangle-exclamation mr-2 text-yellow-500"></i>æ—…éŠé ˆçŸ¥ & ç·Šæ€¥è¯çµ¡</h3>
        
        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="bg-red-50 p-3 rounded-xl border border-red-100 flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-white text-red-500 flex items-center justify-center shadow-sm font-bold text-sm"><i class="fa-solid fa-phone-volume"></i></div>
                <div><div class="text-[10px] text-gray-400">ç·Šæ€¥ (è­¦/æ¶ˆ)</div><div class="text-lg font-bold text-red-600 leading-none">110 / 119</div></div>
            </div>
            <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-white text-blue-500 flex items-center justify-center shadow-sm font-bold text-sm"><i class="fa-solid fa-passport"></i></div>
                <div><div class="text-[10px] text-gray-400">é§æ—¥ä»£è¡¨è™•</div><a href="tel:+81664438481" class="text-sm font-bold text-blue-600 leading-tight underline">06-6443-8481</a></div>
            </div>
        </div>
        
        <div class="space-y-3">
            <div class="flex gap-3 items-start">
                <i class="fa-solid fa-plug text-gray-400 mt-1 w-4 text-center"></i>
                <div>
                    <h5 class="text-xs font-bold text-gray-700">é›»å£“èˆ‡æ’åº§</h5>
                    <p class="text-[10px] text-gray-500">æ—¥æœ¬é›»å£“ç‚º 100Vï¼Œæ’åº§ç‚ºé›™å­”æ‰å‹ï¼ˆèˆ‡å°ç£ç›¸åŒï¼‰ã€‚ä¸€èˆ¬å°ç£é›»å™¨å¯ç›´æ¥ä½¿ç”¨ï¼Œç„¡éœ€è½‰æ¥é ­ã€‚</p>
                </div>
            </div>
            <div class="flex gap-3 items-start">
                <i class="fa-solid fa-clock text-gray-400 mt-1 w-4 text-center"></i>
                <div>
                    <h5 class="text-xs font-bold text-gray-700">æ™‚å·®</h5>
                    <p class="text-[10px] text-gray-500">æ—¥æœ¬æ¯”å°ç£å¿« 1 å°æ™‚ (å°ç£ 8:00 = æ—¥æœ¬ 9:00)ã€‚</p>
                </div>
            </div>
            
            <!-- å°è²»èˆ‡é€€ç¨… (Updated) -->
            <div class="flex gap-3 items-start">
                <i class="fa-solid fa-hand-holding-dollar text-gray-400 mt-1 w-4 text-center"></i>
                <div>
                    <h5 class="text-xs font-bold text-gray-700">å°è²»èˆ‡é€€ç¨…</h5>
                    <p class="text-[10px] text-gray-500">ç„¡å°è²»æ–‡åŒ–ã€‚è³¼ç‰©ç´„æ»¿ 5,000 æ—¥åœ“ï¼ˆæœªç¨…ï¼‰å¯æ†‘è­·ç…§è¾¦ç†é€€ç¨…ï¼Œå¯¦éš›ä¾åº—å®¶å…¬å‘Šç‚ºä¸»ã€‚</p>
                    <p class="text-[10px] text-red-400 mt-1 bg-red-50 p-1.5 rounded border border-red-100 leading-tight">
                        <i class="fa-solid fa-circle-exclamation mr-1"></i><b>æ³¨æ„ï¼š</b>è¾¦ç†é€€ç¨…å¾Œçš„æ¶ˆè€—å“ï¼ˆè—¥å¦ã€é£Ÿå“ç­‰ï¼‰æœƒè¢«è£å…¥ç‰¹æ®Šå°æ¢è¢‹ä¸­ï¼Œ<b>ä¸å¯åœ¨æ—¥æœ¬å¢ƒå…§æ‹†å°ä½¿ç”¨</b>ï¼Œå¦å‰‡é›¢å¢ƒæ™‚å¯èƒ½éœ€è£œç¹³ç¨…é‡‘ã€‚
                    </p>
                </div>
            </div>

            <!-- å¤©æ°£èˆ‡ç©¿æ­ (New) -->
            <div class="flex gap-3 items-start">
                <i class="fa-solid fa-temperature-half text-gray-400 mt-1 w-4 text-center"></i>
                <div>
                    <h5 class="text-xs font-bold text-gray-700">4æœˆæ°£å€™èˆ‡ç©¿æ­</h5>
                    <p class="text-[10px] text-gray-500 leading-relaxed">
                        å¤§é˜ª/äº¬éƒ½ 4 æœˆå¹³å‡æ°£æº«ç´„ <b>10Â°C ~ 20Â°C</b>ï¼Œæ°£å€™å®œäººä½†æ—©æ™šæº«å·®å¤§ã€‚
                        <br>å»ºè­°æ¡ç”¨<b>æ´‹è”¥å¼ç©¿æ³•</b>ï¼ˆè–„é•·è¢– + è–„å¤–å¥—/é‡ç¹”è¡«/é¢¨è¡£/è¼•ç¾½çµ¨ï¼‰ï¼Œä¸­åˆç†±æ™‚å¯è„«ï¼Œæ—©æ™šæ¶¼æ™‚å¯ç©¿ã€‚
                    </p>
                </div>
            </div>

            <div class="flex gap-3 items-start">
                <i class="fa-solid fa-qrcode text-gray-400 mt-1 w-4 text-center"></i>
                <div>
                    <h5 class="text-xs font-bold text-gray-700">
                        <a href="https://vjw-lp.digital.go.jp/zh-hant/" target="_blank" class="text-blue-500 hover:text-blue-700 underline decoration-blue-300 underline-offset-2">Visit Japan Web</a>
                        <i class="fa-solid fa-arrow-up-right-from-square text-[10px] ml-1 text-blue-400"></i>
                    </h5>
                    <p class="text-[10px] text-gray-500">å»ºè­°äº‹å…ˆå¡«å¯«å…¥å¢ƒå¯©æŸ¥èˆ‡æµ·é—œç”³å ±ï¼Œä¸¦æˆªåœ– QR Code ä»¥åŠ é€Ÿé€šé—œã€‚</p>
                </div>
            </div>
            <div class="flex gap-3 items-start">
                <i class="fa-regular fa-credit-card text-gray-400 mt-1 w-4 text-center"></i>
                <div>
                    <h5 class="text-xs font-bold text-gray-700">äº¤é€šå¡ (ICOCA)</h5>
                    <p class="text-[10px] text-gray-500">å¤§é˜ªèˆ‡äº¬éƒ½çš„ JRã€åœ°éµã€ç§éµåŠå·´å£«çš†é€šç”¨ã€‚é€²å‡ºç«™çš†éœ€åˆ·å¡ã€‚</p>
                </div>
            </div>
            
            <!-- Detailed Etiquette Section -->
            <div class="pt-2 mt-2 border-t border-gray-100">
                <div class="flex gap-3 items-start">
                    <i class="fa-solid fa-user-tie text-gray-400 mt-1 w-4 text-center"></i>
                    <div class="w-full">
                        <h5 class="text-xs font-bold text-gray-700 mb-2">æ—¥æœ¬æ—…éŠç¦®å„€å¤§å…¨</h5>
                        
                        <div class="space-y-2">
                            <!-- Dining -->
                            <div class="bg-orange-50/50 p-2.5 rounded-lg border border-orange-100">
                                <h6 class="text-[10px] font-bold text-orange-800 mb-1 flex items-center"><i class="fa-solid fa-utensils mr-1.5 text-orange-400"></i>ç”¨é¤ç¦®å„€</h6>
                                <ul class="text-[10px] text-gray-600 list-disc pl-3 space-y-1 leading-relaxed">
                                    <li><b>åš´ç¦é‚Šèµ°é‚Šåƒ</b>ï¼šæ—¥æœ¬è¦–ç‚ºä¸ç¦®è²Œã€‚è«‹åœ¨è³¼è²·åº—å®¶å‰å®šé»åƒå®Œï¼Œæˆ–è‡³é™„è¿‘å…¬åœ’/ä¼‘æ¯å€ã€‚</li>
                                    <li><b>ç­·å­ç¦å¿Œ</b>ï¼šä¸å¯ç”¨ç­·å­å‚³éé£Ÿç‰©ï¼ˆåƒæ’¿éª¨ï¼‰ã€ä¸å¯å°‡ç­·å­ç›´æ’åœ¨é£¯ä¸Šã€ä¸å¯ç”¨ç­·å­æŒ‡äººã€‚</li>
                                    <li><b>é¤ç›¤å›æ”¶</b>ï¼šåœ¨ç¾é£Ÿè¡—æˆ–é€Ÿé£Ÿåº—ï¼Œç”¨é¤å®Œç•¢è«‹è‡ªè¡Œåˆ†é¡å›æ”¶é¤å…·èˆ‡åƒåœ¾ã€‚</li>
                                    <li><b>ç¦å¸¶å¤–é£Ÿ</b>ï¼šå¤§å¤šæ•¸é¤å»³èˆ‡å’–å•¡å»³åš´ç¦æ”œå¸¶å¤–é£Ÿæˆ–é£²æ–™å…¥å…§é£Ÿç”¨ã€‚</li>
                                </ul>
                            </div>

                            <!-- Transport -->
                            <div class="bg-blue-50/50 p-2.5 rounded-lg border border-blue-100">
                                <h6 class="text-[10px] font-bold text-blue-800 mb-1 flex items-center"><i class="fa-solid fa-train-subway mr-1.5 text-blue-400"></i>äº¤é€šç¦®å„€</h6>
                                <ul class="text-[10px] text-gray-600 list-disc pl-3 space-y-1 leading-relaxed">
                                    <li><b>è»Šå»‚å¯§éœ</b>ï¼šæ‰‹æ©Ÿè«‹è¨­éœéŸ³ï¼ˆManner Modeï¼‰ï¼Œé¿å…é€šè©±ã€‚äº¤è«‡è«‹è¼•è²ç´°èªã€‚</li>
                                    <li><b>å¾ŒèƒŒåŒ…å‰èƒŒ</b>ï¼šå°–å³°æ™‚åˆ»æ­è»Šï¼Œè«‹å°‡å¾ŒèƒŒåŒ…æ”¹èƒŒåœ¨èƒ¸å‰ï¼Œä»¥å…æ’åˆ°ä»–äººã€‚</li>
                                    <li><b>æ‰‹æ‰¶æ¢¯ç«™æ³•</b>ï¼šå¤§é˜ªç¿’æ…£<b>é å³</b>ç«™ç«‹ï¼ˆèˆ‡å°ç£ç›¸åŒï¼‰ï¼Œä½†äº¬éƒ½èˆ‡å…¶ä»–åœ°å€å¤šç‚º<b>é å·¦</b>ã€‚å»ºè­°è§€å¯Ÿå‰æ–¹äººæµã€‚</li>
                                    <li><b>å„ªå…ˆå¸­</b>ï¼šåšæ„›åº§é™„è¿‘è«‹é—œé–‰æ‰‹æ©Ÿé›»æºï¼ˆå› å¿ƒå¾‹èª¿ç¯€å™¨å¹²æ“¾ç–‘æ…®ï¼‰ï¼Œä¸¦å„ªå…ˆç¦®è®“ã€‚</li>
                                </ul>
                            </div>

                            <!-- Shopping/General -->
                            <div class="bg-gray-50 p-2.5 rounded-lg border border-gray-200">
                                <h6 class="text-[10px] font-bold text-gray-700 mb-1 flex items-center"><i class="fa-solid fa-bag-shopping mr-1.5 text-pink-400"></i>è³¼ç‰©èˆ‡æ—¥å¸¸</h6>
                                <ul class="text-[10px] text-gray-600 list-disc pl-3 space-y-1 leading-relaxed">
                                    <li><b>ä»˜æ¬¾ç¦®å„€</b>ï¼šçµå¸³æ™‚è«‹å°‡ç¾é‡‘æˆ–ä¿¡ç”¨å¡ç½®æ–¼æ«ƒæª¯çš„<b>ã€ŒéŒ¢ç›¤ (Cash Tray)ã€</b>ä¸Šï¼Œå‹¿ç›´æ¥æ‰‹éçµ¦åº—å“¡ã€‚</li>
                                    <li><b>åƒåœ¾ä¸è½åœ°</b>ï¼šæ—¥æœ¬è¡—é ­åƒåœ¾æ¡¶æ¥µå°‘ã€‚è«‹éš¨èº«æ”œå¸¶å°å¡‘è† è¢‹ï¼Œå°‡åƒåœ¾å¸¶å›é£¯åº—æˆ–è»Šç«™ä¸Ÿæ£„ã€‚</li>
                                    <li><b>æ‹ç…§æ³¨æ„</b>ï¼šè«‹å‹¿ç›´æ¥å°è‘—é™Œç”Ÿäººã€è­¦å¯Ÿæˆ–ç¦æ­¢æ”å½±çš„åº—å®¶å•†å“è¿‘è·é›¢æ‹æ”ã€‚</li>
                                    <li><b>è©¦ç©¿ç¦®å„€</b>ï¼šè©¦ç©¿è¡£æœï¼ˆå°¤å…¶æ˜¯æ·ºè‰²ä¸Šè¡£ï¼‰æ™‚ï¼Œè«‹ä½¿ç”¨åº—å®¶æä¾›çš„ä¸ç¹”å¸ƒé ­å¥—ï¼Œä»¥å…å¦å®¹æ²¾æŸ“è¡£ç‰©ã€‚</li>
                                    <li><b>å®¤å…§è„«é‹</b>ï¼šé€²å…¥ç„é—œè‹¥æœ‰é«˜ä½å·®ï¼Œé€šå¸¸ä»£è¡¨éœ€è„«é‹ã€‚è„«ä¸‹çš„é‹å­è«‹å°‡é‹å°–æœå¤–ï¼ˆæœé–€å£ï¼‰æ“ºæ”¾æ•´é½Šã€‚</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </div>

      <!-- Packing List -->
      <div class="bg-white rounded-2xl p-5 shadow-card">
        <h3 class="font-bold text-sakura-text mb-3 border-b pb-2 flex justify-between items-center">
          <span><i class="fa-solid fa-suitcase-rolling mr-2 text-sakura"></i>è¡Œææª¢æŸ¥æ¸…å–®</span>
        </h3>

        <!-- ä¿®æ”¹ç‚º Grid ä½ˆå±€ï¼Œè¨­å®šç‚º 4 æ¬„ (æ¯æ’ 4 ä½) -->
        <div class="grid grid-cols-4 gap-2 mb-3">
          <button v-for="person in packingPeople" :key="person" @click="currentPackingFilter = person"
            :class="['w-full py-1.5 rounded-full text-xs font-bold transition-colors border', (currentPackingFilter === person) ? 'bg-sakura text-white border-sakura shadow-md' : 'bg-white text-gray-500 border-gray-200']">
            {{ person }}
          </button>
        </div>

        <div class="space-y-0.5 mb-4">
          <div v-if="filteredPackingList.length === 0" class="text-center text-gray-400 py-4 text-xs">
            <i class="fa-solid fa-clipboard-check mb-1"></i><br>ç›®å‰æ²’æœ‰é …ç›®
          </div>
          <div v-for="(item, index) in filteredPackingList" :key="item.id" class="flex items-center gap-3 py-0.5 px-2 rounded-lg transition-colors hover:bg-gray-50 group border border-transparent hover:border-gray-100">
            <label class="flex items-center gap-3 flex-1 cursor-pointer">
              <div class="relative flex items-center justify-center">
                <input type="checkbox" :checked="item.checked" @change="togglePackingCheck(item)" class="peer appearance-none w-5 h-5 border-2 border-gray-300 rounded-md checked:bg-sakura checked:border-sakura transition-colors">
                <i class="fa-solid fa-check text-white text-xs absolute opacity-0 peer-checked:opacity-100 pointer-events-none transition-opacity"></i>
              </div>
              <span :class="{'line-through text-gray-400': item.checked, 'text-gray-600': !item.checked}" class="text-sm font-medium transition-colors select-none">
                {{ item.text }}
              </span>
            </label>
            <button @click="deletePackingItem(item.id)" class="text-gray-300 hover:text-red-400 p-1 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-xmark"></i></button>
          </div>
        </div>

        <div class="flex gap-2 mb-2">
          <input type="text" v-model="newPackingItem" placeholder="æ–°å¢æª¢æŸ¥é …ç›®..." class="flex-1 bg-gray-50 rounded-lg px-3 py-2 text-sm outline-none border focus:border-sakura" @keyup.enter="addPackingItem">
          <button @click="addPackingItem" class="bg-sakura text-white px-3 py-2 rounded-lg text-sm font-bold shadow-sm active:scale-95 transition-transform"><i class="fa-solid fa-plus"></i></button>
        </div>
        
        <button v-if="filteredPackingList.length === 0 && currentPackingFilter" @click="checkAndMigrateData(true, currentPackingFilter)" class="w-full py-2 bg-gray-100 text-gray-500 rounded-lg text-xs font-bold hover:bg-gray-200 transition-colors dashed border border-gray-300">
            <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> å¹« {{ currentPackingFilter }} è£œé½Šé è¨­é …ç›®
        </button>
      </div>

      <!-- Osaka Metro Map (Removed) -->

    </div>

    <!-- TAB 3: Shopping -->
    <div v-if="currentTab === 'shopping'">
      <div class="flex flex-wrap gap-2 mb-4 px-1 justify-center">
        <!-- é»æ“ŠæŒ‰éˆ•æ™‚è¨­å®š filterï¼Œé€™æœƒè§£é™¤éš±ç§é®ç½© -->
        <button v-for="traveler in shoppingTravelers" :key="traveler" @click="currentShoppingFilter = traveler"
          :class="['px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-colors border', (currentShoppingFilter === traveler) ? 'bg-sakura text-white border-sakura shadow-md' : 'bg-white text-gray-500 border-gray-200']">
          {{ traveler }}
        </button>
      </div>

      <div class="bg-pink-50 text-pink-700 text-xs px-4 py-2 rounded-xl mb-4 flex items-center border border-pink-100 mx-2 shadow-sm animate-pulse">
        <i class="fa-solid fa-wallet mr-2 text-pink-500"></i>
        æº«é¦¨æé†’ï¼šæ—¥æœ¬æ˜¯å…ç¨…ä¸æ˜¯å…è²»~ è«‹ç†æ€§è³¼ç‰©ğŸ˜†
      </div>

      <!-- éš±ç§é®ç½© (ç•¶æ²’æœ‰é¸æ“‡æˆå“¡æ™‚é¡¯ç¤º) -->
      <div v-if="!currentShoppingFilter" class="flex flex-col items-center justify-center py-20 text-gray-300 animate-fade-in">
          <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4 shadow-inner">
              <i class="fa-solid fa-bag-shopping text-3xl text-gray-300"></i>
          </div>
          <p class="text-sm font-bold text-gray-400">è³¼ç‰©æ¸…å–®å·²éš±è—</p>
          <p class="text-xs mt-1">ğŸ‘† è«‹é»æ“Šä¸Šæ–¹æˆå“¡åå­—ä»¥æŸ¥çœ‹å…§å®¹</p>
      </div>

      <!-- åˆ—è¡¨å…§å®¹ (åªæœ‰ç•¶æœ‰é¸æ“‡æˆå“¡æ™‚æ‰é¡¯ç¤º) -->
      <div v-else class="grid grid-cols-2 gap-4 pb-24 animate-slide-up">
        <div v-for="(item, index) in filteredShoppingList" :key="item.id" class="bg-white rounded-2xl overflow-hidden shadow-card relative group">
          <div class="h-32 bg-gray-100 relative overflow-hidden">
            <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
            <div v-else class="w-full h-full flex items-center justify-center text-gray-300"><i class="fa-solid fa-image text-3xl"></i></div>
            <div class="absolute top-1 right-1 flex gap-1">
              <button @click="openModal('shopping', item)" class="bg-white/80 w-6 h-6 rounded-full text-gray-500 text-xs flex items-center justify-center shadow-sm hover:text-sakura-dark"><i class="fa-solid fa-pen"></i></button>
            </div>
            <span class="absolute bottom-1 left-1 bg-black/50 text-white text-[10px] px-2 py-0.5 rounded-full backdrop-blur-sm">{{ item.owner || 'æœªæŒ‡å®š' }}</span>
          </div>
          <div class="p-3">
            <h4 class="font-bold text-gray-700 text-sm truncate">{{ item.name }}</h4>
            <div class="flex items-center gap-1 mt-2 justify-between">
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="checkbox" :checked="item.bought" @change="toggleShoppingCheck(item)" class="accent-sakura w-4 h-4 rounded-full">
                    <span class="text-xs text-gray-500" :class="{'line-through': item.bought}">å·²è³¼è²·</span>
                </label>
                <button @click="deleteShoppingItem(item.id)" class="text-gray-300 hover:text-red-400 text-xs p-1"><i class="fa-solid fa-trash-can"></i></button>
            </div>
          </div>
        </div>
        <!-- å³ä½¿é¸äº†äººä½†æ¸…å–®æ˜¯ç©ºçš„ -->
        <div v-if="filteredShoppingList.length === 0" class="col-span-2 text-center py-10 text-gray-400">
            <i class="fa-regular fa-folder-open text-2xl mb-2"></i>
            <p class="text-xs">å°šç„¡è³¼ç‰©é …ç›®</p>
        </div>
      </div>
      
      <!-- æ–°å¢æŒ‰éˆ•æ”¹ç‚ºæ‰“é–‹ Modal æ™‚é è¨­ç‚ºç•¶å‰é¸æ“‡çš„äºº (å¦‚æœå·²é¸) -->
      <button @click="openModal('shopping')" class="fixed bottom-24 right-6 w-14 h-14 bg-sakura text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-sakura-dark transition-colors z-20"><i class="fa-solid fa-plus"></i></button>
    </div>

    <!-- TAB 4: Expense -->
    <div v-if="currentTab === 'expense'">
      <div class="flex flex-wrap gap-2 mb-4 px-1 justify-center">
        <!-- ä¿®æ”¹ "å…¨éƒ¨" æŒ‰éˆ•çš„é‚è¼¯ï¼Œè³¦äºˆç‰¹æ®Šå€¼ 'ALL' -->
        <button @click="currentMemberFilter = 'ALL'" :class="['px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-colors border', (currentMemberFilter === 'ALL') ? 'bg-sakura text-white border-sakura shadow-md' : 'bg-white text-gray-500 border-gray-200']">å…¨éƒ¨</button>
        <button v-for="traveler in travelers" :key="traveler" @click="currentMemberFilter = traveler"
          :class="['px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-colors border', (currentMemberFilter === traveler) ? 'bg-sakura text-white border-sakura shadow-md' : 'bg-white text-gray-500 border-gray-200']">
          {{ traveler }}
        </button>
      </div>

      <!-- éš±ç§é®ç½© (ç•¶æ²’æœ‰é¸æ“‡æˆå“¡æ™‚é¡¯ç¤º) -->
      <div v-if="!currentMemberFilter" class="flex flex-col items-center justify-center py-20 text-gray-300 animate-fade-in">
          <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4 shadow-inner">
              <i class="fa-solid fa-user-shield text-3xl text-gray-300"></i>
          </div>
          <p class="text-sm font-bold text-gray-400">èŠ±è²»ç´€éŒ„ä¿è­·ä¸­</p>
          <p class="text-xs mt-1">ğŸ‘† è«‹é»æ“Šä¸Šæ–¹æˆå“¡åå­—ä»¥æŸ¥çœ‹è©³æƒ…</p>
      </div>

      <!-- å…§å®¹å€å¡Š (åªæœ‰ç•¶æœ‰é¸æ“‡æˆå“¡æ™‚æ‰é¡¯ç¤º) -->
      <div v-else class="animate-slide-up">
          <div class="bg-gradient-to-r from-sakura to-sakura-dark rounded-2xl p-6 text-white shadow-soft mb-6 text-center transition-all duration-300">
            <p class="text-sm opacity-90 mb-1 flex items-center justify-center gap-2">
                <i class="fa-solid fa-user-tag text-xs"></i>
                {{ currentMemberFilter === 'ALL' ? 'ç›®å‰ç¸½' : currentMemberFilter + ' çš„' }}èŠ±è²» (JPY)
            </p>
            <h2 class="text-4xl font-bold font-mono">Â¥ {{ filteredTotalExpense.toLocaleString() }}</h2>
            <p class="text-xs opacity-70 mt-2">ç´„ TWD {{ (filteredTotalExpense * currentRate).toLocaleString(undefined, {maximumFractionDigits: 0}) }}</p>
          </div>

          <div class="bg-white rounded-t-2xl shadow-card min-h-[300px] pb-24">
            <div v-for="(item, index) in filteredExpenses" :key="item.id" class="p-4 border-b border-gray-50 flex justify-between items-center" @click="openModal('expense', item)">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-lg shadow-sm">
                  <i :class="getExpenseIcon(item.category)" class="text-sakura-dark"></i>
                </div>
                <div>
                  <h4 class="font-bold text-gray-800">{{ item.name }}</h4>
                  <p class="text-xs text-gray-400">{{ item.date }} Â· {{ item.owner || 'æœªæŒ‡å®š' }}</p>
                </div>
              </div>
              <div class="text-right">
                <p class="font-bold text-gray-800 font-mono">Â¥{{ Number(item.amount).toLocaleString() }}</p>
              </div>
            </div>
            <div v-if="filteredExpenses.length === 0" class="text-center py-8 text-gray-400 text-sm">æ­¤åˆ†é¡ä¸‹ç„¡ç´€éŒ„</div>
          </div>
      </div>
      
      <button @click="openModal('expense')" class="fixed bottom-24 right-6 w-14 h-14 bg-sakura text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-sakura-dark transition-colors z-20"><i class="fa-solid fa-plus"></i></button>
    </div>

    <!-- TAB 5: Notebook -->
    <div v-if="currentTab === 'notebook'">
      <div class="flex flex-wrap gap-2 mb-4 px-1 justify-center">
        <button v-for="traveler in notebookOwners" :key="traveler" @click="currentNotebookFilter = traveler"
          :class="['px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-colors border', (currentNotebookFilter === traveler) ? 'bg-sakura text-white border-sakura shadow-md' : 'bg-white text-gray-500 border-gray-200']">
          {{ traveler }}
        </button>
      </div>

      <!-- éš±ç§é®ç½© (ç•¶æ²’æœ‰é¸æ“‡æˆå“¡æ™‚é¡¯ç¤º) -->
      <div v-if="!currentNotebookFilter" class="flex flex-col items-center justify-center py-20 text-gray-300 animate-fade-in">
          <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4 shadow-inner">
              <i class="fa-solid fa-book-open text-3xl text-gray-300"></i>
          </div>
          <p class="text-sm font-bold text-gray-400">ç­†è¨˜æœ¬å…§å®¹å·²éš±è—</p>
          <p class="text-xs mt-1">ğŸ‘† è«‹é»æ“Šä¸Šæ–¹æˆå“¡åå­—ä»¥æŸ¥çœ‹å…§å®¹</p>
      </div>

      <!-- ç­†è¨˜åˆ—è¡¨ (åªæœ‰ç•¶æœ‰é¸æ“‡æˆå“¡æ™‚æ‰é¡¯ç¤º) -->
      <div v-else class="grid gap-3 pb-24 animate-slide-up">
        <div v-if="filteredNotebookList.length === 0" class="text-center py-10 text-gray-400">
          <i class="fa-solid fa-book-open text-4xl mb-3 opacity-50"></i><p>é€™è£¡ç©ºç©ºçš„ï¼Œè¨˜é»ä»€éº¼å§ï¼</p>
        </div>
        <div v-for="note in filteredNotebookList" :key="note.id" class="bg-white p-4 rounded-2xl shadow-card relative group border-l-4 border-sakura-light">
          <h4 class="font-bold text-gray-800 mb-1">{{ note.title }}</h4>
          <p class="text-sm text-gray-600 whitespace-pre-line leading-relaxed">{{ note.content }}</p>
          <div class="mt-3 flex justify-between items-end border-t border-gray-50 pt-2">
            <span class="text-[10px] text-gray-400">{{ note.owner }}</span>
            <div class="flex gap-3">
                <button @click="openModal('notebook', note)" class="text-xs text-gray-400 hover:text-sakura-dark font-bold"><i class="fa-solid fa-pen mr-1"></i>ç·¨è¼¯</button>
                <button @click="deleteNote(note.id)" class="text-xs text-red-300 hover:text-red-500 font-bold"><i class="fa-solid fa-trash-can mr-1"></i>åˆªé™¤</button>
            </div>
          </div>
        </div>
      </div>
      
      <button @click="openModal('notebook')" class="fixed bottom-24 right-6 w-14 h-14 bg-sakura text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-sakura-dark transition-colors z-20"><i class="fa-solid fa-plus"></i></button>
    </div>

  </main>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 flex justify-around items-center h-20 px-2 pb-2 rounded-t-[20px] shadow-[0_-5px_20px_rgba(0,0,0,0.03)] z-40 max-w-[480px] mx-auto">
    <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" class="flex flex-col items-center justify-center w-16 h-16 transition-all">
      <div class="w-10 h-6 flex items-center justify-center rounded-full mb-1 transition-all" :class="currentTab === tab.id ? 'bg-sakura-light text-sakura-dark' : 'text-gray-400'">
        <i :class="tab.icon" class="text-lg"></i>
      </div>
      <span class="text-[10px] font-bold transition-all" :class="currentTab === tab.id ? 'text-sakura-text' : 'text-gray-400'">{{ tab.name }}</span>
    </button>
  </nav>

  <!-- Input Modal -->
  <div v-if="modal.show" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center animate-fade-in">
    <div class="bg-white w-full max-w-[480px] rounded-t-[20px] sm:rounded-2xl p-6 shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-sakura-text">{{ modal.title }}</h3>
        <button @click="closeModal" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>

      <!-- Dynamic Fields -->
      <div class="space-y-4">
        <template v-if="modal.type === 'itinerary'">
             <div class="text-gray-500 text-center py-10">æ­¤è¡Œç¨‹ç‚ºå”¯è®€æ¨¡å¼</div>
        </template>

        <template v-if="modal.type === 'shopping'">
            <div><label class="block text-xs font-medium text-gray-500 mb-1">èª°è¦è²·</label><select v-model="formData.owner" class="w-full bg-blue-50 rounded-xl p-3 font-bold text-blue-800"><option v-for="t in shoppingTravelers.filter(x=>x!=='å…¨éƒ¨')" :value="t">{{t}}</option></select></div>
            <div><label class="block text-xs font-medium text-gray-500 mb-1">å•†å“åç¨±</label><input type="text" v-model="formData.name" class="w-full bg-gray-50 rounded-xl p-3 border focus:border-sakura outline-none"></div>
            <div>
                 <label class="block text-xs font-medium text-gray-500 mb-1">åœ–ç‰‡</label>
                 <div class="relative w-full h-32 bg-gray-100 rounded-xl flex items-center justify-center border-2 border-dashed border-gray-300 overflow-hidden">
                    <input type="file" @change="handleImageUpload" class="absolute inset-0 opacity-0 cursor-pointer">
                    <img v-if="formData.image" :src="formData.image" class="w-full h-full object-cover">
                    <div v-else class="text-center text-gray-400"><i class="fa-solid fa-camera mb-1"></i><p class="text-xs">é»æ“Šä¸Šå‚³åœ–ç‰‡</p></div>
                 </div>
            </div>
        </template>
        
        <template v-if="modal.type === 'expense'">
            <div><label class="block text-xs font-medium text-gray-500 mb-1">èª°ä»˜éŒ¢</label><select v-model="formData.owner" class="w-full bg-gray-50 rounded-xl p-3"><option v-for="t in travelers" :value="t">{{t}}</option></select></div>
            <div><label class="block text-xs font-medium text-gray-500 mb-1">æ—¥æœŸ</label><select v-model="formData.date" class="w-full bg-gray-50 rounded-xl p-3"><option v-for="d in days" :value="d.dateStr">{{d.displayDate}}</option></select></div>
            <div><label class="block text-xs font-medium text-gray-500 mb-1">é¡åˆ¥</label>
                <select v-model="formData.category" class="w-full bg-gray-50 rounded-xl p-3">
                    <option value="food">é£²é£Ÿ</option><option value="transport">äº¤é€š</option><option value="shopping">è³¼ç‰©</option><option value="ticket">é–€ç¥¨</option><option value="accommodation">ä½å®¿</option><option value="other">å…¶ä»–</option>
                </select>
            </div>
            <div><label class="block text-xs font-medium text-gray-500 mb-1">é …ç›®</label><input type="text" v-model="formData.name" class="w-full bg-gray-50 rounded-xl p-3 border focus:border-sakura outline-none"></div>
            <div><label class="block text-xs font-medium text-gray-500 mb-1">é‡‘é¡ (JPY)</label><input type="number" v-model="formData.amount" class="w-full bg-gray-50 rounded-xl p-3 text-xl font-mono border focus:border-sakura outline-none"></div>
        </template>

        <template v-if="modal.type === 'notebook'">
            <div><label class="block text-xs font-medium text-gray-500 mb-1">è¨˜éŒ„äºº</label><select v-model="formData.owner" class="w-full bg-gray-50 rounded-xl p-3"><option v-for="t in travelers" :value="t">{{t}}</option></select></div>
            <div><label class="block text-xs font-medium text-gray-500 mb-1">æ¨™é¡Œ</label><input type="text" v-model="formData.title" class="w-full bg-gray-50 rounded-xl p-3 border focus:border-sakura outline-none"></div>
            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">å…§å®¹</label>
                <textarea v-model="formData.content" placeholder="è«‹è¼¸å…¥å…§å®¹..." class="w-full bg-gray-50 rounded-xl p-3 h-32 border focus:border-sakura outline-none"></textarea>
            </div>
        </template>
      </div>

      <div class="mt-6 flex gap-3" v-if="modal.type !== 'itinerary'">
        <button v-if="modal.isEdit" @click="deleteCurrentItem" class="flex-1 bg-red-50 text-red-500 font-bold py-3 rounded-xl hover:bg-red-100 transition-colors">åˆªé™¤</button>
        <button @click="submitForm" class="flex-[2] bg-sakura text-white font-bold py-3 rounded-xl shadow-soft hover:bg-sakura-dark transition-colors flex items-center justify-center">
            <i v-if="isSaving" class="fa-solid fa-spinner fa-spin mr-2"></i>
            {{ isSaving ? 'å„²å­˜ä¸­...' : (modal.isEdit ? 'å„²å­˜è®Šæ›´' : 'æ–°å¢') }}
        </button>
      </div>
    </div>
  </div>
  
  <!-- Confirm Modal -->
  <div v-if="confirmState.show" class="fixed inset-0 z-[60] flex items-center justify-center px-4 bg-black/20 backdrop-blur-sm animate-fade-in">
    <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl transform transition-all scale-100 glass-modal border border-white/50">
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-sakura-light mb-4">
          <i class="fa-solid fa-question text-sakura text-xl"></i>
        </div>
        <h3 class="text-lg font-bold text-gray-900 mb-2">è«‹ç¢ºèª</h3>
        <p class="text-sm text-gray-500 mb-6 whitespace-pre-line">{{ confirmState.message }}</p>
      </div>
      <div class="flex gap-3">
        <button type="button" class="flex-1 rounded-xl border border-gray-300 bg-white px-4 py-2 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none" @click="handleConfirm(false)">
          å–æ¶ˆ
        </button>
        <button type="button" class="flex-1 rounded-xl bg-sakura px-4 py-2 text-sm font-bold text-white shadow-sm hover:bg-sakura-dark focus:outline-none" @click="handleConfirm(true)">
          ç¢ºå®š
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div v-if="toastState.show" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-[70] animate-fade-in">
    <div class="bg-gray-800/90 text-white px-6 py-3 rounded-full shadow-xl backdrop-blur-md flex items-center gap-3 border border-white/10">
      <i class="fa-solid fa-circle-info text-sakura"></i>
      <span class="text-sm font-bold">{{ toastState.message }}</span>
    </div>
  </div>

</div>

<!-- FULL DATA SEEDING -->
<script>
window.__FULL_ITINERARY_DATA__ = [
  { id: 0, date: '2026-04-02', category: 'other', name: 'é«˜é›„å°æ¸¯æ©Ÿå ´é›†åˆ', time: '04:30', travelTime: 0, transportType: 'walk', note: 'åœ‹éš›èˆªå»ˆå‡ºå¢ƒå¤§å»³', description: 'æº–å‚™å•Ÿç¨‹å‡ºç™¼å›‰ï¼ğŸ‰ è«‹å‹™å¿…æ–¼04:30æº–æ™‚é›†åˆï¼Œè¾¦ç†ç™»æ©Ÿæ‰‹çºŒã€‚è¨˜å¾—å†æ¬¡æª¢æŸ¥è­·ç…§èˆ‡å¿…å‚™è­‰ä»¶ï¼' },
  { id: 1, date: '2026-04-02', category: 'flight', name: 'èˆªç­ IT-284 KHH->KIX', time: '07:00', travelTime: 0, transportType: 'flight', note: 'èµ·é£› 07:00 / æŠµé” 10:55 (é è¨ˆå‡ºé—œ 11:30)' },
  
  // Day 1
  { id: 2, date: '2026-04-02', category: 'transport', name: 'é—œè¥¿æ©Ÿå ´ â†’ é›£æ³¢', time: '11:40', travelTime: 45, transportType: 'transit', note: 'å·²äº‹å…ˆè³¼ç¥¨ï¼ŒæŠµé”æ©Ÿå ´å¾Œæ©Ÿå°åŠƒä½å³å¯', description: 'ğŸš‰ è·¯ç·šï¼šå—æµ·é›»éµ - ç©ºæ¸¯æ€¥è¡Œ (Nankai Airport Exp.)\nğŸ“ å€é–“ï¼šé—œè¥¿æ©Ÿå ´ç«™ (Kansai Airport) â†’ å—æµ·é›£æ³¢ç«™ (Namba)\nğŸ’¡ æç¤ºï¼šå‡ºç«™å¾Œä¾æŒ‡ç¤ºå‰å¾€åœ°éµå¾¡å ‚ç­‹ç·šã€‚' },
  { id: 3, date: '2026-04-02', category: 'transport', name: 'é›£æ³¢ â†’ æœ¬ç”º (é£¯åº—)', time: '12:40', travelTime: 15, transportType: 'transit', note: 'è½‰ä¹˜å¾¡å ‚ç­‹ç·š (ç´…ç·š)', description: 'ğŸš‰ è·¯ç·šï¼šåœ°éµå¾¡å ‚ç­‹ç·š\nğŸ“ å€é–“ï¼šé›£æ³¢ç«™ (M20) â†’ æœ¬ç”ºç«™ (M18)\nğŸš¶ æ­¥è¡Œï¼šç”± 11 è™Ÿæˆ– 12 è™Ÿå‡ºå£å‡ºç«™ï¼Œæ­¥è¡Œç´„ 3-5 åˆ†é˜æŠµé”é£¯åº—ã€‚' },
  { id: 4, date: '2026-04-02', category: 'accommodation', name: 'æ±æ€¥ Stay å¤§é˜ªæœ¬ç”º', time: '13:00', travelTime: 0, transportType: 'walk', note: 'å…ˆå¯„æ”¾è¡Œæ', description: 'å…ˆåœ¨å¤§å»³å¯„æ”¾è¡Œæï¼Œè¼•è£å‡ºç™¼ï¼' },
  { id: 41, date: '2026-04-02', category: 'transport', name: 'æœ¬ç”º â†’ æ—¥æœ¬æ©‹ (é»‘é–€å¸‚å ´)', time: '13:15', travelTime: 15, transportType: 'transit', note: 'åœ°éµæˆ–è¨ˆç¨‹è»Š', description: 'ğŸš‰ è·¯ç·šï¼šåœ°éµå ºç­‹ç·š (Sakaisuji Line)\nğŸ“ å€é–“ï¼šå ºç­‹æœ¬ç”ºç«™ (K15) â†’ æ—¥æœ¬æ©‹ç«™ (K17)\nğŸš¶ æ­¥è¡Œï¼š10è™Ÿå‡ºå£å‡ºç«™ï¼Œæ­¥è¡Œå³é”é»‘é–€å¸‚å ´ã€‚' },
  { id: 42, date: '2026-04-02', category: 'food', name: 'åˆé¤ï¼šé»‘é–€å¸‚å ´', time: '13:30', travelTime: 0, transportType: 'walk', note: 'å¤§é˜ªçš„å»šæˆ¿', openHours: '09:00 - 18:00', description: 'å¤§å•–æµ·é®®ã€å’Œç‰›ã€é—œæ±ç…®ï¼æ¨è–¦å˜—è©¦ç¾çƒ¤æ‰‡è²ã€é®ªé­šç”Ÿé­šç‰‡ã€è±†æ¼¿æ¿ƒéƒçš„è±†ä¹³ã€‚è«‹åœ¨åº—å®¶æŒ‡å®šçš„å…§ç”¨å€æˆ–ç«‹é£Ÿå€äº«ç”¨ï¼Œè«‹å‹¿é‚Šèµ°é‚Šåƒã€‚' },
  { id: 43, date: '2026-04-02', category: 'transport', name: 'æ—¥æœ¬æ©‹ â†’ å¤§é˜ªåŸå…¬åœ’ ', time: '15:00', travelTime: 30, transportType: 'transit', note: 'å ºç­‹ç·šè½‰ä¸­å¤®ç·š', description: 'ğŸ“ è½‰ä¹˜è·¯å¾‘ï¼š\n1. æ—¥æœ¬æ©‹ç«™ (K17) æ­ä¹˜ å ºç­‹ç·š (å¾€åŒ—) â†’ å ºç­‹æœ¬ç”ºç«™ (K15)\n2. è½‰ä¹˜ ä¸­å¤®ç·š (å¾€é•·ç”°æ–¹å‘) â†’ æ£®ä¹‹å®®ç«™ (C19)\n3. 3-Bå‡ºå£å‡ºç«™å³ç‚ºå¤§é˜ªåŸå…¬åœ’å…¥å£ï¼ˆå™´æ°´æ± å€ï¼‰ï¼Œå¯æ…¢æ…¢æ•£æ­¥è‡³å¤©å®ˆé–£ã€‚' },
  { id: 6, date: '2026-04-02', category: 'attraction', name: 'å¤§é˜ªåŸå…¬åœ’ & å¤©å®ˆé–£', time: '15:30', travelTime: 0, transportType: 'walk', note: 'ğŸŒ¸ æ«»èŠ±ç™¾é¸åæ‰€', openHours: '09:00 - 17:00 (æœ€å¾Œå…¥å ´ 16:30)', ticket: 'å¤©å®ˆé–£ Â¥600', description: 'å¤§é˜ªçš„åœ°æ¨™ï¼Œåœ’å…§ç¨®æ¤ç´„3000æ ªæ«»èŠ±ã€‚æ¨è–¦å‰å¾€ã€Œè¥¿ä¹‹ä¸¸åº­åœ’ã€è³æ«»ï¼Œé€™è£¡ä»¥æŸ“äº•å‰é‡æ«»ç‚ºä¸»ï¼Œèƒ½æ‹åˆ°å¤©å®ˆé–£èˆ‡æ«»èŠ±åŒæ¡†çš„çµ•ç¾ç•«é¢ã€‚å¤©å®ˆé–£å…§å±•ç¤ºè±è‡£ç§€å‰çš„æ­·å²æ–‡ç‰©ï¼Œ8æ¨“å±•æœ›å°å¯ä¿¯ç°å¤§é˜ªå¸‚æ™¯ã€‚' },
  { id: 7, date: '2026-04-02', category: 'transport', name: 'å¤§é˜ªåŸ â†’ é£¯åº—', time: '17:30', travelTime: 20, transportType: 'transit', note: 'å›é£¯åº—è¾¦ç†å…¥ä½', description: 'ğŸš‰ è·¯ç·šï¼šåœ°éµä¸­å¤®ç·š\nğŸ“ å€é–“ï¼šæ£®ä¹‹å®®ç«™ (C19) / è°·ç”ºå››ä¸ç›® (C18) â†’ å ºç­‹æœ¬ç”ºç«™ (C17)\nğŸš¶ æ­¥è¡Œï¼šç”± 11 è™Ÿå‡ºå£å‡ºç«™ï¼Œæ­¥è¡Œç´„ 1-2 åˆ†é˜æŠµé”é£¯åº—ã€‚' },
  { id: 8, date: '2026-04-02', category: 'accommodation', name: 'é£¯åº— Check-in & ä¼‘æ¯', time: '18:00', travelTime: 0, transportType: 'walk', note: 'ç¨ä½œæ•´ç†èˆ‡ä¼‘æ¯', description: 'è¾¦ç†å…¥ä½æ‰‹çºŒï¼Œé€²æˆ¿æ•´ç†ä¸€ä¸‹è¡Œæï¼Œä¼‘æ¯ç‰‡åˆ»ï¼Œæº–å‚™æ™šä¸Šå»é€›è¡—ï¼' },
  { id: 9, date: '2026-04-02', category: 'transport', name: 'é£¯åº— â†’ å¿ƒé½‹æ©‹', time: '18:45', travelTime: 15, transportType: 'walk', note: 'æ­¥è¡Œæˆ–æ­åœ°éµä¸€ç«™', description: 'ğŸš‰ è·¯ç·šï¼šæ­¥è¡Œ æˆ– åœ°éµå¾¡å ‚ç­‹ç·š\nğŸ“ å€é–“ï¼šæœ¬ç”ºç«™ (M18) â†’ å¿ƒé½‹æ©‹ç«™ (M19)\nğŸš¶ æ­¥è¡Œï¼šäº¦å¯ç›´æ¥æ²¿è‘—å¿ƒé½‹æ©‹å•†åº—è¡—æ­¥è¡Œç´„ 10-15 åˆ†é˜ã€‚' },
  { id: 10, date: '2026-04-02', category: 'shopping', name: 'å¿ƒé½‹æ©‹ & é“é “å € æ™šé¤', time: '19:00', travelTime: 0, transportType: 'walk', note: 'é€›è¡—ã€åƒæ™šé¤ã€è·‘è·‘äººçœ‹æ¿', openHours: 'ä¾åº—å®¶ (ç´„è‡³ 20:00/21:00)', description: 'å¤§é˜ªæœ€ç†±é¬§çš„è³¼ç‰©å€ã€‚å¿ƒé½‹æ©‹æœ‰å¤§ä¸¸ç™¾è²¨ã€Uniqloæ——è‰¦åº—ã€è—¥å¦åº—ã€‚æ™šé¤å»ºè­°åˆ°é“é “å €å“åšç« é­šç‡’ã€æ‹‰éºµ (ä¸€è˜­/é‡‘é¾) æˆ–å¤§é˜ªç‡’ã€‚åˆ¥å¿˜äº†åœ¨æˆæ©‹è·Ÿå›ºåŠ›æœè·‘è·‘äººåˆç…§ï¼' },
  { id: 11, date: '2026-04-02', category: 'transport', name: 'å¿ƒé½‹æ©‹ â†’ é£¯åº—', time: '21:30', travelTime: 15, transportType: 'walk', note: 'æ­¥è¡Œæˆ–æ­åœ°éµ', description: 'åƒé£½å–è¶³å¾Œï¼Œæ•£æ­¥å›é£¯åº—æ¶ˆåŒ–ä¸€ä¸‹ï¼ŒçµæŸç¬¬ä¸€å¤©çš„è¡Œç¨‹ã€‚' },

  // Day 2 (Kyoto)
  { id: 301, date: '2026-04-03', category: 'transport', name: 'é£¯åº— â†’ äº¬éƒ½è»Šç«™', time: '08:00', travelTime: 50, transportType: 'transit', note: 'åœ°éµè½‰ JR (ç¶“æ–°å¤§é˜ª)', description: 'ğŸ“ è½‰ä¹˜è·¯å¾‘ï¼š\n1. æœ¬ç”ºç«™ (M18) â†’ æ–°å¤§é˜ªç«™ (M13) (åœ°éµå¾¡å ‚ç­‹ç·š)\n2. JR æ–°å¤§é˜ªç«™ â†’ JR äº¬éƒ½ç«™ (JRäº¬éƒ½ç·š - æ–°å¿«é€Ÿ)\nğŸ’¡ æç¤ºï¼šåœ¨æ–°å¤§é˜ªè½‰ä¹˜æ¯”åœ¨æ¢…ç”°ç°¡å–®ï¼Œæ­ä¹˜ã€Œæ–°å¿«é€Ÿã€åˆ—è»Šç´„ 25 åˆ†é˜æŠµé”äº¬éƒ½ã€‚' },
  { id: 302, date: '2026-04-03', category: 'transport', name: 'äº¬éƒ½è»Šç«™ â†’ æ¸…æ°´å¯º', time: '09:00', travelTime: 30, transportType: 'transit', note: 'è½‰ä¹˜äº¬éƒ½å¸‚å·´å£«', description: 'ğŸš‰ è·¯ç·šï¼šäº¬éƒ½å¸‚å·´å£« (206è™Ÿ / 100è™Ÿ)\nğŸ“ å€é–“ï¼šäº¬éƒ½è»Šç«™å‰å·´å£«ç¸½ç«™ (D1/D2) â†’ äº”æ¢å‚æˆ–æ¸…æ°´é“\nğŸš¶ æ­¥è¡Œï¼šä¸‹è»Šå¾Œæ­¥è¡Œä¸Šå¡ç´„ 10-15 åˆ†é˜æŠµé”ä»ç‹é–€ã€‚' },
  { id: 303, date: '2026-04-03', category: 'attraction', name: 'æ¸…æ°´å¯º', time: '09:40', travelTime: 15, transportType: 'walk', note: 'æ¸…æ°´èˆå°ã€éŸ³ç¾½ç€‘å¸ƒ', ticket: 'Â¥500', openHours: '06:00 - 18:00', description: 'äº¬éƒ½æœ€è‘—åçš„å¤è€å¯ºé™¢ï¼Œå¿…çœ‹æ‡¸ç©ºçš„ã€Œæ¸…æ°´èˆå°ã€ã€‚åƒæ‹œå¾Œå¯å»ã€Œåœ°ä¸»ç¥ç¤¾ã€æ±‚å§»ç·£ (è‹¥æ•´ä¿®ä¸­å‰‡ç•¥é)ï¼Œæœ€å¾Œåˆ¥å¿˜äº†åœ¨ã€ŒéŸ³ç¾½ç€‘å¸ƒã€æ’éšŠå–æ°´ç¥ˆç¦ï¼ˆåˆ†åˆ¥ä»£è¡¨å­¸æ¥­ã€æˆ€æ„›ã€é•·å£½ï¼Œåªèƒ½é¸ä¸€é“å–å–”ï¼‰ã€‚' },
  { id: 304, date: '2026-04-03', category: 'attraction', name: 'æ•£æ­¥ï¼šäºŒä¸‰å¹´å‚ & å¯§å¯§ä¹‹é“', time: '11:30', travelTime: 0, transportType: 'walk', note: 'å¤è‰²å¤é¦™è€è¡—', description: 'é †è‘—æ¸…æ°´å¯ºèµ°ä¸‹ä¾†ï¼Œæœƒç¶“éä¸‰å¹´å‚ï¼ˆç”¢å¯§å‚ï¼‰å’ŒäºŒå¹´å‚ã€‚é€™è£¡æœ‰éå¸¸å¤šæ—¥å¼é›œè²¨èˆ‡é»å¿ƒåº—ã€‚é€”ä¸­æ¨è–¦å»ã€Œæ˜Ÿå·´å…‹äº¬éƒ½äºŒå¯§å‚é›…ç¥¥èŒ¶å±‹åº—ã€æ‹ç…§ï¼Œé€™æ˜¯å…¨çƒå”¯ä¸€è¨­åœ¨ç™¾å¹´ç”ºå®¶è£¡çš„æ¦»æ¦»ç±³æ˜Ÿå·´å…‹ã€‚æ¥è‘—å‰å¾€é«˜å°å¯ºæ—çš„å¯§å¯§ä¹‹é“ã€‚' },
  { id: 305, date: '2026-04-03', category: 'attraction', name: 'å…«å‚ç¥ç¤¾ã€ç¥‡åœ’ & èŠ±è¦‹å°è·¯', time: '13:00', travelTime: 15, transportType: 'walk', note: 'è—å¦“èˆ‡èŒ¶å±‹æ–‡åŒ–', description: 'æ²¿è‘—å¯§å¯§ä¹‹é“èµ°åˆ°å…«å‚ç¥ç¤¾ï¼Œå†å‰å¾€ç¥‡åœ’å€åŸŸã€‚èŠ±è¦‹å°è·¯å…©æ—æ˜¯ä¿å­˜è‰¯å¥½çš„å‚³çµ±èŒ¶å±‹ï¼Œé‹æ°£å¥½å¯èƒ½æœƒçœ‹åˆ°è—å¦“æˆ–èˆå¦“ç¶“éï¼ˆè«‹å‹¿è§¸ç¢°æˆ–é˜»æ“‹æ‹ç…§ï¼‰ã€‚åˆé¤å»ºè­°åœ¨æ­¤å€åŸŸæˆ–æ²³åŸç”ºè§£æ±ºã€‚' },
  { id: 306, date: '2026-04-03', category: 'attraction', name: 'é´¨å· & æ²³åŸç”ºå•†åº—è¡—', time: '15:00', travelTime: 10, transportType: 'walk', note: 'æ²³å²¸æ•£æ­¥èˆ‡é€›è¡—', description: 'å¾ç¥‡åœ’è·¨éå››æ¢å¤§æ©‹å°±æ˜¯é´¨å·ï¼Œé©åˆåœ¨æ²³å ¤é‚Šåè‘—ä¼‘æ¯å¹é¢¨ï¼Œæ¬£è³æ²³æ™¯ã€‚éæ©‹å¾Œå³é€²å…¥æ²³åŸç”ºå•†åœˆï¼Œé€™è£¡æœ‰å„ç¨®è—¥å¦èˆ‡æœé£¾åº—ï¼Œéå¸¸å¥½é€›ã€‚' },
  { id: 307, date: '2026-04-03', category: 'transport', name: 'æ²³åŸç”º â†’ äº¬éƒ½è»Šç«™', time: '18:00', travelTime: 20, transportType: 'transit', note: 'åœ°éµæˆ–å·´å£«', description: 'ğŸš‰ è·¯ç·šï¼šäº¬éƒ½å¸‚å·´å£« æˆ– åœ°éµçƒä¸¸ç·š\nğŸ“ å€é–“ï¼šå››æ¢æ²³åŸç”º â†’ äº¬éƒ½è»Šç«™\nğŸ’¡ æç¤ºï¼šå·´å£«äººå¤šæ™‚ï¼Œå»ºè­°èµ°è‡³åœ°éµå››æ¢ç«™æ­ä¹˜çƒä¸¸ç·šã€‚' },
  { id: 308, date: '2026-04-03', category: 'transport', name: 'äº¬éƒ½è»Šç«™ â†’ é£¯åº—', time: '18:30', travelTime: 50, transportType: 'transit', note: 'JR è½‰ åœ°éµ (ç¶“æ–°å¤§é˜ª)', description: 'ğŸ“ è½‰ä¹˜è·¯å¾‘ï¼š\n1. JR äº¬éƒ½ç«™ â†’ JR æ–°å¤§é˜ªç«™ (JRäº¬éƒ½ç·š - æ–°å¿«é€Ÿ)\n2. æ–°å¤§é˜ªç«™ â†’ æœ¬ç”ºç«™ (M18) (åœ°éµå¾¡å ‚ç­‹ç·š)\nğŸ’¡ é€™æ˜¯æœ€å¿«ä¹Ÿæœ€å–®ç´”çš„è·¯ç·šã€‚æ™šé¤å»ºè­°åœ¨äº¬éƒ½è»Šç«™æ‹‰éºµå°è·¯è§£æ±ºï¼Œæˆ–è²·ä¾¿ç•¶å›é£¯åº—äº«ç”¨ã€‚' },
  { id: 310, date: '2026-04-03', category: 'other', name: 'é£¯åº—è‡ªç”±æ´»å‹•', time: '20:00', travelTime: 0, transportType: 'walk', note: 'ä¼‘æ¯æˆ–æ•´ç†è¡Œæ', description: 'ç¶“éä¸€æ•´å¤©äº¬éƒ½èµ°è·¯è¡Œç¨‹ï¼Œè…¿æ‡‰è©²å¾ˆé…¸äº†ï¼Œå»ºè­°æ—©é»ä¼‘æ¯ï¼Œæˆ–æ˜¯åœ¨é£¯åº—é™„è¿‘è¶…å•†è²·é»å®µå¤œã€‚' },

  // Day 3 (Nara)
  { id: 201, date: '2026-04-04', category: 'transport', name: 'é£¯åº— â†’ å¥ˆè‰¯', time: '08:00', travelTime: 60, transportType: 'transit', note: 'åœ°éµè½‰è¿‘éµ', description: 'ğŸ“ è½‰ä¹˜è·¯å¾‘ï¼š\n1. æœ¬ç”ºç«™ (M18) â†’ é›£æ³¢ç«™ (M20) (åœ°éµå¾¡å ‚ç­‹ç·š)\n2. é›£æ³¢ç«™ â†’ è¿‘éµå¥ˆè‰¯ç«™ (è¿‘éµå¥ˆè‰¯ç·š - å¿«é€Ÿæ€¥è¡Œ)\nğŸ’¡ æç¤ºï¼šæ­ä¹˜å¿«é€Ÿæ€¥è¡Œç´„ 40 åˆ†é˜ï¼Œæ¯”æ™®é€šè»Šå¿«å¾ˆå¤šã€‚' },
  { id: 202, date: '2026-04-04', category: 'attraction', name: 'å¥ˆè‰¯å…¬åœ’ (æ¢…èŠ±é¹¿å…¬åœ’)', time: '09:10', travelTime: 10, transportType: 'walk', note: 'è²·é¹¿ä»™è²å°å¿ƒè¢«åœæ”»', ticket: 'é¹¿ä»™è²Â¥200', description: 'å¾è¿‘éµå¥ˆè‰¯ç«™ 2 è™Ÿå‡ºå£å‡ºä¾†ï¼Œæ²¿è‘—ç™»å¤§è·¯å¾€æ±èµ°å³é”ã€‚æ²¿é€”å°±æœƒçœ‹åˆ°å¾ˆå¤šé¹¿ã€‚è«‹æ³¨æ„æ‰‹ä¸Šçš„åœ°åœ–æˆ–ç´™å¼µï¼Œé¹¿å¯èƒ½æœƒå’¬èµ°ã€‚' },
  { id: 203, date: '2026-04-04', category: 'attraction', name: 'æ±å¤§å¯º (å¤§ä½›æ®¿)', time: '10:00', travelTime: 15, transportType: 'walk', note: 'ä¸–ç•Œæœ€å¤§æœ¨é€ å»ºç¯‰', ticket: 'Â¥600', openHours: '07:30 - 17:30', description: 'ç©¿è¶Šå·¨å¤§çš„å—å¤§é–€ï¼ˆæœ‰é‡‘å‰›åŠ›å£«åƒï¼‰ï¼Œåƒè§€å¤§ä½›æ®¿å…§çš„ç›§èˆé‚£ä½›ã€‚å¦‚æœäººä¸å¤šï¼Œå¯ä»¥æŒ‘æˆ°é‘½ã€Œå¤§ä½›é¼»å­”ã€æŸ±å­æ´ï¼Œè½èªªèƒ½ä¿å¹³å®‰ã€‚' },
  { id: 204, date: '2026-04-04', category: 'attraction', name: 'æ˜¥æ—¥å¤§ç¤¾', time: '11:30', travelTime: 20, transportType: 'walk', note: 'åƒé“çŸ³ç‡ˆç± ', description: 'æ²¿è‘—æ£®æ—åƒé“å‰å¾€ï¼Œé€™è£¡æ°£æ°›æ¯”è¼ƒå¹½éœã€‚ä»¥æ•¸åƒåº§çŸ³ç‡ˆç± å’ŒåŠç‡ˆç± èåã€‚å¦‚æœèµ°ç´¯äº†ï¼Œå¯ä»¥åœ¨åƒé“å…¥å£é™„è¿‘çš„èŒ¶å±‹ä¼‘æ¯åƒé»æ±è¥¿ã€‚' },
  { id: 205, date: '2026-04-04', category: 'transport', name: 'æ˜¥æ—¥å¤§ç¤¾ â†’ JR å¥ˆè‰¯ç«™', time: '13:00', travelTime: 25, transportType: 'transit', note: 'æ­ä¹˜å·´å£«', description: 'ğŸš‰ è·¯ç·šï¼šå¥ˆè‰¯äº¤é€šå·´å£« (70/97/98è™Ÿ)\nğŸ“ å€é–“ï¼šæ˜¥æ—¥å¤§ç¤¾æœ¬æ®¿ â†’ JR å¥ˆè‰¯ç«™\nğŸ’¡ æç¤ºï¼šè‹¥æ­¥è¡Œéœ€ç´„ 30-40 åˆ†é˜ï¼Œå»ºè­°æ­è»Šä¿ç•™é«”åŠ›ã€‚' },
  { id: 206, date: '2026-04-04', category: 'transport', name: 'JR å¥ˆè‰¯ â†’ JR ç¨»è·', time: '13:30', travelTime: 35, transportType: 'transit', note: 'æ­ä¹˜ JR å¥ˆè‰¯ç·š', description: 'ğŸš‰ è·¯ç·šï¼šJR å¥ˆè‰¯ç·š\nğŸ“ å€é–“ï¼šJR å¥ˆè‰¯ç«™ â†’ JR ç¨»è·ç«™\nğŸ’¡ æ³¨æ„ï¼šè«‹æ­ä¹˜ã€Œæ™®é€šã€åˆ—è»Š (Miyakoji Rapid ä¸åœç¨»è·)ï¼Œæˆ–æ­å¿«é€Ÿåˆ°å®‡æ²»/æ±ç¦å¯ºå†è½‰æ™®é€šè»Šã€‚' },
  { id: 207, date: '2026-04-04', category: 'attraction', name: 'ä¼è¦‹ç¨»è·å¤§ç¤¾', time: '14:10', travelTime: 0, transportType: 'walk', note: 'åƒæœ¬é³¥å±…', description: 'å¿…æ‹åƒæœ¬é³¥å±…ï¼å»ºè­°å¾€å±±ä¸Šèµ°ä¸€æ®µï¼Œäººæ½®æœƒè®Šå°‘ï¼Œæ¯”è¼ƒå¥½æ‹ç…§ã€‚é€™è£¡ç‹ç‹¸æ˜¯ç¥çš„ä½¿è€…ï¼Œç¹ªé¦¬ä¹Ÿæ˜¯ç‹ç‹¸å½¢ç‹€çš„å–”ã€‚' },
  { id: 208, date: '2026-04-04', category: 'transport', name: 'ç¨»è· â†’ é£¯åº— (ç¶“äº¬éƒ½/æ–°å¤§é˜ª)', time: '16:30', travelTime: 60, transportType: 'transit', note: 'JR è½‰ åœ°éµ', description: 'ğŸ“ è½‰ä¹˜è·¯å¾‘ï¼š\n1. JR ç¨»è·ç«™ â†’ JR äº¬éƒ½ç«™ (JRå¥ˆè‰¯ç·š)\n2. JR äº¬éƒ½ç«™ â†’ JR æ–°å¤§é˜ªç«™ (JRäº¬éƒ½ç·š - æ–°å¿«é€Ÿ)\n3. æ–°å¤§é˜ªç«™ â†’ æœ¬ç”ºç«™ (M18) (åœ°éµå¾¡å ‚ç­‹ç·š)\nğŸ’¡ é€™æ˜¯åˆ©ç”¨ JR PASS æˆ–å–®ç¨‹ç¥¨çš„å¿«é€Ÿèµ°æ³•ã€‚' },
  { id: 209, date: '2026-04-04', category: 'shopping', name: 'æ™šä¸Šè‡ªç”±é€›è¡—', time: '18:30', travelTime: 0, transportType: 'walk', note: 'è‡ªç”±æ´»å‹•', description: 'å›åˆ°æœ¬ç”º/å¿ƒé½‹æ©‹å€åŸŸã€‚å¯ä»¥å„è‡ªå»è—¥å¦åº—è£œè²¨ï¼Œæˆ–æ˜¯å»é›£æ³¢ Parksã€é«˜å³¶å±‹é€›è¡—ã€‚æ™šé¤å¯ç›¸ç´„åƒç‡’è‚‰æˆ–å„è‡ªè¦“é£Ÿã€‚' },

  // Day 4 (Osaka)
  { id: 401, date: '2026-04-05', category: 'transport', name: 'é£¯åº— â†’ æµ·éŠé¤¨', time: '08:00', travelTime: 20, transportType: 'transit', note: 'æ­ä¹˜ä¸­å¤®ç·š (ç¶ ç·š)', description: 'ğŸ“ è½‰ä¹˜è·¯å¾‘ï¼š\n1. æœ¬ç”ºç«™ (C16) æ­¥è¡Œ/è½‰ä¹˜è‡³ ä¸­å¤®ç·šæœˆå°\n2. æ­ä¹˜ åœ°éµä¸­å¤®ç·š (å¾€å®‡å®™å»£å ´æ–¹å‘) â†’ å¤§é˜ªæ¸¯ç«™ (C11)\n3. 1è™Ÿæˆ–2è™Ÿå‡ºå£å‡ºç«™ï¼Œæ­¥è¡Œç´„ 5-10 åˆ†é˜æŠµé”ã€‚' },
  { id: 402, date: '2026-04-05', category: 'attraction', name: 'æµ·éŠé¤¨', time: '08:30', travelTime: 0, transportType: 'walk', note: 'ä¸–ç•Œæœ€å¤§ç´šæ°´æ—é¤¨', ticket: 'Â¥2,700', openHours: '09:30 - 20:00', description: 'æ—©é»åˆ°å¯ä»¥é¿é–‹æ’éšŠäººæ½®ã€‚å¿…çœ‹å·¨å¤§çš„ã€Œå¤ªå¹³æ´‹ã€æ°´æ§½èˆ‡é®é¤¨ä¹‹å¯¶â€”â€”é¯¨é¯Šã€‚é¤¨å…§è¨­è¨ˆæ˜¯å¾8æ¨“èºæ—‹ç‹€å¾€ä¸‹åƒè§€ï¼Œæ¨¡æ“¬å¾æµ·é¢æ½›å…¥æ·±æµ·çš„éç¨‹ã€‚' },
  { id: 403, date: '2026-04-05', category: 'transport', name: 'æµ·éŠé¤¨ â†’ é€šå¤©é–£', time: '11:00', travelTime: 30, transportType: 'transit', note: 'ä¸­å¤®ç·šè½‰å ºç­‹ç·š', description: 'ğŸ“ è½‰ä¹˜è·¯å¾‘ï¼š\n1. å¤§é˜ªæ¸¯ç«™ (C11) â†’ å ºç­‹æœ¬ç”ºç«™ (C17) (åœ°éµä¸­å¤®ç·š)\n2. å ºç­‹æœ¬ç”ºç«™ â†’ æƒ ç¾é ˆç”ºç«™ (K18) (åœ°éµå ºç­‹ç·š)\n3. 3è™Ÿå‡ºå£å‡ºç«™ï¼Œé€šå¤©é–£å°±åœ¨çœ¼å‰ã€‚' },
  { id: 404, date: '2026-04-05', category: 'attraction', name: 'é€šå¤©é–£ & æ–°ä¸–ç•Œ', time: '11:40', travelTime: 0, transportType: 'walk', note: 'å¤§é˜ªæ‡·èˆŠåœ°æ¨™', description: 'é€™è£¡å……æ»¿æ˜­å’Œæ™‚ä»£çš„æ‡·èˆŠæ°›åœï¼Œå·¨å¤§çš„æ²³è±šæ‹›ç‰Œæ˜¯å¿…æ‹æ™¯é»ã€‚å¯ä»¥ä¸Šé€šå¤©é–£å±•æœ›å°æ‘¸æ‘¸Billikenç¥åƒçš„è…³åº•æ±‚å¥½é‹ã€‚' },
  { id: 405, date: '2026-04-05', category: 'food', name: 'åˆé¤ï¼šå…ƒç¥–ç‚¸ä¸²', time: '12:00', travelTime: 0, transportType: 'walk', note: 'ç¦æ­¢äºŒæ¬¡æ²¾é†¬', description: 'åœ¨æ–°ä¸–ç•Œå•†åº—è¡—äº«ç”¨å¤§é˜ªåç‰©ã€Œç‚¸ä¸² (Kushikatsu)ã€ã€‚æ¨è–¦ã€Œé”æ‘© (Daruma)ã€æˆ–ã€Œå…«é‡å‹ã€ã€‚è¨˜å¾—é†¬æ±æ˜¯å…±ç”¨çš„ï¼Œå’¬éå¾Œçµ•å°ä¸èƒ½å†æ²¾å–”ï¼' },
  { id: 406, date: '2026-04-05', category: 'attraction', name: 'å¤©ç‹å¯ºå‹•ç‰©åœ’', time: '13:30', travelTime: 10, transportType: 'walk', note: 'ç™¾å¹´å‹•ç‰©åœ’', ticket: 'Â¥500', openHours: '09:30 - 17:00', description: 'å¾æ–°ä¸–ç•Œæ­¥è¡Œå³å¯æŠµé”ã€Œæ–°ä¸–ç•Œå¤§é–€ã€ã€‚åœ’å€å…§æœ‰æ¨¡æ“¬éæ´²ç†±å¸¶è‰åŸçš„ç”Ÿæ…‹å±•ç¤ºå€ï¼Œèƒ½è¿‘è·é›¢è§€å¯Ÿæ²³é¦¬ã€ç…å­ç­‰å‹•ç‰©ã€‚' },
  { id: 407, date: '2026-04-05', category: 'transport', name: 'å‹•ç‰©åœ’ â†’ é˜¿å€é‡', time: '15:30', travelTime: 15, transportType: 'walk', note: 'ç©¿è¶Šå¤©ç‹å¯ºå…¬åœ’', description: 'ğŸš‰ è·¯ç·šï¼šæ­¥è¡Œ\nğŸ“ å€é–“ï¼šå¤©ç‹å¯ºå‹•ç‰©åœ’ â†’ é˜¿å€é‡ HARUKAS\nğŸš¶ æ­¥è¡Œï¼šç©¿è¶Šæ¼‚äº®çš„ã€Œå¤©ç‹å¯ºå…¬åœ’ (Ten-Shiba)ã€è‰çš®å€ï¼Œå‰æ–¹æœ€é«˜çš„æ‘©å¤©å¤§æ¨“å°±æ˜¯ã€‚' },
  { id: 408, date: '2026-04-05', category: 'attraction', name: 'é˜¿å€é‡ HARUKAS 300', time: '16:00', travelTime: 0, transportType: 'walk', note: 'çµ•ç¾æ—¥è½èˆ‡å¤œæ™¯', ticket: 'Â¥1,800', openHours: '09:00 - 22:00', description: 'ææ—©ä¸Šå±•æœ›å°ä½”å€‹å¥½ä½ç½®ï¼åœ¨ 60 æ¨“å±•æœ›å° 360 åº¦ä¿¯ç°å¤§é˜ªå…¨æ™¯ã€‚é€™å€‹æ™‚é–“ä¸Šå»å¯ä»¥æ‚ é–’åœ°ç­‰å¾…æ—¥è½ï¼Œä¸€æ¬¡æ¬£è³ç™½å¤©ã€å¤•é™½èˆ‡ç™¾è¬å¤œæ™¯çš„è®ŠåŒ–ã€‚' },
  { id: 409, date: '2026-04-05', category: 'transport', name: 'å¤©ç‹å¯º â†’ é£¯åº—', time: '18:30', travelTime: 15, transportType: 'transit', note: 'å¾¡å ‚ç­‹ç·šç›´é”', description: 'ğŸš‰ è·¯ç·šï¼šåœ°éµå¾¡å ‚ç­‹ç·š\nğŸ“ å€é–“ï¼šå¤©ç‹å¯ºç«™ (M23) â†’ æœ¬ç”ºç«™ (M18)\nğŸ’¡ æç¤ºï¼šå…è½‰ä¹˜ï¼Œç›´é”é£¯åº—ã€‚' },
  { id: 410, date: '2026-04-05', category: 'other', name: 'å›é£¯åº—ä¼‘æ¯', time: '19:00', travelTime: 0, transportType: 'walk', note: 'æ•´ç†æˆ°åˆ©å“', description: 'ä»Šå¤©æ˜¯æœ€å¾Œä¸€æ™šï¼Œæ—©é»å›é£¯åº—æ•´ç†è¡Œæï¼Œç¢ºèªä¼´æ‰‹ç¦®æ˜¯å¦è²·é½Šï¼Œæ˜å¤©å°±è¦å›ç¨‹å›‰ã€‚' },

  // Day 5 (Return)
  { id: 501, date: '2026-04-06', category: 'transport', name: 'é£¯åº— â†’ é—œè¥¿æ©Ÿå ´', time: '08:30', travelTime: 60, transportType: 'transit', note: 'åœ°éµè½‰å—æµ·é›»éµ', description: 'ğŸ“ è½‰ä¹˜è·¯å¾‘ï¼š\n1. æœ¬ç”ºç«™ (M18) â†’ é›£æ³¢ç«™ (M20) (åœ°éµå¾¡å ‚ç­‹ç·š)\n2. å—æµ·é›£æ³¢ç«™ â†’ é—œè¥¿æ©Ÿå ´ç«™ (å—æµ·é›»éµ - ç©ºæ¸¯æ€¥è¡Œ)\nğŸ’¡ é›–ç„¶ç­æ©Ÿæ˜¯ 12:00ï¼Œä½†å»ºè­° 10:00 å‰æŠµé”æ©Ÿå ´æ¯”è¼ƒå……è£•ã€‚' },
  { id: 502, date: '2026-04-06', category: 'other', name: 'æ©Ÿå ´å ±åˆ° & è¡Œææ‰˜é‹', time: '10:00', travelTime: 0, transportType: 'walk', note: 'IT-285 (ç¬¬ä¸€èˆªå»ˆ)', description: 'å‰å¾€å°ç£è™èˆªæ«ƒå°è¾¦ç†ç™»æ©Ÿã€‚è¨˜å¾—å†æ¬¡ç¢ºèªéš¨èº«è¡Œæå…§æ²’æœ‰è¶…é 100ml çš„æ¶²é«”ã€å‰ªåˆ€ç­‰é•ç¦å“ã€‚è¡Œå‹•é›»æºå’Œé›»æ± è«‹å‹™å¿…éš¨èº«æ”œå¸¶ï¼Œä¸å¯æ‰˜é‹ã€‚' },
  { id: 503, date: '2026-04-06', category: 'shopping', name: 'å…ç¨…åº—æƒè²¨ & ä¼´æ‰‹ç¦®', time: '10:40', travelTime: 0, transportType: 'walk', note: 'ğŸ å¿…è²·æ¨è–¦æ¸…å–®', description: 'éæµ·é—œå¾Œçš„æœ€å¾Œè¡åˆºï¼æ¨è–¦è³¼è²·ï¼š\n1. ğŸ« ROYCE\' ç”Ÿå·§å…‹åŠ› & æ´‹èŠ‹ç‰‡ (è¨˜å¾—è²·ä¿å†·è¢‹)\n2. ğŸŒ æ±äº¬é¦™è•‰ (Tokyo Banana) - é€™è£¡ä¹Ÿè²·å¾—åˆ°ï¼\n3. ğŸ° LeTAO é›™å±¤ä¹³é…ªè›‹ç³• (ä¾†è‡ªåŒ—æµ·é“çš„ç¾å‘³)\n4. ğŸŸ è–¯æ¢ä¸‰å…„å¼Ÿ (Jaga Pokkuru)\n5. ğŸµ äº¬éƒ½åŒ—å±±èŒ¶ä¹‹è“ (æ¿ƒéƒæŠ¹èŒ¶é¤…ä¹¾)\n6. ğŸ¬ å‘¼å¸å·§å…‹åŠ› (å¤§é˜ªé™å®šï¼Œå¤§åŒ…è£é©åˆåˆ†é€)\nğŸ’¡ æç¤ºï¼šå‰©ä¸‹çš„æ—¥å¹£é›¶éŒ¢å¯ä»¥åœ¨é€™è£¡å…¨éƒ¨èŠ±æ‰ï¼Œä¸è¶³çš„é‡‘é¡å†åˆ·å¡ã€‚' },
  { id: 504, date: '2026-04-06', category: 'flight', name: 'èˆªç­ IT-285 KIX->KHH', time: '12:00', travelTime: 0, transportType: 'flight', note: 'èµ·é£› 12:00 / æŠµé” 14:00', description: 'å¸¶è‘—æ»¿æ»¿çš„å›æ†¶å›å®¶å›‰ï¼âœˆï¸ æŠµé”é«˜é›„å¾Œè¨˜å¾—é ˜å–è¡Œæã€‚' }
];
</script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  
  const { createApp, ref, computed, reactive, onMounted, watch } = Vue;

  // Firebase Configuration (Preserved user's config)
  const firebaseConfig = {
    apiKey: "AIzaSyDc1X5CFJc7ThluEmPN--uVKxSfrlZavek",
    authDomain: "osa0402test.firebaseapp.com",
    projectId: "osa0402test",
    storageBucket: "osa0402test.firebasestorage.app",
    messagingSenderId: "49893570598",
    appId: "1:49893570598:web:c334c87afbd84ee329cee7",
    measurementId: "G-HTNRTFVN0S"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const TRIP_ID = "keihan_2026_0402_v8_final";

  createApp({
    setup() {
      // Basic UI State
      const showSplash = ref(true);
      const currentTab = ref('itinerary');
      const tabs = [
        { id: 'itinerary', name: 'è¡Œç¨‹è¡¨', icon: 'fa-solid fa-map-location-dot' },
        { id: 'info', name: 'è³‡è¨Š', icon: 'fa-solid fa-circle-info' },
        { id: 'shopping', name: 'è³¼ç‰©æ¸…å–®', icon: 'fa-solid fa-basket-shopping' },
        { id: 'expense', name: 'èŠ±è²»', icon: 'fa-solid fa-yen-sign' },
        { id: 'notebook', name: 'ç­†è¨˜æœ¬', icon: 'fa-solid fa-book' },
      ];
      // Changed default image back to previous version
      const bannerImage = ref('https://i.ibb.co/YBR5dpk4/22223.png');
      const handleImageError = () => { bannerImage.value = 'https://via.placeholder.com/480x250?text=Trip'; };
      
      const tripStartDate = new Date('2026-04-02T00:00:00');
      const daysUntilTrip = computed(() => {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const start = new Date(tripStartDate.getFullYear(), tripStartDate.getMonth(), tripStartDate.getDate());
        const diffTime = start - today;
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      });
      
      // ä¿®æ”¹ï¼šç§»é™¤ 'å…¬è²»'
      const travelers = ref(['ç¿”/å›', 'å€«/æ€¡', 'èŒ¹', 'åª½åª½', 'çˆ¸çˆ¸']);
      // ä¿®æ”¹ï¼šç§»é™¤ 'å…¨éƒ¨' é¸é …ï¼Œåªä¿ç•™å€‹åˆ¥æˆå“¡ (åŸæœ¬éæ¿¾å…¬è²»çš„é‚è¼¯ä¿ç•™ä¹Ÿæ²’é—œä¿‚ï¼Œå› ç‚ºå·²ç¶“å¾æºé ­æ‹¿æ‰äº†)
      const shoppingTravelers = computed(() => travelers.value); 
      const notebookOwners = computed(() => travelers.value);
      const packingPeople = ref(['å£«ç¿”', 'ä¾‘å›', 'å£«å€«', 'æ¬£æ€¡', 'ç®èŒ¹', 'åª½åª½', 'çˆ¸çˆ¸']);

      const days = [
        { dateStr: '2026-04-02', displayDate: '4/2', dayOfWeek: 'é€±å››', mainCity: 'å¤§é˜ªå¸‚', locations: [{name:'å¤§é˜ªå¸‚', lat:34.6937, lng:135.5023}] },
        { dateStr: '2026-04-03', displayDate: '4/3', dayOfWeek: 'é€±äº”', mainCity: 'äº¬éƒ½å¸‚', locations: [{name:'äº¬éƒ½å¸‚', lat:35.0116, lng:135.7681}, {name:'å¤§é˜ªå¸‚', lat:34.6937, lng:135.5023}] },
        { dateStr: '2026-04-04', displayDate: '4/4', dayOfWeek: 'é€±å…­', mainCity: 'å¥ˆè‰¯å¸‚', locations: [{name:'å¥ˆè‰¯å¸‚', lat:34.6851, lng:135.8048}, {name:'å¤§é˜ªå¸‚', lat:34.6937, lng:135.5023}] },
        { dateStr: '2026-04-05', displayDate: '4/5', dayOfWeek: 'é€±æ—¥', mainCity: 'å¤§é˜ªå¸‚', locations: [{name:'å¤§é˜ªå¸‚', lat:34.6937, lng:135.5023}] },
        { dateStr: '2026-04-06', displayDate: '4/6', dayOfWeek: 'é€±ä¸€', mainCity: 'é—œè¥¿æ©Ÿå ´', locations: [{name:'å¤§é˜ªå¸‚', lat:34.6937, lng:135.5023}, {name:'æ³‰ä½é‡å¸‚(æ©Ÿå ´)', lat:34.4320, lng:135.2304}] },
      ];
      const selectedDate = ref('2026-04-02');

      const isTigerairInfoExpanded = ref(false);
      // const isTravelTipsExpanded = ref(false); // Removed
      const isExchangeWarningExpanded = ref(false); // New state for Exchange Warning

      // --- FIREBASE SYNC COLLECTIONS ---
      const itineraryList = ref([]);
      const shoppingList = ref([]);
      const expenses = ref([]);
      const notebookList = ref([]);
      const packingList = ref([]);
      const firebaseStatus = ref('connecting'); 
      const isSaving = ref(false);
      const migrationStatus = ref('');

      const currentMemberFilter = ref(null); // Default null for privacy
      const currentNotebookFilter = ref(null); // Default null for privacy (Modified)
      const currentShoppingFilter = ref(null); // Default null for privacy
      const currentPackingFilter = ref('å£«ç¿”');
      const newPackingItem = ref('');

      // Metro Map Zoom Logic (Removed)

      // Watch Tab Change to Reset Privacy Filters
      watch(currentTab, (newVal) => {
          // ç•¶åˆ‡æ›åˆ†é æ™‚ï¼Œé‡ç½®æ•æ„Ÿè³‡è¨Šçš„ç¯©é¸å™¨ç‚º null (éš±è—ç‹€æ…‹)
          if (newVal !== 'shopping') currentShoppingFilter.value = null;
          if (newVal !== 'expense') currentMemberFilter.value = null;
          if (newVal !== 'notebook') currentNotebookFilter.value = null; // Add notebook reset
      });

      // Custom Alert & Confirm Implementation
      const confirmState = reactive({ show: false, message: '', resolve: null });
      const toastState = reactive({ show: false, message: '' });

      const showToast = (msg) => {
        toastState.message = msg;
        toastState.show = true;
        setTimeout(() => toastState.show = false, 3000);
      };

      const askConfirm = (msg) => {
        confirmState.message = msg;
        confirmState.show = true;
        return new Promise((resolve) => {
            confirmState.resolve = resolve;
        });
      };

      const handleConfirm = (result) => {
        confirmState.show = false;
        if(confirmState.resolve) {
            confirmState.resolve(result);
            confirmState.resolve = null;
        }
      };

      const subscribeCollection = (colName, targetRef, orderByField = null) => {
        let q = collection(db, 'trips', TRIP_ID, colName);
        if (orderByField) q = query(q, orderBy(orderByField));
        
        onSnapshot(q, (snapshot) => {
            const data = [];
            snapshot.forEach(doc => {
                data.push({ id: doc.id, ...doc.data() });
            });
            targetRef.value = data;
            firebaseStatus.value = 'connected';
        }, (err) => {
            console.error("Sync error:", err);
            firebaseStatus.value = 'error';
        });
      };

      // --- DATA MIGRATION ---
      const checkAndMigrateData = async (force = false, specificPerson = null) => {
          migrationStatus.value = "æª¢æŸ¥è¡Œææ¸…å–®...";

          const packRef = collection(db, 'trips', TRIP_ID, 'packing');
          const snapPack = await getDocs(packRef);
          
          const ownerCounts = {};
          packingPeople.value.forEach(p => ownerCounts[p] = 0);

          snapPack.forEach(doc => {
              const data = doc.data();
              if (data.owner && ownerCounts.hasOwnProperty(data.owner)) {
                  ownerCounts[data.owner]++;
              }
          });

          const defaultItems = [
               'è­·ç…§ (æœ‰æ•ˆæœŸ6å€‹æœˆä»¥ä¸Š)', 'Visit Japan Web QRcode æˆªåœ–', 'ç¶²å¡ / eSIM', 'æ—¥å¹£ç¾é‡‘ / ä¿¡ç”¨å¡',
               'è¡Œå‹•é›»æº (éœ€éš¨èº«æ”œå¸¶)', 'å€‹äººå¸¸å‚™è—¥ / æšˆæ©Ÿè—¥', 'ç‰™åˆ·ç‰™è† (æ—¥æœ¬éƒ¨åˆ†é£¯åº—ä¸ä¸»å‹•æä¾›)'
          ];

          const targets = specificPerson ? [specificPerson] : packingPeople.value;
          let updateCount = 0;

          for (const p of targets) {
                if (force || (ownerCounts[p] === 0)) {
                    migrationStatus.value = `æ­£åœ¨ç‚º ${p} å»ºç«‹æ¸…å–®...`;
                    for (const txt of defaultItems) {
                        const safeId = (p + '_' + txt).replace(/[\/\s]/g, '');
                        await setDoc(doc(db, 'trips', TRIP_ID, 'packing', safeId), { 
                            text: txt, 
                            owner: p, 
                            checked: false,
                            createdAt: serverTimestamp() 
                        }, { merge: true });
                    }
                    updateCount++;
                }
          }
          
          migrationStatus.value = "";
          if ((force || specificPerson) && updateCount > 0) showToast('å·²æˆåŠŸè£œé½Šé è¨­é …ç›®ï¼');
          else if ((force || specificPerson) && updateCount === 0) showToast('æ¸…å–®å·²å­˜åœ¨ï¼Œç„¡éœ€è£œé½Šã€‚');
      };

      const updateItineraryContentOnly = async () => {
          if(!(await askConfirm('é€™å°‡æœƒæŠŠè¡Œç¨‹è¡¨çš„æ–‡å­—æè¿°æ›´æ–°ç‚ºæœ€æ–°ç‰ˆ (åŒ…å«é»‘é–€å¸‚å ´äº¤é€šæŒ‡å¼•èˆ‡ç¦é£Ÿæé†’)ï¼Œæ‚¨çš„è³¼ç‰©æ¸…å–®èˆ‡èŠ±è²»ç´€éŒ„éƒ½æœƒä¿ç•™ã€‚ç¢ºå®šæ›´æ–°å—ï¼Ÿ'))) return;
          
          migrationStatus.value = "æ­£åœ¨æ›´æ–°è¡Œç¨‹è³‡æ–™...";
          const itinToUpload = window.__FULL_ITINERARY_DATA__ || [];
          
          try {
             const q = collection(db, 'trips', TRIP_ID, 'itinerary');
             const snapshot = await getDocs(q);
             const existingItems = [];
             snapshot.forEach(doc => existingItems.push({ _docId: doc.id, ...doc.data() }));

             if (Array.isArray(itinToUpload)) {
                 for (const item of itinToUpload) {
                      const match = existingItems.find(ex => ex.name === item.name && ex.date === item.date);
                      if (match) {
                          await setDoc(doc(db, 'trips', TRIP_ID, 'itinerary', match._docId), item, { merge: true });
                      } else {
                          const id = item.id ? String(item.id) : Date.now().toString();
                          await setDoc(doc(db, 'trips', TRIP_ID, 'itinerary', id), item);
                      }
                 }
             }
             showToast("è¡Œç¨‹è³‡æ–™å·²æ›´æ–°å®Œç•¢ï¼");
          } catch(e) {
             showToast("æ›´æ–°å¤±æ•—ï¼š" + e.message);
          } finally {
             migrationStatus.value = "";
          }
      };

      const fixDuplicates = async () => {
          if(!(await askConfirm('é€™å°‡æœƒå¼·åˆ¶æƒææ‰€æœ‰ã€Œé«˜é›„å°æ¸¯æ©Ÿå ´é›†åˆã€çš„é …ç›®ï¼Œä¸¦å¼·åˆ¶å°‡å…¶æ›´æ–°ç‚º 04:30ï¼ŒåŒæ™‚åˆªé™¤å¤šé¤˜çš„é‡è¤‡é …ã€‚\n\nç¢ºå®šåŸ·è¡Œï¼Ÿ'))) return;
          
          migrationStatus.value = "æ­£åœ¨å¼·åˆ¶ä¿®æ­£...";
          try {
              const q = collection(db, 'trips', TRIP_ID, 'itinerary');
              const snapshot = await getDocs(q);
              const items = [];
              snapshot.forEach(doc => items.push({ _docId: doc.id, ...doc.data() }));

              let deletedCount = 0;
              let updatedCount = 0;
              const seedData = window.__FULL_ITINERARY_DATA__ || [];

              for (const seed of seedData) {
                  const duplicates = items.filter(i => i.name === seed.name && i.date === seed.date);
                  
                  if (duplicates.length > 0) {
                      const survivor = duplicates[0];
                      const survivorRef = doc(db, 'trips', TRIP_ID, 'itinerary', survivor._docId);
                      await setDoc(survivorRef, seed); 
                      updatedCount++;

                      if (duplicates.length > 1) {
                          for (let i = 1; i < duplicates.length; i++) {
                              await deleteDoc(doc(db, 'trips', TRIP_ID, 'itinerary', duplicates[i]._docId));
                              deletedCount++;
                          }
                      }
                  }
              }
              
              showToast(`ä¿®å¾©å®Œæˆï¼æ›´æ–° ${updatedCount} ç­†ï¼Œç§»é™¤ ${deletedCount} ç­†`);
          } catch(e) {
              showToast("ä¿®å¾©å¤±æ•—ï¼š" + e.message);
          } finally {
              migrationStatus.value = "";
          }
      };
      
      const reconnectFirebase = () => window.location.reload();

      // --- COMPUTED DATA VIEWS ---
      const filteredItinerary = computed(() => 
        itineraryList.value
            .filter(i => i.date === selectedDate.value)
            .sort((a,b) => (a.time || '').localeCompare(b.time || ''))
      );

      const filteredShoppingList = computed(() => {
        // å¦‚æœæ²’æœ‰é¸æ“‡éæ¿¾å™¨ (null)ï¼Œå›å‚³ç©ºé™£åˆ— (é…åˆ v-if æ§åˆ¶é¡¯ç¤º)
        if (!currentShoppingFilter.value) return [];
        // ç§»é™¤ 'å…¨éƒ¨' çš„é‚è¼¯
        return shoppingList.value.filter(item => item.owner === currentShoppingFilter.value);
      });

      const filteredExpenses = computed(() => {
        // å¦‚æœæ²’æœ‰é¸æ“‡éæ¿¾å™¨ (null)ï¼Œå›å‚³ç©ºé™£åˆ—
        if (!currentMemberFilter.value) return [];
        if (currentMemberFilter.value === 'ALL') return expenses.value; // Special flag for ALL
        return expenses.value.filter(item => item.owner === currentMemberFilter.value);
      });

      const filteredTotalExpense = computed(() => filteredExpenses.value.reduce((sum, item) => sum + Number(item.amount||0), 0));
      const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + Number(item.amount||0), 0)); 
      
      const filteredPackingList = computed(() => {
        return packingList.value
          .filter(p => p.owner === currentPackingFilter.value)
          .sort((a, b) => {
             const getScore = (item) => {
                 if (item.createdAt === undefined) return 0;
                 if (item.createdAt === null) return 99999999999;
                 return item.createdAt.seconds || 0;
             };
             return getScore(a) - getScore(b);
          });
      });

      const filteredNotebookList = computed(() => {
          // Add privacy check
          if (!currentNotebookFilter.value) return [];
          return notebookList.value.filter(n => n.owner === currentNotebookFilter.value);
      });

      // --- MODAL & FORM ---
      const modal = reactive({ show: false, type: '', title: '', isEdit: false });
      const formData = reactive({});

      const openModal = (type, item = null) => {
        if (type === 'itinerary' && item) return; 
        if (type === 'itinerary' && !item) return;

        modal.type = type;
        modal.show = true;
        modal.isEdit = !!item;
        
        Object.keys(formData).forEach(k => delete formData[k]);
        
        if (item) {
            modal.title = 'ç·¨è¼¯';
            Object.assign(formData, JSON.parse(JSON.stringify(item))); 
        } else {
            modal.title = 'æ–°å¢';
            // Shopping: use current filter if set, otherwise default
            if (type === 'shopping') {
                // ä¿®æ”¹é è¨­é‚è¼¯ï¼šå¦‚æœæœ‰é¸äººå°±ç”¨é‚£å€‹äººï¼Œæ²’é¸äººé è¨­ç‚º 'ç¿”/å›'
                const defaultOwner = currentShoppingFilter.value ? currentShoppingFilter.value : 'ç¿”/å›';
                Object.assign(formData, { owner: defaultOwner, bought: false });
            }
            // Expense: use current filter if set, otherwise default
            if (type === 'expense') {
                // ä¿®æ”¹é è¨­é‚è¼¯ï¼šå› ç‚ºç§»é™¤äº† 'å…¬è²»'ï¼Œé è¨­æ”¹ç‚ºç¬¬ä¸€ä½æˆå“¡ 'ç¿”/å›'
                const defaultOwner = (currentMemberFilter.value && currentMemberFilter.value !== 'ALL') ? currentMemberFilter.value : 'ç¿”/å›';
                Object.assign(formData, { date: selectedDate.value, category: 'food', owner: defaultOwner, method: 'ç¾é‡‘' });
            }
            // Notebook: use current filter if set, otherwise default
            if (type === 'notebook') {
                const defaultOwner = currentNotebookFilter.value ? currentNotebookFilter.value : 'ç¿”/å›';
                Object.assign(formData, { owner: defaultOwner });
            }
        }
      };
      
      const closeModal = () => modal.show = false;

      // --- ACTIONS ---
      const submitForm = async () => {
        isSaving.value = true;
        try {
            const colName = modal.type === 'shopping' ? 'shopping' : 
                          modal.type === 'expense' ? 'expenses' : 'notebook';
            
            const docId = formData.id ? String(formData.id) : (Date.now().toString() + Math.random().toString().slice(2,6));
            const docRef = doc(db, 'trips', TRIP_ID, colName, docId);
            
            const payload = { ...formData };
            if(payload.id) payload.id = String(payload.id);

            await setDoc(docRef, payload, { merge: true });
            closeModal();
            firebaseStatus.value = 'connected'; // Reset on success
        } catch(e) {
            console.error(e);
            firebaseStatus.value = 'error'; // Set error state
            showToast("å„²å­˜å¤±æ•—: " + e.message);
        } finally {
            isSaving.value = false;
        }
      };

      const deleteCurrentItem = async () => {
         if(!(await askConfirm('ç¢ºå®šåˆªé™¤ï¼Ÿ'))) return;
         const colName = modal.type === 'shopping' ? 'shopping' : 
                          modal.type === 'expense' ? 'expenses' : 'notebook';
         await deleteDoc(doc(db, 'trips', TRIP_ID, colName, String(formData.id)));
         closeModal();
      };
      
      const deleteNote = async(id) => {
         if(!(await askConfirm('åˆªé™¤ç­†è¨˜ï¼Ÿ'))) return;
         await deleteDoc(doc(db, 'trips', TRIP_ID, 'notebook', String(id)));
      };

      const deleteShoppingItem = async (id) => {
        if(await askConfirm('åˆªé™¤æ­¤å•†å“ï¼Ÿ')) await deleteDoc(doc(db, 'trips', TRIP_ID, 'shopping', String(id)));
      };
      const toggleShoppingCheck = async (item) => {
        await updateDoc(doc(db, 'trips', TRIP_ID, 'shopping', String(item.id)), { bought: !item.bought });
      };

      const addPackingItem = async () => {
        if (!newPackingItem.value.trim()) return;
        const docId = Date.now().toString();
        await setDoc(doc(db, 'trips', TRIP_ID, 'packing', docId), {
            text: newPackingItem.value,
            owner: currentPackingFilter.value,
            checked: false,
            createdAt: serverTimestamp()
        });
        newPackingItem.value = '';
      };
      const togglePackingCheck = async (item) => {
        await updateDoc(doc(db, 'trips', TRIP_ID, 'packing', String(item.id)), { checked: !item.checked });
      };
      const deletePackingItem = async (id) => {
        if(await askConfirm('ç§»é™¤ï¼Ÿ')) await deleteDoc(doc(db, 'trips', TRIP_ID, 'packing', String(id)));
      };

      // --- UTILS ---
      const weatherData = reactive({ 
          city: 'å¤§é˜ªå¸‚', temp: '--', maxTemp: '--', minTemp: '--', 
          humidity: '--', windSpeed: '--', rain: '--', pressure: '--', visibility: '--', uvIndex: '--', 
          sunrise: '--', sunset: '--', 
          icon: 'fa-solid fa-spinner', description: 'è¼‰å…¥ä¸­...', clothing: '...', iconColor: '#ccc', 
          apparentTemp: '--', forecast: [], hourly: [] 
      });
      const weatherLoading = ref(false);
      const isWeatherExpanded = ref(false);
      const toggleWeather = () => isWeatherExpanded.value = !isWeatherExpanded.value;
      const currentDayCities = computed(() => {
          const d = days.find(x => x.dateStr === selectedDate.value);
          return d ? d.locations : [];
      });

      const getClothingAdvice = (avg, max, min) => {
        if (max < 10) return "å¤©æ°£å¯’å†·ï¼Œè«‹ç©¿è‘—ä¿æš–å¤§è¡£ã€åœå·¾ã€æ‰‹å¥—ï¼Œå»ºè­°æ¡ç”¨æ´‹è”¥å¼ç©¿æ³•ã€‚";
        if (max < 15) return "ç¨æœ‰å¯’æ„ï¼Œå»ºè­°ç©¿è‘—æ¯›è¡£ã€é¢¨è¡£æˆ–æ˜¯è¼•ç¾½çµ¨ï¼Œæ—©æ™šæº«å·®å¤§è¦æ³¨æ„ä¿æš–ã€‚";
        if (max < 20) return "æ°£æº«èˆ’é©åæ¶¼ï¼Œå»ºè­°é•·è¢–ä¸Šè¡£æ­é…é‡ç¹”è¡«æˆ–ç‰›ä»”å¤–å¥—ï¼Œé©åˆèµ°è·¯çš„è£æ‰®ã€‚";
        if (max < 25) return "æº«æš–èˆ’é©ï¼Œå¯ç©¿è–„é•·è¢–æˆ–çŸ­è¢–æ­é…è–„è¥¯è¡«ï¼Œä¸­åˆå¯èƒ½æœƒè¦ºå¾—ç†±ã€‚";
        if (max >= 25) return "å¤©æ°£ç‚ç†±ï¼Œè«‹ç©¿è‘—é€æ°£è¼•ä¾¿è¡£ç‰©ï¼Œä¸¦æ³¨æ„é˜²æ›¬èˆ‡è£œå……æ°´åˆ†ã€‚";
        return "æ°£æº«è®ŠåŒ–å¤§ï¼Œå»ºè­°éš¨èº«æ”œå¸¶è–„å¤–å¥—ä»¥å‚™ä¸æ™‚ä¹‹éœ€ã€‚";
      };

      const getWeatherInfo = (code, isDay) => {
        if (code === 0) return { desc: 'æ™´æœ—', icon: isDay ? 'fa-solid fa-sun' : 'fa-solid fa-moon', color: '#fbbf24' };
        if (code <= 3) return { desc: 'å¤šé›²', icon: isDay ? 'fa-solid fa-cloud-sun' : 'fa-solid fa-cloud-moon', color: '#fbbf24' };
        if (code <= 48) return { desc: 'æœ‰éœ§', icon: 'fa-solid fa-smog', color: '#9ca3af' };
        if (code <= 55) return { desc: 'æ¯›æ¯›é›¨', icon: 'fa-solid fa-cloud-rain', color: '#60a5fa' };
        if (code <= 67) return { desc: 'ä¸‹é›¨', icon: 'fa-solid fa-umbrella', color: '#3b82f6' };
        if (code <= 77) return { desc: 'ä¸‹é›ª', icon: 'fa-regular fa-snowflake', color: '#93c5fd' };
        if (code <= 82) return { desc: 'é™£é›¨', icon: 'fa-solid fa-cloud-showers-heavy', color: '#2563eb' };
        if (code >= 95) return { desc: 'é›·é›¨', icon: 'fa-solid fa-bolt', color: '#eab308' };
        return { desc: 'æœªçŸ¥', icon: 'fa-solid fa-circle-question', color: '#ccc' };
      };

      const changeWeatherCity = async (city) => {
         weatherLoading.value = true;
         weatherData.city = city.name;
         try {
             // Updated API URL for detailed metrics + hourly forecast
             const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lng}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,weather_code,wind_speed_10m,surface_pressure,visibility,cloud_cover&hourly=temperature_2m,weather_code,precipitation_probability,is_day&daily=weather_code,sunrise,sunset,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo`);
             const data = await res.json();
             
             const current = data.current;
             const daily = data.daily;
             const hourly = data.hourly;

             // Current Conditions
             weatherData.temp = Math.round(current.temperature_2m);
             weatherData.apparentTemp = Math.round(current.apparent_temperature);
             weatherData.humidity = current.relative_humidity_2m;
             weatherData.windSpeed = current.wind_speed_10m;
             weatherData.rain = current.precipitation;
             weatherData.pressure = Math.round(current.surface_pressure);
             weatherData.visibility = (current.visibility / 1000).toFixed(1); // Convert m to km
             
             // UV Index logic (Simulated based on cloud/time as API doesn't provide real-time UV freely easily mixed)
             const cloudCover = current.cloud_cover;
             let uvText = 'ä½';
             if (current.is_day && cloudCover < 30) uvText = 'é«˜';
             else if (current.is_day && cloudCover < 70) uvText = 'ä¸­';
             weatherData.uvIndex = uvText;

             if(daily.sunrise.length > 0) {
                 weatherData.sunrise = daily.sunrise[0].split('T')[1];
                 weatherData.sunset = daily.sunset[0].split('T')[1];
             }

             weatherData.maxTemp = Math.round(daily.temperature_2m_max[0]);
             weatherData.minTemp = Math.round(daily.temperature_2m_min[0]);
             
             const info = getWeatherInfo(current.weather_code, current.is_day === 1);
             weatherData.description = info.desc;
             weatherData.icon = info.icon;
             weatherData.iconColor = info.color;
             weatherData.clothing = getClothingAdvice(weatherData.temp, weatherData.maxTemp, weatherData.minTemp);

             // Process Daily Forecast
             const forecastList = [];
             const weekDays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
             for (let i = 1; i <= 3; i++) {
                if (daily.time[i]) {
                    const d = new Date(daily.time[i]);
                    const code = daily.weather_code[i];
                    const fInfo = getWeatherInfo(code, true);
                    forecastList.push({
                        dayName: weekDays[d.getDay()],
                        max: Math.round(daily.temperature_2m_max[i]),
                        min: Math.round(daily.temperature_2m_min[i]),
                        pop: daily.precipitation_probability_max ? daily.precipitation_probability_max[i] : 0,
                        icon: fInfo.icon,
                        color: fInfo.color
                    });
                }
             }
             weatherData.forecast = forecastList;

             // Process Hourly Forecast (Next 24 Hours)
             const hourlyList = [];
             const now = new Date();
             const currentHourIndex = hourly.time.findIndex(t => new Date(t) > now); // Find next hour
             
             if (currentHourIndex !== -1) {
                 for (let i = currentHourIndex; i < currentHourIndex + 24; i++) {
                     if (!hourly.time[i]) break;
                     const t = new Date(hourly.time[i]);
                     const code = hourly.weather_code[i];
                     const isDay = hourly.is_day[i] === 1;
                     const hInfo = getWeatherInfo(code, isDay);
                     
                     hourlyList.push({
                         time: t.getHours().toString().padStart(2, '0') + ':00',
                         temp: Math.round(hourly.temperature_2m[i]),
                         icon: hInfo.icon,
                         color: hInfo.color,
                         pop: hourly.precipitation_probability[i]
                     });
                 }
             }
             weatherData.hourly = hourlyList;

         } catch(e) { console.error(e); }
         finally { setTimeout(() => weatherLoading.value=false, 500); }
      };

      const exchange = reactive({ jpy: '', twd: '' });
      const currentRate = ref(0.218);
      const rateUpdateDate = ref('');
      
      const fetchExchangeRate = async () => {
         try {
            const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
            const data = await res.json();
            const marketRate = data.rates.TWD;
            
            // SIMULATE TAISHIN BANK CASH SELLING RATE (+0.002 spread)
            currentRate.value = marketRate + 0.002;
            
            rateUpdateDate.value = data.date;
         } catch(e) {
            console.error("Exchange rate fetch failed", e);
         }
      };
      
      const calcTwd = () => {
        if(!exchange.jpy) { exchange.twd = ''; return; }
        exchange.twd = parseFloat((exchange.jpy * currentRate.value).toFixed(2));
      };
      const calcJpy = () => {
        if(!exchange.twd) { exchange.jpy = ''; return; }
        exchange.jpy = parseFloat((exchange.twd / currentRate.value).toFixed(2));
      };

      const handleImageUpload = (e) => {
        const file = e.target.files[0];
        if(!file) return;

        const maxSize = 2 * 1024 * 1024; // 2MB

        if (file.size > maxSize) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const maxDim = 1280;
                    if (width > maxDim || height > maxDim) {
                        if (width > height) {
                            height = Math.round((height * maxDim) / width);
                            width = maxDim;
                        } else {
                            width = Math.round((width * maxDim) / height);
                            height = maxDim;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    formData.image = canvas.toDataURL('image/jpeg', 0.3);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        } else {
            const reader = new FileReader();
            reader.onload = (evt) => {
                formData.image = evt.target.result;
            };
            reader.readAsDataURL(file);
        }
      };
      
      const handleBannerUpload = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            bannerImage.value = evt.target.result;
            localStorage.setItem('trip_banner_image', evt.target.result);
        };
        reader.readAsDataURL(file);
      };

      const openMap = (name) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}`);

      const getCategoryLabel = (c) => ({attraction:'æ™¯é»',food:'ç¾é£Ÿ',shopping:'è³¼ç‰©',transport:'äº¤é€š',flight:'èˆªç­',accommodation:'ä½å®¿',other:'å…¶ä»–'}[c]||c);
      const getCategoryColor = (c) => ({attraction:'bg-red-100 text-red-500',food:'bg-orange-100 text-orange-500',shopping:'bg-pink-100 text-pink-500',flight:'bg-blue-100 text-blue-500', transport:'bg-green-100 text-green-600', accommodation:'bg-purple-100 text-purple-500'}[c]||'bg-gray-100 text-gray-500');
      const getExpenseIcon = (c) => ({food:'fa-solid fa-utensils',transport:'fa-solid fa-train',shopping:'fa-solid fa-bag-shopping',accommodation:'fa-solid fa-bed',ticket:'fa-solid fa-ticket'}[c]||'fa-solid fa-yen-sign');
      const getTransportIcon = (t) => t==='walk'?'fa-solid fa-person-walking':(t==='flight'?'fa-solid fa-plane':'fa-solid fa-train-subway');

      // --- AUTH & INIT ---
      onMounted(() => {
        setTimeout(() => showSplash.value = false, 3000);
        
        const savedBanner = localStorage.getItem('trip_banner_image');
        if(savedBanner) bannerImage.value = savedBanner;
        
        try {
            signInAnonymously(auth).then(async () => {
                subscribeCollection('itinerary', itineraryList);
                subscribeCollection('shopping', shoppingList);
                subscribeCollection('expenses', expenses);
                subscribeCollection('notebook', notebookList);
                subscribeCollection('packing', packingList);
                
                setTimeout(() => checkAndMigrateData(false), 1500);
                
                const d = days.find(x => x.dateStr === selectedDate.value);
                if(d && d.locations) changeWeatherCity(d.locations[0]);
                fetchExchangeRate();

            }).catch(err => {
                console.error("Auth failed", err);
                firebaseStatus.value = 'error';
                showSplash.value = false;
            });
        } catch(e) {
            console.error("Init failed", e);
            showSplash.value = false;
        }
      });

      return {
        showSplash, currentTab, tabs, bannerImage, handleImageError, daysUntilTrip,
        days, selectedDate, travelers, shoppingTravelers, packingPeople,
        
        // Data
        filteredItinerary, filteredShoppingList, expenses, totalExpense, filteredTotalExpense, notebookList, filteredPackingList, filteredExpenses, filteredNotebookList,
        currentShoppingFilter, currentPackingFilter, currentMemberFilter, currentNotebookFilter, notebookOwners, newPackingItem,
        
        // Actions
        openModal, closeModal, modal, formData, submitForm, deleteCurrentItem, isSaving,
        deleteShoppingItem, toggleShoppingCheck,
        addPackingItem, togglePackingCheck, deletePackingItem, deleteNote,
        updateItineraryContentOnly, 
        fixDuplicates, 
        checkAndMigrateData, 
        TRIP_ID, 

        // Utils
        weatherData, isWeatherExpanded, toggleWeather, weatherLoading, currentDayCities, changeWeatherCity,
        exchange, currentRate, calcTwd, calcJpy, rateUpdateDate,
        getCategoryLabel, getCategoryColor, getExpenseIcon, getTransportIcon, handleImageUpload, openMap,
        firebaseStatus, reconnectFirebase, migrationStatus,
        isTigerairInfoExpanded, isExchangeWarningExpanded, // Export new state
        handleBannerUpload,
        
        // Modal & Toast
        confirmState, toastState, handleConfirm
      };
    }
  }).mount('#app');
</script>
</body>
</html>
