<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>京阪之旅</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Zen Maru Gothic -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sakura: {
                            light: '#fff0f5',
                            DEFAULT: '#ffb7c5',
                            dark: '#ff8fab',
                            text: '#5d4037',
                        }
                    },
                    fontFamily: {
                        sans: ['"Zen Maru Gothic"', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(255, 183, 197, 0.4)',
                        'card': '0 2px 10px rgba(0,0,0,0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        body, button, input, select, textarea, h1, h2, h3, h4, h5, h6, span, p, div {
            font-family: 'Zen Maru Gothic', sans-serif;
        }

        body {
            background-color: #D0E7F5; /* 勿忘草色背景 */
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background-color: #fafafa;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            padding-bottom: 80px;
        }
        .weather-loading {
            animation: pulse-bg 1.5s infinite;
        }
        @keyframes pulse-bg {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
    </style>
</head>
<body>

<div id="app" class="app-container">
    
    <!-- 1. 頂部標題區 (Sticky 置頂) -->
    <div class="pt-6 pb-3 px-6 bg-white/95 backdrop-blur-sm sticky top-0 z-40 border-b border-gray-100 flex justify-between items-end shadow-sm">
        <div>
            <h1 class="text-2xl font-black tracking-widest text-sakura-text">京阪之旅</h1>
            <p class="text-xs text-gray-500 font-bold mt-1 tracking-wide">2026.04.02 - 04.06</p>
        </div>
        <div class="bg-sakura-light text-sakura-text text-[10px] px-2 py-1 rounded-lg font-bold border border-sakura/20">
            <i class="fa-regular fa-clock mr-1"></i>
            <span v-if="daysUntilTrip > 0">還有 {{ daysUntilTrip }} 天</span>
            <span v-else-if="daysUntilTrip === 0">就是今天！</span>
            <span v-else>Day {{ Math.abs(daysUntilTrip) + 1 }}</span>
        </div>
    </div>

    <!-- 2. 頁首 Banner -->
    <header class="relative h-[200px] w-full overflow-hidden bg-gray-200 group">
        <img 
            src="https://i.ibb.co/5gYDvnCj/Gemini-Generated-Image-b9cv82b9cv82b9cv.png" 
            alt="Sakura Banner" 
            class="w-full h-full object-cover object-[center_60%] transition-opacity duration-500"
            referrerpolicy="no-referrer"
        >
        <div class="absolute inset-0 bg-gradient-to-b from-transparent to-black/5 pointer-events-none"></div>
    </header>

    <main class="relative -mt-6 bg-[#fafafa] rounded-t-[30px] px-4 pt-6 min-h-[500px] z-10">
        
        <!-- === TAB 1: 行程表 === -->
        <div v-if="currentTab === 'itinerary'">
            <!-- 天氣區塊 -->
            <div class="bg-gradient-to-br from-blue-50 to-sakura-light/50 rounded-2xl mb-6 shadow-soft overflow-hidden relative">
                <div v-if="weatherLoading" class="absolute inset-0 bg-white/50 backdrop-blur-sm z-20 flex items-center justify-center">
                    <div class="text-sakura-dark animate-pulse flex flex-col items-center">
                        <i class="fa-solid fa-location-dot text-2xl mb-1"></i>
                        <span class="text-xs font-bold">更新天氣中...</span>
                    </div>
                </div>
                <div v-if="currentDayCities.length > 1" class="flex gap-2 px-4 pt-4 overflow-x-auto no-scrollbar z-10 relative">
                    <button v-for="city in currentDayCities" :key="city.name" @click="changeWeatherCity(city)" :class="['text-xs px-3 py-1.5 rounded-full border transition-all shadow-sm flex items-center gap-1', weatherData.city === city.name ? 'bg-white text-sakura-dark border-sakura/30 font-bold' : 'bg-white/40 text-gray-500 border-transparent hover:bg-white/60']">
                        <i class="fa-solid fa-location-dot text-[10px]" :class="weatherData.city === city.name ? 'text-sakura' : 'text-gray-400'"></i> {{ city.name }}
                    </button>
                </div>
                <div @click="toggleWeather" class="p-4 flex items-center justify-between cursor-pointer">
                    <div class="flex items-center gap-3">
                        <i :class="weatherData.icon" class="text-3xl" :style="{color: weatherData.iconColor}"></i>
                        <div>
                            <p class="text-sakura-text font-bold text-lg">{{ weatherData.city }} <i class="fa-solid fa-chevron-down text-xs ml-1 transition-transform" :class="{'rotate-180': isWeatherExpanded}"></i></p>
                            <p class="text-xs text-gray-500">{{ weatherData.description }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-3xl font-bold text-sakura-text">{{ weatherData.temp }}°C</p>
                        <p class="text-xs text-gray-500">體感 {{ weatherData.apparentTemp }}°C</p>
                    </div>
                </div>
                <div v-if="isWeatherExpanded" class="px-4 pb-4 animate-fade-in">
                    <div class="grid grid-cols-4 gap-2 bg-white/60 rounded-xl p-3 shadow-inner">
                        <div class="text-center"><p class="text-[10px] text-gray-400">濕度</p><p class="text-xs font-bold">{{ weatherData.humidity }}%</p></div>
                        <div class="text-center"><p class="text-[10px] text-gray-400">風速</p><p class="text-xs font-bold">{{ weatherData.windSpeed }}m/s</p></div>
                        <div class="text-center"><p class="text-[10px] text-gray-400">降雨</p><p class="text-xs font-bold">{{ weatherData.rain }}mm</p></div>
                        <div class="text-center"><p class="text-[10px] text-gray-400">紫外線</p><p class="text-xs font-bold">{{ weatherData.uvIndex }}</p></div>
                    </div>
                </div>
            </div>

            <!-- 日期選單 -->
            <div class="flex overflow-x-auto no-scrollbar gap-3 mb-4 pb-2 justify-center">
                <button v-for="(day, index) in days" :key="index" @click="selectedDate = day.dateStr" :class="['flex-shrink-0 flex flex-col items-center justify-center w-16 h-20 rounded-2xl transition-all', selectedDate === day.dateStr ? 'bg-sakura text-white shadow-soft transform scale-105' : 'bg-white text-gray-400 border border-gray-100']">
                    <span class="text-lg font-bold">{{ day.dayOfWeek }}</span>
                    <span class="text-sm">{{ day.displayDate }}</span>
                    <span v-if="selectedDate === day.dateStr" class="absolute bottom-1 text-[10px] opacity-80">{{ day.mainCity }}</span>
                </button>
            </div>

            <!-- 行程列表 -->
            <div class="space-y-4">
                <div v-for="(item, index) in filteredItinerary" :key="item.id" class="relative pl-4 border-l-2 border-sakura-light">
                    <div class="bg-white rounded-2xl p-4 shadow-card relative group border-l-4 border-sakura">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-xs px-2 py-1 rounded-full font-bold mb-2 inline-block" :class="getCategoryColor(item.category)">{{ getCategoryLabel(item.category) }}</span>
                            <span class="text-sm font-bold text-sakura-text bg-sakura-light px-2 py-1 rounded-lg">{{ item.time }}</span>
                        </div>
                        <h3 @click="openMap(item.name)" class="font-bold text-gray-800 text-lg mb-2 flex items-center gap-2 cursor-pointer">{{ item.name }} <i class="fa-solid fa-location-arrow text-xs text-sakura"></i></h3>
                        <div class="space-y-2">
                            <div v-if="item.description" class="text-xs bg-gray-50 p-3 rounded-lg border border-gray-100 leading-relaxed text-gray-500">
                                <p style="white-space: pre-line;">{{ item.description }}</p>
                            </div>
                            <!-- 備註：白色底, #3A8FB7 文字 -->
                            <p v-if="item.note" class="text-xs mt-2 flex items-center font-bold px-2 py-1.5 rounded-lg w-fit shadow-sm border border-gray-100" style="background-color: #ffffff; color: #3A8FB7;">
                                <i class="fa-solid fa-circle-exclamation mr-1"></i> {{ item.note }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- === TAB 2: 資訊 === -->
        <div v-if="currentTab === 'info'" class="space-y-6 pb-20">
            <!-- 匯率 -->
            <div class="bg-white rounded-2xl p-5 shadow-card">
                <h3 class="font-bold text-sakura-text mb-4 border-b pb-2 flex justify-between items-center">
                    <span><i class="fa-solid fa-coins mr-2 text-yellow-500"></i>匯率換算</span>
                </h3>
                <div class="flex items-center gap-4">
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 mb-1 block">日幣 (JPY)</label>
                        <input type="number" v-model="exchange.jpy" @input="calcTwd" class="w-full bg-gray-50 rounded-xl p-3 outline-none focus:ring-2 focus:ring-sakura" placeholder="¥">
                    </div>
                    <i class="fa-solid fa-arrow-right-arrow-left text-gray-300"></i>
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 mb-1 block">台幣 (TWD)</label>
                        <input type="number" v-model="exchange.twd" readonly class="w-full bg-sakura-light rounded-xl p-3 font-bold text-sakura-text" placeholder="NT$">
                    </div>
                </div>
            </div>
            <!-- 注意事項 -->
            <div class="bg-white rounded-2xl p-5 shadow-card border-l-4 border-yellow-400">
                <h3 class="font-bold text-gray-700 mb-3"><i class="fa-solid fa-lightbulb text-yellow-400 mr-2"></i>旅行溫馨提醒</h3>
                <ul class="text-xs text-gray-600 space-y-2 list-disc pl-4 font-bold">
                    <li>個人藥品請務必記得攜帶。</li>
                    <li>自由行每日約為20,000步以上，回飯店休息後別忘了讓腳好好休息唷!!</li>
                    <li>行程含SIM卡，不用再另外購買。</li>
                </ul>
            </div>
        </div>

        <!-- === TAB 3: 購物清單 (含篩選器) === -->
        <div v-if="currentTab === 'shopping'">
            
            <!-- 篩選器 UI -->
            <div class="flex gap-2 overflow-x-auto no-scrollbar mb-4 px-1">
                <button 
                    @click="shoppingFilter = null"
                    :class="['px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all border', !shoppingFilter ? 'bg-sakura text-white border-sakura shadow-md' : 'bg-white text-gray-400 border-gray-100']"
                >
                    全部
                </button>
                <button 
                    v-for="name in travelers" 
                    :key="name"
                    @click="shoppingFilter = name"
                    :class="['px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all border', shoppingFilter === name ? 'bg-sakura text-white border-sakura shadow-md' : 'bg-white text-gray-400 border-gray-100']"
                >
                    {{ name }}
                </button>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div v-for="(item, index) in filteredShoppingList" :key="index" class="bg-white rounded-2xl overflow-hidden shadow-card relative group">
                    <div class="h-32 bg-gray-100 relative overflow-hidden">
                        <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                        <div v-else class="w-full h-full flex items-center justify-center text-gray-300"><i class="fa-solid fa-image text-3xl"></i></div>
                        <button @click="deleteShoppingItem(index)" class="absolute top-1 right-1 bg-white/80 w-6 h-6 rounded-full text-red-400 text-xs flex items-center justify-center shadow-sm"><i class="fa-solid fa-xmark"></i></button>
                        <!-- 成員標籤 -->
                        <span class="absolute bottom-1 left-1 bg-black/50 text-white text-[10px] px-2 py-0.5 rounded-full backdrop-blur-sm">{{ item.owner }}</span>
                    </div>
                    <div class="p-3">
                        <h4 class="font-bold text-gray-700 text-sm truncate">{{ item.name }}</h4>
                        <div class="flex items-center gap-1 mt-2">
                             <input type="checkbox" v-model="item.bought" @change="saveShopping" class="accent-sakura w-4 h-4 rounded-full">
                             <span class="text-xs text-gray-500" :class="{'line-through': item.bought}">已購買</span>
                        </div>
                    </div>
                </div>
            </div>
            <div v-if="filteredShoppingList.length === 0" class="text-center py-10 text-gray-400"><i class="fa-solid fa-basket-shopping text-4xl mb-3 opacity-50"></i><p>這裡還沒有東西唷</p></div>
            <button @click="openModal('shopping')" class="fixed bottom-24 right-6 w-14 h-14 bg-sakura text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-sakura-dark transition-colors z-20"><i class="fa-solid fa-plus"></i></button>
        </div>

        <!-- === TAB 4: 花費 (含篩選器) === -->
        <div v-if="currentTab === 'expense'">
            
            <!-- 篩選器 UI -->
            <div class="flex gap-2 overflow-x-auto no-scrollbar mb-4 px-1">
                <button 
                    @click="expenseFilter = null"
                    :class="['px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all border', !expenseFilter ? 'bg-sakura text-white border-sakura shadow-md' : 'bg-white text-gray-400 border-gray-100']"
                >
                    全部加總
                </button>
                <button 
                    v-for="name in ['公費', ...travelers]" 
                    :key="name"
                    @click="expenseFilter = name"
                    :class="['px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all border', expenseFilter === name ? 'bg-sakura text-white border-sakura shadow-md' : 'bg-white text-gray-400 border-gray-100']"
                >
                    {{ name }}
                </button>
            </div>

            <!-- 總花費看板 (動態更新) -->
            <div class="bg-gradient-to-r from-sakura to-sakura-dark rounded-2xl p-6 text-white shadow-soft mb-6 text-center">
                <p class="text-sm opacity-90 mb-1">{{ expenseFilter || '合計' }} 的支出 (JPY)</p>
                <h2 class="text-4xl font-bold font-mono">¥ {{ filteredTotalExpense.toLocaleString() }}</h2>
                <p class="text-xs opacity-70 mt-2">約 TWD {{ Math.round(filteredTotalExpense * 0.218).toLocaleString() }}</p>
            </div>

            <div class="bg-white rounded-t-2xl shadow-card min-h-[300px]">
                <div v-for="(item, index) in filteredExpenses" :key="index" class="p-4 border-b border-gray-50 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-lg"><i :class="getExpenseIcon(item.category)" class="text-sakura-dark"></i></div>
                        <div>
                            <h4 class="font-bold text-gray-800">{{ item.name }}</h4>
                            <p class="text-xs text-gray-400">{{ item.date }} · <span class="bg-sakura-light text-sakura-dark px-1 rounded">{{ item.owner }}</span></p>
                        </div>
                    </div>
                    <div class="text-right"><p class="font-bold text-gray-800 font-mono">¥{{ Number(item.amount).toLocaleString() }}</p><button @click="deleteExpense(index)" class="text-xs text-red-300 mt-1">刪除</button></div>
                </div>
                <div v-if="filteredExpenses.length === 0" class="text-center py-10 text-gray-400 text-sm">無相關紀錄</div>
            </div>
            <button @click="openModal('expense')" class="fixed bottom-24 right-6 w-14 h-14 bg-sakura text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-sakura-dark transition-colors z-20"><i class="fa-solid fa-plus"></i></button>
        </div>
    </main>

    <!-- 底部導航 Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 flex justify-around items-center h-20 px-2 pb-2 rounded-t-[20px] shadow-[0_-5px_20px_rgba(0,0,0,0.03)] z-40 max-w-[480px] mx-auto">
        <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" class="flex flex-col items-center justify-center w-16 h-16">
            <div class="w-10 h-6 flex items-center justify-center rounded-full mb-1 transition-all" :class="currentTab === tab.id ? 'bg-sakura-light text-sakura-dark' : 'text-gray-400'"><i :class="tab.icon" class="text-lg"></i></div>
            <span class="text-[10px] font-bold" :class="currentTab === tab.id ? 'text-sakura-text' : 'text-gray-400'">{{ tab.name }}</span>
        </button>
    </nav>

    <!-- Modal -->
    <div v-if="modal.show" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center animate-fade-in">
        <div class="bg-white w-full max-w-[480px] rounded-t-[20px] p-6 shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-sakura-text">{{ modal.title }}</h3><button @click="closeModal" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            
            <div v-if="modal.type === 'shopping'" class="space-y-4">
                <div><label class="block text-xs font-bold text-gray-500 mb-1">是誰要買的？</label>
                    <select v-model="formData.owner" class="w-full bg-gray-50 rounded-xl p-3 border outline-none">
                        <option v-for="name in travelers" :value="name">{{ name }}</option>
                    </select>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">商品名稱</label><input type="text" v-model="formData.name" class="w-full bg-gray-50 rounded-xl p-3 border focus:border-sakura outline-none" placeholder="例：合利他命"></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">圖片</label><div class="relative w-full h-32 bg-gray-100 rounded-xl flex items-center justify-center border-2 border-dashed border-gray-300 overflow-hidden"><input type="file" @change="handleImageUpload" class="absolute inset-0 opacity-0 cursor-pointer"><img v-if="formData.image" :src="formData.image" class="w-full h-full object-cover"><div v-else class="text-center text-gray-400"><i class="fa-solid fa-camera mb-1"></i><p class="text-xs">點擊上傳圖片</p></div></div></div>
            </div>

            <div v-if="modal.type === 'expense'" class="space-y-4">
                <div><label class="block text-xs font-bold text-gray-500 mb-1">付款人</label>
                    <select v-model="formData.owner" class="w-full bg-gray-50 rounded-xl p-3 border outline-none">
                        <option v-for="name in ['公費', ...travelers]" :value="name">{{ name }}</option>
                    </select>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">日期</label><select v-model="formData.date" class="w-full bg-gray-50 rounded-xl p-3"><option v-for="day in days" :value="day.dateStr">{{ day.displayDate }}</option></select></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">類別</label><select v-model="formData.category" class="w-full bg-gray-50 rounded-xl p-3"><option value="transport">交通</option><option value="food">飲食</option><option value="shopping">購物</option><option value="other">其他</option></select></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">名稱</label><input type="text" v-model="formData.name" class="w-full bg-gray-50 rounded-xl p-3 border focus:border-sakura outline-none" placeholder="例：拉麵"></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">金額 (JPY)</label><input type="number" v-model="formData.amount" class="w-full bg-gray-50 rounded-xl p-3 border focus:border-sakura outline-none"></div>
            </div>

            <button @click="submitForm" class="w-full bg-sakura text-white font-bold py-4 rounded-xl mt-6 shadow-soft hover:bg-sakura-dark transition-colors">確認新增</button>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, reactive, onMounted, watch } = Vue;

    createApp({
        setup() {
            const currentTab = ref('itinerary');
            const tabs = [
                { id: 'itinerary', name: '行程表', icon: 'fa-solid fa-map-location-dot' },
                { id: 'info', name: '資訊', icon: 'fa-solid fa-circle-info' },
                { id: 'shopping', name: '購物清單', icon: 'fa-solid fa-basket-shopping' },
                { id: 'expense', name: '花費', icon: 'fa-solid fa-yen-sign' },
            ];

            const bannerImage = 'https://i.ibb.co/5gYDvnCj/Gemini-Generated-Image-b9cv82b9cv82b9cv.png';
            const travelers = ref(['翔', '倫', '茹', '萍']);

            // 篩選器狀態
            const shoppingFilter = ref(null);
            const expenseFilter = ref(null);

            const days = [
                { dateStr: '2026-04-02', displayDate: '4/2', dayOfWeek: '週四', mainCity: '大阪市', lat: 34.6937, lng: 135.5023 },
                { dateStr: '2026-04-03', displayDate: '4/3', dayOfWeek: '週五', mainCity: '奈良/京都', lat: 34.6851, lng: 135.8048 },
                { dateStr: '2026-04-04', displayDate: '4/4', dayOfWeek: '週六', mainCity: '京都市', lat: 35.0116, lng: 135.7681 },
                { dateStr: '2026-04-05', displayDate: '4/5', dayOfWeek: '週日', mainCity: '大阪市', lat: 34.6937, lng: 135.5023 },
                { dateStr: '2026-04-06', displayDate: '4/6', dayOfWeek: '週一', mainCity: '大阪市', lat: 34.6937, lng: 135.5023 },
            ];
            const selectedDate = ref('2026-04-02');
            const tripStartDate = new Date('2026-04-02T00:00:00');
            const daysUntilTrip = computed(() => {
                const diff = tripStartDate - new Date();
                return Math.ceil(diff / 86400000);
            });

            // 天氣邏輯
            const isWeatherExpanded = ref(false);
            const weatherLoading = ref(true);
            const weatherData = reactive({ temp: '--', apparentTemp: '--', humidity: '--', windSpeed: '--', rain: '--', uvIndex: '--', description: '載入中...', icon: 'fa-solid fa-spinner', iconColor: '#ccc', city: '' });
            const toggleWeather = () => isWeatherExpanded.value = !isWeatherExpanded.value;
            const currentDayCities = computed(() => [days.find(d => d.dateStr === selectedDate.value)]);
            const fetchWeather = async (lat, lng, cityName) => {
                weatherLoading.value = true;
                weatherData.city = cityName;
                try {
                    const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,weather_code,wind_speed_10m&timezone=Asia%2FTokyo`);
                    const data = await response.json();
                    const cur = data.current;
                    weatherData.temp = Math.round(cur.temperature_2m);
                    weatherData.apparentTemp = Math.round(cur.apparent_temperature);
                    weatherData.humidity = cur.relative_humidity_2m;
                    weatherData.windSpeed = cur.wind_speed_10m;
                    weatherData.rain = cur.precipitation;
                    weatherData.description = cur.weather_code === 0 ? '晴朗' : '多雲時晴';
                    weatherData.icon = cur.weather_code === 0 ? 'fa-solid fa-sun' : 'fa-solid fa-cloud-sun';
                    weatherData.iconColor = '#fbbf24';
                    weatherData.uvIndex = '中';
                } catch { weatherData.description = "無法讀取天氣"; }
                finally { setTimeout(() => weatherLoading.value = false, 300); }
            };
            const changeWeatherCity = (c) => fetchWeather(c.lat, c.lng, c.mainCity);
            watch(selectedDate, (val) => { const d = days.find(x => x.dateStr === val); fetchWeather(d.lat, d.lng, d.mainCity); });
            onMounted(() => { const d = days[0]; fetchWeather(d.lat, d.lng, d.mainCity); });

            // 行程資料
            const initialItinerary = [
                { id: 1, date: '2026-04-02', category: 'flight', name: '航班 IT-284', time: '07:00', description: '高雄 -> 關西', note: '已事先購票' },
                { id: 2, date: '2026-04-02', category: 'accommodation', name: '飯店寄放行李', time: '13:00', description: '東急 STAY 大阪本町', note: '飯店可先寄放' },
                { id: 3, date: '2026-04-03', category: 'attraction', name: '奈良公園', time: '09:10', description: '餵鹿', note: '鹿仙貝 ¥200' }
            ];
            const itineraryList = ref(JSON.parse(localStorage.getItem('sakura_itinerary')) || initialItinerary);
            const filteredItinerary = computed(() => itineraryList.value.filter(i => i.date === selectedDate.value).sort((a,b)=>a.time.localeCompare(b.time)));

            // 購物清單 (含篩選)
            const shoppingList = ref(JSON.parse(localStorage.getItem('sakura_shopping')) || []);
            const filteredShoppingList = computed(() => {
                if (!shoppingFilter.value) return shoppingList.value;
                return shoppingList.value.filter(item => item.owner === shoppingFilter.value);
            });
            const deleteShoppingItem = (i) => { shoppingList.value.splice(i, 1); saveShopping(); };
            const saveShopping = () => localStorage.setItem('sakura_shopping', JSON.stringify(shoppingList.value));

            // 花費 (含篩選)
            const expenses = ref(JSON.parse(localStorage.getItem('sakura_expenses')) || []);
            const filteredExpenses = computed(() => {
                if (!expenseFilter.value) return expenses.value;
                return expenses.value.filter(item => item.owner === expenseFilter.value);
            });
            const filteredTotalExpense = computed(() => filteredExpenses.value.reduce((s, i) => s + Number(i.amount), 0));
            const totalExpense = computed(() => expenses.value.reduce((s, i) => s + Number(i.amount), 0));
            const deleteExpense = (i) => { expenses.value.splice(i, 1); localStorage.setItem('sakura_expenses', JSON.stringify(expenses.value)); };

            // 匯率
            const exchange = reactive({ jpy: '', twd: '' });
            const calcTwd = () => exchange.twd = Math.round(exchange.jpy * 0.218);
            
            // Modal
            const modal = reactive({ show: false, type: '', title: '' });
            const formData = reactive({ name: '', owner: '翔', amount: '', category: 'food', date: '2026-04-02', image: '' });
            
            const openModal = (type) => { 
                modal.type = type; 
                modal.show = true; 
                modal.title = type === 'shopping' ? '新增購物清單' : '新增花費紀錄';
                formData.owner = travelers.value[0];
                formData.date = selectedDate.value;
            };
            const closeModal = () => modal.show = false;
            
            const submitForm = () => {
                if (modal.type === 'shopping') { 
                    shoppingList.value.push({ ...formData, bought: false }); 
                    saveShopping(); 
                } else { 
                    expenses.value.push({ ...formData }); 
                    localStorage.setItem('sakura_expenses', JSON.stringify(expenses.value)); 
                }
                closeModal();
                formData.name = ''; formData.image = ''; formData.amount = '';
            };

            const handleImageUpload = (e) => { 
                const f = e.target.files[0]; 
                const reader = new FileReader(); 
                reader.onload = (ev) => formData.image = ev.target.result; 
                reader.readAsDataURL(f); 
            };

            const openMap = (k) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(k)}`, '_blank');
            const getCategoryLabel = (c) => ({ attraction: '景點', accommodation: '住宿', transport: '交通', flight: '航班' }[c] || '其他');
            const getCategoryColor = (c) => ({ attraction: 'bg-red-100 text-red-500', transport: 'bg-green-100 text-green-600' }[c] || 'bg-blue-100 text-blue-500');
            const getExpenseIcon = (cat) => `fa-solid ${{ transport: 'fa-train', food: 'fa-utensils', shopping: 'fa-bag-shopping' }[cat] || 'fa-circle'}`;

            return { 
                currentTab, tabs, bannerImage, travelers, days, selectedDate, daysUntilTrip, 
                weatherLoading, weatherData, isWeatherExpanded, toggleWeather, currentDayCities, changeWeatherCity, 
                filteredItinerary, shoppingList, filteredShoppingList, shoppingFilter, deleteShoppingItem, saveShopping, 
                expenses, filteredExpenses, expenseFilter, filteredTotalExpense, totalExpense, deleteExpense, 
                exchange, calcTwd, modal, formData, openModal, closeModal, submitForm, handleImageUpload, 
                openMap, getCategoryLabel, getCategoryColor, getExpenseIcon 
            };
        }
    }).mount('#app');
</script>

<style>
    @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .animate-slide-up { animation: slide-up 0.3s ease-out forwards; }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }
</style>
</body>
</html>