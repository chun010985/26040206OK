<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>京阪行程</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
</head>
<body class="bg-gray-100">

<div id="app" class="max-w-md mx-auto p-4">

  <!-- Splash -->
  <div v-if="showSplash" class="fixed inset-0 bg-white flex items-center justify-center z-50">
    <div class="text-xl font-bold">載入中…</div>
  </div>

  <!-- Tabs -->
  <div class="flex gap-2 mb-4">
    <button
      v-for="t in tabs"
      :key="t.id"
      class="px-3 py-1 rounded text-sm"
      :class="currentTab === t.id ? 'bg-blue-500 text-white' : 'bg-white'"
      @click="currentTab = t.id"
    >
      <i :class="t.icon"></i> {{ t.name }}
    </button>
  </div>

  <!-- 行程 -->
  <div v-if="currentTab === 'itinerary'">
    <div
      v-for="item in itineraryList"
      :key="item.id"
      class="bg-white p-2 rounded mb-2"
    >
      <div class="font-bold">{{ item.time }} {{ item.title }}</div>
      <div class="text-sm text-gray-600">{{ item.note }}</div>
    </div>
  </div>

  <!-- 購物 -->
  <div v-if="currentTab === 'shopping'">
    <div
      v-for="item in shoppingList"
      :key="item.id"
      class="bg-white p-2 rounded mb-2"
    >
      {{ item.name }}
    </div>
  </div>

  <!-- 花費 -->
  <div v-if="currentTab === 'expense'">
    <div
      v-for="item in expenses"
      :key="item.id"
      class="bg-white p-2 rounded mb-2"
    >
      {{ item.name }} - ¥{{ item.amount }}
    </div>
  </div>

  <!-- 筆記 -->
  <div v-if="currentTab === 'notebook'">
    <div
      v-for="item in notebookList"
      :key="item.id"
      class="bg-white p-2 rounded mb-2"
    >
      {{ item.text }}
    </div>
  </div>

  <!-- 雲端狀態 -->
  <div class="text-xs text-gray-500 mt-4">
    {{ cloudSync.message }}
  </div>

</div>

<script>
const { createApp, ref, reactive, onMounted } = Vue;

createApp({
  setup() {

    /* ===== 基本 ===== */
    const showSplash = ref(true);
    const currentTab = ref('itinerary');

    const tabs = [
      { id: 'itinerary', name: '行程', icon: 'fa-solid fa-map' },
      { id: 'shopping', name: '購物', icon: 'fa-solid fa-basket-shopping' },
      { id: 'expense', name: '花費', icon: 'fa-solid fa-yen-sign' },
      { id: 'notebook', name: '筆記', icon: 'fa-solid fa-book' },
    ];

    /* ===== localStorage ===== */
    const load = (k, d) => JSON.parse(localStorage.getItem(k)) || d;
    const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    const itineraryList = ref(load('sakura_itinerary_v14', []));
    const shoppingList  = ref(load('sakura_shopping', []));
    const expenses      = ref(load('sakura_expenses', []));
    const notebookList  = ref(load('sakura_notebook', []));

    /* ===== 補 ID ===== */
    const ensureIds = (list, key) => {
      let changed = false;
      list.value.forEach((i, idx) => {
        if (!i.id) {
          i.id = Date.now() + idx + Math.random();
          changed = true;
        }
      });
      if (changed) save(key, list.value);
    };

    /* ===== 雲端 ===== */
    const cloudSync = reactive({
      state: 'idle',
      message: '尚未同步'
    });

    let isHydratingFromCloud = false;

    const applyCloudToLocal = (cloud) => {
      if (!cloud || !Array.isArray(cloud.itinerary) || cloud.itinerary.length === 0) return;
      itineraryList.value = cloud.itinerary;
      shoppingList.value  = cloud.shopping  || [];
      expenses.value      = cloud.expenses  || [];
      notebookList.value  = cloud.notebook  || [];
      save('sakura_itinerary_v14', itineraryList.value);
      save('sakura_shopping', shoppingList.value);
      save('sakura_expenses', expenses.value);
      save('sakura_notebook', notebookList.value);
    };

    const pullFromCloudOnce = async () => {
      if (!window.__CLOUD_GET_STATE__) return;
      isHydratingFromCloud = true;
      cloudSync.message = '從雲端讀取中…';
      try {
        const cloud = await window.__CLOUD_GET_STATE__();
        applyCloudToLocal(cloud);
        cloudSync.message = '已同步';
      } catch {
        cloudSync.message = '雲端讀取失敗';
      } finally {
        setTimeout(() => isHydratingFromCloud = false, 300);
      }
    };

    /* ===== onMounted（只此一個） ===== */
    onMounted(async () => {
      setTimeout(() => showSplash.value = false, 1500);

      ensureIds(shoppingList, 'sakura_shopping');
      ensureIds(expenses, 'sakura_expenses');
      ensureIds(notebookList, 'sakura_notebook');

      await pullFromCloudOnce();
    });

    return {
      showSplash,
      currentTab,
      tabs,
      itineraryList,
      shoppingList,
      expenses,
      notebookList,
      cloudSync
    };
  }
}).mount('#app');
</script>

</body>
</html>
