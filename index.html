<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>äº¬é˜ªä¹‹æ—…</title>

  <!-- 1. å…¨å±€éŒ¯èª¤æ””æˆªèˆ‡å¼·åˆ¶æ•‘æ´ (æœ€å„ªå…ˆåŸ·è¡Œ) -->
  <script>
    window.addEventListener('error', function(e) {
      console.error("Global Error:", e.error);
      setTimeout(() => {
        const splash = document.getElementById('splash-screen');
        if (splash) splash.style.display = 'none';
      }, 1000);
    });

    // 4ç§’å¾Œå¼·åˆ¶é€²å…¥ï¼Œé˜²æ­¢æ°¸ä¹…å¡æ­»
    setTimeout(() => {
      const splash = document.getElementById('splash-screen');
      if (splash && splash.style.display !== 'none') {
        splash.style.display = 'none';
      }
    }, 4000);
  </script>

  <!-- å„ªåŒ–é€£ç·š -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 2. Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
  <!-- Vue 3 (Global Build) -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            sakura: { light: '#fff0f5', DEFAULT: '#ffb7c5', dark: '#2EA9DF', text: '#5d4037' }
          },
          fontFamily: { sans: ['"Zen Maru Gothic"', 'sans-serif'] },
          boxShadow: { 'soft': '0 4px 20px -2px rgba(255, 183, 197, 0.4)', 'card': '0 2px 10px rgba(0,0,0,0.05)' },
          animation: {
            'float': 'float 3s ease-in-out infinite',
            'fade-in': 'fadeIn 0.3s ease-out forwards',
            'slide-up': 'slideUp 0.3s ease-out forwards',
            'fall-1': 'fall-sway-1 6s linear infinite',
          },
          keyframes: {
            float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
            'fall-sway-1': {
              '0%': { top: '-10%', left: 'var(--start-left)', transform: 'rotate(0deg) translateX(0)', opacity: '0' },
              '10%': { opacity: '0.8' },
              '50%': { transform: 'rotate(180deg) translateX(20px)' },
              '100%': { top: '110%', left: 'calc(var(--start-left) + 10%)', transform: 'rotate(360deg) translateX(-20px)', opacity: '0' }
            }
          }
        }
      }
    }
  </script>

  <style>
    body { background-color: #fff0f5; -webkit-tap-highlight-color: transparent; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .app-container { max-width: 480px; margin: 0 auto; background-color: #fafafa; min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.05); padding-bottom: 80px; }
    .sakura-petal { position: absolute; background-color: #ffb7c5; border-radius: 100% 0 100% 0; opacity: 0; top: -20px; }
    .blur-sm { filter: blur(1px); }
  </style>
</head>

<body>
<div id="app" class="app-container">

  <!-- Splash -->
  <div id="splash-screen" v-if="showSplash" class="fixed inset-0 z-[100] bg-gradient-to-b from-[#fff0f5] to-white flex flex-col items-center justify-center overflow-hidden transition-opacity duration-700">
    <div class="absolute inset-0 pointer-events-none z-10 w-full h-full overflow-hidden">
      <span class="sakura-petal w-4 h-4 animate-fall-1" style="--start-left: 10%; animation-duration: 6s;"></span>
      <span class="sakura-petal w-5 h-5 animate-fall-1" style="--start-left: 70%; animation-duration: 8s; animation-delay: 1s;"></span>
    </div>
    <div class="relative z-10 text-center animate-float">
      <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mx-auto mb-6 shadow-soft border-4 border-white">
        <i class="fa-solid fa-plane-departure text-4xl text-sakura-dark"></i>
      </div>
      <h1 class="text-4xl font-black text-sakura-text tracking-[0.3em] mb-3 ml-2">äº¬é˜ªä¹‹æ—…</h1>
      <div class="inline-block px-4 py-1 bg-white/60 rounded-full backdrop-blur-sm mt-2">
        <p class="text-sm font-bold text-sakura-dark tracking-widest">READY FOR TRIP</p>
      </div>
    </div>
    <div class="absolute bottom-12 text-sakura-text/50 text-xs font-bold animate-pulse text-center w-full">
      <span v-if="migrationStatus">{{ migrationStatus }}</span>
      <span v-else>æ­£åœ¨å‰µé€ ç¾å¥½å›æ†¶...</span>
    </div>
  </div>

  <!-- Header -->
  <header class="relative h-[250px] w-full overflow-hidden bg-gray-200 group">
    <img :src="bannerImage" class="w-full h-full object-cover transition-opacity duration-500" @error="handleImageError">
    <div class="absolute top-4 right-4 bg-white/70 backdrop-blur-md px-3 py-1.5 rounded-full text-sakura-text text-xs border border-white/50 shadow-sm flex items-center gap-2 z-20">
      <i class="fa-regular fa-clock"></i>
      <span v-if="daysUntilTrip > 0">è·é›¢å‡ºç™¼é‚„æœ‰ <b>{{ daysUntilTrip }}</b> å¤©</span>
      <span v-else-if="daysUntilTrip >= -3">æ—…ç¨‹ç¬¬ {{ Math.abs(daysUntilTrip) + 1 }} å¤©</span>
      <span v-else-if="daysUntilTrip === -4">æ—…ç¨‹çµæŸï¼Œå¹³å®‰è¿”å®¶ ğŸ </span>
      <span v-else>æ—…ç¨‹å·²åœ“æ»¿çµæŸ</span>
    </div>
    <div class="absolute top-6 left-6 z-10 bg-white p-3 rounded-2xl border border-white/40 shadow-sm">
      <h1 class="text-3xl font-bold tracking-widest text-sakura-text">äº¬é˜ªä¹‹æ—…</h1>
      <p class="text-sm opacity-90 text-sakura-text/80">2026.04.02 - 04.06</p>
    </div>
  </header>

  <main class="relative -mt-10 bg-[#fafafa] rounded-t-[40px] px-4 pt-4 min-h-[500px] z-10">

    <!-- Cloud Status -->
    <div class="fixed top-4 left-4 z-50 flex items-center gap-2" @click="reconnectFirebase">
      <div class="w-3 h-3 rounded-full shadow-[0_0_8px_rgba(0,0,0,0.2)] border border-white transition-all duration-500"
           :class="isSaving ? 'bg-yellow-400 animate-pulse' : (firebaseStatus === 'error' ? 'bg-red-500' : (firebaseStatus === 'connected' ? 'bg-green-400' : 'bg-yellow-400'))">
      </div>
      <span v-if="isSaving || migrationStatus" class="text-[10px] bg-white/90 backdrop-blur px-2 py-0.5 rounded-full text-gray-600 font-bold shadow-sm border border-gray-100">
        {{ migrationStatus || 'åŒæ­¥ä¸­...' }}
      </span>
    </div>

    <!-- TAB 1: Itinerary -->
    <div v-if="currentTab === 'itinerary'">
      <!-- Weather Card -->
      <div class="relative bg-white rounded-3xl p-5 shadow-[0_8px_30px_rgba(0,0,0,0.04)] mb-5 border border-gray-50 overflow-hidden group transition-all duration-300">
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-gradient-to-br from-sakura-light to-blue-50 rounded-full blur-3xl opacity-50 pointer-events-none"></div>
        
        <div v-if="weatherLoading" class="absolute inset-0 bg-white/80 backdrop-blur-md z-30 flex items-center justify-center rounded-3xl">
          <div class="text-sakura-dark animate-pulse flex flex-col items-center gap-1">
            <i class="fa-solid fa-cloud-sun text-4xl animate-bounce"></i>
            <span class="text-xs font-bold tracking-widest uppercase mt-1">Loading Weather</span>
          </div>
        </div>

        <div v-if="currentDayCities.length > 1" class="flex justify-end gap-1.5 mb-1 relative z-20 overflow-x-auto no-scrollbar pb-1">
          <button v-for="city in currentDayCities" :key="city.name" @click.stop="changeWeatherCity(city)"
            :class="['text-[10px] px-2.5 py-1 rounded-full font-bold transition-all border shadow-sm', weatherData.city === city.name ? 'bg-sakura text-white border-sakura ring-1 ring-sakura/20' : 'bg-white text-gray-400 border-gray-100 hover:bg-gray-50']">
            {{ city.name }}
          </button>
        </div>

        <div @click="toggleWeather" class="relative z-10 cursor-pointer pt-1">
          <div class="flex justify-between items-center">
            <div class="pl-2">
              <div class="flex items-center gap-2 mb-0.5">
                <h2 class="text-xl font-black text-gray-800 tracking-tight">{{ weatherData.city }}</h2>
                <span class="px-2 py-0.5 bg-gray-100 rounded-md text-xs font-bold text-gray-500 flex items-center gap-1">
                  <i class="fa-solid fa-circle text-[6px]" :style="{color: weatherData.iconColor}"></i>
                  {{ weatherData.description }}
                </span>
              </div>
              <div class="flex items-end h-12">
                <span class="text-5xl font-black text-gray-800 tracking-tighter leading-none -ml-0.5">{{ weatherData.temp }}Â°</span>
                <div class="ml-3 flex flex-col justify-center text-xs font-bold text-gray-400 leading-tight border-l border-gray-200 pl-2 h-8">
                  <span class="flex items-center gap-1 mb-0.5"><i class="fa-solid fa-arrow-up text-red-300"></i>{{ weatherData.maxTemp }}Â°</span>
                  <span class="flex items-center gap-1"><i class="fa-solid fa-arrow-down text-blue-300"></i>{{ weatherData.minTemp }}Â°</span>
                </div>
              </div>
              <p class="text-xs text-gray-400 mt-1 font-medium pl-0.5">é«”æ„Ÿ {{ weatherData.apparentTemp }}Â°C</p>
            </div>
            <div class="w-14 h-14 flex items-center justify-center animate-float mr-1">
              <i :class="weatherData.icon" class="text-5xl drop-shadow-md transition-all duration-500" :style="{color: weatherData.iconColor}"></i>
            </div>
          </div>
          <div class="flex justify-center -mt-1 opacity-30 group-hover:opacity-100 transition-opacity">
            <i class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-300 text-xs" :class="{'rotate-180': isWeatherExpanded}"></i>
          </div>
        </div>

        <div v-if="isWeatherExpanded" class="mt-2 pt-2 border-t border-gray-100 animate-fade-in relative z-10">
          <div class="mb-2 bg-gradient-to-r from-sakura-light/30 to-white border border-sakura-light/40 rounded-xl p-2.5 shadow-sm flex gap-2.5 items-start">
            <div class="w-6 h-6 rounded-full bg-white text-sakura-dark flex items-center justify-center shrink-0 shadow-sm text-xs mt-0.5"><i class="fa-solid fa-shirt"></i></div>
            <div>
              <h5 class="text-[10px] font-bold text-sakura-dark mb-0.5 tracking-wider uppercase">Outfit Advice</h5>
              <p class="text-xs text-gray-600 font-medium leading-relaxed">{{ weatherData.clothing }}</p>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2 mb-2">
            <div class="bg-gray-50 rounded-xl p-2 flex items-center gap-2 border border-gray-100">
              <div class="w-7 h-7 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center text-xs"><i class="fa-solid fa-droplet"></i></div>
              <div><div class="text-[10px] text-gray-400 font-bold uppercase leading-none mb-0.5">æ¿•åº¦</div><div class="text-sm font-black text-gray-700 leading-none">{{ weatherData.humidity }}%</div></div>
            </div>
            <div class="bg-gray-50 rounded-xl p-2 flex items-center gap-2 border border-gray-100">
              <div class="w-7 h-7 rounded-full bg-indigo-100 text-indigo-500 flex items-center justify-center text-xs"><i class="fa-solid fa-wind"></i></div>
              <div><div class="text-[10px] text-gray-400 font-bold uppercase leading-none mb-0.5">é¢¨é€Ÿ</div><div class="text-sm font-black text-gray-700 leading-none">{{ weatherData.windSpeed }} <span class="text-[10px] font-normal">m/s</span></div></div>
            </div>
            <div class="bg-gray-50 rounded-xl p-2 flex items-center gap-2 border border-gray-100">
              <div class="w-7 h-7 rounded-full bg-cyan-100 text-cyan-500 flex items-center justify-center text-xs"><i class="fa-solid fa-umbrella"></i></div>
              <div><div class="text-[10px] text-gray-400 font-bold uppercase leading-none mb-0.5">é™é›¨</div><div class="text-sm font-black text-gray-700 leading-none">{{ weatherData.rain }} <span class="text-[10px] font-normal">mm</span></div></div>
            </div>
            <div class="bg-gray-50 rounded-xl p-2 flex items-center gap-2 border border-gray-100">
              <div class="w-7 h-7 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center text-xs"><i class="fa-solid fa-sun"></i></div>
              <div><div class="text-[10px] text-gray-400 font-bold uppercase leading-none mb-0.5">ç´«å¤–ç·š</div><div class="text-sm font-black text-gray-700 leading-none">{{ weatherData.uvIndex }}</div></div>
            </div>
          </div>

          <div class="flex justify-between items-center bg-gray-50 rounded-full px-3 py-1.5 border border-gray-100 mb-3">
            <div class="flex items-center gap-1.5"><i class="fa-regular fa-sun text-orange-400 text-xs"></i><span class="text-xs font-bold text-gray-600">{{ weatherData.sunrise }}</span></div>
            <div class="h-1 flex-1 mx-3 bg-gradient-to-r from-orange-200 to-indigo-200 rounded-full relative"><div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 bg-white border border-orange-300 rounded-full shadow-sm"></div></div>
            <div class="flex items-center gap-1.5"><span class="text-xs font-bold text-gray-600">{{ weatherData.sunset }}</span><i class="fa-regular fa-moon text-indigo-400 text-xs"></i></div>
          </div>

          <div v-if="weatherData.forecast && weatherData.forecast.length > 0" class="border-t border-gray-100 pt-2">
            <div class="flex justify-between gap-2">
              <div v-for="day in weatherData.forecast" :key="day.dayName" class="flex-1 bg-gray-50 rounded-xl p-2 flex flex-col items-center border border-transparent hover:border-sakura-light transition-colors">
                <span class="text-[10px] text-gray-400 font-bold mb-1">{{ day.dayName }}</span>
                <i :class="day.icon" class="text-lg mb-1" :style="{color: day.color}"></i>
                <div class="flex items-center text-xs font-black text-gray-700">{{ day.max }}Â° <span class="text-[9px] text-gray-400 font-normal ml-0.5">/{{ day.min }}Â°</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Dates -->
      <div class="flex overflow-x-auto no-scrollbar gap-3 mb-4 pb-2 justify-center">
        <button v-for="(day, index) in days" :key="index" @click="selectedDate = day.dateStr"
          :class="['flex-shrink-0 flex flex-col items-center justify-center w-16 h-20 rounded-2xl transition-all duration-300 relative overflow-hidden', selectedDate === day.dateStr ? 'bg-sakura text-white shadow-soft transform scale-105' : 'bg-white text-gray-400 border border-gray-100']">
          <span class="text-lg font-bold z-10">{{ day.dayOfWeek }}</span>
          <span class="text-sm z-10">{{ day.displayDate }}</span>
          <span v-if="selectedDate === day.dateStr" class="absolute bottom-1 text-[10px] opacity-80 z-10">{{ day.mainCity.split('/')[0] }}</span>
        </button>
      </div>

      <!-- Itinerary list (Read Only) -->
      <div class="space-y-4">
        <div v-for="(item, index) in filteredItinerary" :key="item.id" class="relative pl-4 border-l-2 border-sakura-light">
          <div class="bg-white rounded-2xl p-4 shadow-card relative group"
               :class="{'border-l-4 border-sakura': item.category !== 'flight', 'bg-blue-50 border-l-4 border-blue-400': item.category === 'flight'}">
            
            <div v-if="item.category === 'flight'">
              <div class="flex justify-between items-start mb-2">
                <span class="bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full font-bold"><i class="fa-solid fa-plane-departure mr-1"></i>èˆªç­</span>
                <span class="text-xs text-gray-500 font-bold">{{ item.time }}</span>
              </div>
              <h3 class="font-bold text-gray-800 text-lg mb-1">{{ item.name }}</h3>
              <div class="text-sm text-gray-600 space-y-1"><p>{{ item.note }}</p></div>
              <div v-if="item.description" class="text-xs text-gray-400 mt-1">{{ item.description }}</div>
            </div>

            <div v-else>
              <div class="flex justify-between items-start mb-1">
                <div class="flex items-center gap-2 mb-2 flex-wrap">
                  <span :class="['text-xs px-2 py-1 rounded-full font-bold inline-block', getCategoryColor(item.category)]">{{ getCategoryLabel(item.category) }}</span>
                  <span v-if="item.travelTime > 0" class="text-[10px] text-gray-400 flex items-center bg-gray-50 px-2 py-1 rounded-full border border-gray-100">
                    <i :class="getTransportIcon(item.transportType)" class="mr-1 text-sakura-dark"></i>ç´„ {{ item.travelTime }} åˆ†
                  </span>
                  <span v-else-if="index === 0 && selectedDate !== '2026-04-02' && item.category !== 'flight'" class="text-[10px] text-gray-400 flex items-center bg-gray-50 px-2 py-1 rounded-full border border-gray-100">
                    <i class="fa-solid fa-hotel mr-1 text-sakura-dark"></i>é£¯åº—å‡ºç™¼
                  </span>
                </div>
                <span class="text-sm font-black text-sakura-text bg-sakura-light px-2 py-1 rounded-lg whitespace-nowrap ml-2">{{ item.time }}</span>
              </div>
              <h3 class="font-bold text-gray-800 text-lg mb-2 flex items-center gap-2" @click.stop="openMap(item.name)">
                {{ item.name }} <i class="fa-solid fa-location-arrow text-xs text-sakura cursor-pointer"></i>
              </h3>
              <div class="space-y-2 text-sm text-gray-600">
                <div class="flex flex-wrap gap-3 text-xs">
                  <p v-if="item.category !== 'other' && item.category !== 'accommodation' && item.openHours" class="flex items-center"><i class="fa-regular fa-clock w-4 text-center text-gray-400 mr-1"></i> {{ item.openHours }}</p>
                  <p v-if="item.category === 'attraction' && item.ticket" class="flex items-center"><i class="fa-solid fa-ticket w-4 text-center text-yellow-500 mr-1"></i> {{ item.ticket }}</p>
                </div>
                <div v-if="item.description" class="text-xs bg-gray-50 p-3 rounded-lg border border-gray-100 leading-relaxed text-gray-500">
                  <p style="white-space: pre-line;">{{ item.description }}</p>
                </div>
                <p v-if="item.note" class="text-xs text-sakura-dark mt-1 flex items-start"><i class="fa-solid fa-circle-exclamation w-4 mt-0.5 mr-1"></i> {{ item.note }}</p>
              </div>
            </div>
          </div>
        </div>

        <div v-if="filteredItinerary.length === 0" class="text-center py-10 text-gray-400">
          <p v-if="migrationStatus" class="animate-pulse">æ­£åœ¨è¼‰å…¥è¡Œç¨‹è³‡æ–™...</p>
          <div v-else>
             <i class="fa-solid fa-mug-hot text-4xl mb-3 opacity-50"></i>
             <p>æœ¬æ—¥å°šç„¡è¡Œç¨‹</p>
          </div>
        </div>
      </div>
      
      <!-- æ›´æ–°èˆ‡ä¿®å¾©æŒ‰éˆ•å€åŸŸ -->
      <div class="text-center pb-20 pt-8 space-y-3">
        <button @click="updateItineraryContentOnly" class="text-[12px] text-gray-400 underline hover:text-sakura-dark transition-colors font-bold flex items-center justify-center mx-auto">
            <i class="fa-solid fa-arrows-rotate mr-1"></i>æ›´æ–°è¡Œç¨‹å…§å®¹ (ä¿ç•™å…¶ä»–è³‡æ–™)
        </button>
        
        <button @click="fixDuplicates" class="text-[12px] text-red-300 underline hover:text-red-500 transition-colors font-bold flex items-center justify-center mx-auto">
            <i class="fa-solid fa-wrench mr-1"></i>ä¿®å¾©é‡è¤‡è¡Œç¨‹ (è‹¥å‡ºç¾é‡è¤‡è«‹é»æ­¤)
        </button>

        <div class="text-[10px] text-gray-300 pt-2">è³‡æ–™åº«ç‰ˆæœ¬: {{ TRIP_ID }}</div>
      </div>
    </div>

    <!-- TAB 2: info -->
    <div v-if="currentTab === 'info'" class="space-y-6 pb-20">
      <!-- exchange -->
      <div class="bg-white rounded-2xl p-5 shadow-card">
        <h3 class="font-bold text-sakura-text mb-4 border-b pb-2 flex justify-between items-center">
          <span><i class="fa-solid fa-coins mr-2 text-yellow-500"></i>å³æ™‚åŒ¯ç‡åƒè€ƒ</span>
          <div class="text-right">
            <!-- é¡¯ç¤ºåŸå§‹åŒ¯ç‡æ•¸å€¼ï¼Œä¸é€²è¡Œä»»ä½•å››æ¨äº”å…¥ -->
            <span class="text-[10px] text-gray-400 block font-mono">1 JPY â‰ˆ {{ currentRate.toFixed(4) }} TWD</span>
            <span v-if="rateUpdateDate" class="text-[9px] text-gray-300 block">æ›´æ–°: {{ rateUpdateDate }}</span>
          </div>
        </h3>
        <div class="flex items-center gap-4">
          <div class="flex-1"><label class="text-xs text-gray-500 mb-1 block">æ—¥å¹£ (JPY)</label><input type="number" v-model="exchange.jpy" @input="calcTwd" class="w-full bg-gray-50 rounded-xl p-3 outline-none focus:ring-2 focus:ring-sakura" placeholder="Â¥"></div>
          <i class="fa-solid fa-arrow-right-arrow-left text-gray-300"></i>
          <div class="flex-1"><label class="text-xs text-gray-500 mb-1 block">å°å¹£ (TWD)</label><input type="number" v-model="exchange.twd" @input="calcJpy" class="w-full bg-sakura-light rounded-xl p-3 font-bold text-sakura-text outline-none focus:ring-2 focus:ring-sakura" placeholder="NT$"></div>
        </div>
        <p class="text-[10px] text-gray-400 mt-2 flex items-start"><i class="fa-solid fa-circle-info mr-1 mt-0.5"></i> ç”±æ–¼æŠ€è¡“é™åˆ¶ï¼Œæ­¤ç‚ºä¾æ“šå³æ™‚å¸‚å ´åŒ¯ç‡+é»å·®æ¨ç®—çš„ç¾é‡‘è³£å‡ºåƒ¹ï¼Œå¯¦éš›è«‹ä»¥éŠ€è¡Œå…¬å‘Šç‚ºæº–ã€‚</p>
      </div>

      <!-- flight (Combined with Tigerair Info) -->
      <div class="bg-white rounded-2xl p-5 shadow-card">
        <h3 class="font-bold text-sakura-text mb-4 border-b pb-2"><i class="fa-solid fa-plane mr-2 text-blue-400"></i>èˆªç­è³‡è¨Š</h3>
        <!-- å»ç¨‹ -->
        <div class="mb-4 bg-blue-50 rounded-xl p-4 border border-blue-100 relative overflow-hidden">
          <div class="absolute top-0 right-0 bg-blue-500 text-white text-xs px-3 py-1 rounded-bl-xl font-bold tracking-wider">å»ç¨‹</div>
          <div class="flex items-center gap-2 mb-4">
            <span class="font-black text-xl text-gray-800 tracking-wide">IT-284</span>
            <span class="text-[10px] text-blue-600 bg-white px-2 py-0.5 rounded-full border border-blue-100 font-bold">å°ç£è™èˆª</span>
          </div>
          <div class="flex justify-between items-center text-center mb-4 relative z-10">
            <div class="text-left"><div class="text-3xl font-black text-gray-800 leading-none">07:00</div><div class="text-sm font-bold text-gray-600 mt-1">KHH é«˜é›„</div><div class="text-[10px] text-gray-400 mt-0.5 bg-white/60 inline-block px-1 rounded">åœ‹éš›èˆªå»ˆ</div></div>
            <div class="flex flex-col items-center w-1/3 px-2"><span class="text-[10px] text-gray-400 mb-2 font-bold">2h 55m</span><div class="w-full h-0.5 bg-gray-300 relative flex items-center justify-center"><i class="fa-solid fa-plane-departure text-blue-400 text-sm absolute bg-blue-50 px-1"></i></div><span class="text-[10px] text-blue-400 mt-1">ç›´é£›</span></div>
            <div class="text-right"><div class="text-3xl font-black text-gray-800 leading-none">10:55</div><div class="text-sm font-bold text-gray-600 mt-1">KIX é—œè¥¿</div><div class="text-[10px] text-gray-400 mt-0.5 bg-white/60 inline-block px-1 rounded">ç¬¬ä¸€èˆªå»ˆ</div></div>
          </div>
          <div class="text-center mb-3">
            <span class="text-xs font-bold text-blue-600 bg-white border border-blue-200 px-3 py-1 rounded-full shadow-sm"><i class="fa-solid fa-user-clock mr-1"></i>å»ºè­°å ±åˆ°ï¼š04:30</span>
          </div>
          <div class="flex justify-between items-center text-xs text-gray-500 border-t border-blue-200/50 pt-3 mt-2">
            <span class="flex items-center"><i class="fa-regular fa-calendar-check mr-1.5 text-blue-400"></i>2026/04/02 (é€±å››)</span>
            <span class="flex items-center"><i class="fa-solid fa-suitcase-rolling mr-1 text-blue-400"></i>20kg<span class="mx-1 text-blue-200">|</span><i class="fa-solid fa-briefcase mr-1 text-blue-400"></i>10kg<span class="mx-1 text-blue-200">|</span><i class="fa-solid fa-utensils mr-1 text-blue-400"></i>å«é¤</span>
          </div>
        </div>
        <!-- å›ç¨‹ -->
        <div class="bg-sakura-light/40 rounded-xl p-4 border border-sakura-light relative overflow-hidden mb-4">
          <div class="absolute top-0 right-0 bg-sakura text-white text-xs px-3 py-1 rounded-bl-xl font-bold tracking-wider">å›ç¨‹</div>
          <div class="flex items-center gap-2 mb-4">
            <span class="font-black text-xl text-gray-800 tracking-wide">IT-285</span>
            <span class="text-[10px] text-sakura-dark bg-white px-2 py-0.5 rounded-full border border-sakura-light font-bold">å°ç£è™èˆª</span>
          </div>
          <div class="flex justify-between items-center text-center mb-4 relative z-10">
            <div class="text-left"><div class="text-3xl font-black text-gray-800">12:00</div><div class="text-sm font-bold text-gray-600 mt-1">KIX é—œè¥¿</div><div class="text-[10px] text-gray-400 mt-0.5 bg-white/60 inline-block px-1 rounded">ç¬¬ä¸€èˆªå»ˆ</div></div>
            <div class="flex flex-col items-center w-1/3 px-2"><span class="text-[10px] text-gray-400 mb-2 font-bold">3h 0m</span><div class="w-full h-0.5 bg-gray-300 relative flex items-center justify-center"><i class="fa-solid fa-plane-departure text-sakura text-sm absolute bg-sakura-light/40 px-1"></i></div><span class="text-[10px] text-sakura mt-1">ç›´é£›</span></div>
            <div class="text-right"><div class="text-3xl font-black text-gray-800 leading-none">14:00</div><div class="text-sm font-bold text-gray-600 mt-1">KHH é«˜é›„</div><div class="text-[10px] text-gray-400 mt-0.5 bg-white/60 inline-block px-1 rounded">åœ‹éš›èˆªå»ˆ</div></div>
          </div>
          <div class="text-center mb-3">
            <span class="text-xs font-bold text-sakura-text bg-white border border-sakura-light px-3 py-1 rounded-full shadow-sm"><i class="fa-solid fa-user-clock mr-1 text-sakura"></i>å»ºè­°å ±åˆ°ï¼š10:00</span>
          </div>
          <div class="flex justify-between items-center text-xs text-gray-500 border-t border-sakura-light pt-3 mt-2">
            <span class="flex items-center"><i class="fa-regular fa-calendar-check mr-1.5 text-sakura"></i>2026/04/06 (é€±ä¸€)</span>
            <span class="flex items-center"><i class="fa-solid fa-suitcase-rolling mr-1 text-sakura"></i>25kg<span class="mx-1 text-sakura-light">|</span><i class="fa-solid fa-briefcase mr-1 text-sakura"></i>10kg<span class="mx-1 text-sakura-light">|</span><i class="fa-solid fa-utensils mr-1 text-sakura"></i>å«é¤</span>
          </div>
        </div>

        <!-- è™èˆªèªªæ˜ -->
        <div class="bg-orange-50 border border-orange-200 rounded-xl overflow-hidden mt-4">
            <button @click="isTigerairInfoExpanded = !isTigerairInfoExpanded" class="w-full text-left p-3 flex justify-between items-center hover:bg-orange-100 transition-colors focus:outline-none">
                <h4 class="font-bold text-gray-800 text-xs flex items-center">
                <i class="fa-solid fa-plane-up mr-2 text-orange-500"></i>å°ç£è™èˆªæ­ä¹˜èªªæ˜èˆ‡æ³¨æ„äº‹é …
                </h4>
                <div class="flex items-center gap-2">
                <span class="text-[10px] text-gray-400 font-normal" v-show="!isTigerairInfoExpanded">å±•é–‹</span>
                <i class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-300" :class="{'rotate-180': isTigerairInfoExpanded}"></i>
                </div>
            </button>

            <div v-show="isTigerairInfoExpanded" class="px-4 pb-4 animate-fade-in bg-white border-t border-orange-100">
                <div class="space-y-4 pt-3">
                <div>
                    <h5 class="text-xs font-bold text-gray-700 flex items-center mb-1.5"><i class="fa-solid fa-suitcase text-orange-400 mr-1.5 w-4 text-center"></i>æ‰‹æè¡Œæè¦å®š (éå¸¸åš´æ ¼)</h5>
                    <div class="bg-gray-50 rounded-lg p-2 text-[10px] text-gray-600 leading-relaxed">
                    <p class="mb-1">æ¯ä½ä¹˜å®¢åƒ…é™æ”œå¸¶ï¼š</p>
                    <ul class="list-disc pl-4 space-y-1">
                        <li><b>1ä»¶</b> æ‰‹æè¡Œæ (å°ºå¯¸å°æ–¼ 54x38x23cm)</li>
                        <li><b>1ä»¶</b> å€‹äººéš¨èº«ç‰©å“ (å¦‚æ‰‹æåŒ…ã€é›»è…¦åŒ…)</li>
                        <li class="text-red-500 font-bold">ä¸Šè¿°å…©ä»¶ç¸½é‡é‡ä¸å¾—è¶…é 10 å…¬æ–¤ã€‚</li>
                    </ul>
                    <p class="mt-2 text-gray-400"><i class="fa-solid fa-circle-info mr-1"></i>ç™»æ©Ÿé–€å‰åœ°å‹¤æœƒå†æ¬¡ç§¤é‡æª¢æŸ¥ï¼Œè‹¥è¶…é‡éœ€ç¾å ´æ”¯ä»˜é«˜é¡è¨—é‹è²»ã€‚</p>
                    </div>
                </div>
                <div>
                    <h5 class="text-xs font-bold text-gray-700 flex items-center mb-1.5"><i class="fa-solid fa-clock text-blue-400 mr-1.5 w-4 text-center"></i>å ±åˆ°èˆ‡ç™»æ©Ÿæ™‚é–“</h5>
                    <div class="flex gap-2 text-center text-xs">
                    <div class="flex-1 bg-gray-50 rounded-lg p-2 border border-gray-100"><div class="text-gray-400 text-[10px] mb-1">èµ·é£›å‰</div><div class="font-bold text-gray-700">2.5 å°æ™‚</div><div class="text-gray-400 text-[10px]">é–‹å§‹å ±åˆ°</div></div>
                    <div class="flex-1 bg-red-50 rounded-lg p-2 border border-red-100"><div class="text-red-400 text-[10px] mb-1">èµ·é£›å‰</div><div class="font-bold text-red-600">45 åˆ†é˜</div><div class="text-red-400 text-[10px]">æº–æ™‚é—œæ«ƒ</div></div>
                    <div class="flex-1 bg-gray-50 rounded-lg p-2 border border-gray-100"><div class="text-gray-400 text-[10px] mb-1">èµ·é£›å‰</div><div class="font-bold text-gray-700">10 åˆ†é˜</div><div class="text-gray-400 text-[10px]">é—œé–‰ç™»æ©Ÿé–€</div></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div><h5 class="text-xs font-bold text-gray-700 flex items-center mb-1"><i class="fa-solid fa-bottle-water text-cyan-400 mr-1.5 w-4 text-center"></i>æ¶²é«”é™åˆ¶</h5><ul class="text-[10px] text-gray-500 list-disc pl-3"><li>å–®ç“¶ 100ml ä»¥ä¸‹</li><li>è£æ–¼ 1L é€æ˜è¢‹</li></ul></div>
                    <div><h5 class="text-xs font-bold text-gray-700 flex items-center mb-1"><i class="fa-solid fa-battery-full text-green-500 mr-1.5 w-4 text-center"></i>éš¨èº«æ”œå¸¶</h5><ul class="text-[10px] text-gray-500 list-disc pl-3"><li><b>è¡Œå‹•é›»æº/é‹°é›»æ± </b></li><li>æ‰“ç«æ©Ÿ (é™1å€‹)</li></ul></div>
                </div>
                <div class="bg-gray-50 rounded-lg p-2 flex items-start gap-2">
                    <i class="fa-solid fa-utensils text-gray-400 mt-0.5 text-xs"></i>
                    <p class="text-[10px] text-gray-500 leading-tight"><b>æ©Ÿä¸Šç¦å¸¶å¤–é£Ÿï¼š</b> å°ç£è™èˆªè¦å®šè«‹å‹¿æ”œå¸¶éæ©Ÿä¸Šè³¼è²·ä¹‹é¤é£Ÿæˆ–é£²å“æ–¼æ©Ÿä¸Šé£Ÿç”¨ã€‚</p>
                </div>
                </div>
            </div>
        </div>
      </div>

      <!-- packing -->
      <div class="bg-white rounded-2xl p-5 shadow-card">
        <h3 class="font-bold text-sakura-text mb-3 border-b pb-2 flex justify-between items-center">
          <span><i class="fa-solid fa-suitcase-rolling mr-2 text-sakura"></i>è¡Œææª¢æŸ¥æ¸…å–®</span>
        </h3>

        <div class="flex gap-2 overflow-x-auto no-scrollbar mb-3 pb-1 justify-center">
          <button v-for="person in packingPeople" :key="person" @click="currentPackingFilter = person"
            :class="['px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors border', (currentPackingFilter === person) ? 'bg-sakura text-white border-sakura shadow-md' : 'bg-white text-gray-500 border-gray-200']">
            {{ person }}
          </button>
        </div>

        <div class="space-y-0.5 mb-4">
          <div v-if="filteredPackingList.length === 0" class="text-center text-gray-400 py-4 text-xs">
            <i class="fa-solid fa-clipboard-check mb-1"></i><br>ç›®å‰æ²’æœ‰é …ç›®
          </div>
          <div v-for="(item, index) in filteredPackingList" :key="item.id" class="flex items-center gap-3 py-0.5 px-2 rounded-lg transition-colors hover:bg-gray-50 group border border-transparent hover:border-gray-100">
            <label class="flex items-center gap-3 flex-1 cursor-pointer">
              <div class="relative flex items-center justify-center">
                <input type="checkbox" :checked="item.checked" @change="togglePackingCheck(item)" class="peer appearance-none w-5 h-5 border-2 border-gray-300 rounded-md checked:bg-sakura checked:border-sakura transition-colors">
                <i class="fa-solid fa-check text-white text-xs absolute opacity-0 peer-checked:opacity-100 pointer-events-none transition-opacity"></i>
              </div>
              <span :class="{'line-through text-gray-400': item.checked, 'text-gray-600': !item.checked}" class="text-sm font-medium transition-colors select-none">
                {{ item.text }}
              </span>
            </label>
            <button @click="deletePackingItem(item.id)" class="text-gray-300 hover:text-red-400 p-1 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-xmark"></i></button>
          </div>
        </div>

        <div class="flex gap-2 mb-2">
          <input type="text" v-model="newPackingItem" placeholder="æ–°å¢æª¢æŸ¥é …ç›®..." class="flex-1 bg-gray-50 rounded-lg px-3 py-2 text-sm outline-none border focus:border-sakura" @keyup.enter="addPackingItem">
          <button @click="addPackingItem" class="bg-sakura text-white px-3 py-2 rounded-lg text-sm font-bold shadow-sm active:scale-95 transition-transform"><i class="fa-solid fa-plus"></i></button>
        </div>
        
        <!-- æ–°å¢çš„æ‰‹å‹•è£œé½ŠæŒ‰éˆ• -->
        <button v-if="filteredPackingList.length === 0 && currentPackingFilter" @click="checkAndMigrateData(true, currentPackingFilter)" class="w-full py-2 bg-gray-100 text-gray-500 rounded-lg text-xs font-bold hover:bg-gray-200 transition-colors dashed border border-gray-300">
            <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> å¹« {{ currentPackingFilter }} è£œé½Šé è¨­é …ç›®
        </button>
      </div>
    </div>

    <!-- TAB 3 shopping -->
    <div v-if="currentTab === 'shopping'">
      <div class="flex gap-2 overflow-x-auto no-scrollbar mb-4 px-1 justify-center">
        <button v-for="traveler in shoppingTravelers" :key="traveler" @click="currentShoppingFilter = traveler"
          :class="['px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors border', (currentShoppingFilter === traveler) ? 'bg-sakura text-white border-sakura shadow-md' : 'bg-white text-gray-500 border-gray-200']">
          {{ traveler }}
        </button>
      </div>

      <div class="bg-pink-50 text-pink-700 text-xs px-4 py-2 rounded-xl mb-4 flex items-center border border-pink-100 mx-2 shadow-sm animate-pulse">
        <i class="fa-solid fa-wallet mr-2 text-pink-500"></i>
        æº«é¦¨æé†’ï¼šæ—¥æœ¬æ˜¯å…ç¨…ä¸æ˜¯å…è²»å”·~ è«‹ç†æ€§è³¼ç‰© (ç¬‘)
      </div>

      <div class="grid grid-cols-2 gap-4 pb-24">
        <div v-for="(item, index) in filteredShoppingList" :key="item.id" class="bg-white rounded-2xl overflow-hidden shadow-card relative group">
          <!-- ç§»é™¤é€™è£¡çš„ @click="openModal..." -->
          <div class="h-32 bg-gray-100 relative overflow-hidden">
            <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
            <div v-else class="w-full h-full flex items-center justify-center text-gray-300"><i class="fa-solid fa-image text-3xl"></i></div>
            <div class="absolute top-1 right-1 flex gap-1">
              <!-- ä¿ç•™ç·¨è¼¯æŒ‰éˆ•çš„åŠŸèƒ½ -->
              <button @click="openModal('shopping', item)" class="bg-white/80 w-6 h-6 rounded-full text-gray-500 text-xs flex items-center justify-center shadow-sm hover:text-sakura-dark"><i class="fa-solid fa-pen"></i></button>
            </div>
            <span class="absolute bottom-1 left-1 bg-black/50 text-white text-[10px] px-2 py-0.5 rounded-full backdrop-blur-sm">{{ item.owner || 'æœªæŒ‡å®š' }}</span>
          </div>
          <div class="p-3">
            <h4 class="font-bold text-gray-700 text-sm truncate">{{ item.name }}</h4>
            <div class="flex items-center gap-1 mt-2 justify-between">
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="checkbox" :checked="item.bought" @change="toggleShoppingCheck(item)" class="accent-sakura w-4 h-4 rounded-full">
                    <span class="text-xs text-gray-500" :class="{'line-through': item.bought}">å·²è³¼è²·</span>
                </label>
                <button @click="deleteShoppingItem(item.id)" class="text-gray-300 hover:text-red-400 text-xs p-1"><i class="fa-solid fa-trash-can"></i></button>
            </div>
          </div>
        </div>
      </div>
      <button @click="openModal('shopping')" class="fixed bottom-24 right-6 w-14 h-14 bg-sakura text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-sakura-dark transition-colors z-20"><i class="fa-solid fa-plus"></i></button>
    </div>

    <!-- TAB 4 expense -->
    <div v-if="currentTab === 'expense'">
      <div class="flex gap-2 overflow-x-auto no-scrollbar mb-4 px-1 justify-center">
        <button @click="currentMemberFilter = null" :class="['px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors border', !currentMemberFilter ? 'bg-sakura text-white border-sakura shadow-md' : 'bg-white text-gray-500 border-gray-200']">å…¨éƒ¨</button>
        <button v-for="traveler in travelers" :key="traveler" @click="currentMemberFilter = traveler"
          :class="['px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors border', (currentMemberFilter === traveler) ? 'bg-sakura text-white border-sakura shadow-md' : 'bg-white text-gray-500 border-gray-200']">
          {{ traveler }}
        </button>
      </div>

      <div class="bg-gradient-to-r from-sakura to-sakura-dark rounded-2xl p-6 text-white shadow-soft mb-6 text-center transition-all duration-300">
        <p class="text-sm opacity-90 mb-1 flex items-center justify-center gap-2"><i class="fa-solid fa-user-tag text-xs"></i>{{ currentMemberFilter ? currentMemberFilter + ' çš„' : 'ç›®å‰ç¸½' }}èŠ±è²» (JPY)</p>
        <h2 class="text-4xl font-bold font-mono">Â¥ {{ filteredTotalExpense.toLocaleString() }}</h2>
        <p class="text-xs opacity-70 mt-2">ç´„ TWD {{ (filteredTotalExpense * currentRate).toLocaleString(undefined, {maximumFractionDigits: 20}) }}</p>
      </div>

      <div class="bg-white rounded-t-2xl shadow-card min-h-[300px] pb-24">
        <div v-for="(item, index) in filteredExpenses" :key="item.id" class="p-4 border-b border-gray-50 flex justify-between items-center" @click="openModal('expense', item)">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-lg shadow-sm">
              <i :class="getExpenseIcon(item.category)" class="text-sakura-dark"></i>
            </div>
            <div>
              <h4 class="font-bold text-gray-800">{{ item.name }}</h4>
              <p class="text-xs text-gray-400">{{ item.date }} Â· {{ item.owner || 'æœªæŒ‡å®š' }}</p>
            </div>
          </div>
          <div class="text-right">
            <p class="font-bold text-gray-800 font-mono">Â¥{{ Number(item.amount).toLocaleString() }}</p>
          </div>
        </div>
        <div v-if="expenses.length === 0" class="text-center py-8 text-gray-400 text-sm">æ­¤åˆ†é¡ä¸‹ç„¡ç´€éŒ„</div>
      </div>
      <button @click="openModal('expense')" class="fixed bottom-24 right-6 w-14 h-14 bg-sakura text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-sakura-dark transition-colors z-20"><i class="fa-solid fa-plus"></i></button>
    </div>

    <!-- TAB 5 notebook -->
    <div v-if="currentTab === 'notebook'">
      <div class="flex gap-2 overflow-x-auto no-scrollbar mb-4 px-1 justify-center">
        <button v-for="traveler in notebookOwners" :key="traveler" @click="currentNotebookFilter = traveler"
          :class="['px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors border', (currentNotebookFilter === traveler) ? 'bg-sakura text-white border-sakura shadow-md' : 'bg-white text-gray-500 border-gray-200']">
          {{ traveler }}
        </button>
      </div>

      <div class="grid gap-3 pb-24">
        <div v-if="filteredNotebookList.length === 0" class="text-center py-10 text-gray-400">
          <i class="fa-solid fa-book-open text-4xl mb-3 opacity-50"></i><p>é€™è£¡ç©ºç©ºçš„ï¼Œè¨˜é»ä»€éº¼å§ï¼</p>
        </div>
        <!-- ç§»é™¤å¤–å±¤ div çš„ @click äº‹ä»¶ï¼Œä½¿å…¶é»æ“Šç„¡åæ‡‰ -->
        <div v-for="note in filteredNotebookList" :key="note.id" class="bg-white p-4 rounded-2xl shadow-card relative group border-l-4 border-sakura-light">
          <h4 class="font-bold text-gray-800 mb-1">{{ note.title }}</h4>
          <p class="text-sm text-gray-600 whitespace-pre-line leading-relaxed">{{ note.content }}</p>
          <div class="mt-3 flex justify-between items-end border-t border-gray-50 pt-2">
            <span class="text-[10px] text-gray-400">{{ note.owner }}</span>
            <div class="flex gap-3">
                <!-- ç·¨è¼¯æŒ‰éˆ•ä¿ç•™é»æ“Šäº‹ä»¶ -->
                <button @click="openModal('notebook', note)" class="text-xs text-gray-400 hover:text-sakura-dark font-bold"><i class="fa-solid fa-pen mr-1"></i>ç·¨è¼¯</button>
                <button @click="deleteNote(note.id)" class="text-xs text-red-300 hover:text-red-500 font-bold"><i class="fa-solid fa-trash-can mr-1"></i>åˆªé™¤</button>
            </div>
          </div>
        </div>
      </div>
      <button @click="openModal('notebook')" class="fixed bottom-24 right-6 w-14 h-14 bg-sakura text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-sakura-dark transition-colors z-20"><i class="fa-solid fa-plus"></i></button>
    </div>

  </main>

  <!-- bottom nav -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 flex justify-around items-center h-20 px-2 pb-2 rounded-t-[20px] shadow-[0_-5px_20px_rgba(0,0,0,0.03)] z-40 max-w-[480px] mx-auto">
    <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" class="flex flex-col items-center justify-center w-16 h-16 transition-all">
      <div class="w-10 h-6 flex items-center justify-center rounded-full mb-1 transition-all" :class="currentTab === tab.id ? 'bg-sakura-light text-sakura-dark' : 'text-gray-400'">
        <i :class="tab.icon" class="text-lg"></i>
      </div>
      <span class="text-[10px] font-bold transition-all" :class="currentTab === tab.id ? 'text-sakura-text' : 'text-gray-400'">{{ tab.name }}</span>
    </button>
  </nav>

  <!-- modal -->
  <div v-if="modal.show" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center animate-fade-in">
    <div class="bg-white w-full max-w-[480px] rounded-t-[20px] sm:rounded-2xl p-6 shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-sakura-text">{{ modal.title }}</h3>
        <button @click="closeModal" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>

      <!-- Dynamic Fields -->
      <div class="space-y-4">
        <!-- Itinerary is Read Only -->
        <template v-if="modal.type === 'itinerary'">
             <div class="text-gray-500 text-center py-10">æ­¤è¡Œç¨‹ç‚ºå”¯è®€æ¨¡å¼</div>
        </template>

        <template v-if="modal.type === 'shopping'">
            <div><label class="block text-xs font-bold text-gray-500 mb-1">èª°è¦è²·</label><select v-model="formData.owner" class="w-full bg-blue-50 rounded-xl p-3 font-bold text-blue-800"><option v-for="t in shoppingTravelers.filter(x=>x!=='å…¨éƒ¨')" :value="t">{{t}}</option></select></div>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">å•†å“åç¨±</label><input type="text" v-model="formData.name" class="w-full bg-gray-50 rounded-xl p-3 border focus:border-sakura outline-none"></div>
            <div>
                 <label class="block text-xs font-bold text-gray-500 mb-1">åœ–ç‰‡</label>
                 <div class="relative w-full h-32 bg-gray-100 rounded-xl flex items-center justify-center border-2 border-dashed border-gray-300 overflow-hidden">
                    <input type="file" @change="handleImageUpload" class="absolute inset-0 opacity-0 cursor-pointer">
                    <img v-if="formData.image" :src="formData.image" class="w-full h-full object-cover">
                    <div v-else class="text-center text-gray-400"><i class="fa-solid fa-camera mb-1"></i><p class="text-xs">é»æ“Šä¸Šå‚³åœ–ç‰‡</p></div>
                 </div>
            </div>
        </template>
        
        <template v-if="modal.type === 'expense'">
            <div><label class="block text-xs font-bold text-gray-500 mb-1">èª°ä»˜éŒ¢</label><select v-model="formData.owner" class="w-full bg-gray-50 rounded-xl p-3"><option v-for="t in travelers" :value="t">{{t}}</option></select></div>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸ</label><select v-model="formData.date" class="w-full bg-gray-50 rounded-xl p-3"><option v-for="d in days" :value="d.dateStr">{{d.displayDate}}</option></select></div>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">é¡åˆ¥</label>
                <select v-model="formData.category" class="w-full bg-gray-50 rounded-xl p-3">
                    <option value="food">é£²é£Ÿ</option><option value="transport">äº¤é€š</option><option value="shopping">è³¼ç‰©</option><option value="ticket">é–€ç¥¨</option><option value="accommodation">ä½å®¿</option><option value="other">å…¶ä»–</option>
                </select>
            </div>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">é …ç›®</label><input type="text" v-model="formData.name" class="w-full bg-gray-50 rounded-xl p-3 border focus:border-sakura outline-none"></div>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">é‡‘é¡ (JPY)</label><input type="number" v-model="formData.amount" class="w-full bg-gray-50 rounded-xl p-3 text-xl font-mono border focus:border-sakura outline-none"></div>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">ä»˜æ¬¾æ–¹å¼</label>
                <div class="flex gap-2">
                    <label class="flex-1 bg-gray-50 p-3 rounded-xl flex items-center justify-center gap-2 cursor-pointer has-[:checked]:bg-sakura-light has-[:checked]:text-sakura-dark">
                        <input type="radio" v-model="formData.method" value="ç¾é‡‘" class="hidden"><i class="fa-solid fa-coins"></i> ç¾é‡‘
                    </label>
                    <label class="flex-1 bg-gray-50 p-3 rounded-xl flex items-center justify-center gap-2 cursor-pointer has-[:checked]:bg-sakura-light has-[:checked]:text-sakura-dark">
                        <input type="radio" v-model="formData.method" value="ä¿¡ç”¨å¡" class="hidden"><i class="fa-solid fa-credit-card"></i> ä¿¡ç”¨å¡
                    </label>
                </div>
            </div>
        </template>

        <template v-if="modal.type === 'notebook'">
            <div><label class="block text-xs font-bold text-gray-500 mb-1">è¨˜éŒ„äºº</label><select v-model="formData.owner" class="w-full bg-gray-50 rounded-xl p-3"><option v-for="t in travelers" :value="t">{{t}}</option></select></div>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">æ¨™é¡Œ</label><input type="text" v-model="formData.title" class="w-full bg-gray-50 rounded-xl p-3 border focus:border-sakura outline-none"></div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">å…§å®¹</label>
                <textarea v-model="formData.content" placeholder="è«‹è¼¸å…¥å…§å®¹..." class="w-full bg-gray-50 rounded-xl p-3 h-32 border focus:border-sakura outline-none"></textarea>
            </div>
        </template>
      </div>

      <div class="mt-6 flex gap-3" v-if="modal.type !== 'itinerary'">
        <button v-if="modal.isEdit" @click="deleteCurrentItem" class="flex-1 bg-red-50 text-red-500 font-bold py-3 rounded-xl hover:bg-red-100 transition-colors">åˆªé™¤</button>
        <button @click="submitForm" class="flex-[2] bg-sakura text-white font-bold py-3 rounded-xl shadow-soft hover:bg-sakura-dark transition-colors flex items-center justify-center">
            <i v-if="isSaving" class="fa-solid fa-spinner fa-spin mr-2"></i>
            {{ isSaving ? 'å„²å­˜ä¸­...' : (modal.isEdit ? 'å„²å­˜è®Šæ›´' : 'æ–°å¢') }}
        </button>
      </div>
    </div>
  </div>

</div>

<!-- FULL DATA SEEDING -->
<script>
window.__FULL_ITINERARY_DATA__ = [
  { id: 0, date: '2026-04-02', category: 'other', name: 'é«˜é›„å°æ¸¯æ©Ÿå ´é›†åˆ', time: '04:30', travelTime: 0, transportType: 'walk', note: 'åœ‹éš›èˆªå»ˆå‡ºå¢ƒå¤§å»³', description: 'æº–å‚™å•Ÿç¨‹å‡ºç™¼å›‰ï¼ğŸ‰ è«‹å‹™å¿…æº–æ™‚é›†åˆï¼Œæº–å‚™è¾¦ç†ç™»æ©Ÿæ‰‹çºŒã€‚è¨˜å¾—å†æ¬¡æª¢æŸ¥è­·ç…§èˆ‡å¿…å‚™è­‰ä»¶ï¼' },
  { id: 1, date: '2026-04-02', category: 'flight', name: 'èˆªç­ IT-284 KHH->KIX', time: '07:00', travelTime: 0, transportType: 'flight', note: 'èµ·é£› 07:00 / æŠµé” 10:55 (é è¨ˆå‡ºé—œ 11:30)' },
  
  // Day 1
  { id: 2, date: '2026-04-02', category: 'transport', name: 'é—œè¥¿æ©Ÿå ´ â†’ é›£æ³¢', time: '11:40', travelTime: 45, transportType: 'transit', note: 'å·²äº‹å…ˆè³¼ç¥¨', description: 'ğŸš‰ è·¯ç·šï¼šå—æµ·é›»éµ - ç©ºæ¸¯æ€¥è¡Œ (Nankai Airport Exp.)\nğŸ“ å€é–“ï¼šé—œè¥¿æ©Ÿå ´ç«™ (Kansai Airport) â†’ å—æµ·é›£æ³¢ç«™ (Namba)\nğŸ’¡ æç¤ºï¼šå‡ºç«™å¾Œä¾æŒ‡ç¤ºå‰å¾€åœ°éµå¾¡å ‚ç­‹ç·šã€‚' },
  { id: 3, date: '2026-04-02', category: 'transport', name: 'é›£æ³¢ â†’ æœ¬ç”º (é£¯åº—)', time: '12:40', travelTime: 15, transportType: 'transit', note: 'è½‰ä¹˜å¾¡å ‚ç­‹ç·š (ç´…ç·š)', description: 'ğŸš‰ è·¯ç·šï¼šåœ°éµå¾¡å ‚ç­‹ç·š\nğŸ“ å€é–“ï¼šé›£æ³¢ç«™ (M20) â†’ æœ¬ç”ºç«™ (M18)\nğŸš¶ æ­¥è¡Œï¼šç”± 11 è™Ÿæˆ– 12 è™Ÿå‡ºå£å‡ºç«™ï¼Œæ­¥è¡Œç´„ 3-5 åˆ†é˜æŠµé”é£¯åº—ã€‚' },
  { id: 4, date: '2026-04-02', category: 'accommodation', name: 'æ±æ€¥ Stay å¤§é˜ªæœ¬ç”º', time: '13:00', travelTime: 0, transportType: 'walk', note: 'å…ˆå¯„æ”¾è¡Œæ', description: 'å…ˆåœ¨å¤§å»³å¯„æ”¾è¡Œæï¼Œè¼•è£å‡ºç™¼ï¼' },
  { id: 41, date: '2026-04-02', category: 'transport', name: 'æœ¬ç”º â†’ æ—¥æœ¬æ©‹ (é»‘é–€å¸‚å ´)', time: '13:15', travelTime: 15, transportType: 'transit', note: 'åœ°éµæˆ–è¨ˆç¨‹è»Š', description: 'ğŸš‰ è·¯ç·šï¼šåœ°éµå ºç­‹ç·š (Sakaisuji Line)\nğŸ“ å€é–“ï¼šå ºç­‹æœ¬ç”ºç«™ (K15) â†’ æ—¥æœ¬æ©‹ç«™ (K17)\nğŸš¶ æ­¥è¡Œï¼š10è™Ÿå‡ºå£å‡ºç«™ï¼Œæ­¥è¡Œå³é”é»‘é–€å¸‚å ´ã€‚' },
  { id: 42, date: '2026-04-02', category: 'food', name: 'åˆé¤ï¼šé»‘é–€å¸‚å ´', time: '13:30', travelTime: 0, transportType: 'walk', note: 'å¤§é˜ªçš„å»šæˆ¿', openHours: '09:00 - 18:00', description: 'å¤§å•–æµ·é®®ã€å’Œç‰›ã€é—œæ±ç…®ï¼æ¨è–¦å˜—è©¦ç¾çƒ¤æ‰‡è²ã€é®ªé­šç”Ÿé­šç‰‡ã€è±†æ¼¿æ¿ƒéƒçš„è±†ä¹³ã€‚è«‹åœ¨åº—å®¶æŒ‡å®šçš„å…§ç”¨å€æˆ–ç«‹é£Ÿå€äº«ç”¨ï¼Œè«‹å‹¿é‚Šèµ°é‚Šåƒã€‚' },
  { id: 43, date: '2026-04-02', category: 'transport', name: 'æ—¥æœ¬æ©‹ â†’ å¤§é˜ªåŸå…¬åœ’ (æ£®ä¹‹å®®)', time: '15:00', travelTime: 30, transportType: 'transit', note: 'å ºç­‹ç·šè½‰ä¸­å¤®ç·š', description: 'ğŸ“ è½‰ä¹˜è·¯å¾‘ï¼š\n1. æ—¥æœ¬æ©‹ç«™ (K17) æ­ä¹˜ å ºç­‹ç·š (å¾€åŒ—) â†’ å ºç­‹æœ¬ç”ºç«™ (K15)\n2. è½‰ä¹˜ ä¸­å¤®ç·š (å¾€é•·ç”°æ–¹å‘) â†’ æ£®ä¹‹å®®ç«™ (C19)\n3. 3-Bå‡ºå£å‡ºç«™å³ç‚ºå¤§é˜ªåŸå…¬åœ’å…¥å£ï¼ˆå™´æ°´æ± å€ï¼‰ï¼Œå¯æ…¢æ…¢æ•£æ­¥è‡³å¤©å®ˆé–£ã€‚' },
  { id: 6, date: '2026-04-02', category: 'attraction', name: 'å¤§é˜ªåŸå…¬åœ’ & å¤©å®ˆé–£', time: '15:30', travelTime: 0, transportType: 'walk', note: 'ğŸŒ¸ æ«»èŠ±ç™¾é¸åæ‰€', openHours: '09:00 - 17:00 (æœ€å¾Œå…¥å ´ 16:30)', ticket: 'å¤©å®ˆé–£ Â¥600', description: 'å¤§é˜ªçš„åœ°æ¨™ï¼Œåœ’å…§ç¨®æ¤ç´„3000æ ªæ«»èŠ±ã€‚æ¨è–¦å‰å¾€ã€Œè¥¿ä¹‹ä¸¸åº­åœ’ã€è³æ«»ï¼Œé€™è£¡ä»¥æŸ“äº•å‰é‡æ«»ç‚ºä¸»ï¼Œèƒ½æ‹åˆ°å¤©å®ˆé–£èˆ‡æ«»èŠ±åŒæ¡†çš„çµ•ç¾ç•«é¢ã€‚å¤©å®ˆé–£å…§å±•ç¤ºè±è‡£ç§€å‰çš„æ­·å²æ–‡ç‰©ï¼Œ8æ¨“å±•æœ›å°å¯ä¿¯ç°å¤§é˜ªå¸‚æ™¯ã€‚' },
  { id: 7, date: '2026-04-02', category: 'transport', name: 'å¤§é˜ªåŸ â†’ é£¯åº—', time: '17:30', travelTime: 20, transportType: 'transit', note: 'å›é£¯åº—è¾¦ç†å…¥ä½', description: 'ğŸš‰ è·¯ç·šï¼šåœ°éµä¸­å¤®ç·š\nğŸ“ å€é–“ï¼šæ£®ä¹‹å®®ç«™ (C19) / è°·ç”ºå››ä¸ç›® (C18) â†’ å ºç­‹æœ¬ç”ºç«™ (C17)\nğŸš¶ æ­¥è¡Œï¼šç”± 11 è™Ÿå‡ºå£å‡ºç«™ï¼Œæ­¥è¡Œç´„ 1-2 åˆ†é˜æŠµé”é£¯åº—ã€‚' },
  { id: 8, date: '2026-04-02', category: 'accommodation', name: 'é£¯åº— Check-in & ä¼‘æ¯', time: '18:00', travelTime: 0, transportType: 'walk', note: 'ç¨ä½œæ•´ç†èˆ‡ä¼‘æ¯', description: 'è¾¦ç†å…¥ä½æ‰‹çºŒï¼Œé€²æˆ¿æ•´ç†ä¸€ä¸‹è¡Œæï¼Œä¼‘æ¯ç‰‡åˆ»ï¼Œæº–å‚™æ™šä¸Šå»é€›è¡—ï¼' },
  { id: 9, date: '2026-04-02', category: 'transport', name: 'é£¯åº— â†’ å¿ƒé½‹æ©‹', time: '18:45', travelTime: 15, transportType: 'walk', note: 'æ­¥è¡Œæˆ–æ­åœ°éµä¸€ç«™', description: 'ğŸš‰ è·¯ç·šï¼šæ­¥è¡Œ æˆ– åœ°éµå¾¡å ‚ç­‹ç·š\nğŸ“ å€é–“ï¼šæœ¬ç”ºç«™ (M18) â†’ å¿ƒé½‹æ©‹ç«™ (M19)\nğŸš¶ æ­¥è¡Œï¼šäº¦å¯ç›´æ¥æ²¿è‘—å¿ƒé½‹æ©‹å•†åº—è¡—æ­¥è¡Œç´„ 10-15 åˆ†é˜ã€‚' },
  { id: 10, date: '2026-04-02', category: 'shopping', name: 'å¿ƒé½‹æ©‹ & é“é “å € æ™šé¤', time: '19:00', travelTime: 0, transportType: 'walk', note: 'é€›è¡—ã€åƒæ™šé¤ã€è·‘è·‘äººçœ‹æ¿', openHours: 'ä¾åº—å®¶ (ç´„è‡³ 20:00/21:00)', description: 'å¤§é˜ªæœ€ç†±é¬§çš„è³¼ç‰©å€ã€‚å¿ƒé½‹æ©‹æœ‰å¤§ä¸¸ç™¾è²¨ã€Uniqloæ——è‰¦åº—ã€è—¥å¦åº—ã€‚æ™šé¤å»ºè­°åˆ°é“é “å €å“åšç« é­šç‡’ã€æ‹‰éºµ (ä¸€è˜­/é‡‘é¾) æˆ–å¤§é˜ªç‡’ã€‚åˆ¥å¿˜äº†åœ¨æˆæ©‹è·Ÿå›ºåŠ›æœè·‘è·‘äººåˆç…§ï¼' },
  { id: 11, date: '2026-04-02', category: 'transport', name: 'å¿ƒé½‹æ©‹ â†’ é£¯åº—', time: '21:30', travelTime: 15, transportType: 'walk', note: 'æ­¥è¡Œæˆ–æ­åœ°éµ', description: 'åƒé£½å–è¶³å¾Œï¼Œæ•£æ­¥å›é£¯åº—æ¶ˆåŒ–ä¸€ä¸‹ï¼ŒçµæŸç¬¬ä¸€å¤©çš„è¡Œç¨‹ã€‚' },

  // Day 2 (Nara)
  { id: 201, date: '2026-04-03', category: 'transport', name: 'é£¯åº— â†’ å¥ˆè‰¯', time: '08:00', travelTime: 60, transportType: 'transit', note: 'åœ°éµè½‰è¿‘éµ', description: 'ğŸ“ è½‰ä¹˜è·¯å¾‘ï¼š\n1. æœ¬ç”ºç«™ (M18) â†’ é›£æ³¢ç«™ (M20) (åœ°éµå¾¡å ‚ç­‹ç·š)\n2. é›£æ³¢ç«™ â†’ è¿‘éµå¥ˆè‰¯ç«™ (è¿‘éµå¥ˆè‰¯ç·š - å¿«é€Ÿæ€¥è¡Œ)\nğŸ’¡ æç¤ºï¼šæ­ä¹˜å¿«é€Ÿæ€¥è¡Œç´„ 40 åˆ†é˜ï¼Œæ¯”æ™®é€šè»Šå¿«å¾ˆå¤šã€‚' },
  { id: 202, date: '2026-04-03', category: 'attraction', name: 'å¥ˆè‰¯å…¬åœ’ (æ¢…èŠ±é¹¿å…¬åœ’)', time: '09:10', travelTime: 10, transportType: 'walk', note: 'è²·é¹¿ä»™è²å°å¿ƒè¢«åœæ”»', ticket: 'é¹¿ä»™è²Â¥200', description: 'å¾è¿‘éµå¥ˆè‰¯ç«™ 2 è™Ÿå‡ºå£å‡ºä¾†ï¼Œæ²¿è‘—ç™»å¤§è·¯å¾€æ±èµ°å³é”ã€‚æ²¿é€”å°±æœƒçœ‹åˆ°å¾ˆå¤šé¹¿ã€‚è«‹æ³¨æ„æ‰‹ä¸Šçš„åœ°åœ–æˆ–ç´™å¼µï¼Œé¹¿å¯èƒ½æœƒå’¬èµ°ã€‚' },
  { id: 203, date: '2026-04-03', category: 'attraction', name: 'æ±å¤§å¯º (å¤§ä½›æ®¿)', time: '10:00', travelTime: 15, transportType: 'walk', note: 'ä¸–ç•Œæœ€å¤§æœ¨é€ å»ºç¯‰', ticket: 'Â¥600', openHours: '07:30 - 17:30', description: 'ç©¿è¶Šå·¨å¤§çš„å—å¤§é–€ï¼ˆæœ‰é‡‘å‰›åŠ›å£«åƒï¼‰ï¼Œåƒè§€å¤§ä½›æ®¿å…§çš„ç›§èˆé‚£ä½›ã€‚å¦‚æœäººä¸å¤šï¼Œå¯ä»¥æŒ‘æˆ°é‘½ã€Œå¤§ä½›é¼»å­”ã€æŸ±å­æ´ï¼Œè½èªªèƒ½ä¿å¹³å®‰ã€‚' },
  { id: 204, date: '2026-04-03', category: 'attraction', name: 'æ˜¥æ—¥å¤§ç¤¾', time: '11:30', travelTime: 20, transportType: 'walk', note: 'åƒé“çŸ³ç‡ˆç± ', description: 'æ²¿è‘—æ£®æ—åƒé“å‰å¾€ï¼Œé€™è£¡æ°£æ°›æ¯”è¼ƒå¹½éœã€‚ä»¥æ•¸åƒåº§çŸ³ç‡ˆç± å’ŒåŠç‡ˆç± èåã€‚å¦‚æœèµ°ç´¯äº†ï¼Œå¯ä»¥åœ¨åƒé“å…¥å£é™„è¿‘çš„èŒ¶å±‹ä¼‘æ¯åƒé»æ±è¥¿ã€‚' },
  { id: 205, date: '2026-04-03', category: 'transport', name: 'æ˜¥æ—¥å¤§ç¤¾ â†’ JR å¥ˆè‰¯ç«™', time: '13:00', travelTime: 25, transportType: 'transit', note: 'æ­ä¹˜å·´å£«', description: 'ğŸš‰ è·¯ç·šï¼šå¥ˆè‰¯äº¤é€šå·´å£« (70/97/98è™Ÿ)\nğŸ“ å€é–“ï¼šæ˜¥æ—¥å¤§ç¤¾æœ¬æ®¿ â†’ JR å¥ˆè‰¯ç«™\nğŸ’¡ æç¤ºï¼šè‹¥æ­¥è¡Œéœ€ç´„ 30-40 åˆ†é˜ï¼Œå»ºè­°æ­è»Šä¿ç•™é«”åŠ›ã€‚' },
  { id: 206, date: '2026-04-03', category: 'transport', name: 'JR å¥ˆè‰¯ â†’ JR ç¨»è·', time: '13:30', travelTime: 35, transportType: 'transit', note: 'æ­ä¹˜ JR å¥ˆè‰¯ç·š', description: 'ğŸš‰ è·¯ç·šï¼šJR å¥ˆè‰¯ç·š\nğŸ“ å€é–“ï¼šJR å¥ˆè‰¯ç«™ â†’ JR ç¨»è·ç«™\nğŸ’¡ æ³¨æ„ï¼šè«‹æ­ä¹˜ã€Œæ™®é€šã€åˆ—è»Š (Miyakoji Rapid ä¸åœç¨»è·)ï¼Œæˆ–æ­å¿«é€Ÿåˆ°å®‡æ²»/æ±ç¦å¯ºå†è½‰æ™®é€šè»Šã€‚' },
  { id: 207, date: '2026-04-03', category: 'attraction', name: 'ä¼è¦‹ç¨»è·å¤§ç¤¾', time: '14:10', travelTime: 0, transportType: 'walk', note: 'åƒæœ¬é³¥å±…', description: 'å¿…æ‹åƒæœ¬é³¥å±…ï¼å»ºè­°å¾€å±±ä¸Šèµ°ä¸€æ®µï¼Œäººæ½®æœƒè®Šå°‘ï¼Œæ¯”è¼ƒå¥½æ‹ç…§ã€‚é€™è£¡ç‹ç‹¸æ˜¯ç¥çš„ä½¿è€…ï¼Œç¹ªé¦¬ä¹Ÿæ˜¯ç‹ç‹¸å½¢ç‹€çš„å–”ã€‚' },
  { id: 208, date: '2026-04-03', category: 'transport', name: 'ç¨»è· â†’ é£¯åº— (ç¶“äº¬éƒ½/æ–°å¤§é˜ª)', time: '16:30', travelTime: 60, transportType: 'transit', note: 'JR è½‰ åœ°éµ', description: 'ğŸ“ è½‰ä¹˜è·¯å¾‘ï¼š\n1. JR ç¨»è·ç«™ â†’ JR äº¬éƒ½ç«™ (JRå¥ˆè‰¯ç·š)\n2. JR äº¬éƒ½ç«™ â†’ JR æ–°å¤§é˜ªç«™ (JRäº¬éƒ½ç·š - æ–°å¿«é€Ÿ)\n3. æ–°å¤§é˜ªç«™ â†’ æœ¬ç”ºç«™ (M18) (åœ°éµå¾¡å ‚ç­‹ç·š)\nğŸ’¡ é€™æ˜¯åˆ©ç”¨ JR PASS æˆ–å–®ç¨‹ç¥¨çš„å¿«é€Ÿèµ°æ³•ã€‚' },
  { id: 209, date: '2026-04-03', category: 'shopping', name: 'æ™šä¸Šè‡ªç”±é€›è¡—', time: '18:30', travelTime: 0, transportType: 'walk', note: 'è‡ªç”±æ´»å‹•', description: 'å›åˆ°æœ¬ç”º/å¿ƒé½‹æ©‹å€åŸŸã€‚å¯ä»¥å„è‡ªå»è—¥å¦åº—è£œè²¨ï¼Œæˆ–æ˜¯å»é›£æ³¢ Parksã€é«˜å³¶å±‹é€›è¡—ã€‚æ™šé¤å¯ç›¸ç´„åƒç‡’è‚‰æˆ–å„è‡ªè¦“é£Ÿã€‚' },

  // Day 3 (Kyoto)
  { id: 301, date: '2026-04-04', category: 'transport', name: 'é£¯åº— â†’ äº¬éƒ½è»Šç«™', time: '08:00', travelTime: 50, transportType: 'transit', note: 'åœ°éµè½‰ JR (ç¶“æ–°å¤§é˜ª)', description: 'ğŸ“ è½‰ä¹˜è·¯å¾‘ï¼š\n1. æœ¬ç”ºç«™ (M18) â†’ æ–°å¤§é˜ªç«™ (M13) (åœ°éµå¾¡å ‚ç­‹ç·š)\n2. JR æ–°å¤§é˜ªç«™ â†’ JR äº¬éƒ½ç«™ (JRäº¬éƒ½ç·š - æ–°å¿«é€Ÿ)\nğŸ’¡ æç¤ºï¼šåœ¨æ–°å¤§é˜ªè½‰ä¹˜æ¯”åœ¨æ¢…ç”°ç°¡å–®ï¼Œæ­ä¹˜ã€Œæ–°å¿«é€Ÿã€åˆ—è»Šç´„ 25 åˆ†é˜æŠµé”äº¬éƒ½ã€‚' },
  { id: 302, date: '2026-04-04', category: 'transport', name: 'äº¬éƒ½è»Šç«™ â†’ æ¸…æ°´å¯º', time: '09:00', travelTime: 30, transportType: 'transit', note: 'è½‰ä¹˜äº¬éƒ½å¸‚å·´å£«', description: 'ğŸš‰ è·¯ç·šï¼šäº¬éƒ½å¸‚å·´å£« (206è™Ÿ / 100è™Ÿ)\nğŸ“ å€é–“ï¼šäº¬éƒ½è»Šç«™å‰å·´å£«ç¸½ç«™ (D1/D2) â†’ äº”æ¢å‚æˆ–æ¸…æ°´é“\nğŸš¶ æ­¥è¡Œï¼šä¸‹è»Šå¾Œæ­¥è¡Œä¸Šå¡ç´„ 10-15 åˆ†é˜æŠµé”ä»ç‹é–€ã€‚' },
  { id: 303, date: '2026-04-04', category: 'attraction', name: 'æ¸…æ°´å¯º', time: '09:40', travelTime: 15, transportType: 'walk', note: 'æ¸…æ°´èˆå°ã€éŸ³ç¾½ç€‘å¸ƒ', ticket: 'Â¥400', openHours: '06:00 - 18:00', description: 'äº¬éƒ½æœ€è‘—åçš„å¤è€å¯ºé™¢ï¼Œå¿…çœ‹æ‡¸ç©ºçš„ã€Œæ¸…æ°´èˆå°ã€ã€‚åƒæ‹œå¾Œå¯å»ã€Œåœ°ä¸»ç¥ç¤¾ã€æ±‚å§»ç·£ (è‹¥æ•´ä¿®ä¸­å‰‡ç•¥é)ï¼Œæœ€å¾Œåˆ¥å¿˜äº†åœ¨ã€ŒéŸ³ç¾½ç€‘å¸ƒã€æ’éšŠå–æ°´ç¥ˆç¦ï¼ˆåˆ†åˆ¥ä»£è¡¨å­¸æ¥­ã€æˆ€æ„›ã€é•·å£½ï¼Œåªèƒ½é¸ä¸€é“å–å–”ï¼‰ã€‚' },
  { id: 304, date: '2026-04-04', category: 'attraction', name: 'æ•£æ­¥ï¼šäºŒä¸‰å¹´å‚ & å¯§å¯§ä¹‹é“', time: '11:30', travelTime: 0, transportType: 'walk', note: 'å¤è‰²å¤é¦™è€è¡—', description: 'é †è‘—æ¸…æ°´å¯ºèµ°ä¸‹ä¾†ï¼Œæœƒç¶“éä¸‰å¹´å‚ï¼ˆç”¢å¯§å‚ï¼‰å’ŒäºŒå¹´å‚ã€‚é€™è£¡æœ‰éå¸¸å¤šæ—¥å¼é›œè²¨èˆ‡é»å¿ƒåº—ã€‚é€”ä¸­æ¨è–¦å»ã€Œæ˜Ÿå·´å…‹äº¬éƒ½äºŒå¯§å‚é›…ç¥¥èŒ¶å±‹åº—ã€æ‹ç…§ï¼Œé€™æ˜¯å…¨çƒå”¯ä¸€è¨­åœ¨ç™¾å¹´ç”ºå®¶è£¡çš„æ¦»æ¦»ç±³æ˜Ÿå·´å…‹ã€‚æ¥è‘—å‰å¾€é«˜å°å¯ºæ—çš„å¯§å¯§ä¹‹é“ã€‚' },
  { id: 305, date: '2026-04-04', category: 'attraction', name: 'å…«å‚ç¥ç¤¾ã€ç¥‡åœ’ & èŠ±è¦‹å°è·¯', time: '13:00', travelTime: 15, transportType: 'walk', note: 'è—å¦“èˆ‡èŒ¶å±‹æ–‡åŒ–', description: 'æ²¿è‘—å¯§å¯§ä¹‹é“èµ°åˆ°å…«å‚ç¥ç¤¾ï¼Œå†å‰å¾€ç¥‡åœ’å€åŸŸã€‚èŠ±è¦‹å°è·¯å…©æ—æ˜¯ä¿å­˜è‰¯å¥½çš„å‚³çµ±èŒ¶å±‹ï¼Œé‹æ°£å¥½å¯èƒ½æœƒçœ‹åˆ°è—å¦“æˆ–èˆå¦“ç¶“éï¼ˆè«‹å‹¿è§¸ç¢°æˆ–é˜»æ“‹æ‹ç…§ï¼‰ã€‚åˆé¤å»ºè­°åœ¨æ­¤å€åŸŸæˆ–æ²³åŸç”ºè§£æ±ºã€‚' },
  { id: 306, date: '2026-04-04', category: 'attraction', name: 'é´¨å· & æ²³åŸç”ºå•†åº—è¡—', time: '15:00', travelTime: 10, transportType: 'walk', note: 'æ²³å²¸æ•£æ­¥èˆ‡é€›è¡—', description: 'å¾ç¥‡åœ’è·¨éå››æ¢å¤§æ©‹å°±æ˜¯é´¨å·ï¼Œé©åˆåœ¨æ²³å ¤é‚Šåè‘—ä¼‘æ¯å¹é¢¨ï¼Œæ¬£è³æ²³æ™¯ã€‚éæ©‹å¾Œå³é€²å…¥æ²³åŸç”ºå•†åœˆï¼Œé€™è£¡æœ‰é«˜å³¶å±‹ã€Disney Storeã€å„ç§è—¥å¦èˆ‡æœé£¾åº—ï¼Œéå¸¸å¥½é€›ã€‚' },
  { id: 307, date: '2026-04-04', category: 'transport', name: 'æ²³åŸç”º â†’ äº¬éƒ½è»Šç«™', time: '18:00', travelTime: 20, transportType: 'transit', note: 'åœ°éµæˆ–å·´å£«', description: 'ğŸš‰ è·¯ç·šï¼šäº¬éƒ½å¸‚å·´å£« æˆ– åœ°éµçƒä¸¸ç·š\nğŸ“ å€é–“ï¼šå››æ¢æ²³åŸç”º â†’ äº¬éƒ½è»Šç«™\nğŸ’¡ æç¤ºï¼šå·´å£«äººå¤šæ™‚ï¼Œå»ºè­°èµ°è‡³åœ°éµå››æ¢ç«™æ­ä¹˜çƒä¸¸ç·šã€‚' },
  { id: 308, date: '2026-04-04', category: 'transport', name: 'äº¬éƒ½è»Šç«™ â†’ é£¯åº—', time: '18:30', travelTime: 50, transportType: 'transit', note: 'JR è½‰ åœ°éµ (ç¶“æ–°å¤§é˜ª)', description: 'ğŸ“ è½‰ä¹˜è·¯å¾‘ï¼š\n1. JR äº¬éƒ½ç«™ â†’ JR æ–°å¤§é˜ªç«™ (JRäº¬éƒ½ç·š - æ–°å¿«é€Ÿ)\n2. æ–°å¤§é˜ªç«™ â†’ æœ¬ç”ºç«™ (M18) (åœ°éµå¾¡å ‚ç­‹ç·š)\nğŸ’¡ é€™æ˜¯æœ€å¿«ä¹Ÿæœ€å–®ç´”çš„è·¯ç·šã€‚æ™šé¤å»ºè­°åœ¨äº¬éƒ½è»Šç«™æ‹‰éºµå°è·¯è§£æ±ºï¼Œæˆ–è²·ä¾¿ç•¶å›é£¯åº—äº«ç”¨ã€‚' },
  { id: 310, date: '2026-04-04', category: 'other', name: 'é£¯åº—è‡ªç”±æ´»å‹•', time: '20:00', travelTime: 0, transportType: 'walk', note: 'ä¼‘æ¯æˆ–æ•´ç†è¡Œæ', description: 'ç¶“éä¸€æ•´å¤©äº¬éƒ½èµ°è·¯è¡Œç¨‹ï¼Œè…¿æ‡‰è©²å¾ˆé…¸äº†ï¼Œå»ºè­°æ—©é»ä¼‘æ¯ï¼Œæˆ–æ˜¯åœ¨é£¯åº—é™„è¿‘è¶…å•†è²·é»å®µå¤œã€‚' },

  // Day 4 (Osaka)
  { id: 401, date: '2026-04-05', category: 'transport', name: 'é£¯åº— â†’ æµ·éŠé¤¨', time: '08:00', travelTime: 20, transportType: 'transit', note: 'æ­ä¹˜ä¸­å¤®ç·š (ç¶ ç·š)', description: 'ğŸ“ è½‰ä¹˜è·¯å¾‘ï¼š\n1. æœ¬ç”ºç«™ (C16) æ­¥è¡Œ/è½‰ä¹˜è‡³ ä¸­å¤®ç·šæœˆå°\n2. æ­ä¹˜ åœ°éµä¸­å¤®ç·š (å¾€å®‡å®™å»£å ´æ–¹å‘) â†’ å¤§é˜ªæ¸¯ç«™ (C11)\n3. 1è™Ÿæˆ–2è™Ÿå‡ºå£å‡ºç«™ï¼Œæ­¥è¡Œç´„ 5-10 åˆ†é˜æŠµé”ã€‚' },
  { id: 402, date: '2026-04-05', category: 'attraction', name: 'æµ·éŠé¤¨', time: '08:30', travelTime: 0, transportType: 'walk', note: 'ä¸–ç•Œæœ€å¤§ç´šæ°´æ—é¤¨', ticket: 'Â¥2,700', openHours: '09:30 - 20:00', description: 'æ—©é»åˆ°å¯ä»¥é¿é–‹æ’éšŠäººæ½®ã€‚å¿…çœ‹å·¨å¤§çš„ã€Œå¤ªå¹³æ´‹ã€æ°´æ§½èˆ‡é®é¤¨ä¹‹å¯¶â€”â€”é¯¨é¯Šã€‚é¤¨å…§è¨­è¨ˆæ˜¯å¾8æ¨“èºæ—‹ç‹€å¾€ä¸‹åƒè§€ï¼Œæ¨¡æ“¬å¾æµ·é¢æ½›å…¥æ·±æµ·çš„éç¨‹ã€‚' },
  { id: 403, date: '2026-04-05', category: 'transport', name: 'æµ·éŠé¤¨ â†’ é€šå¤©é–£', time: '11:00', travelTime: 30, transportType: 'transit', note: 'ä¸­å¤®ç·šè½‰å ºç­‹ç·š', description: 'ğŸ“ è½‰ä¹˜è·¯å¾‘ï¼š\n1. å¤§é˜ªæ¸¯ç«™ (C11) â†’ å ºç­‹æœ¬ç”ºç«™ (C17) (åœ°éµä¸­å¤®ç·š)\n2. å ºç­‹æœ¬ç”ºç«™ â†’ æƒ ç¾é ˆç”ºç«™ (K18) (åœ°éµå ºç­‹ç·š)\n3. 3è™Ÿå‡ºå£å‡ºç«™ï¼Œé€šå¤©é–£å°±åœ¨çœ¼å‰ã€‚' },
  { id: 404, date: '2026-04-05', category: 'attraction', name: 'é€šå¤©é–£ & æ–°ä¸–ç•Œ', time: '11:40', travelTime: 0, transportType: 'walk', note: 'å¤§é˜ªæ‡·èˆŠåœ°æ¨™', description: 'é€™è£¡å……æ»¿æ˜­å’Œæ™‚ä»£çš„æ‡·èˆŠæ°›åœï¼Œå·¨å¤§çš„æ²³è±šæ‹›ç‰Œæ˜¯å¿…æ‹æ™¯é»ã€‚å¯ä»¥ä¸Šé€šå¤©é–£å±•æœ›å°æ‘¸æ‘¸Billikenç¥åƒçš„è…³åº•æ±‚å¥½é‹ã€‚' },
  { id: 405, date: '2026-04-05', category: 'food', name: 'åˆé¤ï¼šå…ƒç¥–ç‚¸ä¸²', time: '12:00', travelTime: 0, transportType: 'walk', note: 'ç¦æ­¢äºŒæ¬¡æ²¾é†¬', description: 'åœ¨æ–°ä¸–ç•Œå•†åº—è¡—äº«ç”¨å¤§é˜ªåç‰©ã€Œç‚¸ä¸² (Kushikatsu)ã€ã€‚æ¨è–¦ã€Œé”æ‘© (Daruma)ã€æˆ–ã€Œå…«é‡å‹ã€ã€‚è¨˜å¾—é†¬æ±æ˜¯å…±ç”¨çš„ï¼Œå’¬éå¾Œçµ•å°ä¸èƒ½å†æ²¾å–”ï¼' },
  { id: 406, date: '2026-04-05', category: 'attraction', name: 'å¤©ç‹å¯ºå‹•ç‰©åœ’', time: '13:30', travelTime: 10, transportType: 'walk', note: 'ç™¾å¹´å‹•ç‰©åœ’', ticket: 'Â¥500', openHours: '09:30 - 17:00', description: 'å¾æ–°ä¸–ç•Œæ­¥è¡Œå³å¯æŠµé”ã€Œæ–°ä¸–ç•Œå¤§é–€ã€ã€‚åœ’å€å…§æœ‰æ¨¡æ“¬éæ´²ç†±å¸¶è‰åŸçš„ç”Ÿæ…‹å±•ç¤ºå€ï¼Œèƒ½è¿‘è·é›¢è§€å¯Ÿæ²³é¦¬ã€ç…å­ç­‰å‹•ç‰©ã€‚' },
  { id: 407, date: '2026-04-05', category: 'transport', name: 'å‹•ç‰©åœ’ â†’ é˜¿å€é‡', time: '15:30', travelTime: 15, transportType: 'walk', note: 'ç©¿è¶Šå¤©ç‹å¯ºå…¬åœ’', description: 'ğŸš‰ è·¯ç·šï¼šæ­¥è¡Œ\nğŸ“ å€é–“ï¼šå¤©ç‹å¯ºå‹•ç‰©åœ’ â†’ é˜¿å€é‡ HARUKAS\nğŸš¶ æ­¥è¡Œï¼šç©¿è¶Šæ¼‚äº®çš„ã€Œå¤©ç‹å¯ºå…¬åœ’ (Ten-Shiba)ã€è‰çš®å€ï¼Œå‰æ–¹æœ€é«˜çš„æ‘©å¤©å¤§æ¨“å°±æ˜¯ã€‚' },
  { id: 408, date: '2026-04-05', category: 'attraction', name: 'é˜¿å€é‡ HARUKAS 300', time: '16:00', travelTime: 0, transportType: 'walk', note: 'çµ•ç¾æ—¥è½èˆ‡å¤œæ™¯', ticket: 'Â¥1,800', openHours: '09:00 - 22:00', description: 'ææ—©ä¸Šå±•æœ›å°ä½”å€‹å¥½ä½ç½®ï¼åœ¨ 60 æ¨“å±•æœ›å° 360 åº¦ä¿¯ç°å¤§é˜ªå…¨æ™¯ã€‚é€™å€‹æ™‚é–“ä¸Šå»å¯ä»¥æ‚ é–’åœ°ç­‰å¾…æ—¥è½ï¼Œä¸€æ¬¡æ¬£è³ç™½å¤©ã€å¤•é™½èˆ‡ç™¾è¬å¤œæ™¯çš„è®ŠåŒ–ã€‚' },
  { id: 409, date: '2026-04-05', category: 'transport', name: 'å¤©ç‹å¯º â†’ é£¯åº—', time: '18:30', travelTime: 15, transportType: 'transit', note: 'å¾¡å ‚ç­‹ç·šç›´é”', description: 'ğŸš‰ è·¯ç·šï¼šåœ°éµå¾¡å ‚ç­‹ç·š\nğŸ“ å€é–“ï¼šå¤©ç‹å¯ºç«™ (M23) â†’ æœ¬ç”ºç«™ (M18)\nğŸ’¡ æç¤ºï¼šå…è½‰ä¹˜ï¼Œç›´é”é£¯åº—ã€‚' },
  { id: 410, date: '2026-04-05', category: 'other', name: 'å›é£¯åº—ä¼‘æ¯', time: '19:00', travelTime: 0, transportType: 'walk', note: 'æ•´ç†æˆ°åˆ©å“', description: 'æœ€å¾Œä¸€æ™šäº†ï¼Œæ—©é»å›é£¯åº—æ•´ç†è¡Œæï¼Œç¢ºèªä¼´æ‰‹ç¦®æ˜¯å¦è²·é½Šï¼Œæ˜å¤©å°±è¦å›ç¨‹å›‰ã€‚' },

  // Day 5 (Return)
  { id: 501, date: '2026-04-06', category: 'transport', name: 'é£¯åº— â†’ é—œè¥¿æ©Ÿå ´', time: '08:30', travelTime: 60, transportType: 'transit', note: 'åœ°éµè½‰å—æµ·é›»éµ', description: 'ğŸ“ è½‰ä¹˜è·¯å¾‘ï¼š\n1. æœ¬ç”ºç«™ (M18) â†’ é›£æ³¢ç«™ (M20) (åœ°éµå¾¡å ‚ç­‹ç·š)\n2. å—æµ·é›£æ³¢ç«™ â†’ é—œè¥¿æ©Ÿå ´ç«™ (å—æµ·é›»éµ - ç©ºæ¸¯æ€¥è¡Œ)\nğŸ’¡ é›–ç„¶ç­æ©Ÿæ˜¯ 12:00ï¼Œä½†å»ºè­° 10:00 å‰æŠµé”æ©Ÿå ´æ¯”è¼ƒå……è£•ã€‚' },
  { id: 502, date: '2026-04-06', category: 'other', name: 'æ©Ÿå ´å ±åˆ° & è¡Œææ‰˜é‹', time: '10:00', travelTime: 0, transportType: 'walk', note: 'IT-285 (ç¬¬ä¸€èˆªå»ˆ)', description: 'å‰å¾€å°ç£è™èˆªæ«ƒå°è¾¦ç†ç™»æ©Ÿã€‚è¨˜å¾—å†æ¬¡ç¢ºèªéš¨èº«è¡Œæå…§æ²’æœ‰è¶…é 100ml çš„æ¶²é«”ã€å‰ªåˆ€ç­‰é•ç¦å“ã€‚è¡Œå‹•é›»æºå’Œé›»æ± è«‹å‹™å¿…éš¨èº«æ”œå¸¶ï¼Œä¸å¯æ‰˜é‹ã€‚' },
  { id: 503, date: '2026-04-06', category: 'shopping', name: 'å…ç¨…åº—æƒè²¨ & ä¼´æ‰‹ç¦®', time: '10:40', travelTime: 0, transportType: 'walk', note: 'ğŸ å¿…è²·æ¨è–¦æ¸…å–®', description: 'éæµ·é—œå¾Œçš„æœ€å¾Œè¡åˆºï¼æ¨è–¦è³¼è²·ï¼š\n1. ğŸ« ROYCE\' ç”Ÿå·§å…‹åŠ› & æ´‹èŠ‹ç‰‡ (è¨˜å¾—è²·ä¿å†·è¢‹)\n2. ğŸŒ æ±äº¬é¦™è•‰ (Tokyo Banana) - é€™è£¡ä¹Ÿè²·å¾—åˆ°ï¼\n3. ğŸ° LeTAO é›™å±¤ä¹³é…ªè›‹ç³• (ä¾†è‡ªåŒ—æµ·é“çš„ç¾å‘³)\n4. ğŸŸ è–¯æ¢ä¸‰å…„å¼Ÿ (Jaga Pokkuru)\n5. ğŸµ äº¬éƒ½åŒ—å±±èŒ¶ä¹‹è“ (æ¿ƒéƒæŠ¹èŒ¶é¤…ä¹¾)\n6. ğŸ¬ å‘¼å¸å·§å…‹åŠ› (å¤§é˜ªé™å®šï¼Œå¤§åŒ…è£é©åˆåˆ†é€)\nğŸ’¡ æç¤ºï¼šå‰©ä¸‹çš„æ—¥å¹£é›¶éŒ¢å¯ä»¥åœ¨é€™è£¡å…¨éƒ¨èŠ±æ‰ï¼Œä¸è¶³çš„é‡‘é¡å†åˆ·å¡ã€‚' },
  { id: 504, date: '2026-04-06', category: 'flight', name: 'èˆªç­ IT-285 KIX->KHH', time: '12:00', travelTime: 0, transportType: 'flight', note: 'èµ·é£› 12:00 / æŠµé” 14:00', description: 'å¸¶è‘—æ»¿æ»¿çš„å›æ†¶å›å®¶å›‰ï¼âœˆï¸ æŠµé”é«˜é›„å¾Œè¨˜å¾—é ˜å–è¡Œæã€‚' }
];
</script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  
  // ç§»é™¤å¾ CDN å¼•å…¥ Vue çš„é€™è¡Œï¼Œæ”¹ç”¨å…¨åŸŸè®Šæ•¸
  const { createApp, ref, computed, reactive, onMounted, watch } = Vue;

  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDc1X5CFJc7ThluEmPN--uVKxSfrlZavek",
    authDomain: "osa0402test.firebaseapp.com",
    projectId: "osa0402test",
    storageBucket: "osa0402test.firebasestorage.app",
    messagingSenderId: "49893570598",
    appId: "1:49893570598:web:c334c87afbd84ee329cee7",
    measurementId: "G-HTNRTFVN0S"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  // ä¿ç•™æ‚¨çš„èˆŠè³‡æ–™ ID (v8_final)
  const TRIP_ID = "keihan_2026_0402_v8_final";

  createApp({
    setup() {
      // Basic UI State
      const showSplash = ref(true);
      const currentTab = ref('itinerary');
      const tabs = [
        { id: 'itinerary', name: 'è¡Œç¨‹è¡¨', icon: 'fa-solid fa-map-location-dot' },
        { id: 'info', name: 'è³‡è¨Š', icon: 'fa-solid fa-circle-info' },
        { id: 'shopping', name: 'è³¼ç‰©æ¸…å–®', icon: 'fa-solid fa-basket-shopping' },
        { id: 'expense', name: 'èŠ±è²»', icon: 'fa-solid fa-yen-sign' },
        { id: 'notebook', name: 'ç­†è¨˜æœ¬', icon: 'fa-solid fa-book' },
      ];
      const bannerImage = ref('https://i.ibb.co/8nZ43bCk/Gemini-Generated-Image-nki8ufnki8ufnki8.png');
      const handleImageError = () => { bannerImage.value = 'https://via.placeholder.com/480x250?text=Trip'; };
      
      const tripStartDate = new Date('2026-04-02T00:00:00');
      const daysUntilTrip = computed(() => {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const start = new Date(tripStartDate.getFullYear(), tripStartDate.getMonth(), tripStartDate.getDate());
        const diffTime = start - today;
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      });
      
      const travelers = ref(['å…¬è²»', 'ç¿”/å›', 'å€«/æ€¡', 'èŒ¹', 'åª½åª½', 'çˆ¸çˆ¸']);
      const shoppingTravelers = computed(() => ['å…¨éƒ¨', ...travelers.value.filter(t => t !== 'å…¬è²»')]);
      const notebookOwners = computed(() => travelers.value.filter(t => t !== 'å…¬è²»'));
      const packingPeople = ref(['å£«ç¿”', 'ä¾‘å›', 'å£«å€«', 'æ¬£æ€¡', 'ç®èŒ¹', 'åª½åª½', 'çˆ¸çˆ¸']);

      const days = [
        { dateStr: '2026-04-02', displayDate: '4/2', dayOfWeek: 'é€±å››', mainCity: 'å¤§é˜ªå¸‚', locations: [{name:'å¤§é˜ªå¸‚', lat:34.6937, lng:135.5023}] },
        { dateStr: '2026-04-03', displayDate: '4/3', dayOfWeek: 'é€±äº”', mainCity: 'å¥ˆè‰¯/äº¬éƒ½', locations: [{name:'å¤§é˜ªå¸‚', lat:34.6937, lng:135.5023}, {name:'å¥ˆè‰¯å¸‚', lat:34.6851, lng:135.8048}, {name:'äº¬éƒ½å¸‚', lat:35.0116, lng:135.7681}] },
        { dateStr: '2026-04-04', displayDate: '4/4', dayOfWeek: 'é€±å…­', mainCity: 'äº¬éƒ½å¸‚', locations: [{name:'äº¬éƒ½å¸‚', lat:35.0116, lng:135.7681}, {name:'å¤§é˜ªå¸‚', lat:34.6937, lng:135.5023}] },
        { dateStr: '2026-04-05', displayDate: '4/5', dayOfWeek: 'é€±æ—¥', mainCity: 'å¤§é˜ªå¸‚', locations: [{name:'å¤§é˜ªå¸‚', lat:34.6937, lng:135.5023}] },
        { dateStr: '2026-04-06', displayDate: '4/6', dayOfWeek: 'é€±ä¸€', mainCity: 'é—œè¥¿æ©Ÿå ´', locations: [{name:'å¤§é˜ªå¸‚', lat:34.6937, lng:135.5023}, {name:'æ³‰ä½é‡å¸‚(æ©Ÿå ´)', lat:34.4320, lng:135.2304}] },
      ];
      const selectedDate = ref('2026-04-02');

      const isTigerairInfoExpanded = ref(false);

      // --- FIREBASE SYNC COLLECTIONS ---
      const itineraryList = ref([]);
      const shoppingList = ref([]);
      const expenses = ref([]);
      const notebookList = ref([]);
      const packingList = ref([]);
      const firebaseStatus = ref('connecting'); 
      const isSaving = ref(false);
      const migrationStatus = ref('');

      const currentMemberFilter = ref(null);
      const currentNotebookFilter = ref('ç¿”/å›');
      const currentShoppingFilter = ref('å…¨éƒ¨');
      const currentPackingFilter = ref('å£«ç¿”');
      const newPackingItem = ref('');

      const subscribeCollection = (colName, targetRef, orderByField = null) => {
        let q = collection(db, 'trips', TRIP_ID, colName);
        if (orderByField) q = query(q, orderBy(orderByField));
        
        onSnapshot(q, (snapshot) => {
            const data = [];
            snapshot.forEach(doc => {
                data.push({ id: doc.id, ...doc.data() });
            });
            targetRef.value = data;
            firebaseStatus.value = 'connected';
        }, (err) => {
            console.error("Sync error:", err);
            firebaseStatus.value = 'error';
        });
      };

      // --- DATA MIGRATION ---
      const checkAndMigrateData = async (force = false, specificPerson = null) => {
          migrationStatus.value = "æª¢æŸ¥è¡Œææ¸…å–®...";

          // Fetch all current packing items
          const packRef = collection(db, 'trips', TRIP_ID, 'packing');
          const snapPack = await getDocs(packRef);
          
          // Map of owner -> count of items
          const ownerCounts = {};
          packingPeople.value.forEach(p => ownerCounts[p] = 0);

          snapPack.forEach(doc => {
              const data = doc.data();
              if (data.owner && ownerCounts.hasOwnProperty(data.owner)) {
                  ownerCounts[data.owner]++;
              }
          });

          const defaultItems = [
               'è­·ç…§ (æœ‰æ•ˆæœŸ6å€‹æœˆä»¥ä¸Š)', 'Visit Japan Web QRcode æˆªåœ–', 'ç¶²å¡ / eSIM', 'æ—¥å¹£ç¾é‡‘ / ä¿¡ç”¨å¡',
               'è¡Œå‹•é›»æº (éœ€éš¨èº«æ”œå¸¶)', 'å€‹äººå¸¸å‚™è—¥ / æšˆæ©Ÿè—¥', 'ç‰™åˆ·ç‰™è† (æ—¥æœ¬éƒ¨åˆ†é£¯åº—ä¸ä¸»å‹•æä¾›)'
          ];

          const targets = specificPerson ? [specificPerson] : packingPeople.value;

          let updateCount = 0;

          for (const p of targets) {
                // Condition: Force update OR (Auto mode AND person has 0 items)
                if (force || (ownerCounts[p] === 0)) {
                    migrationStatus.value = `æ­£åœ¨ç‚º ${p} å»ºç«‹æ¸…å–®...`;
                    for (const txt of defaultItems) {
                        const safeId = (p + '_' + txt).replace(/[\/\s]/g, '');
                        await setDoc(doc(db, 'trips', TRIP_ID, 'packing', safeId), { 
                            text: txt, 
                            owner: p, 
                            checked: false,
                            createdAt: serverTimestamp() 
                        }, { merge: true });
                    }
                    updateCount++;
                }
          }
          
          migrationStatus.value = "";
          if ((force || specificPerson) && updateCount > 0) alert('å·²æˆåŠŸè£œé½Šé è¨­é …ç›®ï¼');
          else if ((force || specificPerson) && updateCount === 0) alert('æ¸…å–®å·²å­˜åœ¨ï¼Œç„¡éœ€è£œé½Šã€‚');
      };

      // é—œéµæ–°å¢åŠŸèƒ½ï¼šåªæ›´æ–°è¡Œç¨‹å…§å®¹ï¼Œä¸åˆªé™¤å…¶ä»–è³‡æ–™
      const updateItineraryContentOnly = async () => {
          if(!confirm('é€™å°‡æœƒæŠŠè¡Œç¨‹è¡¨çš„æ–‡å­—æè¿°æ›´æ–°ç‚ºæœ€æ–°ç‰ˆ (åŒ…å«é»‘é–€å¸‚å ´äº¤é€šæŒ‡å¼•èˆ‡ç¦é£Ÿæé†’)ï¼Œæ‚¨çš„è³¼ç‰©æ¸…å–®èˆ‡èŠ±è²»ç´€éŒ„éƒ½æœƒä¿ç•™ã€‚ç¢ºå®šæ›´æ–°å—ï¼Ÿ')) return;
          
          migrationStatus.value = "æ­£åœ¨æ›´æ–°è¡Œç¨‹è³‡æ–™...";
          const itinToUpload = window.__FULL_ITINERARY_DATA__ || [];
          
          try {
             // æ–°é‚è¼¯ï¼šä¾æ“š Name å’Œ Date ä¾†æ›´æ–°ï¼Œè€Œä¸æ˜¯ç›²ç›®ç”¨ ID
             const q = collection(db, 'trips', TRIP_ID, 'itinerary');
             const snapshot = await getDocs(q);
             const existingItems = [];
             snapshot.forEach(doc => existingItems.push({ _docId: doc.id, ...doc.data() }));

             if (Array.isArray(itinToUpload)) {
                  for (const item of itinToUpload) {
                      // å°‹æ‰¾æ˜¯å¦å·²æœ‰åŒååŒæ—¥æœŸçš„è¡Œç¨‹
                      const match = existingItems.find(ex => ex.name === item.name && ex.date === item.date);
                      
                      if (match) {
                          // å¦‚æœæœ‰ï¼Œæ›´æ–°è©²ç­†è³‡æ–™ (ä¿ç•™åŸæœ¬çš„ docID)
                          await setDoc(doc(db, 'trips', TRIP_ID, 'itinerary', match._docId), item, { merge: true });
                      } else {
                          // å¦‚æœæ²’æœ‰ï¼Œæ‰æ–°å¢
                          const id = item.id ? String(item.id) : Date.now().toString();
                          await setDoc(doc(db, 'trips', TRIP_ID, 'itinerary', id), item);
                      }
                  }
              }
              alert("è¡Œç¨‹è³‡æ–™å·²æ›´æ–°å®Œç•¢ï¼è‹¥ç™¼ç¾é‡è¤‡è¡Œç¨‹ï¼Œè«‹ä½¿ç”¨ä¸‹æ–¹çš„ã€Œä¿®å¾©é‡è¤‡è¡Œç¨‹ã€æŒ‰éˆ•ã€‚");
          } catch(e) {
              alert("æ›´æ–°å¤±æ•—ï¼š" + e.message);
          } finally {
              migrationStatus.value = "";
          }
      };

      // ä¿®å¾©é‡è¤‡è¡Œç¨‹åŠŸèƒ½ (è¶…ç´šå¼·åŠ›ç‰ˆ)
      const fixDuplicates = async () => {
          if(!confirm('é€™å°‡æœƒå¼·åˆ¶æƒææ‰€æœ‰ã€Œé«˜é›„å°æ¸¯æ©Ÿå ´é›†åˆã€çš„é …ç›®ï¼Œä¸¦å¼·åˆ¶å°‡å…¶æ›´æ–°ç‚º 04:30ï¼ŒåŒæ™‚åˆªé™¤å¤šé¤˜çš„é‡è¤‡é …ã€‚\n\nç¢ºå®šåŸ·è¡Œï¼Ÿ')) return;
          
          migrationStatus.value = "æ­£åœ¨å¼·åˆ¶ä¿®æ­£...";
          try {
              const q = collection(db, 'trips', TRIP_ID, 'itinerary');
              const snapshot = await getDocs(q);
              const items = [];
              snapshot.forEach(doc => items.push({ _docId: doc.id, ...doc.data() }));

              let deletedCount = 0;
              let updatedCount = 0;
              const seedData = window.__FULL_ITINERARY_DATA__ || [];

              // é‡å°æ¯ä¸€å€‹ç¨®å­è³‡æ–™
              for (const seed of seedData) {
                  // æ‰¾å‡ºè³‡æ–™åº«ä¸­æ‰€æœ‰åŒååŒæ—¥æœŸçš„é …ç›®
                  const duplicates = items.filter(i => i.name === seed.name && i.date === seed.date);
                  
                  if (duplicates.length > 0) {
                      // 1. é¸å‡ºè¦ä¿ç•™çš„ã€Œå€–å­˜è€…ã€ï¼ˆç›´æ¥é¸ç¬¬ä¸€ç­†æ‰¾åˆ°çš„ï¼Œä¸ç®¡å®ƒæ˜¯èª°ï¼‰
                      const survivor = duplicates[0];

                      // 2. ã€é—œéµå‹•ä½œã€‘å¼·åˆ¶æŠŠå€–å­˜è€…çš„å…§å®¹ï¼Œè¦†å¯«æˆç¨‹å¼ç¢¼è£¡çš„æœ€æ–°ç‰ˆ (04:30)
                      const survivorRef = doc(db, 'trips', TRIP_ID, 'itinerary', survivor._docId);
                      await setDoc(survivorRef, seed); // ç›´æ¥è¦†è“‹ï¼Œä¸ä½¿ç”¨ mergeï¼Œç¢ºä¿å®Œå…¨ä¸€è‡´
                      updatedCount++;

                      // 3. åˆªé™¤å…¶ä»–çš„é‡è¤‡é …
                      if (duplicates.length > 1) {
                          for (let i = 1; i < duplicates.length; i++) {
                              await deleteDoc(doc(db, 'trips', TRIP_ID, 'itinerary', duplicates[i]._docId));
                              deletedCount++;
                          }
                      }
                  }
              }
              
              alert(`å¼·åˆ¶ä¿®å¾©å®Œæˆï¼\n- å·²å¼·åˆ¶æ›´æ–° ${updatedCount} ç­†è³‡æ–™ç‚ºæœ€æ–°å…§å®¹ (å« 04:30)\n- å·²ç§»é™¤ ${deletedCount} ç­†é‡è¤‡é …ç›®`);
          } catch(e) {
              alert("ä¿®å¾©å¤±æ•—ï¼š" + e.message);
          } finally {
              migrationStatus.value = "";
          }
      };

      const forceResetData = () => {
          if(confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è¡Œç¨‹å—ï¼Ÿé€™æœƒè¦†è“‹ç›®å‰çš„ä¿®æ”¹ã€‚')) {
              checkAndMigrateData(true);
          }
      };
      
      const reconnectFirebase = () => window.location.reload();

      // --- COMPUTED DATA VIEWS ---
      const filteredItinerary = computed(() => 
        itineraryList.value
            .filter(i => i.date === selectedDate.value)
            .sort((a,b) => (a.time || '').localeCompare(b.time || ''))
      );

      const filteredShoppingList = computed(() => {
        if (currentShoppingFilter.value === 'å…¨éƒ¨') return shoppingList.value;
        return shoppingList.value.filter(item => item.owner === currentShoppingFilter.value);
      });

      const filteredExpenses = computed(() => {
        if (!currentMemberFilter.value) return expenses.value;
        return expenses.value.filter(item => item.owner === currentMemberFilter.value);
      });

      const filteredTotalExpense = computed(() => filteredExpenses.value.reduce((sum, item) => sum + Number(item.amount||0), 0));
      const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + Number(item.amount||0), 0)); 
      
      const filteredPackingList = computed(() => {
        return packingList.value
          .filter(p => p.owner === currentPackingFilter.value)
          .sort((a, b) => {
             const getScore = (item) => {
                 if (item.createdAt === undefined) return 0;
                 if (item.createdAt === null) return 99999999999;
                 return item.createdAt.seconds || 0;
             };
             return getScore(a) - getScore(b);
          });
      });

      const filteredNotebookList = computed(() => notebookList.value.filter(n => n.owner === currentNotebookFilter.value));

      // --- MODAL & FORM ---
      const modal = reactive({ show: false, type: '', title: '', isEdit: false });
      const formData = reactive({});

      const openModal = (type, item = null) => {
        if (type === 'itinerary' && item) return; 
        if (type === 'itinerary' && !item) return;

        modal.type = type;
        modal.show = true;
        modal.isEdit = !!item;
        
        Object.keys(formData).forEach(k => delete formData[k]);
        
        if (item) {
            modal.title = 'ç·¨è¼¯';
            Object.assign(formData, JSON.parse(JSON.stringify(item))); 
        } else {
            modal.title = 'æ–°å¢';
            if (type === 'shopping') Object.assign(formData, { owner: currentShoppingFilter.value==='å…¨éƒ¨'?'ç¿”/å›':currentShoppingFilter.value, bought: false });
            if (type === 'expense') Object.assign(formData, { date: selectedDate.value, category: 'food', owner: 'å…¬è²»', method: 'ç¾é‡‘' });
            if (type === 'notebook') Object.assign(formData, { owner: currentNotebookFilter.value || 'ç¿”/å›' });
        }
      };
      
      const closeModal = () => modal.show = false;

      // --- ACTIONS ---
      const submitForm = async () => {
        isSaving.value = true;
        try {
            const colName = modal.type === 'shopping' ? 'shopping' : 
                          modal.type === 'expense' ? 'expenses' : 'notebook';
            
            const docId = formData.id ? String(formData.id) : (Date.now().toString() + Math.random().toString().slice(2,6));
            const docRef = doc(db, 'trips', TRIP_ID, colName, docId);
            
            const payload = { ...formData };
            if(payload.id) payload.id = String(payload.id);

            await setDoc(docRef, payload, { merge: true });
            closeModal();
            firebaseStatus.value = 'connected'; // Reset on success
        } catch(e) {
            console.error(e);
            firebaseStatus.value = 'error'; // Set error state
            alert("å„²å­˜å¤±æ•—: " + e.message);
        } finally {
            isSaving.value = false;
        }
      };

      const deleteCurrentItem = async () => {
         if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
         const colName = modal.type === 'shopping' ? 'shopping' : 
                          modal.type === 'expense' ? 'expenses' : 'notebook';
         await deleteDoc(doc(db, 'trips', TRIP_ID, colName, String(formData.id)));
         closeModal();
      };
      
      const deleteNote = async(id) => {
         if(!confirm('åˆªé™¤ç­†è¨˜ï¼Ÿ')) return;
         await deleteDoc(doc(db, 'trips', TRIP_ID, 'notebook', String(id)));
      };

      const deleteShoppingItem = async (id) => {
        if(confirm('åˆªé™¤æ­¤å•†å“ï¼Ÿ')) await deleteDoc(doc(db, 'trips', TRIP_ID, 'shopping', String(id)));
      };
      const toggleShoppingCheck = async (item) => {
        await updateDoc(doc(db, 'trips', TRIP_ID, 'shopping', String(item.id)), { bought: !item.bought });
      };

      const addPackingItem = async () => {
        if (!newPackingItem.value.trim()) return;
        const docId = Date.now().toString();
        await setDoc(doc(db, 'trips', TRIP_ID, 'packing', docId), {
            text: newPackingItem.value,
            owner: currentPackingFilter.value,
            checked: false,
            createdAt: serverTimestamp()
        });
        newPackingItem.value = '';
      };
      const togglePackingCheck = async (item) => {
        await updateDoc(doc(db, 'trips', TRIP_ID, 'packing', String(item.id)), { checked: !item.checked });
      };
      const deletePackingItem = async (id) => {
        if(confirm('ç§»é™¤ï¼Ÿ')) await deleteDoc(doc(db, 'trips', TRIP_ID, 'packing', String(id)));
      };

      // --- UTILS ---
      const weatherData = reactive({ city: 'å¤§é˜ªå¸‚', temp: '--', maxTemp: '--', minTemp: '--', humidity: '--', windSpeed: '--', icon: 'fa-solid fa-spinner', description: 'è¼‰å…¥ä¸­...', clothing: '...', iconColor: '#ccc', forecast: [], apparentTemp: '--', rain: '--', uvIndex: '--', sunrise: '--', sunset: '--' });
      const weatherLoading = ref(false);
      const isWeatherExpanded = ref(false);
      const toggleWeather = () => isWeatherExpanded.value = !isWeatherExpanded.value;
      const currentDayCities = computed(() => {
          const d = days.find(x => x.dateStr === selectedDate.value);
          return d ? d.locations : [];
      });

      const getClothingAdvice = (avg, max, min) => {
        if (max < 10) return "å¤©æ°£å¯’å†·ï¼Œè«‹ç©¿è‘—ä¿æš–å¤§è¡£ã€åœå·¾ã€æ‰‹å¥—ï¼Œå»ºè­°æ¡ç”¨æ´‹è”¥å¼ç©¿æ³•ã€‚";
        if (max < 15) return "ç¨æœ‰å¯’æ„ï¼Œå»ºè­°ç©¿è‘—æ¯›è¡£ã€é¢¨è¡£æˆ–æ˜¯è¼•ç¾½çµ¨ï¼Œæ—©æ™šæº«å·®å¤§è¦æ³¨æ„ä¿æš–ã€‚";
        if (max < 20) return "æ°£æº«èˆ’é©åæ¶¼ï¼Œå»ºè­°é•·è¢–ä¸Šè¡£æ­é…é‡ç¹”è¡«æˆ–ç‰›ä»”å¤–å¥—ï¼Œé©åˆèµ°è·¯çš„è£æ‰®ã€‚";
        if (max < 25) return "æº«æš–èˆ’é©ï¼Œå¯ç©¿è–„é•·è¢–æˆ–çŸ­è¢–æ­é…è–„è¥¯è¡«ï¼Œä¸­åˆå¯èƒ½æœƒè¦ºå¾—ç†±ã€‚";
        if (max >= 25) return "å¤©æ°£ç‚ç†±ï¼Œè«‹ç©¿è‘—é€æ°£è¼•ä¾¿è¡£ç‰©ï¼Œä¸¦æ³¨æ„é˜²æ›¬èˆ‡è£œå……æ°´åˆ†ã€‚";
        return "æ°£æº«è®ŠåŒ–å¤§ï¼Œå»ºè­°éš¨èº«æ”œå¸¶è–„å¤–å¥—ä»¥å‚™ä¸æ™‚ä¹‹éœ€ã€‚";
      };

      const getWeatherInfo = (code, isDay) => {
        if (code === 0) return { desc: 'æ™´æœ—', icon: isDay ? 'fa-solid fa-sun' : 'fa-solid fa-moon', color: '#fbbf24' };
        if (code <= 3) return { desc: 'å¤šé›²', icon: isDay ? 'fa-solid fa-cloud-sun' : 'fa-solid fa-cloud-moon', color: '#fbbf24' };
        if (code <= 48) return { desc: 'æœ‰éœ§', icon: 'fa-solid fa-smog', color: '#9ca3af' };
        if (code <= 55) return { desc: 'æ¯›æ¯›é›¨', icon: 'fa-solid fa-cloud-rain', color: '#60a5fa' };
        if (code <= 67) return { desc: 'ä¸‹é›¨', icon: 'fa-solid fa-umbrella', color: '#3b82f6' };
        if (code <= 77) return { desc: 'ä¸‹é›ª', icon: 'fa-regular fa-snowflake', color: '#93c5fd' };
        if (code <= 82) return { desc: 'é™£é›¨', icon: 'fa-solid fa-cloud-showers-heavy', color: '#2563eb' };
        if (code >= 95) return { desc: 'é›·é›¨', icon: 'fa-solid fa-bolt', color: '#eab308' };
        return { desc: 'æœªçŸ¥', icon: 'fa-solid fa-circle-question', color: '#ccc' };
      };

      const changeWeatherCity = async (city) => {
         weatherLoading.value = true;
         weatherData.city = city.name;
         try {
             const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lng}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,weather_code,wind_speed_10m&daily=weather_code,sunrise,sunset,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo`);
             const data = await res.json();
             
             const current = data.current;
             const daily = data.daily;

             weatherData.temp = Math.round(current.temperature_2m);
             weatherData.apparentTemp = Math.round(current.apparent_temperature);
             weatherData.humidity = current.relative_humidity_2m;
             weatherData.windSpeed = current.wind_speed_10m;
             weatherData.rain = current.precipitation;
             weatherData.uvIndex = (current.is_day===1 && current.weather_code <= 2) ? 'é«˜' : 'ä½';
             if(daily.sunrise.length > 0) {
                 weatherData.sunrise = daily.sunrise[0].split('T')[1];
                 weatherData.sunset = daily.sunset[0].split('T')[1];
             }

             weatherData.maxTemp = Math.round(daily.temperature_2m_max[0]);
             weatherData.minTemp = Math.round(daily.temperature_2m_min[0]);
             
             const info = getWeatherInfo(current.weather_code, current.is_day === 1);
             weatherData.description = info.desc;
             weatherData.icon = info.icon;
             weatherData.iconColor = info.color;
             weatherData.clothing = getClothingAdvice(weatherData.temp, weatherData.maxTemp, weatherData.minTemp);

             const forecastList = [];
             const weekDays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
             for (let i = 1; i <= 3; i++) {
                if (daily.time[i]) {
                    const d = new Date(daily.time[i]);
                    const code = daily.weather_code[i];
                    const fInfo = getWeatherInfo(code, true);
                    forecastList.push({
                        dayName: weekDays[d.getDay()],
                        max: Math.round(daily.temperature_2m_max[i]),
                        min: Math.round(daily.temperature_2m_min[i]),
                        icon: fInfo.icon,
                        color: fInfo.color
                    });
                }
             }
             weatherData.forecast = forecastList;

         } catch(e) { console.error(e); }
         finally { setTimeout(() => weatherLoading.value=false, 500); }
      };

      const exchange = reactive({ jpy: '', twd: '' });
      const currentRate = ref(0.218);
      const rateUpdateDate = ref('');
      
      const fetchExchangeRate = async () => {
         try {
            // Get standard market rate
            const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
            const data = await res.json();
            const marketRate = data.rates.TWD;
            
            // SIMULATE TAISHIN BANK CASH SELLING RATE
            // Typically banks add ~0.002 to 0.004 spread on JPY cash selling
            // We use +0.002 as a safe estimate
            currentRate.value = marketRate + 0.002;
            
            rateUpdateDate.value = data.date;
         } catch(e) {
            console.error("Exchange rate fetch failed", e);
         }
      };
      
      const calcTwd = () => {
        if(!exchange.jpy) { exchange.twd = ''; return; }
        // Keep precise value
        exchange.twd = parseFloat((exchange.jpy * currentRate.value).toFixed(2));
      };
      const calcJpy = () => {
        if(!exchange.twd) { exchange.jpy = ''; return; }
        exchange.jpy = parseFloat((exchange.twd / currentRate.value).toFixed(2));
      };

      const handleImageUpload = (e) => {
        const file = e.target.files[0];
        if(!file) return;

        // Check size (2MB = 2 * 1024 * 1024 bytes)
        const maxSize = 2 * 1024 * 1024;

        if (file.size > maxSize) {
            // Compress
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // Resize logic (optional, but good for compression)
                    const maxDim = 1280;
                    if (width > maxDim || height > maxDim) {
                        if (width > height) {
                            height = Math.round((height * maxDim) / width);
                            width = maxDim;
                        } else {
                            width = Math.round((width * maxDim) / height);
                            height = maxDim;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Compress to JPEG with 0.3 quality (æ›´ä¿éšªçš„å£“ç¸®æ¯”ï¼Œç¢ºä¿å¤§åœ–ä¹Ÿèƒ½ä¸Šå‚³)
                    formData.image = canvas.toDataURL('image/jpeg', 0.3);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        } else {
            // Normal upload
            const reader = new FileReader();
            reader.onload = (evt) => {
                formData.image = evt.target.result;
            };
            reader.readAsDataURL(file);
        }
      };
      
      const openMap = (name) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}`);

      const getCategoryLabel = (c) => ({attraction:'æ™¯é»',food:'ç¾é£Ÿ',shopping:'è³¼ç‰©',transport:'äº¤é€š',flight:'èˆªç­',accommodation:'ä½å®¿',other:'å…¶ä»–'}[c]||c);
      const getCategoryColor = (c) => ({attraction:'bg-red-100 text-red-500',food:'bg-orange-100 text-orange-500',shopping:'bg-pink-100 text-pink-500',flight:'bg-blue-100 text-blue-500', transport:'bg-green-100 text-green-600', accommodation:'bg-purple-100 text-purple-500'}[c]||'bg-gray-100 text-gray-500');
      const getExpenseIcon = (c) => ({food:'fa-solid fa-utensils',transport:'fa-solid fa-train',shopping:'fa-solid fa-bag-shopping',accommodation:'fa-solid fa-bed',ticket:'fa-solid fa-ticket'}[c]||'fa-solid fa-yen-sign');
      const getTransportIcon = (t) => t==='walk'?'fa-solid fa-person-walking':(t==='flight'?'fa-solid fa-plane':'fa-solid fa-train-subway');

      // --- AUTH & INIT ---
      onMounted(() => {
        // è¨­å®šå¼·åˆ¶3ç§’å¾Œé—œé–‰ Splashï¼Œé¿å…å¡æ­»
        setTimeout(() => showSplash.value = false, 3000);
        
        try {
            signInAnonymously(auth).then(async () => {
                subscribeCollection('itinerary', itineraryList);
                subscribeCollection('shopping', shoppingList);
                subscribeCollection('expenses', expenses);
                subscribeCollection('notebook', notebookList);
                subscribeCollection('packing', packingList);
                
                setTimeout(() => checkAndMigrateData(false), 1500);
                
                const d = days.find(x => x.dateStr === selectedDate.value);
                if(d && d.locations) changeWeatherCity(d.locations[0]);
                fetchExchangeRate();

            }).catch(err => {
                console.error("Auth failed", err);
                firebaseStatus.value = 'error';
                // å³ä½¿å¤±æ•—ä¹Ÿè¦é—œé–‰å‹•ç•«
                showSplash.value = false;
            });
        } catch(e) {
            console.error("Init failed", e);
            showSplash.value = false;
        }
      });

      return {
        showSplash, currentTab, tabs, bannerImage, handleImageError, daysUntilTrip,
        days, selectedDate, travelers, shoppingTravelers, packingPeople,
        
        // Data
        filteredItinerary, filteredShoppingList, expenses, totalExpense, filteredTotalExpense, notebookList, filteredPackingList, filteredExpenses, filteredNotebookList,
        currentShoppingFilter, currentPackingFilter, currentMemberFilter, currentNotebookFilter, notebookOwners, newPackingItem,
        
        // Actions
        openModal, closeModal, modal, formData, submitForm, deleteCurrentItem, isSaving,
        deleteShoppingItem, toggleShoppingCheck,
        addPackingItem, togglePackingCheck, deletePackingItem, deleteNote,
        updateItineraryContentOnly, // ç¢ºä¿å›å‚³æ›´æ–°å‡½æ•¸
        fixDuplicates, // æ–°å¢ä¿®å¾©é‡è¤‡å‡½æ•¸
        forceResetData, // ç¢ºä¿å›å‚³é‡ç½®å‡½æ•¸
        checkAndMigrateData, // ç¢ºä¿å›å‚³æ‰‹å‹•è£œé½Šå‡½æ•¸
        TRIP_ID, // Expose for template

        // Utils
        weatherData, isWeatherExpanded, toggleWeather, weatherLoading, currentDayCities, changeWeatherCity,
        exchange, currentRate, calcTwd, calcJpy, rateUpdateDate,
        getCategoryLabel, getCategoryColor, getExpenseIcon, getTransportIcon, handleImageUpload, openMap,
        firebaseStatus, reconnectFirebase, migrationStatus,
        isTigerairInfoExpanded
      };
    }
  }).mount('#app');
</script>
</body>
</html>


