const cloudSync = reactive({
  state: "idle",          // idle | syncing | synced | error
  message: "尚未同步",
  lastSyncedAt: null,
  error: null
});

let isHydratingFromCloud = false;   // ★關鍵：避免「拉雲端」時 watch 又立刻上傳
let lastCloudUpdatedAt = null;      // ★可選：用來判斷版本新舊

const waitForCloudFns = () => new Promise((resolve, reject) => {
  const start = Date.now();
  const timer = setInterval(() => {
    const ok = (typeof window.__CLOUD_GET_STATE__ === "function") &&
               (typeof window.__CLOUD_SET_STATE__ === "function");
    if (ok) { clearInterval(timer); resolve(true); }
    if (Date.now() - start > 8000) { clearInterval(timer); reject(new Error("Cloud functions not ready")); }
  }, 100);
});

const buildPayload = () => ({
  itinerary: itineraryList.value,
  shopping: shoppingList.value,
  expenses: expenses.value,
  bannerImage: bannerImage.value,          // ★把 banner 一起同步
  updatedAt: new Date().toISOString()
});

const applyCloudToLocal = (cloud) => {
  if (!cloud) return;

  // 套用到 Vue state
  if (Array.isArray(cloud.itinerary)) itineraryList.value = cloud.itinerary;
  if (Array.isArray(cloud.shopping))  shoppingList.value  = cloud.shopping;
  if (Array.isArray(cloud.expenses))  expenses.value      = cloud.expenses;
  if (cloud.bannerImage) bannerImage.value = cloud.bannerImage;

  // 同步到 localStorage（讓下次開啟速度快）
  saveToLocal('sakura_itinerary', itineraryList.value);
  saveToLocal('sakura_shopping', shoppingList.value);
  saveToLocal('sakura_expenses', expenses.value);
  try {
    localStorage.setItem('sakura_banner_image', bannerImage.value);
  } catch (e) {}

  lastCloudUpdatedAt = cloud.updatedAt || null;
};

const pullFromCloudOnce = async () => {
  await waitForCloudFns();

  cloudSync.state = "syncing";
  cloudSync.message = "從雲端載入中…";
  cloudSync.error = null;

  const cloud = await window.__CLOUD_GET_STATE__();

  // ★避免拉資料時觸發 watch 上傳
  isHydratingFromCloud = true;
  applyCloudToLocal(cloud);
  isHydratingFromCloud = false;

  cloudSync.state = "synced";
  cloudSync.message = cloud ? "已從雲端載入" : "雲端目前沒有資料";
  cloudSync.lastSyncedAt = new Date().toISOString();
};

const pushToCloud = async () => {
  await waitForCloudFns();
  await window.__CLOUD_SET_STATE__(buildPayload());
};

const manualCloudSync = async () => {
  try {
    if (isHydratingFromCloud) return;

    cloudSync.state = "syncing";
    cloudSync.message = "同步中…";
    cloudSync.error = null;

    await pushToCloud();

    cloudSync.state = "synced";
    cloudSync.message = "已同步到雲端";
    cloudSync.lastSyncedAt = new Date().toISOString();
  } catch (err) {
    console.error(err);
    cloudSync.state = "error";
    cloudSync.message = "同步失敗，點這裡重試";
    cloudSync.error = err?.message || String(err);
  }
};

// ★開啟時先拉雲端（非常重要）
onMounted(() => {
  pullFromCloudOnce();
});

// ★自動同步：加防抖，避免連續狂寫
let syncTimer = null;
const scheduleSync = () => {
  if (isHydratingFromCloud) return;
  clearTimeout(syncTimer);
  syncTimer = setTimeout(() => manualCloudSync(), 800);
};

watch(itineraryList, scheduleSync, { deep: true });
watch(shoppingList, scheduleSync, { deep: true });
watch(expenses, scheduleSync, { deep: true });
watch(bannerImage, scheduleSync); // ★banner 也要自動同步
