<!DOCTYPE html>
<html lang="zh-TW">
<head>
  
  <head>
  <!-- ⬇️ 把錯誤顯示 script 放這裡（最上面） -->
  <script>
    window.addEventListener("error", (e) => {
      document.body.innerHTML =
        "<pre style='white-space:pre-wrap;color:red;font-size:14px'>" +
        "JS Error:\n" + (e?.message || e) +
        "\n\n" + (e?.filename || "") + ":" + (e?.lineno || "") +
        "</pre>";
    });
    window.addEventListener("unhandledrejection", (e) => {
      document.body.innerHTML =
        "<pre style='white-space:pre-wrap;color:red;font-size:14px'>" +
        "Promise Error:\n" + (e?.reason?.message || e?.reason || e) +
        "</pre>";
    });
  </script>

  <!-- 下面才是原本的 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>京阪之旅</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

  <script>

    tailwind.config = {
      theme: {
        extend: {
          colors: {
            sakura: {
              light: '#fff0f5',
              DEFAULT: '#ffb7c5',
              dark: '#2EA9DF',
              text: '#5d4037',
            }
          },
          fontFamily: {
            sans: ['"Zen Maru Gothic"', 'sans-serif'],
          },
          boxShadow: {
            'soft': '0 4px 20px -2px rgba(255, 183, 197, 0.4)',
            'card': '0 2px 10px rgba(0,0,0,0.05)',
          },
          animation: {
            'float': 'float 3s ease-in-out infinite',
            'spin-slow': 'spin 8s linear infinite',
            'sync-bar': 'syncBar 1.5s infinite ease-in-out',
            'fade-in': 'fadeIn 0.3s ease-out forwards',
            'slide-up': 'slideUp 0.3s ease-out forwards',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            },
            syncBar: {
              '0%': { transform: 'translateX(-100%)' },
              '100%': { transform: 'translateX(300%)' }
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' }
            },
            slideUp: {
              '0%': { transform: 'translateY(100%)' },
              '100%': { transform: 'translateY(0)' }
            }
          }
        }
      }
    }
  </script>

  <style>
    body, button, input, select, textarea, h1, h2, h3, h4, h5, h6, span, p, div { font-family: 'Zen Maru Gothic', sans-serif; }
    body { background-color: #fff0f5; -webkit-tap-highlight-color: transparent; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    .app-container {
      max-width: 480px;
      margin: 0 auto;
      background-color: #fafafa;
      min-height: 100vh;
      position: relative;
      box-shadow: 0 0 20px rgba(0,0,0,0.05);
      padding-bottom: 80px;
    }

    .weather-loading { animation: pulse-bg 1.5s infinite; }
    @keyframes pulse-bg { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

    /* Sakura petals */
    .sakura-petal {
      position: absolute;
      background-color: #ffb7c5;
      border-radius: 100% 0 100% 0;
      opacity: 0;
      top: -20px;
    }

    @keyframes fall-sway-1 {
      0% { top: -10%; left: var(--start-left); transform: rotate(0deg) translateX(0); opacity: 0; }
      10% { opacity: 0.8; }
      50% { transform: rotate(180deg) translateX(20px); }
      90% { opacity: 0.8; }
      100% { top: 110%; left: calc(var(--start-left) + 10%); transform: rotate(360deg) translateX(-20px); opacity: 0; }
    }
    @keyframes fall-sway-2 {
      0% { top: -10%; left: var(--start-left); transform: rotate(0deg) translateX(0); opacity: 0; }
      20% { opacity: 0.9; }
      60% { transform: rotate(-120deg) translateX(-30px); }
      100% { top: 110%; left: calc(var(--start-left) - 15%); transform: rotate(-240deg) translateX(10px); opacity: 0; }
    }
    @keyframes fall-sway-3 {
      0% { top: -10%; left: var(--start-left); transform: rotate(0deg) scale(1); opacity: 0; }
      15% { opacity: 1; }
      50% { transform: rotate(90deg) scale(0.8) translateX(15px); }
      100% { top: 110%; left: calc(var(--start-left) + 5%); transform: rotate(180deg) scale(1) translateX(-5px); opacity: 0; }
    }
    .animate-fall-1 { animation: fall-sway-1 linear infinite; }
    .animate-fall-2 { animation: fall-sway-2 linear infinite; }
    .animate-fall-3 { animation: fall-sway-3 linear infinite; }
    .blur-sm { filter: blur(1px); }
    .blur-md { filter: blur(2px); }
  </style>
</head>

<body>
<div id="app" class="app-container">

  <!-- Splash -->
  <transition name="fade">
    <div v-if="showSplash" class="fixed inset-0 z-[100] bg-gradient-to-b from-[#fff0f5] to-white flex flex-col items-center justify-center overflow-hidden transition-opacity duration-700">
      <div class="absolute inset-0 pointer-events-none z-10 w-full h-full overflow-hidden">
        <span class="sakura-petal w-4 h-4 animate-fall-1" style="--start-left: 10%; animation-duration: 6s; animation-delay: 0s;"></span>
        <span class="sakura-petal w-3 h-3 animate-fall-2 blur-sm" style="--start-left: 20%; animation-duration: 8s; animation-delay: 1.5s;"></span>
        <span class="sakura-petal w-5 h-5 animate-fall-3" style="--start-left: 35%; animation-duration: 5.5s; animation-delay: 0.5s;"></span>
        <span class="sakura-petal w-2 h-2 animate-fall-1 blur-md" style="--start-left: 50%; animation-duration: 9s; animation-delay: 2s;"></span>
        <span class="sakura-petal w-4 h-4 animate-fall-2" style="--start-left: 65%; animation-duration: 7s; animation-delay: 1s;"></span>
        <span class="sakura-petal w-3 h-3 animate-fall-3 blur-sm" style="--start-left: 80%; animation-duration: 6.5s; animation-delay: 3s;"></span>
        <span class="sakura-petal w-4 h-4 animate-fall-1" style="--start-left: 90%; animation-duration: 5s; animation-delay: 0.2s;"></span>
        <span class="sakura-petal w-2 h-2 animate-fall-2" style="--start-left: 5%; animation-duration: 7.5s; animation-delay: 4s;"></span>
        <span class="sakura-petal w-3 h-3 animate-fall-3" style="--start-left: 45%; animation-duration: 6s; animation-delay: 2.5s;"></span>
        <span class="sakura-petal w-5 h-5 animate-fall-1 blur-sm" style="--start-left: 75%; animation-duration: 8.5s; animation-delay: 1.2s;"></span>
      </div>

      <div class="relative z-10 text-center animate-float">
        <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mx-auto mb-6 shadow-soft border-4 border-white">
          <i class="fa-solid fa-plane-departure text-4xl text-sakura-dark"></i>
        </div>
        <h1 class="text-4xl font-black text-sakura-text tracking-[0.3em] mb-3 ml-2">京阪之旅</h1>
        <div class="inline-block px-4 py-1 bg-white/60 rounded-full backdrop-blur-sm">
          <p class="text-sm font-bold text-sakura-dark tracking-widest">READY FOR TRIP</p>
        </div>
      </div>

      <div class="absolute bottom-12 text-sakura-text/50 text-xs font-bold animate-pulse">
        正在創造美好回憶...
      </div>
    </div>
  </transition>

  <!-- Header -->
  <header class="relative h-[250px] w-full overflow-hidden bg-gray-200 group">
    <img
      :src="bannerImage"
      alt="Sakura Banner"
      class="w-full h-full object-cover transition-opacity duration-500"
      referrerpolicy="no-referrer"
      @error="handleImageError"
    >

    <div class="absolute top-4 right-4 bg-white/70 backdrop-blur-md px-3 py-1.5 rounded-full text-sakura-text text-xs border border-white/50 shadow-sm flex items-center gap-2 z-20">
      <i class="fa-regular fa-clock"></i>
      <span v-if="daysUntilTrip > 0">距離出發還有 <b>{{ daysUntilTrip }}</b> 天</span>
      <span v-else-if="daysUntilTrip === 0">就是今天！出發！✈️</span>
      <span v-else>旅程第 {{ Math.abs(daysUntilTrip) + 1 }} 天</span>
    </div>

    <div class="absolute top-6 left-6 z-10 bg-white p-3 rounded-2xl border border-white/40 shadow-sm">
      <h1 class="text-3xl font-bold tracking-widest text-sakura-text">京阪之旅</h1>
      <p class="text-sm opacity-90 text-sakura-text/80">2026.04.02 - 04.06</p>
    </div>
  </header>

  <main class="relative -mt-10 bg-[#fafafa] rounded-t-[40px] px-4 pt-4 min-h-[500px] z-10">

    <!-- Cloud sync dot -->
    <div class="fixed top-4 left-4 z-50">
      <div
        class="w-3 h-3 rounded-full shadow-[0_0_8px_rgba(0,0,0,0.2)] border border-white transition-all duration-500"
        :class="cloudSyncDotClass"
        @click="cloudSync.state === 'error' && manualCloudSync()"
        title="點一下可重試同步（若紅燈）"
      ></div>
    </div>

    <!-- TAB 1 -->
    <div v-if="currentTab === 'itinerary'">
      <!-- Weather card -->
      <div class="relative bg-white rounded-3xl p-5 shadow-[0_8px_30px_rgba(0,0,0,0.04)] mb-5 border border-gray-50 overflow-hidden group transition-all duration-300">
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-gradient-to-br from-sakura-light to-blue-50 rounded-full blur-3xl opacity-50 pointer-events-none"></div>
        <div class="absolute top-20 -left-10 w-24 h-24 bg-yellow-50 rounded-full blur-3xl opacity-50 pointer-events-none"></div>

        <div v-if="weatherLoading" class="absolute inset-0 bg-white/80 backdrop-blur-md z-30 flex items-center justify-center rounded-3xl">
          <div class="text-sakura-dark animate-pulse flex flex-col items-center gap-1">
            <i class="fa-solid fa-cloud-sun text-4xl animate-bounce"></i>
            <span class="text-xs font-bold tracking-widest uppercase mt-1">Loading Weather</span>
          </div>
        </div>

        <div v-if="currentDayCities.length > 1" class="flex justify-end gap-1.5 mb-1 relative z-20 overflow-x-auto no-scrollbar pb-1">
          <button
            v-for="city in currentDayCities"
            :key="city.name"
            @click.stop="changeWeatherCity(city)"
            :class="['text-[10px] px-2.5 py-1 rounded-full font-bold transition-all border shadow-sm', weatherData.city === city.name ? 'bg-sakura text-white border-sakura ring-1 ring-sakura/20' : 'bg-white text-gray-400 border-gray-100 hover:bg-gray-50']"
          >
            {{ city.name }}
          </button>
        </div>

        <div @click="toggleWeather" class="relative z-10 cursor-pointer pt-1">
          <div class="flex justify-between items-center">
            <div class="pl-2">
              <div class="flex items-center gap-2 mb-0.5">
                <h2 class="text-xl font-black text-gray-800 tracking-tight">{{ weatherData.city }}</h2>
                <span class="px-2 py-0.5 bg-gray-100 rounded-md text-xs font-bold text-gray-500 flex items-center gap-1">
                  <i class="fa-solid fa-circle text-[6px]" :style="{color: weatherData.iconColor}"></i>
                  {{ weatherData.description }}
                </span>
              </div>

              <div class="flex items-end h-12">
                <span class="text-5xl font-black text-gray-800 tracking-tighter leading-none -ml-0.5">{{ weatherData.temp }}°</span>
                <div class="ml-3 flex flex-col justify-center text-xs font-bold text-gray-400 leading-tight border-l border-gray-200 pl-2 h-8">
                  <span class="flex items-center gap-1 mb-0.5"><i class="fa-solid fa-arrow-up text-red-300"></i>{{ weatherData.maxTemp }}°</span>
                  <span class="flex items-center gap-1"><i class="fa-solid fa-arrow-down text-blue-300"></i>{{ weatherData.minTemp }}°</span>
                </div>
              </div>
              <p class="text-xs text-gray-400 mt-1 font-medium pl-0.5">體感 {{ weatherData.apparentTemp }}°C</p>
            </div>

            <div class="w-14 h-14 flex items-center justify-center animate-float mr-1">
              <i :class="weatherData.icon" class="text-5xl drop-shadow-md transition-all duration-500" :style="{color: weatherData.iconColor}"></i>
            </div>
          </div>

          <div class="flex justify-center -mt-1 opacity-30 group-hover:opacity-100 transition-opacity">
            <i class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-300 text-xs" :class="{'rotate-180': isWeatherExpanded}"></i>
          </div>
        </div>

        <div v-if="isWeatherExpanded" class="mt-2 pt-2 border-t border-gray-100 animate-fade-in relative z-10">
          <div class="mb-2 bg-gradient-to-r from-sakura-light/30 to-white border border-sakura-light/40 rounded-xl p-2.5 shadow-sm flex gap-2.5 items-start">
            <div class="w-6 h-6 rounded-full bg-white text-sakura-dark flex items-center justify-center shrink-0 shadow-sm text-xs mt-0.5">
              <i class="fa-solid fa-shirt"></i>
            </div>
            <div>
              <h5 class="text-[10px] font-bold text-sakura-dark mb-0.5 tracking-wider uppercase">Outfit Advice</h5>
              <p class="text-xs text-gray-600 font-medium leading-relaxed">{{ weatherData.clothing }}</p>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2 mb-2">
            <div class="bg-gray-50 rounded-xl p-2 flex items-center gap-2 border border-gray-100">
              <div class="w-7 h-7 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center text-xs"><i class="fa-solid fa-droplet"></i></div>
              <div>
                <div class="text-[10px] text-gray-400 font-bold uppercase leading-none mb-0.5">濕度</div>
                <div class="text-sm font-black text-gray-700 leading-none">{{ weatherData.humidity }}%</div>
              </div>
            </div>
            <div class="bg-gray-50 rounded-xl p-2 flex items-center gap-2 border border-gray-100">
              <div class="w-7 h-7 rounded-full bg-indigo-100 text-indigo-500 flex items-center justify-center text-xs"><i class="fa-solid fa-wind"></i></div>
              <div>
                <div class="text-[10px] text-gray-400 font-bold uppercase leading-none mb-0.5">風速</div>
                <div class="text-sm font-black text-gray-700 leading-none">{{ weatherData.windSpeed }} <span class="text-[10px] font-normal">m/s</span></div>
              </div>
            </div>
            <div class="bg-gray-50 rounded-xl p-2 flex items-center gap-2 border border-gray-100">
              <div class="w-7 h-7 rounded-full bg-cyan-100 text-cyan-500 flex items-center justify-center text-xs"><i class="fa-solid fa-umbrella"></i></div>
              <div>
                <div class="text-[10px] text-gray-400 font-bold uppercase leading-none mb-0.5">降雨</div>
                <div class="text-sm font-black text-gray-700 leading-none">{{ weatherData.rain }} <span class="text-[10px] font-normal">mm</span></div>
              </div>
            </div>
            <div class="bg-gray-50 rounded-xl p-2 flex items-center gap-2 border border-gray-100">
              <div class="w-7 h-7 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center text-xs"><i class="fa-solid fa-sun"></i></div>
              <div>
                <div class="text-[10px] text-gray-400 font-bold uppercase leading-none mb-0.5">紫外線</div>
                <div class="text-sm font-black text-gray-700 leading-none">{{ weatherData.uvIndex }}</div>
              </div>
            </div>
          </div>

          <div class="flex justify-between items-center bg-gray-50 rounded-full px-3 py-1.5 border border-gray-100 mb-3">
            <div class="flex items-center gap-1.5">
              <i class="fa-regular fa-sun text-orange-400 text-xs"></i>
              <span class="text-xs font-bold text-gray-600">{{ weatherData.sunrise }}</span>
            </div>
            <div class="h-1 flex-1 mx-3 bg-gradient-to-r from-orange-200 to-indigo-200 rounded-full relative">
              <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 bg-white border border-orange-300 rounded-full shadow-sm"></div>
            </div>
            <div class="flex items-center gap-1.5">
              <span class="text-xs font-bold text-gray-600">{{ weatherData.sunset }}</span>
              <i class="fa-regular fa-moon text-indigo-400 text-xs"></i>
            </div>
          </div>

          <div v-if="weatherData.forecast && weatherData.forecast.length > 0" class="border-t border-gray-100 pt-2">
            <div class="flex justify-between gap-2">
              <div v-for="day in weatherData.forecast" :key="day.dayName" class="flex-1 bg-gray-50 rounded-xl p-2 flex flex-col items-center border border-transparent hover:border-sakura-light transition-colors">
                <span class="text-[10px] text-gray-400 font-bold mb-1">{{ day.dayName }}</span>
                <i :class="day.icon" class="text-lg mb-1" :style="{color: day.color}"></i>
                <div class="flex items-center text-xs font-black text-gray-700">
                  {{ day.max }}° <span class="text-[9px] text-gray-400 font-normal ml-0.5">/{{ day.min }}°</span>
                </div>
              </div>
            </div>
          </div>

        </div>

<div id="app-version"
     style="
       position: fixed;
       bottom: 6px;
       right: 8px;
       font-size: 10px;
       color: #999;
       opacity: 0.85;
       z-index: 999999;
       background: rgba(255,255,255,0.75);
       padding: 2px 6px;
       border-radius: 999px;
     ">
  版本：{{ appVersion }}
</div>


      </div>

      <!-- Dates -->
      <div class="flex overflow-x-auto no-scrollbar gap-3 mb-4 pb-2 justify-center">
        <button
          v-for="(day, index) in days"
          :key="index"
          @click="selectedDate = day.dateStr"
          :class="['flex-shrink-0 flex flex-col items-center justify-center w-16 h-20 rounded-2xl transition-all duration-300 relative overflow-hidden', selectedDate === day.dateStr ? 'bg-sakura text-white shadow-soft transform scale-105' : 'bg-white text-gray-400 border border-gray-100']"
        >
          <span class="text-lg font-bold z-10">{{ day.dayOfWeek }}</span>
          <span class="text-sm z-10">{{ day.displayDate }}</span>
          <span v-if="selectedDate === day.dateStr" class="absolute bottom-1 text-[10px] opacity-80 z-10">{{ day.mainCity }}</span>
        </button>
      </div>

      <div class="bg-yellow-50 text-yellow-700 text-xs px-4 py-2 rounded-xl mb-4 flex items-center border border-yellow-100 mx-2 shadow-sm">
        <i class="fa-solid fa-circle-exclamation mr-2 text-yellow-500"></i>
        溫馨提醒：交通時間皆為預估，依當天狀況為主。
      </div>

      <!-- Itinerary list -->
      <div class="space-y-4">
        <div v-for="(item, index) in filteredItinerary" :key="item.id" class="relative pl-4 border-l-2 border-sakura-light">
          <div class="bg-white rounded-2xl p-4 shadow-card relative group"
               :class="{'border-l-4 border-sakura': item.category !== 'flight', 'bg-blue-50 border-l-4 border-blue-400': item.category === 'flight'}">
            <div v-if="item.category === 'flight'">
              <div class="flex justify-between items-start mb-2">
                <span class="bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full font-bold">
                  <i class="fa-solid fa-plane-departure mr-1"></i>航班
                </span>
                <span class="text-xs text-gray-500 font-bold">{{ item.time }}</span>
              </div>
              <h3 class="font-bold text-gray-800 text-lg mb-1">{{ item.name }}</h3>
              <div class="text-sm text-gray-600 space-y-1"><p>{{ item.note }}</p></div>
            </div>

            <div v-else>
              <div class="flex justify-between items-start mb-1">
                <div class="flex items-center gap-2 mb-2 flex-wrap">
                  <span :class="['text-xs px-2 py-1 rounded-full font-bold inline-block', getCategoryColor(item.category)]">
                    {{ getCategoryLabel(item.category) }}
                  </span>

                  <span v-if="index > 0" class="text-[10px] text-gray-400 flex items-center bg-gray-50 px-2 py-1 rounded-full border border-gray-100">
                    <i :class="getTransportIcon(item.transportType)" class="mr-1 text-sakura-dark"></i>約 {{ item.travelTime }} 分
                  </span>
                  <span v-else-if="index === 0 && selectedDate !== '2026-04-02'" class="text-[10px] text-gray-400 flex items-center bg-gray-50 px-2 py-1 rounded-full border border-gray-100">
                    <i class="fa-solid fa-hotel mr-1 text-sakura-dark"></i>飯店出發 20分
                  </span>
                </div>

                <span class="text-sm font-black text-sakura-text bg-sakura-light px-2 py-1 rounded-lg whitespace-nowrap ml-2">{{ item.time }}</span>
              </div>

              <h3 @click.stop="openMap(item.name)" class="font-bold text-gray-800 text-lg mb-2 flex items-center gap-2 cursor-pointer hover:text-sakura-dark">
                {{ item.name }} <i class="fa-solid fa-location-arrow text-xs text-sakura"></i>
              </h3>

              <div class="space-y-2 text-sm text-gray-600">
                <div class="flex flex-wrap gap-3 text-xs">
                  <p v-if="item.category !== 'other' && item.category !== 'accommodation' && item.openHours" class="flex items-center">
                    <i class="fa-regular fa-clock w-4 text-center text-gray-400 mr-1"></i> {{ item.openHours }}
                  </p>
                  <p v-if="item.category === 'attraction' && item.ticket" class="flex items-center">
                    <i class="fa-solid fa-ticket w-4 text-center text-yellow-500 mr-1"></i> {{ item.ticket }}
                  </p>
                </div>

                <div v-if="item.description" class="text-xs bg-gray-50 p-3 rounded-lg border border-gray-100 leading-relaxed text-gray-500">
                  <p style="white-space: pre-line;">{{ item.description }}</p>
                </div>

                <p v-if="item.note" class="text-xs text-sakura-dark mt-1 flex items-start">
                  <i class="fa-solid fa-circle-exclamation w-4 mt-0.5 mr-1"></i> {{ item.note }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <div v-if="filteredItinerary.length === 0" class="text-center py-10 text-gray-400">
          <i class="fa-solid fa-mug-hot text-4xl mb-3 opacity-50"></i>
          <p>本日尚無行程</p>
        </div>
      </div>
    </div>

    <!-- TAB 2: info -->
    <div v-if="currentTab === 'info'" class="space-y-6 pb-20">
      <!-- exchange -->
      <div class="bg-white rounded-2xl p-5 shadow-card">
        <h3 class="font-bold text-sakura-text mb-4 border-b pb-2 flex justify-between items-center">
          <span><i class="fa-solid fa-coins mr-2 text-yellow-500"></i>匯率換算</span>
          <div class="text-right">
            <span class="text-xs text-gray-400 font-normal block">更新: {{ today }}</span>
            <span v-if="currentRate" class="text-[10px] text-sakura-dark font-bold">1 JPY ≈ {{ currentRate }} TWD</span>
          </div>
        </h3>
        <div class="flex items-center gap-4">
          <div class="flex-1">
            <label class="text-xs text-gray-500 mb-1 block">日幣 (JPY)</label>
            <input type="number" v-model="exchange.jpy" @input="calcTwd" class="w-full bg-gray-50 rounded-xl p-3 outline-none focus:ring-2 focus:ring-sakura" placeholder="¥">
          </div>
          <i class="fa-solid fa-arrow-right-arrow-left text-gray-300"></i>
          <div class="flex-1">
            <label class="text-xs text-gray-500 mb-1 block">台幣 (TWD)</label>
            <input type="number" v-model="exchange.twd" @input="calcJpy" class="w-full bg-sakura-light rounded-xl p-3 font-bold text-sakura-text outline-none focus:ring-2 focus:ring-sakura" placeholder="NT$">
          </div>
        </div>
      </div>

      <!-- flight -->
      <div class="bg-white rounded-2xl p-5 shadow-card">
        <h3 class="font-bold text-sakura-text mb-4 border-b pb-2"><i class="fa-solid fa-plane mr-2 text-blue-400"></i>航班資訊</h3>

        <div class="mb-4 bg-blue-50 rounded-xl p-4 border border-blue-100 relative overflow-hidden">
          <div class="absolute top-0 right-0 bg-blue-500 text-white text-xs px-3 py-1 rounded-bl-xl font-bold tracking-wider">去程</div>

          <div class="flex items-center gap-2 mb-4">
            <span class="font-black text-xl text-gray-800 tracking-wide">IT-284</span>
            <span class="text-[10px] text-blue-600 bg-white px-2 py-0.5 rounded-full border border-blue-100 font-bold">台灣虎航</span>
          </div>

          <div class="flex justify-between items-center text-center mb-4 relative z-10">
            <div class="text-left">
              <div class="text-3xl font-black text-gray-800 leading-none">07:00</div>
              <div class="text-sm font-bold text-gray-600 mt-1">KHH 高雄</div>
              <div class="text-[10px] text-gray-400 mt-0.5 bg-white/60 inline-block px-1 rounded">國際航廈</div>
            </div>

            <div class="flex flex-col items-center w-1/3 px-2">
              <span class="text-[10px] text-gray-400 mb-2 font-bold">2h 55m</span>
              <div class="w-full h-0.5 bg-gray-300 relative flex items-center justify-center">
                <i class="fa-solid fa-plane-departure text-blue-400 text-sm absolute bg-blue-50 px-1"></i>
              </div>
              <span class="text-[10px] text-blue-400 mt-1">直飛</span>
            </div>

            <div class="text-right">
              <div class="text-3xl font-black text-gray-800 leading-none">10:55</div>
              <div class="text-sm font-bold text-gray-600 mt-1">KIX 關西</div>
              <div class="text-[10px] text-gray-400 mt-0.5 bg-white/60 inline-block px-1 rounded">第一航廈</div>
            </div>
          </div>

          <div class="text-center mb-3">
            <span class="text-xs font-bold text-blue-600 bg-white border border-blue-200 px-3 py-1 rounded-full shadow-sm">
              <i class="fa-solid fa-user-clock mr-1"></i>建議報到：05:00
            </span>
          </div>

          <div class="flex justify-between items-center text-xs text-gray-500 border-t border-blue-200/50 pt-3 mt-2">
            <span class="flex items-center"><i class="fa-regular fa-calendar-check mr-1.5 text-blue-400"></i>2026/04/02 (週四)</span>
            <span class="flex items-center">
              <i class="fa-solid fa-suitcase-rolling mr-1 text-blue-400"></i>20kg
              <span class="mx-1 text-blue-200">|</span>
              <i class="fa-solid fa-briefcase mr-1 text-blue-400"></i>10kg
              <span class="mx-1 text-blue-200">|</span>
              <i class="fa-solid fa-utensils mr-1 text-blue-400"></i>含餐
            </span>
          </div>
        </div>

        <div class="bg-sakura-light/40 rounded-xl p-4 border border-sakura-light relative overflow-hidden">
          <div class="absolute top-0 right-0 bg-sakura text-white text-xs px-3 py-1 rounded-bl-xl font-bold tracking-wider">回程</div>

          <div class="flex items-center gap-2 mb-4">
            <span class="font-black text-xl text-gray-800 tracking-wide">IT-285</span>
            <span class="text-[10px] text-sakura-dark bg-white px-2 py-0.5 rounded-full border border-sakura-light font-bold">台灣虎航</span>
          </div>

          <div class="flex justify-between items-center text-center mb-4 relative z-10">
            <div class="text-left">
              <div class="text-3xl font-black text-gray-800">12:00</div>
              <div class="text-sm font-bold text-gray-600 mt-1">KIX 關西</div>
              <div class="text-[10px] text-gray-400 mt-0.5 bg-white/60 inline-block px-1 rounded">第一航廈</div>
            </div>

            <div class="flex flex-col items-center w-1/3 px-2">
              <span class="text-[10px] text-gray-400 mb-2 font-bold">3h 0m</span>
              <div class="w-full h-0.5 bg-gray-300 relative flex items-center justify-center">
                <i class="fa-solid fa-plane-departure text-sakura text-sm absolute bg-sakura-light/40 px-1"></i>
              </div>
              <span class="text-[10px] text-sakura mt-1">直飛</span>
            </div>

            <div class="text-right">
              <div class="text-3xl font-black text-gray-800 leading-none">14:00</div>
              <div class="text-sm font-bold text-gray-600 mt-1">KHH 高雄</div>
              <div class="text-[10px] text-gray-400 mt-0.5 bg-white/60 inline-block px-1 rounded">國際航廈</div>
            </div>
          </div>

          <div class="text-center mb-3">
            <span class="text-xs font-bold text-sakura-text bg-white border border-sakura-light px-3 py-1 rounded-full shadow-sm">
              <i class="fa-solid fa-user-clock mr-1 text-sakura"></i>建議報到：10:00
            </span>
          </div>

          <div class="flex justify-between items-center text-xs text-gray-500 border-t border-sakura-light pt-3 mt-2">
            <span class="flex items-center"><i class="fa-regular fa-calendar-check mr-1.5 text-sakura"></i>2026/04/06 (週一)</span>
            <span class="flex items-center">
              <i class="fa-solid fa-suitcase-rolling mr-1 text-sakura"></i>25kg
              <span class="mx-1 text-sakura-light">|</span>
              <i class="fa-solid fa-briefcase mr-1 text-sakura"></i>10kg
              <span class="mx-1 text-sakura-light">|</span>
              <i class="fa-solid fa-utensils mr-1 text-sakura"></i>含餐
            </span>
          </div>
        </div>

        <div class="mt-4 bg-white border-l-4 border-orange-400 rounded-xl overflow-hidden shadow-card transition-all duration-300">
          <button
            @click="isTigerairInfoExpanded = !isTigerairInfoExpanded"
            class="w-full text-left p-4 flex justify-between items-center hover:bg-gray-50 transition-colors focus:outline-none"
          >
            <h4 class="font-bold text-gray-800 text-sm flex items-center">
              <img src="https://static.tigerairtw.com/img/common/logo.svg" alt="Tigerair" class="h-4 mr-2 opacity-80" onerror="this.style.display='none'">
              <i class="fa-solid fa-plane-up mr-2 text-orange-500" onerror="this.style.display='inline-block'"></i>
              台灣虎航搭乘詳細須知
            </h4>
            <div class="flex items-center gap-2">
              <span class="text-[10px] text-gray-400 font-normal" v-show="!isTigerairInfoExpanded">點擊查看詳情</span>
              <i class="fa-solid fa-chevron-down text-gray-300 transition-transform duration-300" :class="{'rotate-180': isTigerairInfoExpanded}"></i>
            </div>
          </button>

          <div v-show="isTigerairInfoExpanded" class="px-5 pb-5 animate-fade-in">
            <div class="space-y-4 border-t border-gray-100 pt-4">
              <div>
                <h5 class="text-xs font-bold text-gray-700 flex items-center mb-1.5">
                  <i class="fa-solid fa-suitcase text-orange-400 mr-1.5 w-4 text-center"></i>
                  手提行李規定 (非常嚴格)
                </h5>
                <div class="bg-orange-50 rounded-lg p-3 text-xs text-gray-600 leading-relaxed">
                  <p class="mb-1">每位乘客僅限攜帶：</p>
                  <ul class="list-disc pl-4 space-y-1">
                    <li><b>1件</b> 手提行李 (尺寸小於 54x38x23cm)</li>
                    <li><b>1件</b> 個人隨身物品 (如手提包、電腦包)</li>
                    <li class="text-red-500 font-bold">上述兩件總重量不得超過 10 公斤。</li>
                  </ul>
                  <p class="mt-2 text-[10px] text-gray-500"><i class="fa-solid fa-circle-info mr-1"></i>登機門前地勤會再次秤重檢查，若超重需現場支付高額託運費。</p>
                </div>
              </div>

              <div>
                <h5 class="text-xs font-bold text-gray-700 flex items-center mb-1.5">
                  <i class="fa-solid fa-clock text-blue-400 mr-1.5 w-4 text-center"></i>
                  報到與登機時間
                </h5>
                <div class="flex gap-2 text-center text-xs">
                  <div class="flex-1 bg-gray-50 rounded-lg p-2 border border-gray-100">
                    <div class="text-gray-400 text-[10px] mb-1">起飛前</div>
                    <div class="font-bold text-gray-700">2.5 小時</div>
                    <div class="text-gray-400 text-[10px]">開始報到</div>
                  </div>
                  <div class="flex-1 bg-red-50 rounded-lg p-2 border border-red-100">
                    <div class="text-red-400 text-[10px] mb-1">起飛前</div>
                    <div class="font-bold text-red-600">45 分鐘</div>
                    <div class="text-red-400 text-[10px]">準時關櫃</div>
                  </div>
                  <div class="flex-1 bg-gray-50 rounded-lg p-2 border border-gray-100">
                    <div class="text-gray-400 text-[10px] mb-1">起飛前</div>
                    <div class="font-bold text-gray-700">10 分鐘</div>
                    <div class="text-gray-400 text-[10px]">關閉登機門</div>
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-3">
                <div>
                  <h5 class="text-xs font-bold text-gray-700 flex items-center mb-1.5">
                    <i class="fa-solid fa-bottle-water text-cyan-400 mr-1.5 w-4 text-center"></i>
                    隨身液體限制
                  </h5>
                  <ul class="text-[10px] text-gray-500 list-disc pl-3 space-y-1">
                    <li>單瓶容器須 <b>100ml 以下</b></li>
                    <li>所有容器須裝於 <b>1公升透明夾鏈袋</b> 內</li>
                    <li>每人限帶 1 袋</li>
                  </ul>
                </div>
                <div>
                  <h5 class="text-xs font-bold text-gray-700 flex items-center mb-1.5">
                    <i class="fa-solid fa-battery-full text-green-500 mr-1.5 w-4 text-center"></i>
                    務必隨身攜帶
                  </h5>
                  <ul class="text-[10px] text-gray-500 list-disc pl-3 space-y-1">
                    <li><b>行動電源 / 鋰電池</b> (嚴禁託運)</li>
                    <li>打火機 (每人限1個，需隨身)</li>
                    <li>筆記型電腦 / 平板</li>
                    <li>貴重物品 / 護照錢包</li>
                  </ul>
                </div>
              </div>

              <div class="bg-gray-50 rounded-lg p-2 flex items-start gap-2">
                <i class="fa-solid fa-utensils text-gray-400 mt-0.5 text-xs"></i>
                <p class="text-[10px] text-gray-500 leading-tight">
                  <b>機上禁帶外食：</b> 台灣虎航規定請勿攜帶非機上購買之餐食或飲品於機上食用。若有需求請事先預訂餐點。
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- hotel -->
      <div class="bg-white rounded-2xl p-5 shadow-card">
        <h3 class="font-bold text-sakura-text mb-4 border-b pb-2"><i class="fa-solid fa-bed mr-2 text-purple-400"></i>住宿資訊</h3>
        <h4 class="font-bold text-lg mb-1">東急 STAY 大阪本町</h4>
        <div class="flex gap-2 mb-3">
          <a href="https://www.google.com/maps/search/?api=1&query=東急STAY大阪本町" target="_blank" class="flex-1 bg-sakura text-white py-2 rounded-xl text-center text-sm shadow-md active:scale-95 transition-transform"><i class="fa-solid fa-location-dot mr-1"></i> 導航</a>
          <a href="tel:+81612345678" class="flex-1 bg-gray-100 text-gray-600 py-2 rounded-xl text-center text-sm active:scale-95 transition-transform"><i class="fa-solid fa-phone mr-1"></i> 電話</a>
        </div>
        <p class="text-xs text-gray-400">大阪府大阪市中央區久太郎町 2-4-24</p>
      </div>

      <!-- tips -->
      <div class="bg-white rounded-2xl p-5 shadow-card border-l-4 border-yellow-400">
        <h3 class="font-bold text-gray-700 mb-3"><i class="fa-solid fa-lightbulb text-yellow-400 mr-2"></i>溫馨提醒</h3>
        <ul class="text-xs text-gray-600 space-y-2 list-disc pl-4">
          <li><b>注意事項</b>：
            <ol class="list-decimal pl-4 mt-1 space-y-1 text-gray-500">
              <li>行程含吃到飽(請留意公平使用原則)SIM卡，不用再另外購買。</li>
              <li>飯店因早餐不是自助式且價格昂貴，附近是心齋橋還有LOWSAN跟超市，故這次不含早餐。</li>
              <li>自由行每日約為20,000步以上，回飯店休息後別忘了讓腳好好休息!!!</li>
            </ol>
          </li>
          <li><b>護照與簽證</b>：請確認護照有效期超過 6 個月，並於出發前填寫 <a href="https://services.digital.go.jp/zh-cmn-hant/visit-japan-web/" target="_blank" class="text-blue-500 underline hover:text-blue-600">Visit Japan Web</a>。</li>
          <li><b>電壓與插座</b>：日本電壓為 100V，插座為雙孔扁平（與台灣相同），通常不需轉接頭。</li>
          <li><b>禮儀</b>：電車內請保持安靜，手機調成靜音。走路請靠左側通行（大阪部分手扶梯靠右，依循前人即可）且日本禁止邊走邊吃。</li>
          <li><b>小費</b>：日本無小費文化，服務費通常已包含在帳單內。</li>
          <li><b>垃圾</b>：街上垃圾桶很少，請隨身攜帶塑膠袋裝垃圾，回飯店再丟。</li>
          <li><b>支付方式</b>：現金/信用卡(touch)/Pay pay</li>
        </ul>
      </div>

      <!-- packing -->
      <div class="bg-white rounded-2xl p-5 shadow-card">
        <h3 class="font-bold text-sakura-text mb-3 border-b pb-2 flex justify-between items-center">
          <span><i class="fa-solid fa-suitcase-rolling mr-2 text-sakura"></i>行李檢查清單</span>
        </h3>

        <div class="flex gap-2 overflow-x-auto no-scrollbar mb-3 pb-1 justify-center">
          <button
            v-for="person in packingPeople"
            :key="person"
            @click="currentPackingFilter = person"
            :class="[
              'px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors border',
              (currentPackingFilter === person) ? 'bg-sakura text-white border-sakura shadow-md' : 'bg-white text-gray-500 border-gray-200'
            ]"
          >
            {{ person }}
          </button>
        </div>

        <div class="space-y-0.5 mb-4">
          <div v-if="!packingData[currentPackingFilter] || packingData[currentPackingFilter].length === 0" class="text-center text-gray-400 py-4 text-xs">
            <i class="fa-solid fa-clipboard-check mb-1"></i><br>目前沒有項目
          </div>

          <template v-if="packingData[currentPackingFilter]">
            <div v-for="(item, index) in packingData[currentPackingFilter]" :key="item.id" class="flex items-center gap-3 py-0.5 px-2 rounded-lg transition-colors hover:bg-gray-50 group border border-transparent hover:border-gray-100">
              <label class="flex items-center gap-3 flex-1 cursor-pointer">
                <div class="relative flex items-center justify-center">
                  <input type="checkbox" v-model="item.checked" class="peer appearance-none w-5 h-5 border-2 border-gray-300 rounded-md checked:bg-sakura checked:border-sakura transition-colors">
                  <i class="fa-solid fa-check text-white text-xs absolute opacity-0 peer-checked:opacity-100 pointer-events-none transition-opacity"></i>
                </div>
                <span :class="{'line-through text-gray-400': item.checked, 'text-gray-600': !item.checked}" class="text-sm font-medium transition-colors select-none">
                  {{ item.text }}
                </span>
              </label>
              <button @click="removePackingItem(index)" class="text-gray-300 hover:text-red-400 p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
          </template>
        </div>

        <div class="flex gap-2">
          <input type="text" v-model="newPackingItem" placeholder="新增檢查項目..." class="flex-1 bg-gray-50 rounded-lg px-3 py-2 text-sm outline-none border focus:border-sakura" @keyup.enter="addPackingItem">
          <button @click="addPackingItem" class="bg-sakura text-white px-3 py-2 rounded-lg text-sm font-bold shadow-sm active:scale-95 transition-transform"><i class="fa-solid fa-plus"></i></button>
        </div>
      </div>
    </div>

    <!-- TAB 3 shopping -->
    <div v-if="currentTab === 'shopping'">
      <div class="flex gap-2 overflow-x-auto no-scrollbar mb-4 px-1 justify-center">
        <button
          v-for="traveler in shoppingTravelers"
          :key="traveler"
          @click="currentShoppingFilter = traveler"
          :class="[
            'px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors border',
            (currentShoppingFilter === traveler) ? 'bg-sakura text-white border-sakura shadow-md' : 'bg-white text-gray-500 border-gray-200'
          ]"
        >
          {{ traveler }}
        </button>
      </div>

      <div class="bg-pink-50 text-pink-700 text-xs px-4 py-2 rounded-xl mb-4 flex items-center border border-pink-100 mx-2 shadow-sm animate-pulse">
        <i class="fa-solid fa-wallet mr-2 text-pink-500"></i>
        溫馨提醒：日本是免稅不是免費唷~ 請理性購物 (笑)
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div v-for="(item, index) in filteredShoppingList" :key="item.id" class="bg-white rounded-2xl overflow-hidden shadow-card relative group">
          <div class="h-32 bg-gray-100 relative overflow-hidden">
            <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
            <div v-else class="w-full h-full flex items-center justify-center text-gray-300"><i class="fa-solid fa-image text-3xl"></i></div>

            <div class="absolute top-1 right-1 flex gap-1">
              <button @click.stop="openModal('shopping', item)" class="bg-white/80 w-6 h-6 rounded-full text-gray-500 text-xs flex items-center justify-center shadow-sm hover:text-sakura-dark"><i class="fa-solid fa-pen"></i></button>
              <button @click.stop="deleteShoppingItem(item.id)" class="bg-white/80 w-6 h-6 rounded-full text-red-400 text-xs flex items-center justify-center shadow-sm hover:bg-red-50"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <span class="absolute bottom-1 left-1 bg-black/50 text-white text-[10px] px-2 py-0.5 rounded-full backdrop-blur-sm">{{ item.owner || '未指定' }}</span>
          </div>
          <div class="p-3">
            <h4 class="font-bold text-gray-700 text-sm truncate">{{ item.name }}</h4>
            <div class="flex items-center gap-1 mt-2">
              <input type="checkbox" v-model="item.bought" class="accent-sakura w-4 h-4 rounded-full">
              <span class="text-xs text-gray-500" :class="{'line-through': item.bought}">已購買</span>
            </div>
          </div>
        </div>
      </div>

      <div v-if="filteredShoppingList.length === 0" class="text-center py-10 text-gray-400">
        <i class="fa-solid fa-basket-shopping text-4xl mb-3 opacity-50"></i>
        <p>還沒有相關紀錄喔</p>
      </div>

      <button @click="openModal('shopping')" class="fixed bottom-24 right-6 w-14 h-14 bg-sakura text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-sakura-dark transition-colors z-20">
        <i class="fa-solid fa-plus"></i>
      </button>
    </div>

    <!-- TAB 4 expense -->
    <div v-if="currentTab === 'expense'">
      <div class="flex gap-2 overflow-x-auto no-scrollbar mb-4 px-1 justify-center">
        <button @click="currentMemberFilter = null" :class="['px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors border', !currentMemberFilter ? 'bg-sakura text-white border-sakura shadow-md' : 'bg-white text-gray-500 border-gray-200']">全部</button>
        <button
          v-for="traveler in travelers"
          :key="traveler"
          @click="currentMemberFilter = traveler"
          :class="[
            'px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors border',
            (currentMemberFilter === traveler) ? 'bg-sakura text-white border-sakura shadow-md' : 'bg-white text-gray-500 border-gray-200'
          ]"
        >
          {{ traveler }}
        </button>
      </div>

      <div class="bg-gradient-to-r from-sakura to-sakura-dark rounded-2xl p-6 text-white shadow-soft mb-6 text-center transition-all duration-300">
        <p class="text-sm opacity-90 mb-1 flex items-center justify-center gap-2">
          <i class="fa-solid fa-user-tag text-xs"></i>
          {{ currentMemberFilter ? currentMemberFilter + ' 的花費' : '目前總花費' }} (JPY)
        </p>
        <h2 class="text-4xl font-bold font-mono">¥ {{ filteredTotalExpense.toLocaleString() }}</h2>
        <p class="text-xs opacity-70 mt-2">約 TWD {{ Math.round(filteredTotalExpense * (currentRate || 0.218)).toLocaleString() }}</p>
      </div>

      <div class="bg-white rounded-t-2xl shadow-card min-h-[300px]">
        <div v-for="(item, index) in filteredExpenses" :key="item.id" class="p-4 border-b border-gray-50 flex justify-between items-center">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-lg">
              <i :class="getExpenseIcon(item.category)" class="text-sakura-dark"></i>
            </div>
            <div>
              <h4 class="font-bold text-gray-800">{{ item.name }}</h4>
              <p class="text-xs text-gray-400">
                {{ item.date }} · {{ item.method }}
                <span class="ml-1 bg-gray-100 text-gray-500 px-1.5 rounded text-[10px]">{{ item.owner || '未指定' }}</span>
              </p>
            </div>
          </div>
          <div class="text-right">
            <p class="font-bold text-gray-800 font-mono">¥{{ Number(item.amount).toLocaleString() }}</p>
            <div class="mt-1 flex justify-end gap-2">
              <button @click="openModal('expense', item)" class="text-xs text-gray-400 hover:text-sakura-dark">編輯</button>
              <button @click="deleteExpense(item.id)" class="text-xs text-red-300 hover:text-red-500">刪除</button>
            </div>
          </div>
        </div>
        <div v-if="filteredExpenses.length === 0" class="text-center py-8 text-gray-400 text-sm">此分類下無紀錄</div>
      </div>

      <button @click="openModal('expense')" class="fixed bottom-24 right-6 w-14 h-14 bg-sakura text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-sakura-dark transition-colors z-20">
        <i class="fa-solid fa-plus"></i>
      </button>
    </div>

    <!-- TAB 5 notebook -->
    <div v-if="currentTab === 'notebook'">
      <div class="flex gap-2 overflow-x-auto no-scrollbar mb-4 px-1 justify-center">
        <button
          v-for="traveler in notebookOwners"
          :key="traveler"
          @click="currentNotebookFilter = traveler"
          :class="[
            'px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors border',
            (currentNotebookFilter === traveler) ? 'bg-sakura text-white border-sakura shadow-md' : 'bg-white text-gray-500 border-gray-200'
          ]"
        >
          {{ traveler }}
        </button>
      </div>

      <div class="grid gap-3 pb-24">
        <div v-if="filteredNotebookList.length === 0" class="text-center py-10 text-gray-400">
          <i class="fa-solid fa-book-open text-4xl mb-3 opacity-50"></i>
          <p>這裡空空的，記點什麼吧！</p>
        </div>

        <div v-for="note in filteredNotebookList" :key="note.id" class="bg-white p-4 rounded-2xl shadow-card relative group border-l-4 border-sakura-light">
          <h4 class="font-bold text-gray-800 mb-1">{{ note.title }}</h4>
          <p class="text-sm text-gray-600 whitespace-pre-line leading-relaxed">{{ note.content }}</p>
          <div class="mt-3 flex justify-between items-end border-t border-gray-50 pt-2">
            <span class="text-[10px] text-gray-400">{{ new Date(note.id).toLocaleDateString() }}</span>
            <div class="flex gap-2">
              <button @click="openModal('notebook', note)" class="text-xs text-gray-400 hover:text-sakura-dark"><i class="fa-solid fa-pen mr-1"></i>編輯</button>
              <button @click="deleteNote(note.id)" class="text-xs text-red-300 hover:text-red-500"><i class="fa-solid fa-trash-can mr-1"></i>刪除</button>
            </div>
          </div>
        </div>
      </div>

      <button @click="openModal('notebook')" class="fixed bottom-24 right-6 w-14 h-14 bg-sakura text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-sakura-dark transition-colors z-20">
        <i class="fa-solid fa-plus"></i>
      </button>
    </div>

  </main>

  <!-- bottom nav -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 flex justify-around items-center h-20 px-2 pb-2 rounded-t-[20px] shadow-[0_-5px_20px_rgba(0,0,0,0.03)] z-40 max-w-[480px] mx-auto">
    <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" class="flex flex-col items-center justify-center w-16 h-16 transition-all">
      <div class="w-10 h-6 flex items-center justify-center rounded-full mb-1 transition-all" :class="currentTab === tab.id ? 'bg-sakura-light text-sakura-dark' : 'text-gray-400'">
        <i :class="tab.icon" class="text-lg"></i>
      </div>
      <span class="text-[10px] font-bold transition-all" :class="currentTab === tab.id ? 'text-sakura-text' : 'text-gray-400'">{{ tab.name }}</span>
    </button>
  </nav>

  <!-- modal -->
  <div v-if="modal.show" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center animate-fade-in">
    <div class="bg-white w-full max-w-[480px] rounded-t-[20px] sm:rounded-2xl p-6 shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-sakura-text">{{ modal.title }}</h3>
        <button @click="closeModal" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>

      <div v-if="modal.type === 'itinerary'" class="space-y-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">分類</label>
          <select v-model="formData.category" class="w-full bg-gray-50 rounded-xl p-3">
            <option value="attraction">景點</option>
            <option value="transport">交通</option>
            <option value="food">美食</option>
            <option value="shopping">購物</option>
            <option value="accommodation">住宿</option>
            <option value="flight">航班</option>
            <option value="other">其他</option>
          </select>
        </div>
        <div><label class="block text-xs font-bold text-gray-500 mb-1">名稱</label><input type="text" v-model="formData.name" class="w-full bg-gray-50 rounded-xl p-3 border focus:border-sakura outline-none"></div>
        <div class="flex gap-3">
          <div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">時間</label><input type="time" v-model="formData.time" class="w-full bg-gray-50 rounded-xl p-3 border outline-none"></div>
          <div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">交通時間(分)</label><input type="number" v-model="formData.travelTime" class="w-full bg-gray-50 rounded-xl p-3 border outline-none" placeholder="30"></div>
        </div>
        <div><label class="block text-xs font-bold text-gray-500 mb-1">交通方式</label><select v-model="formData.transportType" class="w-full bg-gray-50 rounded-xl p-3"><option value="walk">步行</option><option value="transit">大眾運輸</option></select></div>
        <div v-if="['attraction', 'food', 'shopping'].includes(formData.category)"><label class="block text-xs font-bold text-gray-500 mb-1">營業時間</label><input type="text" v-model="formData.openHours" class="w-full bg-gray-50 rounded-xl p-3 border outline-none" placeholder="09:00 - 20:00"></div>
        <div v-if="formData.category === 'attraction'"><label class="block text-xs font-bold text-gray-500 mb-1">門票資訊</label><input type="text" v-model="formData.ticket" class="w-full bg-gray-50 rounded-xl p-3 border outline-none" placeholder="¥1000"></div>
        <div><label class="block text-xs font-bold text-gray-500 mb-1">備註</label><textarea v-model="formData.note" class="w-full bg-gray-50 rounded-xl p-3 border outline-none h-20"></textarea></div>

        <div v-if="modal.isEdit" class="pt-2">
          <button @click="confirmDeleteItinerary" class="w-full py-3 text-red-400 text-sm font-bold border border-red-100 rounded-xl hover:bg-red-50">刪除此行程</button>
        </div>
      </div>

      <div v-if="modal.type === 'shopping'" class="space-y-4">
        <div><label class="block text-xs font-bold text-gray-500 mb-1">是誰要買的？</label>
          <select v-model="formData.owner" class="w-full bg-blue-50 text-blue-800 font-bold rounded-xl p-3 border-blue-200">
            <option v-for="t in shoppingOwners" :value="t">{{ t }}</option>
          </select>
        </div>
        <div><label class="block text-xs font-bold text-gray-500 mb-1">商品名稱</label><input type="text" v-model="formData.name" class="w-full bg-gray-50 rounded-xl p-3 border focus:border-sakura outline-none"></div>
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">圖片</label>
          <div class="relative w-full h-32 bg-gray-100 rounded-xl flex items-center justify-center border-2 border-dashed border-gray-300 overflow-hidden">
            <input type="file" @change="handleImageUpload" class="absolute inset-0 opacity-0 cursor-pointer">
            <img v-if="formData.image" :src="formData.image" class="w-full h-full object-cover">
            <div v-else class="text-center text-gray-400"><i class="fa-solid fa-camera mb-1"></i><p class="text-xs">點擊上傳圖片</p></div>
          </div>
        </div>
      </div>

      <div v-if="modal.type === 'expense'" class="space-y-4">
        <div><label class="block text-xs font-bold text-gray-500 mb-1">是誰付的錢？</label>
          <select v-model="formData.owner" class="w-full bg-blue-50 text-blue-800 font-bold rounded-xl p-3 border-blue-200">
            <option v-for="t in travelers" :value="t">{{ t }}</option>
          </select>
        </div>
        <div><label class="block text-xs font-bold text-gray-500 mb-1">日期</label>
          <select v-model="formData.date" class="w-full bg-gray-50 rounded-xl p-3">
            <option v-for="day in days" :value="day.dateStr">{{ day.displayDate }}</option>
          </select>
        </div>
        <div><label class="block text-xs font-bold text-gray-500 mb-1">類別</label>
          <select v-model="formData.category" class="w-full bg-gray-50 rounded-xl p-3">
            <option value="transport">交通</option><option value="food">飲食</option><option value="accommodation">住宿</option><option value="ticket">門票</option><option value="shopping">購物</option><option value="gambling">博弈</option><option value="other">其他</option>
          </select>
        </div>
        <div><label class="block text-xs font-bold text-gray-500 mb-1">名稱</label><input type="text" v-model="formData.name" class="w-full bg-gray-50 rounded-xl p-3 border focus:border-sakura outline-none"></div>
        <div><label class="block text-xs font-bold text-gray-500 mb-1">金額 (JPY)</label><input type="number" v-model="formData.amount" class="w-full bg-gray-50 rounded-xl p-3 border focus:border-sakura outline-none"></div>
        <div><label class="block text-xs font-bold text-gray-500 mb-1">付款方式</label>
          <div class="flex gap-2">
            <label class="flex-1 bg-gray-50 p-3 rounded-xl flex items-center justify-center gap-2 cursor-pointer has-[:checked]:bg-sakura-light has-[:checked]:text-sakura-dark">
              <input type="radio" v-model="formData.method" value="現金" class="hidden"><i class="fa-solid fa-coins"></i> 現金
            </label>
            <label class="flex-1 bg-gray-50 p-3 rounded-xl flex items-center justify-center gap-2 cursor-pointer has-[:checked]:bg-sakura-light has-[:checked]:text-sakura-dark">
              <input type="radio" v-model="formData.method" value="信用卡" class="hidden"><i class="fa-solid fa-credit-card"></i> 信用卡
            </label>
          </div>
        </div>
      </div>

      <div v-if="modal.type === 'notebook'" class="space-y-4">
        <div><label class="block text-xs font-bold text-gray-500 mb-1">筆記擁有者</label>
          <select v-model="formData.owner" class="w-full bg-blue-50 text-blue-800 font-bold rounded-xl p-3 border-blue-200">
            <option v-for="t in notebookOwners" :value="t">{{ t }}</option>
          </select>
        </div>
        <div><label class="block text-xs font-bold text-gray-500 mb-1">標題</label><input type="text" v-model="formData.title" class="w-full bg-gray-50 rounded-xl p-3 border focus:border-sakura outline-none" placeholder="例如：想買的東西、注意事項..."></div>
        <div><label class="block text-xs font-bold text-gray-500 mb-1">內容</label><textarea v-model="formData.content" class="w-full bg-gray-50 rounded-xl p-3 border outline-none h-40" placeholder="寫點什麼..."></textarea></div>
      </div>

      <button @click="submitForm" class="w-full bg-sakura text-white font-bold py-4 rounded-xl mt-6 shadow-soft hover:bg-sakura-dark transition-colors">
        {{ modal.isEdit ? '儲存變更' : '新增' }}
      </button>
    </div>
  </div>

</div>

<script>
const APP_VERSION = "v15-2025-01-01-0120";
  const { createApp, ref, computed, reactive, onMounted, watch } = Vue;

  createApp({
    setup() {
      const showSplash = ref(true);
const appVersion = (typeof APP_VERSION !== 'undefined') ? APP_VERSION : 'version?';

      const currentTab = ref('itinerary');
      const tabs = [
        { id: 'itinerary', name: '行程表', icon: 'fa-solid fa-map-location-dot' },
        { id: 'info', name: '資訊', icon: 'fa-solid fa-circle-info' },
        { id: 'shopping', name: '購物清單', icon: 'fa-solid fa-basket-shopping' },
        { id: 'expense', name: '花費', icon: 'fa-solid fa-yen-sign' },
        { id: 'notebook', name: '筆記本', icon: 'fa-solid fa-book' },
      ];

      const defaultBanner = 'https://i.ibb.co/8nZ43bCk/Gemini-Generated-Image-nki8ufnki8ufnki8.png';
      const bannerImage = ref(defaultBanner);
      const handleImageError = () => { bannerImage.value = defaultBanner; };

      const isTigerairInfoExpanded = ref(false);

      const tripStartDate = new Date('2026-04-02T00:00:00');
      const daysUntilTrip = computed(() => {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const start = new Date(tripStartDate.getFullYear(), tripStartDate.getMonth(), tripStartDate.getDate());
        const diffTime = start - today;
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      });

      const travelers = ref(['公費', '翔/君', '倫/怡', '茹', '媽媽']);
      const shoppingTravelers = computed(() => ['全部', ...travelers.value.filter(t => t !== '公費')]);
      const shoppingOwners = computed(() => travelers.value.filter(t => t !== '公費'));
      const currentShoppingFilter = ref('全部');
      const currentMemberFilter = ref(null);

      const days = [
        { dateStr: '2026-04-02', displayDate: '4/2', dayOfWeek: '週四', mainCity: '大阪市', locations: [{ name: '大阪市', lat: 34.6937, lng: 135.5023 }] },
        { dateStr: '2026-04-03', displayDate: '4/3', dayOfWeek: '週五', mainCity: '奈良/京都', locations: [{ name: '大阪市', lat: 34.6937, lng: 135.5023 }, { name: '奈良市', lat: 34.6851, lng: 135.8048 }, { name: '京都市', lat: 35.0116, lng: 135.7681 }] },
        { dateStr: '2026-04-04', displayDate: '4/4', dayOfWeek: '週六', mainCity: '京都市', locations: [{ name: '京都市', lat: 35.0116, lng: 135.7681 }, { name: '大阪市', lat: 34.6937, lng: 135.5023 }] },
        { dateStr: '2026-04-05', displayDate: '4/5', dayOfWeek: '週日', mainCity: '大阪市', locations: [{ name: '大阪市', lat: 34.6937, lng: 135.5023 }] },
        { dateStr: '2026-04-06', displayDate: '4/6', dayOfWeek: '週一', mainCity: '關西機場', locations: [{ name: '大阪市', lat: 34.6937, lng: 135.5023 }, { name: '泉佐野市(機場)', lat: 34.4320, lng: 135.2304 }] },
      ];
      const selectedDate = ref('2026-04-02');

      // Weather
      const isWeatherExpanded = ref(false);
      const weatherLoading = ref(true);
      const toggleWeather = () => isWeatherExpanded.value = !isWeatherExpanded.value;

      const weatherData = reactive({
        temp: '--', maxTemp: '--', minTemp: '--', apparentTemp: '--', humidity: '--', windSpeed: '--', rain: '--', uvIndex: '--',
        sunrise: '--:--', sunset: '--:--', description: '載入中...', clothing: '載入中...', icon: 'fa-solid fa-spinner', iconColor: '#ccc', city: '大阪市',
        forecast: []
      });

      const currentDayCities = computed(() => {
        const day = days.find(d => d.dateStr === selectedDate.value);
        return day ? day.locations : [];
      });

      const getClothingAdvice = (avgTemp, maxTemp, minTemp) => {
        if (maxTemp < 10) return "天氣寒冷，請穿著保暖大衣、圍巾、手套，建議採用洋蔥式穿法。";
        if (maxTemp < 15) return "稍有寒意，建議穿著毛衣、風衣或是輕羽絨，早晚溫差大要注意保暖。";
        if (maxTemp < 20) return "氣溫舒適偏涼，建議長袖上衣搭配針織衫或牛仔外套，適合走路的裝扮。";
        if (maxTemp < 25) return "溫暖舒適，可穿薄長袖或短袖搭配薄襯衫，中午可能會覺得熱。";
        if (maxTemp >= 25) return "天氣炎熱，請穿著透氣輕便衣物，並注意防曬與補充水分。";
        return "氣溫變化大，建議隨身攜帶薄外套以備不時之需。";
      };

      const getWeatherInfo = (code, isDay) => {
        if (code === 0) return { desc: '晴朗', icon: isDay ? 'fa-solid fa-sun' : 'fa-solid fa-moon', color: '#fbbf24' };
        if (code === 1) return { desc: '大致晴朗', icon: isDay ? 'fa-solid fa-cloud-sun' : 'fa-solid fa-cloud-moon', color: '#fbbf24' };
        if (code === 2) return { desc: '多雲', icon: 'fa-solid fa-cloud', color: '#9ca3af' };
        if (code === 3) return { desc: '陰天', icon: 'fa-solid fa-cloud', color: '#6b7280' };
        if (code >= 45 && code <= 48) return { desc: '有霧', icon: 'fa-solid fa-smog', color: '#9ca3af' };
        if (code >= 51 && code <= 55) return { desc: '毛毛雨', icon: 'fa-solid fa-cloud-rain', color: '#60a5fa' };
        if (code >= 61 && code <= 67) return { desc: '下雨', icon: 'fa-solid fa-umbrella', color: '#3b82f6' };
        if (code >= 71 && code <= 77) return { desc: '下雪', icon: 'fa-regular fa-snowflake', color: '#93c5fd' };
        if (code >= 80 && code <= 82) return { desc: '陣雨', icon: 'fa-solid fa-cloud-showers-heavy', color: '#2563eb' };
        if (code >= 95) return { desc: '雷雨', icon: 'fa-solid fa-bolt', color: '#eab308' };
        return { desc: '未知', icon: 'fa-solid fa-circle-question', color: '#ccc' };
      };

      const fetchWeather = async (lat, lng, cityName) => {
        const cacheKey = `weather_cache_v1_${cityName}_${lat}`;
        const cachedRaw = localStorage.getItem(cacheKey);
        const now = Date.now();
        const CACHE_TIME = 1000 * 60 * 30;

        weatherData.city = cityName;

        if (cachedRaw) {
          try {
            const { timestamp, data } = JSON.parse(cachedRaw);
            if (now - timestamp < CACHE_TIME) {
              Object.assign(weatherData, data);
              weatherLoading.value = false;
              return;
            }
          } catch (e) {
            localStorage.removeItem(cacheKey);
          }
        }

        weatherLoading.value = true;

        try {
          const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,weather_code,wind_speed_10m&daily=weather_code,sunrise,sunset,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo`);
          const data = await response.json();

          if (!data.current) throw new Error("No data");
          const current = data.current;
          const daily = data.daily;

          weatherData.temp = Math.round(current.temperature_2m);
          weatherData.apparentTemp = Math.round(current.apparent_temperature);
          weatherData.humidity = current.relative_humidity_2m;
          weatherData.windSpeed = current.wind_speed_10m;
          weatherData.rain = current.precipitation;

          if (daily) {
            weatherData.maxTemp = Math.round(daily.temperature_2m_max[0]);
            weatherData.minTemp = Math.round(daily.temperature_2m_min[0]);
            if (daily.sunrise.length > 0) {
              weatherData.sunrise = daily.sunrise[0].split('T')[1];
              weatherData.sunset = daily.sunset[0].split('T')[1];
            }
            weatherData.clothing = getClothingAdvice(weatherData.temp, weatherData.maxTemp, weatherData.minTemp);

            const forecastList = [];
            const weekDays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
            for (let i = 1; i <= 3; i++) {
              if (daily.time[i]) {
                const d = new Date(daily.time[i]);
                const dayName = weekDays[d.getDay()];
                const code = daily.weather_code[i];
                const info = getWeatherInfo(code, true);
                forecastList.push({
                  dayName,
                  max: Math.round(daily.temperature_2m_max[i]),
                  min: Math.round(daily.temperature_2m_min[i]),
                  icon: info.icon,
                  color: info.color
                });
              }
            }
            weatherData.forecast = forecastList;
          }

          const wInfo = getWeatherInfo(current.weather_code, current.is_day === 1);
          weatherData.description = wInfo.desc;
          weatherData.icon = wInfo.icon;
          weatherData.iconColor = wInfo.color;
          weatherData.uvIndex = (current.is_day === 1 && current.weather_code <= 2) ? '高' : '低';

          localStorage.setItem(cacheKey, JSON.stringify({ timestamp: now, data: { ...weatherData } }));
        } catch (error) {
          weatherData.temp = 18;
          weatherData.maxTemp = 20;
          weatherData.minTemp = 12;
          weatherData.apparentTemp = 16;
          weatherData.humidity = 45;
          weatherData.windSpeed = 3;
          weatherData.rain = 0;
          weatherData.description = "晴朗 (模擬)";
          weatherData.clothing = "氣溫舒適偏涼，建議長袖上衣搭配針織衫或牛仔外套。(模擬數據)";
          weatherData.icon = "fa-solid fa-sun";
          weatherData.iconColor = "#fbbf24";
          weatherData.uvIndex = "中";
          weatherData.sunrise = "05:42";
          weatherData.sunset = "18:15";
          weatherData.forecast = [
            { dayName: '週六', max: 21, min: 13, icon: 'fa-solid fa-cloud-sun', color: '#fbbf24' },
            { dayName: '週日', max: 22, min: 14, icon: 'fa-solid fa-sun', color: '#fbbf24' },
            { dayName: '週一', max: 19, min: 12, icon: 'fa-solid fa-cloud-rain', color: '#60a5fa' }
          ];
        } finally {
          setTimeout(() => { weatherLoading.value = false; }, 200);
        }
      };

      const changeWeatherCity = (city) => fetchWeather(city.lat, city.lng, city.name);

      watch(selectedDate, (newDate) => {
        const dayInfo = days.find(d => d.dateStr === newDate);
        if (dayInfo && dayInfo.locations.length > 0) changeWeatherCity(dayInfo.locations[0]);
      });

      // Exchange
      const exchange = reactive({ jpy: '', twd: '' });
      const currentRate = ref(0.218);

      const fetchExchangeRate = async () => {
        try {
          const response = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
          const data = await response.json();
          if (data && data.rates && data.rates.TWD) currentRate.value = data.rates.TWD;
        } catch (e) {}
      };
      const calcTwd = () => { exchange.twd = exchange.jpy ? Math.round(exchange.jpy * currentRate.value) : ''; };
      const calcJpy = () => { exchange.jpy = exchange.twd ? Math.round(exchange.twd / currentRate.value) : ''; };
      const today = new Date().toLocaleDateString();

      // Data
      const fullItineraryData = (function(){ return window.__FULL_ITINERARY_DATA__ || []; })(); // 這行留著，下面會馬上覆蓋
      // 直接把你原本 fullItineraryData 內容掛回 window，避免太長重複（下面會再 set 一次）
      // （真正資料在最後一段：window.__FULL_ITINERARY_DATA__ = [...]）

      const itineraryList = ref(JSON.parse(localStorage.getItem('sakura_itinerary_v14')) || []);
      const filteredItinerary = computed(() => itineraryList.value.filter(item => item.date === selectedDate.value).sort((a,b)=>a.time.localeCompare(b.time)));

      const saveToLocal = (key, data) => localStorage.setItem(key, JSON.stringify(data));

      const resetToDefaultItinerary = () => {
        if (confirm('確定要重置行程表嗎？這將會覆蓋您目前的變更，並載入預設的 4/2~4/6 完整行程。')) {
          itineraryList.value = JSON.parse(JSON.stringify(window.__FULL_ITINERARY_DATA__));
          saveToLocal('sakura_itinerary_v14', itineraryList.value);
          alert('行程已重置為預設狀態！');
        }
      };

      const shoppingList = ref(JSON.parse(localStorage.getItem('sakura_shopping')) || []);
      const filteredShoppingList = computed(() => {
        if (currentShoppingFilter.value === '全部') return shoppingList.value;
        return shoppingList.value.filter(item => item.owner === currentShoppingFilter.value);
      });

      const expenses = ref(JSON.parse(localStorage.getItem('sakura_expenses')) || []);
      const filteredExpenses = computed(() => {
        if (!currentMemberFilter.value) return expenses.value;
        return expenses.value.filter(item => item.owner === currentMemberFilter.value);
      });
      const filteredTotalExpense = computed(() => filteredExpenses.value.reduce((sum, item) => sum + Number(item.amount), 0));
      const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + Number(item.amount), 0));

      const notebookList = ref(JSON.parse(localStorage.getItem('sakura_notebook')) || []);
      const notebookOwners = computed(() => travelers.value.filter(t => t !== '公費'));
      const currentNotebookFilter = ref(notebookOwners.value[0]);
      const filteredNotebookList = computed(() => notebookList.value.filter(note => note.owner === currentNotebookFilter.value).sort((a,b)=>b.id-a.id));

      const deleteNote = (id) => {
        if (confirm('確定刪除這則筆記？')) {
          notebookList.value = notebookList.value.filter(n => n.id !== id);
          saveToLocal('sakura_notebook', notebookList.value);
        }
      };

      // Packing
      const defaultPackingItems = [
        '護照 (有效期6個月以上)', 'Visit Japan Web QRcode 截圖', '網卡 / eSIM', '日幣現金 / 信用卡',
        '行動電源 (需隨身攜帶)', '個人常備藥 / 暈機藥', '牙刷牙膏 (日本部分飯店不主動提供)'
      ];
      const packingPeople = ref(['士翔', '侑君', '士倫', '欣怡', '珮茹', '媽媽']);
      const currentPackingFilter = ref(packingPeople.value[0]);
      const rawPacking = JSON.parse(localStorage.getItem('sakura_packing_v2_obj'));
      const packingData = ref(rawPacking || {});
      packingPeople.value.forEach(person => {
        if (!packingData.value[person]) {
          packingData.value[person] = defaultPackingItems.map((text, i) => ({ id: Date.now() + i + Math.random(), text, checked: false }));
        }
      });
      watch(packingData, (newVal) => {
        localStorage.setItem('sakura_packing_v2_obj', JSON.stringify(newVal));
      }, { deep: true });

      const newPackingItem = ref('');
      const addPackingItem = () => {
        if (!newPackingItem.value.trim()) return;
        const person = currentPackingFilter.value;
        if (!packingData.value[person]) packingData.value[person] = [];
        packingData.value[person].push({ id: Date.now() + Math.random(), text: newPackingItem.value, checked: false });
        newPackingItem.value = '';
      };
      const removePackingItem = (index) => {
        if (confirm('確定移除此項目？')) {
          const person = currentPackingFilter.value;
          packingData.value[person].splice(index, 1);
        }
      };

      // Modal
      const modal = reactive({ show: false, type: '', title: '', isEdit: false });
      const formData = reactive({});

      const openModal = (type, item = null) => {
        modal.type = type;
        modal.show = true;
        modal.isEdit = !!item;
        Object.keys(formData).forEach(k => delete formData[k]);

        if (item) {
          modal.title = '編輯';
          Object.assign(formData, JSON.parse(JSON.stringify(item)));
          return;
        }

        if (type === 'itinerary') {
          modal.title = '新增行程';
          Object.assign(formData, { date: selectedDate.value, category: 'attraction', transportType: 'walk', travelTime: 15, name: '', time: '10:00', note: '', description: '', openHours: '', ticket: '' });
        } else if (type === 'shopping') {
          modal.title = '新增購物清單';
          const defaultOwner = currentShoppingFilter.value !== '全部' ? currentShoppingFilter.value : shoppingOwners.value[0];
          Object.assign(formData, { name: '', image: '', bought: false, owner: defaultOwner });
        } else if (type === 'expense') {
          modal.title = '新增花費';
          Object.assign(formData, { date: selectedDate.value, category: 'food', method: '現金', amount: '', name: '', owner: currentMemberFilter.value || travelers.value[1] });
        } else if (type === 'notebook') {
          modal.title = '新增筆記';
          Object.assign(formData, { title: '', content: '', owner: currentNotebookFilter.value || notebookOwners.value[0] });
        }
      };
      const closeModal = () => modal.show = false;

      const submitForm = () => {
        if (!formData.id) formData.id = Date.now() + Math.random();

        const updateList = (listRef, storageKey) => {
          if (modal.isEdit) {
            const idx = listRef.value.findIndex(i => i.id === formData.id);
            if (idx !== -1) listRef.value[idx] = { ...formData };
          } else {
            listRef.value.push({ ...formData });
          }
          saveToLocal(storageKey, listRef.value);
        };

        if (modal.type === 'itinerary') updateList(itineraryList, 'sakura_itinerary_v14');
        else if (modal.type === 'shopping') updateList(shoppingList, 'sakura_shopping');
        else if (modal.type === 'expense') updateList(expenses, 'sakura_expenses');
        else if (modal.type === 'notebook') updateList(notebookList, 'sakura_notebook');

        closeModal();
      };

      const confirmDeleteItinerary = () => {
        if (confirm('確定要刪除這個行程嗎？')) {
          itineraryList.value = itineraryList.value.filter(i => i.id !== formData.id);
          saveToLocal('sakura_itinerary_v14', itineraryList.value);
          closeModal();
        }
      };

      const deleteShoppingItem = (id) => { if (confirm('刪除此商品？')) { shoppingList.value = shoppingList.value.filter(i => i.id !== id); saveToLocal('sakura_shopping', shoppingList.value); } };
      const deleteExpense = (id) => { if (confirm('刪除此紀錄？')) { expenses.value = expenses.value.filter(i => i.id !== id); saveToLocal('sakura_expenses', expenses.value); } };

const fileToDataURL = (file) => new Promise((resolve, reject) => {
  const reader = new FileReader();
  reader.onload = () => resolve(reader.result);
  reader.onerror = reject;
  reader.readAsDataURL(file);
});

const compressDataURL = (dataUrl, maxW = 1280, maxH = 1280, quality = 0.7) =>
  new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      let w = img.width, h = img.height;
      const ratio = Math.min(maxW / w, maxH / h, 1);
      w = Math.round(w * ratio);
      h = Math.round(h * ratio);

      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;
      canvas.getContext("2d").drawImage(img, 0, 0, w, h);

      // 轉成 jpg（體積會小很多）
      resolve(canvas.toDataURL("image/jpeg", quality));
    };
    img.src = dataUrl;
  });     

const handleImageUpload = async (e) => {
  try {
    const file = e.target.files[0];
    if (!file) return;

    // 過大檔案先擋（雙保險）
    if (file.size > 8 * 1024 * 1024) {
      throw new Error("圖片太大，請換一張");
    }

    const dataUrl = await fileToDataURL(file);

    const isCameraPhoto = file.size > 2_000_000;
    const quality = isCameraPhoto ? 0.5 : 0.7;

    const compressed = await compressDataURL(
      dataUrl,
      1280,
      1280,
      quality
    );

    if (!compressed || compressed.length < 1000) {
      throw new Error("圖片壓縮失敗");
    }

    formData.image = compressed;

    // 成功 → 確保不是紅燈
    if (cloudSync.state === "error") {
      cloudSync.state = "idle";
      cloudSync.message = "圖片上傳成功";
      cloudSync.error = null;
    }

    e.target.value = "";

  } catch (err) {
    console.error("❌ 圖片上傳失敗", err);

    // 🔴 關鍵：亮紅燈
    cloudSync.state = "error";
    cloudSync.message = "圖片上傳失敗，請換一張或重試";
    cloudSync.error = err?.message || "圖片處理錯誤";

    alert("圖片上傳失敗，請換一張較小的圖片 🙏");
  }
};
      const openMap = (keyword) => { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(keyword)}`, '_blank'); };

      // Category helpers
      const getCategoryLabel = (cat) => ({ attraction:'景點', food:'美食', shopping:'購物', accommodation:'住宿', flight:'航班', transport:'交通', other:'其他' }[cat] || '其他');
      const getCategoryColor = (cat) => ({ attraction:'bg-red-100 text-red-500', food:'bg-orange-100 text-orange-500', shopping:'bg-pink-100 text-pink-500', accommodation:'bg-purple-100 text-purple-500', transport:'bg-green-100 text-green-600' }[cat] || 'bg-gray-100 text-gray-500');
      const getTransportIcon = (type) => type === 'walk' ? 'fa-solid fa-person-walking' : 'fa-solid fa-train-subway';
      const getExpenseIcon = (cat) => `fa-solid ${{ transport:'fa-train', food:'fa-utensils', accommodation:'fa-bed', ticket:'fa-ticket', shopping:'fa-bag-shopping', other:'fa-circle', gambling:'fa-dice' }[cat] || 'fa-circle'}`;

      // ===== Cloud Sync (多設備同步 + 即時更新) =====
      const cloudSync = reactive({ state: "idle", message: "尚未同步", lastSyncedAt: null, error: null });
const isLocked = computed(() => cloudSync.state === "syncing" || isHydratingFromCloud);

      const cloudSyncDotClass = computed(() => {
        switch (cloudSync.state) {
          case 'syncing': return 'bg-yellow-400 animate-pulse';
          case 'error': return 'bg-red-500 cursor-pointer';
          case 'synced': return 'bg-green-500';
          default: return 'bg-gray-300';
        }
      });

      const deviceId = (() => {
        const k = 'sakura_device_id_v1';
        let v = localStorage.getItem(k);
        if (!v) {
          v = (crypto?.randomUUID ? crypto.randomUUID() : (Date.now() + '-' + Math.random())).toString();
          localStorage.setItem(k, v);
        }
        return v;
      })();

      const localMetaKey = 'sakura_cloud_meta_v1';
      const getLocalMeta = () => {
        try { return JSON.parse(localStorage.getItem(localMetaKey) || '{}'); } catch(e) { return {}; }
      };
      const setLocalMeta = (obj) => localStorage.setItem(localMetaKey, JSON.stringify(obj || {}));

     let isHydratingFromCloud = false;
let isBooting = true;            // ✅ 新增：開機保護期
let syncTimer = null;
let unsubscribeRealtime = null;

      const ensureIdsInPlainArray = (arr) => {
        let changed = false;
        (arr || []).forEach((item, idx) => {
          if (!item.id) { item.id = Date.now() + idx + Math.random(); changed = true; }
        });
        return changed;
      };

      const buildPayload = () => {
        const clientUpdatedAtMs = Date.now();
        const payload = {
          itinerary: itineraryList.value,
          shopping: shoppingList.value,
          expenses: expenses.value,
          notebook: notebookList.value,
          packing: packingData.value,
          clientUpdatedAtMs,
          lastWriter: deviceId
        };
        return payload;
      };

      const applyCloudToLocal = (cloud) => {
        if (!cloud) return;

        // 安全補 id
        if (Array.isArray(cloud.itinerary)) ensureIdsInPlainArray(cloud.itinerary);
        if (Array.isArray(cloud.shopping)) ensureIdsInPlainArray(cloud.shopping);
        if (Array.isArray(cloud.expenses)) ensureIdsInPlainArray(cloud.expenses);
        if (Array.isArray(cloud.notebook)) ensureIdsInPlainArray(cloud.notebook);

        if (Array.isArray(cloud.itinerary)) itineraryList.value = cloud.itinerary;
        if (Array.isArray(cloud.shopping)) shoppingList.value = cloud.shopping;
        if (Array.isArray(cloud.expenses)) expenses.value = cloud.expenses;
        if (Array.isArray(cloud.notebook)) notebookList.value = cloud.notebook;
        if (cloud.packing && typeof cloud.packing === 'object') packingData.value = cloud.packing;

        saveToLocal('sakura_itinerary_v14', itineraryList.value);
        saveToLocal('sakura_shopping', shoppingList.value);
        saveToLocal('sakura_expenses', expenses.value);
        saveToLocal('sakura_notebook', notebookList.value);
        localStorage.setItem('sakura_packing_v2_obj', JSON.stringify(packingData.value));
      };

      const waitForCloudFns = () => new Promise((resolve, reject) => {
        const start = Date.now();
        const timer = setInterval(() => {
          const ok = (typeof window.__CLOUD_GET_STATE__ === "function")
                 && (typeof window.__CLOUD_SET_STATE__ === "function")
                 && (typeof window.__CLOUD_ON_SNAPSHOT__ === "function");
          if (ok) { clearInterval(timer); resolve(true); }
          if (Date.now() - start > 12000) { clearInterval(timer); reject(new Error("Cloud functions not ready")); }
        }, 120);
      });

const markLocalDirty = () => {
  const meta = getLocalMeta();
  meta.localUpdatedAtMs = Date.now();
  meta.lastWriter = deviceId;
  meta.pendingSync = true; // ✅ 新增：代表本機有「尚未同步」的變更
  setLocalMeta(meta);
};
      const manualCloudSync = async () => {
        try {
          if (isHydratingFromCloud) return;
          await waitForCloudFns();
          cloudSync.state = "syncing";
          cloudSync.message = "同步中…";
          cloudSync.error = null;

          markLocalDirty();                 // ✅ 先標記本機變更時間
const payload = buildPayload();   // ✅ 再用最新狀態產生 payload
await window.__CLOUD_SET_STATE__(payload);

// ✅ 同步成功後：標記為乾淨，並記住這次 client 版本
const meta = getLocalMeta();
meta.pendingSync = false;
meta.lastAppliedClientMs = meta.localUpdatedAtMs;
setLocalMeta(meta);

cloudSync.state = "synced";
cloudSync.message = "已同步到雲端";
cloudSync.lastSyncedAt = new Date().toISOString();
        } catch (err) {
          cloudSync.state = "error";
          cloudSync.message = "同步失敗，點這裡重試";
          cloudSync.error = err?.message || String(err);
        }
      };

    const scheduleSync = () => {
  if (cloudSync.state === "syncing") return; // ✅ 關鍵新增

  if (isHydratingFromCloud) return;
  if (isBooting) return;

  markLocalDirty();
  clearTimeout(syncTimer);
  syncTimer = setTimeout(() => manualCloudSync(), 1200);
};

      // Watch local changes
      watch(itineraryList, scheduleSync, { deep: true });
      watch(shoppingList, scheduleSync, { deep: true });
      watch(expenses, scheduleSync, { deep: true });
      watch(notebookList, scheduleSync, { deep: true });
      watch(packingData, scheduleSync, { deep: true });

      const startRealtimeCloud = async () => {
        try {
          await waitForCloudFns();
          cloudSync.state = "syncing";
          cloudSync.message = "連線雲端中…";
          cloudSync.error = null;

          if (unsubscribeRealtime) { try { unsubscribeRealtime(); } catch(e) {} unsubscribeRealtime = null; }

          unsubscribeRealtime = window.__CLOUD_ON_SNAPSHOT__(async (remote) => {
  try {
    if (!remote) {
      cloudSync.state = "synced";
      cloudSync.message = "雲端尚無資料";
      cloudSync.lastSyncedAt = new Date().toISOString();
      return;
    }

    const serverMs = remote.serverUpdatedAtMs || 0;
    const clientMs = remote.clientUpdatedAtMs || 0;
    const writer = remote.lastWriter || null;

    const localMeta = getLocalMeta();
    const localUpdatedAtMs = localMeta.localUpdatedAtMs || 0;

    const isNewerThanApplied =
      (serverMs > (localMeta.lastAppliedServerMs || 0)) ||
      (clientMs > (localMeta.lastAppliedClientMs || 0));

    const isFromOther = writer && writer !== deviceId;

    // ✅ 重點：只有「本機還沒同步出去」才算本機比較新
    const pendingSync = !!localMeta.pendingSync;
    const localIsNewer = pendingSync && (localUpdatedAtMs > clientMs);

    if (isNewerThanApplied && isFromOther && !localIsNewer) {
      isHydratingFromCloud = true;
      applyCloudToLocal(remote);
      isHydratingFromCloud = false;

      const newMeta = getLocalMeta();
      newMeta.lastAppliedServerMs = serverMs;
      newMeta.lastAppliedClientMs = clientMs;

      // ✅ 套用雲端後，本機視為同一份
      newMeta.localUpdatedAtMs = clientMs;
      newMeta.pendingSync = false;

      setLocalMeta(newMeta);

      cloudSync.state = "synced";
      cloudSync.message = "已從雲端同步";
      cloudSync.lastSyncedAt = new Date().toISOString();
      return;
    }
    

    // ✅ 沒套用雲端也要記錄已看到的時間，避免重複判斷
    const newMeta = getLocalMeta();
    newMeta.lastAppliedServerMs = Math.max(newMeta.lastAppliedServerMs || 0, serverMs);
    newMeta.lastAppliedClientMs = Math.max(newMeta.lastAppliedClientMs || 0, clientMs);
    setLocalMeta(newMeta);

    cloudSync.state = "synced";
    cloudSync.message = "即時同步中";
    cloudSync.lastSyncedAt = new Date().toISOString();
  } catch (e) {
    isHydratingFromCloud = false;
    cloudSync.state = "error";
    cloudSync.message = "雲端同步發生錯誤，點這裡重試";
    cloudSync.error = e?.message || String(e);
  }
});

    // ⛔ 不要直接 await，改用 setTimeout 包起來
setTimeout(async () => {
  const first = await window.__CLOUD_GET_STATE__();
  if (first && first.lastWriter !== deviceId) {
    isHydratingFromCloud = true;
    applyCloudToLocal(first);
    isHydratingFromCloud = false;

    const newMeta = getLocalMeta();
    newMeta.lastAppliedServerMs = first.serverUpdatedAtMs || 0;
    newMeta.lastAppliedClientMs = first.clientUpdatedAtMs || 0;
    newMeta.localUpdatedAtMs = first.clientUpdatedAtMs || 0;
    newMeta.pendingSync = false;
    setLocalMeta(newMeta);
  }

  cloudSync.state = "synced";
  cloudSync.message = "雲端連線完成";
  cloudSync.lastSyncedAt = new Date().toISOString();
} catch (err) {
  cloudSync.state = "error";
  cloudSync.message = "雲端連線失敗，點這裡重試";
  cloudSync.error = err?.message || String(err);
}



// init
onMounted(async () => {
  setTimeout(() => { showSplash.value = false; }, 3000);

  // 把預設行程灌進去（本機沒有 or 本機是空陣列 都要灌）
  const rawItin = localStorage.getItem('sakura_itinerary_v14');
  let parsedItin = [];
  try { 
    parsedItin = rawItin ? JSON.parse(rawItin) : []; 
  } catch (e) { 
    parsedItin = []; 
  }

  if (!rawItin || !Array.isArray(parsedItin) || parsedItin.length === 0) {
    itineraryList.value = JSON.parse(JSON.stringify(window.__FULL_ITINERARY_DATA__));
    saveToLocal('sakura_itinerary_v14', itineraryList.value);
  } else {
    itineraryList.value = parsedItin;
  }

  // ✅ 就在這裡加（或放最下面也可以）
const el = document.getElementById("app-version");
if (el) el.innerText = APP_VERSION;
});


        // ensure ids
        if (ensureIdsInPlainArray(shoppingList.value)) saveToLocal('sakura_shopping', shoppingList.value);
        if (ensureIdsInPlainArray(expenses.value)) saveToLocal('sakura_expenses', expenses.value);
        if (ensureIdsInPlainArray(notebookList.value)) saveToLocal('sakura_notebook', notebookList.value);

        // weather + exchange
        const dayInfo = days.find(d => d.dateStr === selectedDate.value);
        if (dayInfo && dayInfo.locations.length > 0) changeWeatherCity(dayInfo.locations[0]);
        fetchExchangeRate();

        // cloud realtime
(async () => {
  if (window.__CLOUD_READY__) {
    await window.__CLOUD_READY__;
  }
  await startRealtimeCloud();

  // ✅ 一定要一起放進來
  isBooting = false;
})();
      return {
appVersion,
        showSplash,
        currentTab, tabs,
        days, selectedDate,
        filteredItinerary,
        modal, formData, openModal, closeModal, submitForm,
        shoppingList, filteredShoppingList,
        expenses, filteredExpenses, totalExpense, filteredTotalExpense,
        packingData, currentPackingFilter, newPackingItem, addPackingItem, removePackingItem, packingPeople,
        notebookList, filteredNotebookList, currentNotebookFilter, notebookOwners, deleteNote,
        exchange, calcTwd, calcJpy, currentRate, today,
        getCategoryLabel, getCategoryColor, getTransportIcon, getExpenseIcon,
        confirmDeleteItinerary, deleteShoppingItem, deleteExpense,
        isWeatherExpanded, toggleWeather, weatherData, weatherLoading, currentDayCities, changeWeatherCity,
        travelers, shoppingTravelers, shoppingOwners, currentShoppingFilter, currentMemberFilter,
        bannerImage, handleImageError, daysUntilTrip,
        cloudSync, cloudSyncDotClass, manualCloudSync, resetToDefaultItinerary,
        isTigerairInfoExpanded,
        openMap,
        handleImageUpload
      };
    }
  }).mount('#app');
</script>

<style>
  @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
  .animate-slide-up { animation: slide-up 0.3s ease-out forwards; }
  @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
  .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }
</style>

<!-- 把你的 fullItineraryData 放到 window，避免上面 Vue 區塊太長 -->
<script>
window.__FULL_ITINERARY_DATA__ = [
  { id: 0, date: '2026-04-02', category: 'other', name: '高雄小港機場集合', time: '05:00', travelTime: 0, transportType: 'walk', note: '國際航廈出境大廳', description: '準備啟程出發囉！🎉 請務必準時集合，準備辦理登機手續。記得再次檢查護照與必備證件！' },
  { id: 1, date: '2026-04-02', category: 'flight', name: '航班 IT-284 KHH->KIX', time: '07:00', travelTime: 0, transportType: 'flight', note: '起飛 07:00 / 抵達 10:55 (預計出關 11:30)' },
  { id: 2, date: '2026-04-02', category: 'transport', name: '關西機場 → 難波', time: '11:40', travelTime: 45, transportType: 'transit', note: '已事先購票', description: '📍 路線：南海電鐵空港急行 (Nankai Airport Exp.)\n🚉 區間：關西機場站 (Kansai Airport) → 南海難波站 (Namba)\n💡 提示：出站後依指示前往地鐵御堂筋線。' },
  { id: 3, date: '2026-04-02', category: 'transport', name: '難波 → 本町 (飯店)', time: '12:40', travelTime: 15, transportType: 'transit', note: '轉乘御堂筋線 (紅線)', description: '🚉 區間：難波站 (M20) → 本町站 (M18)\n🚶 步行：由 11 號或 12 號出口出站，步行約 3-5 分鐘抵達飯店。' },
  { id: 4, date: '2026-04-02', category: 'accommodation', name: '東急 Stay 大阪本町', time: '13:00', travelTime: 0, transportType: 'walk', note: '先寄放行李', description: '先在大廳寄放行李，輕裝出發去大阪城！' },
  { id: 5, date: '2026-04-02', category: 'transport', name: '本町 → 大阪城公園', time: '13:30', travelTime: 20, transportType: 'transit', note: '搭乘中央線 (綠線)', description: '🚉 區間：本町站 (C16) → 谷町四丁目站 (C18)\n🚶 步行：從 9 號出口出來，步行前往大阪城大手門方向，沿途可見護城河與櫻花。' },
  { id: 6, date: '2026-04-02', category: 'attraction', name: '大阪城公園 & 天守閣', time: '14:00', travelTime: 0, transportType: 'walk', note: '🌸 櫻花百選名所', openHours: '09:00 - 17:00 (最後入場 16:30)', ticket: '天守閣 ¥600 / 西之丸庭園 ¥200', description: '大阪的地標，園內種植約3000株櫻花。推薦前往「西之丸庭園」賞櫻，這裡以染井吉野櫻為主，能拍到天守閣與櫻花同框的絕美畫面。天守閣內展示豐臣秀吉的歷史文物，8樓展望台可俯瞰大阪市景。' },
  { id: 7, date: '2026-04-02', category: 'transport', name: '大阪城 → 飯店', time: '16:30', travelTime: 20, transportType: 'transit', note: '回飯店辦理入住', description: '🚉 區間：谷町四丁目站 (C18) → 本町站 (C16) (搭乘中央線)\n返回飯店領取行李並辦理 Check-in。' },
  { id: 8, date: '2026-04-02', category: 'accommodation', name: '飯店 Check-in & 休息', time: '17:00', travelTime: 0, transportType: 'walk', note: '稍作整理與休息', description: '辦理入住手續，進房整理一下行李，補妝或休息片刻，準備晚上去逛街！' },
  { id: 9, date: '2026-04-02', category: 'transport', name: '飯店 → 心齋橋', time: '17:45', travelTime: 15, transportType: 'walk', note: '步行或搭地鐵一站', description: '從本町慢慢散步至心齋橋商店街(約10-15分)，或者搭乘御堂筋線一站 (本町→心齋橋)。' },
  { id: 10, date: '2026-04-02', category: 'shopping', name: '心齋橋 & 道頓堀 晚餐', time: '18:00', travelTime: 0, transportType: 'walk', note: '逛街、吃晚餐、跑跑人看板', openHours: '依店家 (約至 20:00/21:00)', description: '大阪最熱鬧的購物區。心齋橋有大丸百貨、Uniqlo旗艦店、藥妝店。晚餐建議到道頓堀品嚐章魚燒、拉麵 (一蘭/金龍) 或大阪燒。別忘了在戎橋跟固力果跑跑人合照！' },
  { id: 11, date: '2026-04-02', category: 'transport', name: '心齋橋 → 飯店', time: '21:00', travelTime: 15, transportType: 'walk', note: '步行或搭地鐵', description: '吃飽喝足後，散步回飯店消化一下，結束第一天的行程。' },

  { id: 201, date: '2026-04-03', category: 'transport', name: '飯店 → 奈良', time: '08:00', travelTime: 60, transportType: 'transit', note: '地鐵轉近鐵', description: '📍 路線：\n1. 飯店步行至 本町站\n2. 搭乘地鐵御堂筋線至 難波站 (M20)\n3. 出站步行至 近鐵大阪難波站\n4. 搭乘近鐵奈良線 (快速急行) 至 近鐵奈良站\n💡 提示：搭乘快速急行約 40 分鐘，比普通車快很多。' },
  { id: 202, date: '2026-04-03', category: 'attraction', name: '奈良公園 (梅花鹿公園)', time: '09:10', travelTime: 10, transportType: 'walk', note: '買鹿仙貝小心被圍攻', ticket: '鹿仙貝¥200', description: '從近鐵奈良站 2 號出口出來，沿著登大路往東走即達。沿途就會看到很多鹿。請注意手上的地圖或紙張，鹿可能會咬走。' },
  { id: 203, date: '2026-04-03', category: 'attraction', name: '東大寺 (大佛殿)', time: '10:00', travelTime: 15, transportType: 'walk', note: '世界最大木造建築', ticket: '¥600', openHours: '07:30 - 17:30', description: '穿越巨大的南大門（有金剛力士像），參觀大佛殿內的盧舍那佛。如果人不多，可以挑戰鑽「大佛鼻孔」柱子洞，聽說能保平安。' },
  { id: 204, date: '2026-04-03', category: 'attraction', name: '春日大社', time: '11:30', travelTime: 20, transportType: 'walk', note: '參道石燈籠', description: '沿著森林參道前往，這裡氣氛比較幽靜。以數千座石燈籠和吊燈籠聞名。如果走累了，可以在參道入口附近的茶屋休息吃點東西。' },
  { id: 205, date: '2026-04-03', category: 'transport', name: '春日大社 → JR 奈良站', time: '13:00', travelTime: 25, transportType: 'transit', note: '搭乘巴士', description: '步行至「春日大社本殿」巴士站，搭乘奈良交通巴士 (70/97/98號) 前往 JR 奈良站 (約 15-20 分鐘)。\n💡 若步行需約 30-40 分鐘，建議搭車保留體力。' },
  { id: 206, date: '2026-04-03', category: 'transport', name: 'JR 奈良 → JR 稻荷', time: '13:30', travelTime: 35, transportType: 'transit', note: '搭乘 JR 奈良線', description: '🚉 區間：JR 奈良站 → JR 稻荷站\n💡 注意：請搭乘「普通」列車 (Miyakoji Rapid 不停稻荷)，或者搭快速到宇治/東福寺再轉普通車。稻荷站出站即是神社入口。' },
  { id: 207, date: '2026-04-03', category: 'attraction', name: '伏見稻荷大社', time: '14:10', travelTime: 0, transportType: 'walk', note: '千本鳥居', description: '必拍千本鳥居！建議往山上走一段，人潮會變少，比較好拍照。這裡狐狸是神的使者，繪馬也是狐狸形狀的喔。' },
  { id: 208, date: '2026-04-03', category: 'transport', name: '稻荷 → 飯店 (經京都/新大阪)', time: '16:30', travelTime: 60, transportType: 'transit', note: 'JR 轉 地鐵', description: '1. JR 稻荷 → JR 京都 (奈良線)\n2. JR 京都 → JR 新大阪 (JR京都線/新快速)\n3. JR 新大阪 → 地鐵 新大阪 (轉乘御堂筋線)\n4. 地鐵 新大阪 → 本町 (M18)\n💡 這是利用 JR PASS 或單程票的快速走法。' },
  { id: 209, date: '2026-04-03', category: 'shopping', name: '晚上自由逛街', time: '18:30', travelTime: 0, transportType: 'walk', note: '自由活動', description: '回到本町/心齋橋區域。可以各自去藥妝店補貨，或是去難波 Parks、高島屋逛街。晚餐可相約吃燒肉或各自覓食。' },

  { id: 301, date: '2026-04-04', category: 'transport', name: '飯店 → 京都車站', time: '08:00', travelTime: 50, transportType: 'transit', note: '地鐵轉 JR (經新大阪)', description: '📍 路線：\n1. 飯店步行至 本町站\n2. 搭乘地鐵御堂筋線至 新大阪站 (M13)\n3. 站內轉乘 JR 京都線 (新快速) 至 JR 京都站\n💡 提示：在新大阪轉乘比在梅田(大阪站)簡單許多，請搭乘「新快速」列車，約 25 分鐘即可抵達京都。' },
  { id: 302, date: '2026-04-04', category: 'transport', name: '京都車站 → 清水寺', time: '09:00', travelTime: 30, transportType: 'transit', note: '轉乘京都市巴士', description: '前往京都車站前的巴士總站 (D1 或 D2 乘車處)，搭乘 206 號或 100 號 (洛巴士) ，在「五條坂」或「清水道」下車，步行上坡約 10-15 分鐘抵達仁王門。' },
  { id: 303, date: '2026-04-04', category: 'attraction', name: '清水寺', time: '09:40', travelTime: 15, transportType: 'walk', note: '清水舞台、音羽瀑布', ticket: '¥400', openHours: '06:00 - 18:00', description: '京都最著名的古老寺院，必看懸空的「清水舞台」。參拜後可去「地主神社」求姻緣 (若整修中則略過)，最後別忘了在「音羽瀑布」排隊喝水祈福（分別代表學業、戀愛、長壽，只能選一道喝喔）。' },
  { id: 304, date: '2026-04-04', category: 'attraction', name: '散步：二三年坂 & 寧寧之道', time: '11:30', travelTime: 0, transportType: 'walk', note: '古色古香老街', description: '順著清水寺走下來，會經過三年坂（產寧坂）和二年坂。這裡有非常多日式雜貨與點心店。途中推薦去「星巴克京都二寧坂雅祥茶屋店」拍照，這是全球唯一設在百年町家裡的榻榻米星巴克。接著前往高台寺旁的寧寧之道。' },
  { id: 305, date: '2026-04-04', category: 'attraction', name: '八坂神社、祇園 & 花見小路', time: '13:00', travelTime: 15, transportType: 'walk', note: '藝妓與茶屋文化', description: '沿著寧寧之道走到八坂神社，再前往祇園區域。花見小路兩旁是保存良好的傳統茶屋，運氣好可能會看到藝妓或舞妓經過（請勿觸碰或阻擋拍照）。午餐建議在此區域或河原町解決。' },
  { id: 306, date: '2026-04-04', category: 'attraction', name: '鴨川 & 河原町商店街', time: '15:00', travelTime: 10, transportType: 'walk', note: '河岸散步與逛街', description: '從祇園跨過四條大橋就是鴨川，適合在河堤邊坐著休息吹風，欣賞河景。過橋後即進入河原町商圈，這裡有高島屋、Disney Store、各种藥妝與服飾店，非常好逛。' },
  { id: 307, date: '2026-04-04', category: 'transport', name: '河原町 → 京都車站', time: '18:00', travelTime: 20, transportType: 'transit', note: '地鐵或巴士', description: '在四條河原町搭乘巴士回京都車站，或者走至地鐵四條站點搭乘烏丸線至京都站。準備搭 JR 回大阪。' },
  { id: 308, date: '2026-04-04', category: 'transport', name: '京都車站 → 飯店', time: '18:30', travelTime: 50, transportType: 'transit', note: 'JR 轉 地鐵 (經新大阪)', description: '📍 路線：\n1. JR 京都站 (搭乘 JR 京都線/新快速) → JR 新大阪站 (約 24 分)\n2. 站內轉乘地鐵御堂筋線 (新大阪 M13 → 本町 M18)\n3. 步行回飯店\n💡 這是最快也最單純的路線。晚餐建議在京都車站拉麵小路解決，或買便當回飯店享用。' },
  { id: 310, date: '2026-04-04', category: 'other', name: '飯店自由活動', time: '20:00', travelTime: 0, transportType: 'walk', note: '休息或整理行李', description: '經過一整天京都走路行程，腿應該很酸了，建議早點休息，或是在飯店附近超商買點宵夜。' },

  { id: 401, date: '2026-04-05', category: 'transport', name: '飯店 → 海遊館', time: '08:00', travelTime: 20, transportType: 'transit', note: '搭乘中央線 (綠線)', description: '📍 路線：\n1. 飯店步行至 本町站\n2. 搭乘地鐵中央線 (往宇宙廣場方向) 至 大阪港站 (C11)\n3. 1號或2號出口出站，步行約 5-10 分鐘抵達。' },
  { id: 402, date: '2026-04-05', category: 'attraction', name: '海遊館', time: '08:30', travelTime: 0, transportType: 'walk', note: '世界最大級水族館', ticket: '¥2,700', openHours: '09:30 - 20:00', description: '早點到可以避開排隊人潮。必看巨大的「太平洋」水槽與鎮館之寶——鯨鯊。館內設計是從8樓螺旋狀往下參觀，模擬從海面潛入深海的過程。' },
  { id: 403, date: '2026-04-05', category: 'transport', name: '海遊館 → 通天閣', time: '11:00', travelTime: 30, transportType: 'transit', note: '中央線轉堺筋線', description: '1. 大阪港站 (中央線) → 堺筋本町站 (C17)\n2. 轉乘堺筋線 (咖啡色線) → 惠美須町站 (K18)\n3. 3號出口出站，通天閣就在眼前。' },
  { id: 404, date: '2026-04-05', category: 'attraction', name: '通天閣 & 新世界', time: '11:40', travelTime: 0, transportType: 'walk', note: '大阪懷舊地標', description: '這裡充滿昭和時代的懷舊氛圍，巨大的河豚招牌是必拍景點。可以上通天閣展望台摸摸Billiken神像的腳底求好運。' },
  { id: 405, date: '2026-04-05', category: 'food', name: '午餐：元祖炸串', time: '12:00', travelTime: 0, transportType: 'walk', note: '禁止二次沾醬', description: '在新世界商店街享用大阪名物「炸串 (Kushikatsu)」。推薦「達摩 (Daruma)」或「八重勝」。記得醬汁是共用的，咬過後絕對不能再沾喔！' },
  { id: 406, date: '2026-04-05', category: 'attraction', name: '天王寺動物園', time: '13:30', travelTime: 10, transportType: 'walk', note: '百年動物園', ticket: '¥500', openHours: '09:30 - 17:00', description: '從新世界步行即可抵達「新世界大門」。園區內有模擬非洲熱帶草原的生態展示區，能近距離觀察河馬、獅子等動物。' },
  { id: 407, date: '2026-04-05', category: 'transport', name: '動物園 → 阿倍野', time: '15:30', travelTime: 15, transportType: 'walk', note: '穿越天王寺公園', description: '從動物園出來，穿越寬闊漂亮的「天王寺公園 (Ten-Shiba)」草皮區，前方最高的摩天大樓就是阿倍野 HARUKAS。' },
  { id: 408, date: '2026-04-05', category: 'attraction', name: '阿倍野 HARUKAS 300', time: '16:00', travelTime: 0, transportType: 'walk', note: '絕美日落與夜景', ticket: '¥1,800', openHours: '09:00 - 22:00', description: '提早上展望台佔個好位置！在 60 樓展望台 360 度俯瞰大阪全景。這個時間上去可以悠閒地等待日落，一次欣賞白天、夕陽與百萬夜景的變化。' },
  { id: 409, date: '2026-04-05', category: 'transport', name: '天王寺 → 飯店', time: '18:30', travelTime: 15, transportType: 'transit', note: '御堂筋線直達', description: '從天王寺站 (M23) 搭乘御堂筋線，直達 本町站 (M18)。' },
  { id: 410, date: '2026-04-05', category: 'other', name: '回飯店休息', time: '19:00', travelTime: 0, transportType: 'walk', note: '整理戰利品', description: '最後一晚了，早點回飯店整理行李，確認伴手禮是否買齊，明天就要回程囉。' },

  { id: 501, date: '2026-04-06', category: 'transport', name: '飯店 → 關西機場', time: '08:30', travelTime: 60, transportType: 'transit', note: '地鐵轉南海電鐵', description: '1. 地鐵御堂筋線：本町 (M18) → 難波 (M20)\n2. 南海電鐵：難波 → 關西機場 (搭乘空港急行或 Rapi:t)\n💡 雖然班機是 12:00，但建議 10:00 前抵達機場比較充裕。' },
  { id: 502, date: '2026-04-06', category: 'other', name: '機場報到 & 行李托運', time: '10:00', travelTime: 0, transportType: 'walk', note: 'IT-285 (第一航廈)', description: '前往台灣虎航櫃台辦理登機。記得再次確認隨身行李內沒有超過 100ml 的液體、剪刀等違禁品。行動電源和電池請務必隨身攜帶，不可托運。' },
  { id: 503, date: '2026-04-06', category: 'shopping', name: '免稅店掃貨 & 伴手禮', time: '10:40', travelTime: 0, transportType: 'walk', note: '🎁 必買推薦清單', description: '過海關後的最後衝刺！推薦購買：\n1. 🍫 ROYCE\' 生巧克力 & 洋芋片 (記得買保冷袋)\n2. 🍌 東京香蕉 (Tokyo Banana) - 這裡也買得到！\n3. 🍰 LeTAO 雙層乳酪蛋糕 (來自北海道的美味)\n4. 🍟 薯條三兄弟 (Jaga Pokkuru)\n5. 🍵 京都北山茶之菓 (濃郁抹茶餅乾)\n6. 🍬 呼吸巧克力 (大阪限定，大包裝適合分送)\n💡 提示：剩下的日幣零錢可以在這裡全部花掉，不足的金額再刷卡。' },
  { id: 504, date: '2026-04-06', category: 'flight', name: '航班 IT-285 KIX->KHH', time: '12:00', travelTime: 0, transportType: 'flight', note: '起飛 12:00 / 抵達 14:00', description: '帶著滿滿的回憶（和超重的行李）回家囉！✈️ 抵達高雄後記得領取行李。' }
];
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDc1X5CFJc7ThluEmPN--uVKxSfrlZavek",
    authDomain: "osa0402test.firebaseapp.com",
    projectId: "osa0402test",
    storageBucket: "osa0402test.firebasestorage.app",
    messagingSenderId: "49893570598",
    appId: "1:49893570598:web:c334c87afbd84ee329cee7",
    measurementId: "G-HTNRTFVN0S"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const TRIP_ID = "keihan_2026_0402";
  const stateDocRef = () => doc(db, "trips", TRIP_ID, "state", "main");
  const tripMetaRef = () => doc(db, "trips", TRIP_ID);

let user = null;

window.__CLOUD_READY__ = new Promise((resolve) => {
  signInAnonymously(auth).catch(() => {});
  onAuthStateChanged(auth, (u) => {
    if (u) {
      user = u;
      resolve(true);   // ✅ 明確告訴外面：Firebase 登入完成
    }
  });
});

  const waitForUser = async (ms = 6000) => {
    const start = Date.now();
    while (!user && Date.now() - start < ms) await new Promise(r => setTimeout(r, 150));
    return !!user;
  };

  const toMs = (v) => {
    try {
      if (!v) return 0;
      if (typeof v === 'number') return v;
      if (typeof v?.toMillis === 'function') return v.toMillis();
      if (typeof v?.seconds === 'number') return v.seconds * 1000;
      return 0;
    } catch (e) { return 0; }
  };

  window.__CLOUD_GET_STATE__ = async () => {
    const ok = await waitForUser();
    if (!ok) throw new Error("尚未登入，暫時不能讀取雲端");
    const snap = await getDoc(stateDocRef());
    if (!snap.exists()) return null;
    const data = snap.data() || {};
    data.serverUpdatedAtMs = toMs(data.serverUpdatedAt);
    return data;
  };

  window.__CLOUD_SET_STATE__ = async (payload) => {
    const ok = await waitForUser();
    if (!ok) throw new Error("尚未登入，暫時不能寫入雲端");

    const merged = {
      ...payload,
      serverUpdatedAt: serverTimestamp()
    };

    await setDoc(tripMetaRef(), { updatedAt: serverTimestamp() }, { merge: true });
    await setDoc(stateDocRef(), merged, { merge: true });
    return true;
  };

  window.__CLOUD_ON_SNAPSHOT__ = (cb) => {
    const unsub = onSnapshot(stateDocRef(), (snap) => {
      if (!snap.exists()) return cb(null);
      const data = snap.data() || {};
      data.serverUpdatedAtMs = toMs(data.serverUpdatedAt);
      cb(data);
    }, (err) => {
      cb(null);
    });
    return unsub;
  };

  console.log("✅ Firebase ready. TRIP_ID =", TRIP_ID);
</script>
</body>
</html>
